<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù…ØªÙ„ÙƒØ§Øª â€” Ù†Ø³Ø®Ø© Ø´Ø¹Ø§Ø± IBSC (v19)</title>
<link rel="icon" type="image/jpeg" href="https://i.ibb.co/bM7q7dJJ/Screenshot-20260214-214728-Instagram.jpg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{ --bg:#f7f9fb; --fg:#0b0b0b; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb; --accent:#111111; --accent-2:#2f2f2f; --success:#16a34a; --danger:#ef4444; --kpi:#f8fafc; }
html,body{ background:linear-gradient(180deg,#fbfcfe 0%,#f2f5f9 100%); }
body{ margin:0; direction:rtl; text-align:right; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; font-family:"Tajawal","Noto Naskh Arabic",system-ui,-apple-system,"Segoe UI",Roboto,"Tahoma",sans-serif; color:var(--fg); font-size:15px; line-height:1.6; }
*,*:before,*:after{ box-sizing:border-box; }
.container{ max-width:1200px; margin:0 auto; padding:14px; }
.grid{ display:grid; gap:12px; }
@media(min-width:960px){ .cols-3{ grid-template-columns:repeat(3,1fr);} }
@media(min-width:640px){ .cols-2{ grid-template-columns:repeat(2,1fr);} }
.hidden{ display:none !important; }
.kv{ display:flex; flex-wrap:wrap; gap:12px; color:#374151; }
header{ position:sticky; top:0; z-index:50; background:rgba(255,255,255,.85); backdrop-filter:blur(8px); border-bottom:1px solid var(--border); }
.brand{ display:flex; align-items:center; gap:10px; font-weight:700; }

.brand-logo{ height:34px; width:auto; border-radius:10px; display:block; }

.brand img{ height:42px; width:auto; border-radius:6px; object-fit:contain; }
.toolbar{ display:flex; gap:8px; flex-wrap:wrap; }
.btn{ display:inline-flex; align-items:center; justify-content:center; gap:6px; border:1px solid var(--border); background:#fff; color:#0f172a; border-radius:10px; padding:10px 14px; cursor:pointer; transition:all .15s; font-size:14px; }
.btn:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.06); }
.btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent); box-shadow:0 2px 6px rgba(0,0,0,.18); }
.btn.danger{ background:var(--danger); color:#fff; border-color:var(--danger); box-shadow:0 2px 6px rgba(239,68,68,.25); }
.card{ background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 1px 2px rgba(0,0,0,.04); overflow:visible; }
.card-h{ padding:12px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
.card-c{ padding:12px 14px; }
.muted{ color:var(--muted); }
.stat{ background:var(--kpi); border:1px solid var(--border); border-radius:12px; padding:12px 14px; display:flex; align-items:center; gap:10px; }
.icon-card{ border:1px solid var(--border); border-radius:16px; padding:16px; background:#fff; transition:transform .12s, box-shadow .18s; }
.icon-card:hover{ transform:translateY(-2px); box-shadow:0 10px 28px rgba(0,0,0,.07); }
.circle{ width:54px; height:54px; border-radius:50%; display:grid; place-items:center; background:var(--accent); border:1px solid var(--accent); color:#fff; font-size:22px; }
input,select,textarea{ border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:#fff; transition:border-color .15s, box-shadow .15s; }
input:focus,select:focus,textarea:focus{ outline:none; border-color:rgba(0,0,0,.35); box-shadow:0 0 0 3px rgba(0,0,0,.10); }
label{ color:#374151; font-size:12px; margin-bottom:6px; display:block; }
.filters{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.chip{ border:1px solid var(--border); padding:6px 12px; border-radius:999px; cursor:pointer; background:#fff; transition:all .15s; }
.chip.active{ background:#f3f4f6; border-color:#d1d5db; }
table{ width:100%; border-collapse:collapse; border:1px solid var(--border); background:#fff; }
th,td{ border:1px solid var(--border); padding:8px 10px; }
thead{ background:#f8fafc; }
.modal-wrap{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:100; }
.modal-wrap.show{ display:flex; }
.modal-wrap .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.25) }
.modal-wrap .modal{ position:relative; background:#fff; border-radius:18px; border:1px solid var(--border); width:min(820px,94vw); max-height:88vh; overflow:auto; }
.modal .head{ padding:14px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:8px; }
.modal .body{ padding:14px; }
.modal .buttons-row{ display:flex; align-items:center; gap:8px; justify-content:flex-end; margin-top:10px; }
@media print{ header,.toolbar,.filters,.modal-wrap{ display:none !important; } }
.badge{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; }
.badge.success{ background:#ecfdf5; border-color:#bbf7d0; }
.badge.gray{ background:#f3f4f6; border-color:#e5e7eb; }

/* === FORCE: 5 action buttons in ONE horizontal row === */
[data-tenant-row] > div[style*="justify-content:flex-end"]{
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  justify-content: flex-end !important;
  gap: 6px !important;
  flex-wrap: nowrap !important;
}
[data-tenant-row] > div[style*="justify-content:flex-end"] .tenant-actions{
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  gap: 6px !important;
  flex-wrap: nowrap !important;
}
/* Normalize button sizes */
[data-tenant-row] [data-edit],
[data-tenant-row] [data-del],
[data-tenant-row] [data-pay],
[data-tenant-row] [data-docs],
[data-tenant-row] [data-receipt],
[data-tenant-row] [data-contract]{
  min-height: 40px !important;
  padding-inline: 12px !important;
  white-space: nowrap !important;
}

/* Demo mode: keep tenant CRUD visible; hide building creation/import/uploads to keep demo fixed */ 
body.demo #btnAddBuilding,
body.demo #btnImportCSV,
body.demo #btnUpload,
body.demo #btnUploadID{
  display:none !important;
}

/* === ØµÙ„Ø§Ø­ÙŠØ§Øª: Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø· === */
body:not(.is-admin) .admin-only{ display:none !important; }

</style>


<style id="valuation-actions-pack">
/* === Valuation inline actions (ØªØ«Ù…ÙŠÙ†) === */
.section-head{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin:6px 0; }
.inline-actions{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.btn.mini{ padding:8px 10px; font-size:13px; border-radius:10px; }
.drop{ position:relative; }
.drop > summary{ list-style:none; }
.drop > summary::-webkit-details-marker{ display:none; }
.drop-menu{
  display:none;
  position:absolute;
  z-index:40;
  top:calc(100% + 6px);
  right:0;
  min-width:240px;
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  box-shadow:0 14px 34px rgba(0,0,0,.10);
  padding:6px;
  max-width:min(92vw, 320px);
  max-height:min(60vh, 320px);
  overflow:auto;
  overscroll-behavior:contain;
}
.drop[open] .drop-menu{ display:block; }
.drop.open-up .drop-menu{ top:auto; bottom:calc(100% + 6px); }
.drop.align-left .drop-menu{ right:auto; left:0; }
.drop-item{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:8px;
  text-align:right;
  border:1px solid transparent;
  background:#fff;
  color:var(--fg);
  border-radius:10px;
  padding:10px 10px;
  cursor:pointer;
  font-size:14px;
}
.drop-item:hover{
  border-color: var(--border);
  background: rgba(31,111,255,.06);
}
</style>

<style id="oasis-minimal-pack">
/* === Oasis Minimal Pack â€” v1 === */
:root{
  --bg:#faf8f4;
  --fg:#0b1728;
  --muted:#667085;
  --card:#ffffff;
  --border:#e8edf3;
  --accent:#0bb8b2;
  --accent-2:#0891a0;
  --success:#16a34a;
  --danger:#ef4444;
  --kpi:#f2fbfb;
}
html,body{
  background: radial-gradient(1200px 600px at 80% -10%, #e6fbff 0%, transparent 70%),
              radial-gradient(1000px 500px at -10% 100%, #fff3e0 0%, transparent 70%),
              linear-gradient(180deg,#fbfcfd 0%,#f3f6f8 100%);
  color:var(--fg);
}
header{ background: rgba(255,255,255,.78); backdrop-filter: blur(10px) saturate(1.1); border-bottom: 1px solid var(--border); }
.card{ border:1px solid var(--border); border-radius:18px; box-shadow: 0 10px 28px rgba(17,24,39,.06); }
.stat{ background:rgba(255,255,255,.85); border:1px solid var(--border); border-radius:14px; box-shadow: 0 6px 20px rgba(2,132,199,.06); }
.icon-card{ border-radius:18px; background:linear-gradient(180deg,#ffffff 0%, #fbfdff 100%); box-shadow: 0 12px 36px rgba(15,23,42,.08); }
.icon-card .circle{ width:56px;height:56px; background: linear-gradient(135deg, #ccfbf1 0%, #e0f2fe 100%); border:1px solid #cce7f3; }
.btn{ border-radius:12px; border:1px solid var(--border); background:#fff; transition: transform .12s ease, box-shadow .18s ease, background .18s ease; }
.btn:hover{ transform: translateY(-1px); box-shadow:0 10px 26px rgba(0,0,0,.06); }
.btn:focus{ outline:none; box-shadow:0 0 0 3px rgba(11,184,178,.22); }
.btn.primary{ color:#fff; border-color: transparent; background: linear-gradient(135deg, var(--accent) 0%, #22d3ee 100%); box-shadow: 0 6px 20px rgba(34,211,238,.35); }
.btn.primary:hover{ transform: translateY(-1px); box-shadow: 0 10px 28px rgba(34,211,238,.45); }
.btn.danger{ color:#fff; border-color:transparent; background: linear-gradient(135deg, #ef4444 0%, #f97316 100%); box-shadow: 0 6px 18px rgba(249,115,22,.35); }
.chip{ background:#fff; border-radius:999px; }
.chip.active{ background:#e6fffb; border-color:#99f6e4; box-shadow: inset 0 0 0 1px rgba(11,184,178,.25); }
input,select,textarea{ border-radius:12px; border:1px solid var(--border); background:#fff; transition:border-color .15s, box-shadow .15s; }
input:focus,select:focus,textarea:focus{ border-color:#67e8f9; box-shadow: 0 0 0 3px rgba(34,211,238,.3); }
.modal-wrap .modal{ border-radius:20px; box-shadow: 0 24px 70px rgba(15,23,42,.18); }
.modal .head{ background:linear-gradient(180deg,#f8ffff 0%, #ffffff 100%); }
table{ background:#fff; border-radius:14px; overflow:hidden; }
thead{ background:linear-gradient(180deg,#f1fafc 0%, #eaf6fb 100%); }
th,td{ border-color:#e8edf3; }
.badge.success{ background:#e8fff4; border-color:#bfead0; }
.badge.gray{ background:#f5f7fb; border-color:#e8edf3; }
@media print{ body{ background:#fff; } }
</style>


<style id="mobile-enhancements">
/* === Mobile enhancements (phone-first) === */
@media (max-width: 640px) {
  html, body { font-size: 16px; }
  .container { padding: 12px; }
  header .container { flex-direction: column; align-items: stretch; gap: 8px; }
  .toolbar { width: 100%; overflow-x: auto; padding-bottom: 6px; -webkit-overflow-scrolling: touch; }
  .toolbar .btn { flex: 0 0 auto; }
  .card-h { align-items: stretch; }
  .card-h > div:last-child { width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
  .filters { gap: 6px; }
  input, select, textarea { width: 100%; }
  table { display: block; overflow-x: auto; white-space: nowrap; border-radius: 12px; }
  thead, tbody, tfoot, tr, th, td { border-collapse: separate; }
  /* Tenant rows: allow wrapping and stacking on small screens */
  [data-tenant-row] > div[style*="justify-content:flex-end"]{
    justify-content: stretch !important;
    gap: 6px !important;
    flex-wrap: wrap !important;
  }
  [data-tenant-row] .tenant-actions {
    width: 100% !important;
    flex-wrap: wrap !important;
  }
  [data-tenant-row] .tenant-actions .btn {
    flex: 1 1 calc(50% - 6px) !important;
    min-height: 44px !important;
  }
  [data-tenant-row] [data-del]{
    flex: 1 1 100% !important;
    min-height: 44px !important;
  }
  /* Force grid stacks for safety on phones */
  .grid { gap: 10px; }
  .grid.cols-2, .grid.cols-3 { grid-template-columns: 1fr !important; }
  /* Modal: fullscreen on phones */
  .modal-wrap .modal {
    width: 100vw !important;
    max-height: 100vh !important;
    height: 100vh !important;
    border-radius: 0 !important;
  }
  .modal .body { padding-bottom: 72px; }
  .modal .buttons-row {
    position: sticky;
    bottom: 0;
    background: #fff;
    padding: 10px;
    border-top: 1px solid var(--border);
  }
  /* Chips and tabs: horizontal scroll if overflow */
  .filters, #bizTabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .chip { flex: 0 0 auto; }
  /* KPI cards readability */
  .stat { font-size: 14px; }
  /* Building cards: compact layout */
  #buildingsGrid .icon-card { display: grid; grid-template-columns: 56px 1fr; align-items: center; gap: 10px; }
  #buildingsGrid .icon-card .circle { grid-row: span 2; }
}
@media (max-width: 370px){
  .card-h > div:last-child { grid-template-columns: 1fr; }
  [data-tenant-row] .tenant-actions .btn { flex-basis: 100% !important; }
}
/* Better tap targets */
.btn { touch-action: manipulation; }
</style>
<style id="font-unify">
  /* ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø®Ø· ÙÙŠ ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… */
  :root{
    --app-font: "Tajawal","Noto Naskh Arabic",system-ui,-apple-system,"Segoe UI",Roboto,"Tahoma",sans-serif;
  }

  body{ font-family: var(--app-font); }

  button,
  .btn,
  [type="button"],
  [type="submit"],
  [type="reset"],
  .tenant-actions .btn,
  .icon-card .btn,
  input,
  select,
  textarea{
    font-family: var(--app-font) !important;
    font-weight: 500;
    font-size: 14px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    letter-spacing: 0;
    line-height: 1.6;
    appearance: none;
  }

  /* Ù„Ùˆ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø²Ø± Ø¹Ù†Ø§ØµØ± Ø£Ø®Ø±Ù‰ (Ø£ÙŠÙ‚ÙˆÙ†Ø©/Ø³Ø¨Ø§Ù†) ØªØ±Ø« Ù†ÙØ³ Ø§Ù„Ø®Ø· */
  .btn *{ font-family: inherit !important; }
</style>


<style id="beautify-pack-v2">
/* === UI Beautify Pack â€” v2 (IBSC) === */
:root{
  --radius-lg: 22px;
  --shadow-sm: 0 6px 18px rgba(15,23,42,.06);
  --shadow-md: 0 14px 40px rgba(15,23,42,.10);
}
.container{ max-width:1280px; }
header{ box-shadow: 0 8px 30px rgba(15,23,42,.08); }
.brand span{ font-size:16px; letter-spacing:.2px; }
.brand-logo{ box-shadow: 0 10px 26px rgba(15,23,42,.12); }
.toolbar .btn{ padding:10px 12px; }
.toolbar .badge{ border-radius:999px; padding:6px 10px; }

.ymbar{
  background: rgba(255,255,255,.75);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 10px 12px;
  box-shadow: var(--shadow-sm);
}
.ymbar select{ min-width:120px; }

#kpis{ margin-top:10px; }
.stat{
  position:relative;
  overflow:hidden;
  border-radius: 18px;
  box-shadow: var(--shadow-sm);
}
.stat::before{
  content:"";
  position:absolute;
  right:0;
  top:0;
  width:8px;
  height:100%;
  background: linear-gradient(180deg, var(--accent) 0%, #22d3ee 100%);
  opacity:.9;
}
.stat b{ font-size:18px; }

#bizTabs.filters{
  background: rgba(255,255,255,.65);
  border: 1px solid var(--border);
  border-radius: 999px;
  padding: 6px;
  box-shadow: var(--shadow-sm);
  gap:6px;
}
#bizTabs .chip{
  border: 0;
  background: transparent;
  padding: 10px 14px;
  font-weight: 800;
  color: #0b1728;
}
#bizTabs .chip.active{
  background: #fff;
  border: 1px solid var(--border);
  box-shadow: 0 12px 26px rgba(15,23,42,.10);
}
.topbar input[type="search"]{
  border-radius: 999px !important;
  padding: 12px 14px !important;
  background: rgba(255,255,255,.92);
  box-shadow: var(--shadow-sm);
}
.section-head h2{
  font-size: 18px !important;
  letter-spacing: .2px;
}
.section-head{ margin-top: 10px; }
.inline-actions .btn.mini:not(.primary):not(.danger){
  background: rgba(255,255,255,.92);
  box-shadow: var(--shadow-sm);
}
.inline-actions .btn.mini.primary{
  color:#fff;
  border-color: transparent;
  background: linear-gradient(135deg, var(--accent) 0%, #22d3ee 100%);
  box-shadow: 0 6px 20px rgba(34,211,238,.35);
}
.inline-actions .btn.mini.danger{
  color:#fff;
  border-color: transparent;
  background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
  box-shadow: 0 6px 18px rgba(249,115,22,.35);
}

#buildingsGrid{ gap: 14px; }
.icon-card{
  border-radius: 22px !important;
  padding: 16px !important;
  box-shadow: var(--shadow-md) !important;
  position: relative;
  overflow: hidden;
}
.icon-card::after{
  content:"";
  position:absolute;
  inset:-2px;
  background:
    radial-gradient(650px 240px at 100% 0%, rgba(11,184,178,.18) 0%, transparent 60%),
    radial-gradient(520px 220px at 0% 100%, rgba(255,184,107,.16) 0%, transparent 55%);
  pointer-events:none;
}
.icon-card > *{ position:relative; z-index:1; }
.icon-card .circle{
  background: linear-gradient(135deg, #ccfbf1 0%, #e0f2fe 100%) !important;
  border-color: #cce7f3 !important;
  color: #0b1728 !important;
  box-shadow: 0 10px 24px rgba(2,132,199,.10);
}
.icon-card img{
  box-shadow: 0 16px 42px rgba(15,23,42,.10);
}

.card{ border-radius: 20px; box-shadow: var(--shadow-sm); }
.card-h{
  padding: 14px 16px;
  background: linear-gradient(180deg, rgba(255,255,255,.95) 0%, rgba(255,255,255,.86) 100%);
}
.card-c{ padding: 14px 16px; }

table{
  border-radius: 14px;
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}
tbody tr:nth-child(even){ background: rgba(2,132,199,.03); }

.modal-wrap.show .modal{ animation: pop .14s ease-out; }
@keyframes pop{
  from{ transform: translateY(12px) scale(.985); opacity:0; }
  to{ transform: translateY(0) scale(1); opacity:1; }
}

/* Keep â• Ù…Ø¨Ù†Ù‰ visible in DEMO */
body.demo #btnAddBuilding{ display:inline-flex !important; }


/* Dashboard building cards: premium layout on desktop */
@media (min-width: 641px){
  #view-dashboard #buildingsGrid .icon-card{
    padding-top: 74px !important;
  }
  #view-dashboard #buildingsGrid .icon-card .circle{
    position:absolute;
    top:14px;
    right:14px;
  }
  #view-dashboard #buildingsGrid .icon-card > div:nth-child(2){
    font-size: 18px;
    margin-top: 2px;
  }
}

/* Smoother scrollbars (Chrome/Edge) */
*::-webkit-scrollbar{ height:10px; width:10px; }
*::-webkit-scrollbar-thumb{ background: rgba(15,23,42,.18); border-radius: 999px; border: 2px solid rgba(255,255,255,.8); }
*::-webkit-scrollbar-track{ background: rgba(255,255,255,.55); }
</style>

</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div class="brand">
      <img class="brand-logo" alt="IBSC" src="https://i.ibb.co/bM7q7dJJ/Screenshot-20260214-214728-Instagram.jpg"/>
      <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù…ØªÙ„ÙƒØ§Øª</span>
    </div>
    <div class="toolbar">
            <button type="button" class="btn" id="btnWhatsRemind">ğŸ“² ØªØ°ÙƒÙŠØ± ÙˆØ§ØªØ³Ø§Ø¨</button>
      <button type="button" class="btn admin-only" id="btnAddUser">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
      <span class="badge gray" id="userBadge">ØºÙŠØ± Ù…Ø³Ø¬Ù„</span>
      <button type="button" class="btn" id="btnLogin">ğŸ” Ø¯Ø®ÙˆÙ„</button>
      <button type="button" class="btn" id="btnLogout" style="display:none">â†©ï¸ Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
</header>

<main class="container">
  <div class="ymbar" style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
    <div>Ø§Ù„Ø³Ù†Ø©</div>
    <select id="yearSel"></select>
    <div>Ø§Ù„Ø´Ù‡Ø±</div>
    <select id="monthSel"></select>
  </div>

  <section class="grid cols-3" id="kpis">
    <div class="stat">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ (Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯): <b id="kpiIncome">0</b> Ø±.Ø¹</div>
    <div class="stat">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯): <b id="kpiExpenses">0</b> Ø±.Ø¹</div>
    <div class="stat">Ø§Ù„ØµØ§ÙÙŠ: <b id="kpiNet">0</b> Ø±.Ø¹</div>
  </section>

  <section id="view-dashboard" style="margin-top:10px">
    <div id="bizTabs" class="filters" style="margin:8px 0">
      <div class="chip active" data-biz="Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ">ğŸ‘¥ Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ</div>
      <div class="chip" data-biz="ØªØ«Ù…ÙŠÙ†">ğŸ’ ØªØ«Ù…ÙŠÙ†</div>
      <div class="chip" data-biz="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ">ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</div>
    </div>

    <div class="topbar" style="display:flex;gap:8px;align-items:center;margin:6px 0 2px 0">
      <input id="bizSearchInput" type="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ù…ÙˆÙ‚Ø¹" aria-label="Ø¨Ø­Ø«" style="flex:1;min-width:220px" />
    </div>

    <div class="section-head">
      <h2 id="dashTitle" style="margin:0">Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</h2>

      <div id="valInlineActions" class="inline-actions" style="display:none">
        <button type="button" class="btn mini" id="btnValAddBank" title="Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ùƒ">â• Ø¨Ù†Ùƒ</button>
        <button type="button" class="btn mini" id="btnValuationReport" title="ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ«Ù…ÙŠÙ†">ğŸ“ˆ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ«Ù…ÙŠÙ†</button>
        <button type="button" class="btn mini" id="btnValAddBroker" title="Ø¥Ø¶Ø§ÙØ© Ø³Ù…Ø³Ø§Ø±">ğŸ§‘â€ğŸ’¼ Ø¥Ø¶Ø§ÙØ© Ø³Ù…Ø³Ø§Ø±</button>
        <button type="button" class="btn mini" id="btnValFiles" title="Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª">ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª</button>

        <details class="drop" id="valIssueDrop">
          <summary class="btn mini" title="Ø¥ØµØ¯Ø§Ø± ØªÙ‚Ø§Ø±ÙŠØ±">ğŸ§¾ Ø¥ØµØ¯Ø§Ø± ØªÙ‚Ø§Ø±ÙŠØ± â–¾</summary>
          <div class="drop-menu">
            <button type="button" class="drop-item" data-val-issue="brokers">ğŸ“„ Ø¥ØµØ¯Ø§Ø± ØªÙ‚Ø±ÙŠØ± Ø³Ù…Ø§Ø³Ø±Ø©</button>
            <button type="button" class="drop-item" data-val-issue="receipt">ğŸ§¾ Ø¥ØµØ¯Ø§Ø± Ø¥ÙŠØµØ§Ù„ Ù„Ù„Ø²Ø¨ÙˆÙ†</button>
            <button type="button" class="drop-item" data-val-issue="bankMonthly">ğŸ“… Ø¥ØµØ¯Ø§Ø± ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ Ù„Ù„Ø¨Ù†Ùƒ</button>
            <button type="button" class="drop-item" data-val-issue="brokerContract">ğŸ“ Ø¥ØµØ¯Ø§Ø± Ø¹Ù‚Ø¯ Ø³Ù…Ø³Ø§Ø±</button>
          </div>
        </details>
      </div>

      <div id="oaInlineActions" class="inline-actions" style="display:none">
        <button type="button" class="btn mini primary" id="btnAddBuilding" title="Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù†Ù‰">â• Ù…Ø¨Ù†Ù‰</button>
      </div>
    </div>
    <div id="buildingsGrid" class="grid cols-3" data-buildings-grid></div>
    <div id="emptyBuildings" class="card" style="display:none">
      <div class="card-c muted" style="text-align:center;padding:24px">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù†Ù â€” Ø£Ø¶Ù Ù…Ø¨Ù†Ù‰ Ù…Ù† Ø²Ø± (â• Ù…Ø¨Ù†Ù‰) Ø¨Ø¬Ø§Ù†Ø¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ.</div>
    </div>
  </section>

  <section id="view-building" class="hidden">
    <div class="card">
      <div class="card-h">
        <div>
          <h2 id="buildingTitle" style="margin:0 0 4px"></h2>
          <div id="buildingMeta" class="kv" style="font-size:13px"></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button type="button" class="btn" id="btnBack">Ø§Ù„Ø±Ø¬ÙˆØ¹</button>
          <button type="button" class="btn" id="btnEditBuilding">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ù†Ù‰</button>
          <button type="button" class="btn danger" id="btnDeleteBuilding" title="Ø­Ø°Ù Ø§Ù„Ù…Ø¨Ù†Ù‰">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø¨Ù†Ù‰</button>
          <button type="button" class="btn" id="btnImportCSV">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† (CSV)</button>
          <button type="button" class="btn primary" id="btnAddTenant">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø±</button>
          <button type="button" class="btn" id="btnExpenses">ğŸ’° Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
                 <button type="button" class="btn" id="btnFiles">ğŸ“ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</button>
          <button type="button" class="btn" id="btnReport">ğŸ“Š ØªÙ‚Ø±ÙŠØ±</button>
                <button type="button" class="btn" id="btnMaintReport">ğŸ› ï¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³Ù†ÙˆÙŠ</button>

        </div>
      </div>

      <div class="card-c">
        <div id="oaPaymentChartWrap" class="card" style="margin:12px 0;display:none">
          <div class="card-h"><b>Ø­Ø§Ù„Ø© Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù…Ù„Ø§Ùƒ (Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯)</b></div>
          <div class="card-c" style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
            <div style="width:220px;height:220px;max-width:100%">
              <canvas id="oaPaymentChart" aria-label="Pie chart for owners payment status"></canvas>
            </div>
            <div class="muted" style="min-width:220px">
              <div>Ø¯ÙØ¹ÙˆØ§: <b id="oaPaidCount">0</b></div>
              <div>Ù„Ù… ÙŠØ¯ÙØ¹ÙˆØ§: <b id="oaUnpaidCount">0</b></div>
              <div style="margin-top:8px;font-size:12px">ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯ Ø³Ø¬Ù„ Ø¯ÙØ¹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</div>
            </div>
          </div>
        </div>
        <div class="grid cols-3" style="margin-bottom:8px">
          <div class="stat">Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ø§Ù„Ø´Ù‡Ø±): <b id="bkIncome">0</b> Ø±.Ø¹</div>
          <div class="stat">Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ø§Ù„Ø´Ù‡Ø±): <b id="bkExpenses">0</b> Ø±.Ø¹</div>
          <div class="stat">Ø§Ù„ØµØ§ÙÙŠ (Ø§Ù„Ø´Ù‡Ø±): <b id="bkNet">0</b> Ø±.Ø¹</div>
        </div>

        <div class="grid cols-3">
          <div class="stat">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª: <b id="stTotal">0</b></div>
          <div class="stat">Ø´Ù‚Ù‚: <b id="stApt">0</b></div>
          <div class="stat">Ù…Ø­Ù„Ø§Øª/Ù…Ø¹Ø§Ø±Ø¶: <b id="stShop">0</b></div>
          <div class="stat">Ù…Ø´ØºÙˆÙ„Ø©: <b id="stOcc">0</b></div>
          <div class="stat">Ø´Ø§ØºØ±Ø©: <b id="stVac">0</b></div>
          <div class="stat">ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹ (â‰¤30 ÙŠÙˆÙ…): <b id="stExpSoon">0</b></div>
        </div>

        <div class="filters" style="margin:12px 0">
          <input id="searchBox" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„ÙˆØ­Ø¯Ø©/Ø§Ù„Ù‡Ø§ØªÙ/Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©" style="max-width:260px">
          <div class="chip" data-ft="all">Ø§Ù„ÙƒÙ„</div>
          <div class="chip" data-ft="apartment">Ø´Ù‚Ù‚</div>
          <div class="chip" data-ft="shop">Ù…Ø­Ù„Ø§Øª</div>
          <div class="chip" data-ft="showroom">Ù…Ø¹Ø§Ø±Ø¶</div>
          <div class="chip" data-ft="basement">Ù‚Ø¨Ùˆ</div>
          <div class="chip" data-status="occupied">Ù…Ø´ØºÙˆÙ„Ø©</div>
          <div class="chip" data-status="vacant">Ø´Ø§ØºØ±Ø©</div>
        </div>

        <div class="grid cols-2" style="margin-top:12px">
          <div class="card">
            <div class="card-h"><b>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª</b></div>
            <div class="card-c" id="unitsList"><span class="muted">â€”</span></div>
          </div>
          <div class="card">
            <div class="card-h"><b>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙˆÙ†</b></div>
            <div class="card-c" id="tenantsList"><span class="muted">â€”</span></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="modalWrap" class="modal-wrap" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <div class="modal" role="dialog" aria-modal="true">
    <div class="head">
      <h3 id="modalTitle">Ø¹Ù†ÙˆØ§Ù†</h3>
      <button type="button" class="btn" data-close>âœ•</button>
    </div>
    <div class="body" id="modalBody"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
const SKIP_STORAGE_UPLOADS = true;

// ========================= DEMO MODE (Preview Template) =========================
// Turn ON to use fake data (no Firebase reads/writes). Turn OFF for production.
const DEMO_MODE = false; // Firebase mode (set true for demo only)

// Fake dataset for preview (all data is NOT real)
const DemoStore = (function(){
  // deterministic pseudo-random (stable demo each reload)
  function LCG(seed){
    let s = seed >>> 0;
    return function(){
      s = (1664525 * s + 1013904223) >>> 0;
      return s / 4294967296;
    };
  }
  const rnd = LCG(20260209);
  const pick = arr => arr[Math.floor(rnd()*arr.length)];
  const randint = (a,b)=> Math.floor(a + rnd()*(b-a+1));
  const pad2 = n => String(n).padStart(2,'0');
  const now = new Date();
  const Y = now.getFullYear();
  const M = now.getMonth()+1;

  const first = ['Ø³Ø§Ù„Ù…','Ø®Ø§Ù„Ø¯','Ø£Ø­Ù…Ø¯','Ù†Ø§ØµØ±','Ø±Ø§Ø´Ø¯','Ù…Ø­Ù…Ø¯','Ø­Ù…ÙˆØ¯','Ø³ÙŠÙ','Ø¹Ù„ÙŠ','Ù…Ø§Ø²Ù†','ÙŠÙˆØ³Ù','Ø¨Ø¯Ø±','Ù‡Ù„Ø§Ù„','Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡','Ø³Ù‡ÙŠÙ„','Ø­Ù…Ø¯'];
  const last  = ['Ø§Ù„Ø­Ù…Ø§Ø¯ÙŠ','Ø§Ù„Ù†Ø¹ÙŠÙ…ÙŠ','Ø§Ù„Ø¹Ø±ÙŠÙ…ÙŠ','Ø§Ù„ÙƒÙ†Ø¯ÙŠ','Ø§Ù„Ø¨Ù„ÙˆØ´ÙŠ','Ø§Ù„Ù…Ø¹Ù…Ø±ÙŠ','Ø§Ù„Ø±Ø§Ø´Ø¯ÙŠ','Ø§Ù„Ø´Ø­ÙŠ','Ø§Ù„Ù‡Ù†Ø§Ø¦ÙŠ','Ø§Ù„Ø²ÙƒÙˆØ§Ù†ÙŠ','Ø§Ù„Ø¨Ù‡Ù„Ø§Ù†ÙŠ','Ø§Ù„Ø¹Ù„ÙˆÙŠ','Ø§Ù„ØºØ§ÙØ±ÙŠ','Ø§Ù„Ø¹Ø¨Ø±ÙŠ','Ø§Ù„ÙØ²Ø§Ø±ÙŠ'];
  const streets = ['Ø´Ø§Ø±Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ 1','Ø´Ø§Ø±Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ 2','Ø·Ø±ÙŠÙ‚ Ø¯Ø§Ø®Ù„ÙŠ','Ø­ÙŠ ØªØ¬Ø±ÙŠØ¨ÙŠ','Ù…Ø®Ø·Ø· ØªØ¬Ø±ÙŠØ¨ÙŠ','Ù…Ù†Ø·Ù‚Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©'];
  const wilayat = ['Ø¨Ø±ÙƒØ§Ø¡','Ø§Ù„Ù…Ø¹Ø¨ÙŠÙ„Ø©','Ø§Ù„Ø³ÙŠØ¨','Ù†Ø²ÙˆÙ‰','ØµØ­Ø§Ø±','ØµÙˆØ±','ØµÙ„Ø§Ù„Ø©','Ø§Ù„Ø±Ø³ØªØ§Ù‚','Ø§Ù„Ø³ÙˆÙŠÙ‚','Ø¥Ø¨Ø±Ø§Ø¡'];

  const fakePhone = ()=> '9' + String(randint(1000000,9999999));
  const fakeCard  = ()=> String(randint(10000000,99999999));
  const fakeName  = ()=> `${pick(first)} ${pick(last)}`;
  const fakeAddr  = ()=> `${pick(wilayat)} â€” ${pick(streets)} â€” Ø±Ù‚Ù… ${randint(1,99)}`;

  function isoDate(y,m,d){
    // YYYY-MM-DD
    return `${y}-${pad2(m)}-${pad2(d)}`;
  }

  function genTenants(count, isOA){
    const out = [];
    for(let i=0;i<count;i++){
      const kindPool = isOA ? ['apartment','apartment','shop','showroom'] : ['apartment','apartment','apartment','shop','showroom','basement'];
      const kind = pick(kindPool);
      const unitBase = (kind==='apartment') ? randint(1,24) : (kind==='shop') ? randint(1,12) : (kind==='showroom') ? randint(1,6) : randint(1,4);
      const unitNumber = (kind==='apartment') ? `${100+unitBase}` : (kind==='shop') ? `${unitBase}` : (kind==='showroom') ? `SR-${unitBase}` : `B-${unitBase}`;

      const rent = (kind==='apartment') ? randint(180,420) :
                   (kind==='shop') ? randint(250,750) :
                   (kind==='showroom') ? randint(500,1400) :
                   randint(80,220);

      const start = isoDate(Y, Math.max(1, M-1), randint(1,10));
      const end   = isoDate(Y, Math.min(12, M+9), randint(20,28));
      const name = fakeName();
      const phone = fakePhone();
      const card = fakeCard();
      const addr = fakeAddr();

      // simple payment string for current month for some records
      const hasPay = isOA ? (i % 2 === 0) : (rnd() < 0.45);
      const pay = hasPay ? `ğŸ’° Ù…Ø³ØªÙ„Ù…: ${String(rent).padStart(3,'0')}.000 | Ù…ØªØ¨Ù‚ÙŠ: 0.000 | Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¯ÙØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ` : '';

      out.push({
        id: 't_' + Math.floor(rnd()*1e9).toString(36),
        tenantName: name,
        nationalId: card,
        phone: phone,
        unitNumber: unitNumber,
        kind: kind,
        rent: rent,
        deposit: (rnd()<0.25 ? randint(50,200) : 0),
        startDate: start,
        endDate: end,
        notes: `Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${addr} (Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©)`,
        payments: pay ? { [`${Y}-${pad2(M)}`]: pay } : {}
      });
    }
    return out;
  }

  const store = {
    buildings: [
      {
        id:'demo_admin_1',
        bizType:'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ',
        name:'Ù…Ø¨Ù†Ù‰ 1',
        owner:'Ù…Ø§Ù„Ùƒ ØªØ¬Ø±ÙŠØ¨ÙŠ 1',
        contact: fakePhone(),
        location:`${pick(wilayat)} â€” Ù…ÙˆÙ‚Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ`,
        notes:'Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙ‚Ø·',
        apartments: 12, shops: 4, showrooms: 1, basements: 1,
        feeType:'percentage', feeValue: 15
      },
      {
        id:'demo_admin_2',
        bizType:'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ',
        name:'Ù…Ø¨Ù†Ù‰ 2',
        owner:'Ù…Ø§Ù„Ùƒ ØªØ¬Ø±ÙŠØ¨ÙŠ 2',
        contact: fakePhone(),
        location:`${pick(wilayat)} â€” Ù…ÙˆÙ‚Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ`,
        notes:'Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙ‚Ø·',
        apartments: 18, shops: 6, showrooms: 2, basements: 0,
        feeType:'percentage', feeValue: 12
      },
      {
        id:'demo_oa_1',
        bizType:'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ',
        name:'Ù…Ø¨Ù†Ù‰ 1',
        owner:'Ø¬Ù…Ø¹ÙŠØ© Ù…Ù„Ø§Ùƒ â€” Ù†Ù…ÙˆØ°Ø¬ 1',
        contact: fakePhone(),
        location:`${pick(wilayat)} â€” Ù…ÙˆÙ‚Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ`,
        notes:'Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙ‚Ø·',
        apartments: 20, shops: 0, showrooms: 0, basements: 0,
        feeType:'salary', feeValue: 180
      },
      {
        id:'demo_oa_2',
        bizType:'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ',
        name:'Ù…Ø¨Ù†Ù‰ 2',
        owner:'Ø¬Ù…Ø¹ÙŠØ© Ù…Ù„Ø§Ùƒ â€” Ù†Ù…ÙˆØ°Ø¬ 2',
        contact: fakePhone(),
        location:`${pick(wilayat)} â€” Ù…ÙˆÙ‚Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ`,
        notes:'Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙ‚Ø·',
        apartments: 16, shops: 2, showrooms: 0, basements: 0,
        feeType:'percentage', feeValue: 10
      }
      ,
      {
        id:'demo_val_1',
        bizType:'ØªØ«Ù…ÙŠÙ†',
        name:'Ø¨Ù†Ùƒ 1',
        bankContractStart:'2026-01-01',
        owner:'Ø²Ø¨ÙˆÙ† ØªØ¬Ø±ÙŠØ¨ÙŠ 1',
        contact: fakePhone(),
        location:`${pick(wilayat)} â€” Ù…ÙˆÙ‚Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ`,
        notes:'Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙ‚Ø·',
        apartments: 0, shops: 0, showrooms: 0, basements: 0,
        feeType:'salary', feeValue: 0
      },
      {
        id:'demo_val_2',
        bizType:'ØªØ«Ù…ÙŠÙ†',
        name:'Ø¨Ù†Ùƒ 2',
        bankContractStart:'2026-01-01',
        owner:'Ø²Ø¨ÙˆÙ† ØªØ¬Ø±ÙŠØ¨ÙŠ 2',
        contact: fakePhone(),
        location:`${pick(wilayat)} â€” Ù…ÙˆÙ‚Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ`,
        notes:'Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙ‚Ø·',
        apartments: 0, shops: 0, showrooms: 0, basements: 0,
        feeType:'salary', feeValue: 0
      }
    ],
    tenantsBy: {},
    expensesBy: {},
    attachmentsBy: {},
    expenseAttachmentsBy: {}
  };

  // populate tenants & empty ledgers
  for(const b of store.buildings){
    const isOA = b.bizType === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ';
    store.tenantsBy[b.id] = genTenants(isOA ? randint(8,14) : randint(10,18), isOA);
    store.expensesBy[b.id] = [];
    store.attachmentsBy[b.id] = [];
    store.expenseAttachmentsBy[b.id] = {};
  }

  function getBuilding(id){ return store.buildings.find(b=>b.id===id) || null; }
  function getTenant(bid, tid){ return (store.tenantsBy[bid]||[]).find(t=>t.id===tid) || null; }
  function getExpense(bid, eid){ return (store.expensesBy[bid]||[]).find(e=>e.id===eid) || null; }

  function applyPatch(obj, patch){
    Object.keys(patch||{}).forEach(k=>{
      const v = patch[k];
      if (k.includes('.')){
        const [root, ...rest] = k.split('.');
        if(!obj[root]) obj[root] = {};
        let cur = obj[root];
        for(let i=0;i<rest.length-1;i++){
          const kk = rest[i];
          if(!cur[kk]) cur[kk] = {};
          cur = cur[kk];
        }
        cur[rest[rest.length-1]] = v;
      } else {
        obj[k] = v;
      }
    });
  }

  // API (Promise-compatible)
  return {
    getBuilding,
    getTenant,
    getExpense,

    async listBuildings(){ return store.buildings.map(b=>({ ...b })); },
    async createBuilding(data){
      const id = 'demo_b_' + Math.floor(rnd()*1e9).toString(36);
      const b = { id, ...(data||{}) };
      store.buildings.push(b);
      store.tenantsBy[id] = [];
      store.expensesBy[id] = [];
      store.attachmentsBy[id] = [];
      store.expenseAttachmentsBy[id] = {};
      return id;
    },
    async updateBuilding(id, patch){
      const b = getBuilding(id); if(!b) return;
      applyPatch(b, patch||{});
    },
    async removeBuilding(id){
      store.buildings = store.buildings.filter(b=>b.id!==id);
      delete store.tenantsBy[id]; delete store.expensesBy[id]; delete store.attachmentsBy[id]; delete store.expenseAttachmentsBy[id];
    },

    async listTenants(bid){ return (store.tenantsBy[bid]||[]).map(t=>({ ...t, payments: { ...(t.payments||{}) } })); },
    async addTenant(bid, data){
      const id = 't_' + Math.floor(rnd()*1e9).toString(36);
      const t = { id, ...(data||{}) };
      store.tenantsBy[bid] = store.tenantsBy[bid] || [];
      store.tenantsBy[bid].push(t);
      return id;
    },
    async updateTenant(bid, tid, patch){
      const t = getTenant(bid, tid); if(!t) return;
      applyPatch(t, patch||{});
    },
    async deleteTenant(bid, tid){
      store.tenantsBy[bid] = (store.tenantsBy[bid]||[]).filter(t=>t.id!==tid);
    },

    async listExpenses(bid){ return (store.expensesBy[bid]||[]).map(e=>({ ...e })); },
    async addExpense(bid, data){
      const id = 'ex_' + Math.floor(rnd()*1e9).toString(36);
      const ex = { id, ...(data||{}), createdAt: new Date().toISOString() };
      store.expensesBy[bid] = store.expensesBy[bid] || [];
      store.expensesBy[bid].push(ex);
      return id;
    },
    async updateExpense(bid, id, patch){
      const ex = getExpense(bid, id); if(!ex) return;
      applyPatch(ex, patch||{});
    },
    async deleteExpense(bid, id){
      store.expensesBy[bid] = (store.expensesBy[bid]||[]).filter(e=>e.id!==id);
    },

    
  async listExpenseAttachments(bid, expenseId){
    store.expenseAttachmentsBy[bid] = store.expenseAttachmentsBy[bid] || {};
    return deepClone(store.expenseAttachmentsBy[bid][expenseId] || []);
  },

  async addExpenseAttachment(bid, expenseId, file, meta = {}){
    store.expenseAttachmentsBy[bid] = store.expenseAttachmentsBy[bid] || {};
    store.expenseAttachmentsBy[bid][expenseId] = store.expenseAttachmentsBy[bid][expenseId] || [];

    const id = `att_${Math.random().toString(36).slice(2,10)}`;
    const url = (file && file instanceof Blob) ? URL.createObjectURL(file) : '';
    const rec = {
      id,
      name: (meta.displayName || (file && file.name) || 'Ù…Ø±ÙÙ‚'),
      displayName: meta.displayName || '',
      originalName: (file && file.name) || '',
      size: (file && file.size) || 0,
      mime: (file && file.type) || '',
      path: '',
      url,
      uploadedAt: new Date().toISOString().slice(0,10)
    };

    store.expenseAttachmentsBy[bid][expenseId].unshift(rec);

    const ex = (store.expensesBy[bid]||[]).find(x=>x.id===expenseId);
    if(ex){
      ex.attachmentsCount = Number(ex.attachmentsCount||0) + 1;
    }

    return id;
  },

  async deleteExpenseAttachment(bid, expenseId, attId){
    store.expenseAttachmentsBy[bid] = store.expenseAttachmentsBy[bid] || {};
    store.expenseAttachmentsBy[bid][expenseId] = store.expenseAttachmentsBy[bid][expenseId] || [];
    store.expenseAttachmentsBy[bid][expenseId] = store.expenseAttachmentsBy[bid][expenseId].filter(x=>x.id!==attId);

    const ex = (store.expensesBy[bid]||[]).find(x=>x.id===expenseId);
    if(ex){
      ex.attachmentsCount = Math.max(0, Number(ex.attachmentsCount||0) - 1);
    }
  },

async listAttachments(bid){ return (store.attachmentsBy[bid]||[]).map(a=>({ ...a })); },
    async addAttachment(bid, file, meta){
      const id = 'att_' + Math.floor(rnd()*1e9).toString(36);
      const doc = { id, name: (file&&file.name)||'file', url: '', ...(meta||{}), createdAt: new Date().toISOString() };
      store.attachmentsBy[bid] = store.attachmentsBy[bid] || [];
      store.attachmentsBy[bid].push(doc);
      return id;
    },
    async deleteAttachment(bid, id){
      store.attachmentsBy[bid] = (store.attachmentsBy[bid]||[]).filter(a=>a.id!==id);
    }
  };
})();

const App = (()=>{

  // Normalize business type names (handles legacy values)
  function normBiz(v){
    v = (v||'').toString().trim();
    if (v === 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ' || v === 'Ø§Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ù†ÙŠ' || v === 'Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ') return 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ';
    if (!v) return 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ';
    return v;
  }

  const State = {
    activeBuildingId: null,
    selYear: (new Date()).getFullYear(),
    selMonth: (new Date()).getMonth()+1,
    chipsState: { kind:'all', status:null },
    bizTab: 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ',
    bizSearchQuery: '',
    cachedBuildings: []
  };

  // ===== Business tab persistence (keeps the selected section on refresh / return) =====
  const __BIZ_KEY = 'pmBizTab';
  const __BIZ_DEFAULT = 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ';

  function __getSavedBiz(){
    try{
      const v = localStorage.getItem(__BIZ_KEY);
      return normBiz(v || '');
    }catch(_){ return ''; }
  }
  function __saveBiz(v){
    try{ localStorage.setItem(__BIZ_KEY, normBiz(v||__BIZ_DEFAULT)); }catch(_){}
  }

  // Restore last selected tab (or default)
  State.bizTab = normBiz(__getSavedBiz() || State.bizTab || __BIZ_DEFAULT);
  if (!State.bizTab) State.bizTab = __BIZ_DEFAULT;
  __saveBiz(State.bizTab);

  // === Firebase (disabled in DEMO_MODE) ===
  const firebaseConfig = {
    apiKey: "AIzaSyDej24Pcn7UiqDTziS_IaZ5i6_8QDyPKO4",
    authDomain: "lana-32ee1.firebaseapp.com",
    projectId: "lana-32ee1",
    storageBucket: "lana-32ee1.firebasestorage.app",
    messagingSenderId: "245112627495",
    appId: "1:245112627495:web:946e0da6e52084ca028902"
  };

  let db = null;
  let storage = null;
  let fn = null;

  if (firebaseConfig) {
    try{ firebase.initializeApp(firebaseConfig);

      // App Check (optional)
      try {
        const appCheck = firebase.appCheck();
        // appCheck.activate('YOUR_RECAPTCHA_ENTERPRISE_KEY', true);
        window.__waitAppCheck = new Promise(res=>{ try{ appCheck.onTokenChanged(()=>res()); }catch(_){ res(); } });
      } catch(e) { console.warn('AppCheck init error', e); window.__waitAppCheck = Promise.resolve(); }
// Auth + Role (Admin)
window.AuthState = { user:null, isAdmin:false };
try{
  const auth = firebase.auth();

  // Ù†ÙØ¹Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ù‡ÙˆÙ„ ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€” Ø«Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ‚Ø¯Ø± ÙŠØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø¥ÙŠÙ…ÙŠÙ„Ù‡
  try{ auth.signInAnonymously(); }catch(_){}

  window.__waitAuth = new Promise(res=>{
    let first = true;
    try{
      auth.onAuthStateChanged(async (u)=>{
        window.AuthState.user = u || null;
        window.AuthState.isAdmin = false;

        try{
          if(!db){ try{ db = firebase.firestore(); }catch(_){ db=null; } }
          if(u && db){
            const adoc = await db.collection('admins').doc(u.uid).get();
            window.AuthState.isAdmin = !!(adoc && adoc.exists);
          }
        }catch(e){ console.warn('Admin role check failed', e); }

        try{ document.body.classList.toggle('is-admin', !!window.AuthState.isAdmin); }catch(_){}

        // UI: badge + buttons
        try{
          const badge = document.getElementById('userBadge');
          const btnLogin = document.getElementById('btnLogin');
          const btnLogout = document.getElementById('btnLogout');
          const label = u ? (u.isAnonymous ? 'Ø²Ø§Ø¦Ø±' : (u.email || 'Ù…Ø³ØªØ®Ø¯Ù…')) : 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
          if (badge) badge.textContent = (window.AuthState.isAdmin ? ('Ø£Ø¯Ù…Ù†: ' + label) : label);
          if (btnLogin) btnLogin.style.display = (u && !u.isAnonymous) ? 'none' : '';
          if (btnLogout) btnLogout.style.display = (u && !u.isAnonymous) ? '' : 'none';
        }catch(_){}

        if(first){ first=false; res(); }
      });
    }catch(e){ console.warn('Auth listener error', e); res(); }
  });

  window.AuthAPI = {
    signIn: (email,pass)=> auth.signInWithEmailAndPassword(email,pass),
    signOut: ()=> auth.signOut(),
  };


// Admin tools (Cloud Functions callable)
window.AdminAPI = {
  async createUser(payload){
    if(DEMO_MODE) throw new Error('DEMO_MODE');
    if(!fn){ throw new Error('Firebase Functions ØºÙŠØ± Ù…ÙØ¹Ù„Ø©'); }
    const callable = fn.httpsCallable('createUserByAdmin');
    const res = await callable(payload||{});
    return res && res.data ? res.data : res;
  }
};
} catch(e) { console.warn('Auth init error', e); window.__waitAuth = Promise.resolve(); }
    }catch(e){ console.warn('Firebase init error', e); }

    try{ db = firebase.firestore(); } catch(e){ db=null; }
    try{ storage = firebase.storage(); } catch(e){ storage=null; }
    try{ fn = firebase.app().functions('us-central1'); } catch(e){ try{ fn = firebase.functions(); }catch(_){ fn=null; } }
  } else {
    window.__waitAuth = Promise.resolve();
    window.__waitAppCheck = Promise.resolve();
  }
const $  = (s,p=document)=>p.querySelector(s);
  const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
  const todayIso = ()=> new Date().toISOString().slice(0,10);
  const fmtDate  = d => d ? (asDate(d, false))?.toLocaleDateString('ar-OM') : '';
// âœ… Ø¯Ø§Ù„Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±Ù‘ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù
function checkDeletePin() {
  // Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙŠÙ…ÙƒÙ† ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
  const REQUIRED_PIN = '998080';
  const input = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù:');
  if (input !== REQUIRED_PIN) {
    alert('Ø±Ù‚Ù… Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­');
    return false;
  }
  return true;
}


  // Robust month helpers
  const startOfMonth = (y,m)=> new Date(Date.UTC(y, m-1, 1));
  const endOfMonth   = (y,m)=> new Date(Date.UTC(y, m, 0, 23,59,59));
  const prevMonthEnd = (y,m)=> (m===1? endOfMonth(y-1,12) : endOfMonth(y, m-1));

// Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© asDate Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©
const asDate = (v, end = false) => {
  if (!v) return null;
  try {
    let d;
    // Firestore Timestamp
    if (typeof v?.toDate === 'function') d = v.toDate();
    else if (typeof v?.seconds === 'number') d = new Date(v.seconds * 1000);
    else if (v instanceof Date) d = v;
    else {
      const s = String(v).trim();

      // YYYY-MM-DD
      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) {
        return new Date(Date.UTC(+m[1], +m[2] - 1, +m[3],
          end ? 23 : 0, end ? 59 : 0, end ? 59 : 0, end ? 999 : 0));
      }

      // YYYY/MM/DD or YYYY-M-D
      m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
      if (m) {
        const yy = +m[1], mm = +m[2], dd = +m[3];
        if (mm >= 1 && mm <= 12 && dd >= 1 && dd <= 31) {
          return new Date(Date.UTC(yy, mm - 1, dd,
            end ? 23 : 0, end ? 59 : 0, end ? 59 : 0, end ? 999 : 0));
        }
      }

      // MM/DD/YYYY or DD/MM/YYYY (and '-' separator)
      m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if (m) {
        const a = +m[1], b = +m[2], yy = +m[3];
        let mm, dd;

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ø­Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠÙ† Ø£ÙƒØ¨Ø± Ù…Ù† 12 Ù†Ø­Ø¯Ø¯ Ø§Ù„ØªØ±ØªÙŠØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        if (b > 12 && a <= 12) { mm = a; dd = b; }      // MM/DD
        else if (a > 12 && b <= 12) { dd = a; mm = b; } // DD/MM
        else { mm = a; dd = b; }                        // Ø§ÙØªØ±Ø§Ø¶ÙŠ: MM/DD

        if (mm >= 1 && mm <= 12 && dd >= 1 && dd <= 31) {
          return new Date(Date.UTC(yy, mm - 1, dd,
            end ? 23 : 0, end ? 59 : 0, end ? 59 : 0, end ? 999 : 0));
        }
      }

      return null;
    }

    // Ù…Ù‡Ù…: Ø®ÙØ° Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ø´Ù‡Ø±/Ø§Ù„Ø³Ù†Ø© Ø¨Ø§Ù„Ù…Ø­Ù„ÙŠØŒ Ø«Ù… Ø§Ø¨Ù†Ù ØªØ§Ø±ÙŠØ® UTC Ù…Ù†Ù‘Ù‡Ø§ (Ø¨Ø¯ÙˆÙ† Ø§Ù†Ø²ÙŠØ§Ø­)
    const y = d.getFullYear(), m2 = d.getMonth(), day = d.getDate();
    return new Date(Date.UTC(y, m2, day, end ? 23 : 0, end ? 59 : 0, end ? 59 : 0, end ? 999 : 0));
  } catch {
    return null;
  }
};


// Ø§Ø³ØªØ®Ø¯Ù… ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ ||
const isActiveDuring = (s, e, ms, me) => {
  const sd0 = asDate(s, false), ed0 = asDate(e, true);
  const sd  = (sd0 instanceof Date && !isNaN(sd0.getTime())) ? sd0 : new Date(0);
  const ed  = (ed0 instanceof Date && !isNaN(ed0.getTime())) ? ed0 : new Date('9999-12-31T23:59:59.999Z');
  return sd <= me && ed >= ms;  // Ø´Ø§Ù…Ù„ Ù„Ø¢Ø®Ø± ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø´Ù‡Ø±
};



  const num   = v => Number(v||0);
  const ymKey = (y,m)=> String(y).padStart(4,'0') + '-' + String(m).padStart(2,'0');

  const monthsSinceStartIncl = (startY, startM, y, m)=> (y*12+m) - (startY*12+startM) + 1;

  const FB_REAL = {
    listBuildings: async()=> { await (window.__waitAuth||Promise.resolve()); const snap = await db.collection('buildings').get(); return snap.docs.map(d=>({id:d.id, ...d.data()})); },
    createBuilding: async(data)=> { await (window.__waitAuth||Promise.resolve()); return (await db.collection('buildings').add(data)).id },
    updateBuilding: async(id,patch)=> { await (window.__waitAuth||Promise.resolve()); return db.collection('buildings').doc(id).update(patch) },
    removeBuilding: async(id)=> { await (window.__waitAuth||Promise.resolve()); return db.collection('buildings').doc(id).delete() },
    listTenants: async(bid)=> { await (window.__waitAuth||Promise.resolve()); const snap = await db.collection('buildings').doc(bid).collection('tenants').get(); return snap.docs.map(d=>({id:d.id, ...d.data()})); },
    addTenant: async(bid,data)=> { await (window.__waitAuth||Promise.resolve()); return (await db.collection('buildings').doc(bid).collection('tenants').add(data)).id },
    updateTenant: async(bid,id,patch)=> { await (window.__waitAuth||Promise.resolve()); return db.collection('buildings').doc(bid).collection('tenants').doc(id).update(patch); },
    deleteTenant: async(bid,id)=> { await (window.__waitAuth||Promise.resolve()); return db.collection('buildings').doc(bid).collection('tenants').doc(id).delete(); },
    listExpenses: async(bid)=> (await db.collection('buildings').doc(bid).collection('expenses').get()).docs.map(d=>({id:d.id, ...d.data()})),
    addExpense: async(bid,data)=> (await db.collection('buildings').doc(bid).collection('expenses').add(data)).id,
    updateExpense: async(bid,id,patch)=> db.collection('buildings').doc(bid).collection('expenses').doc(id).update(patch),
    deleteExpense: async(bid,id)=> db.collection('buildings').doc(bid).collection('expenses').doc(id).delete(),

  // ========== Attachments (per expense) ==========
  listExpenseAttachments: async (bid, expenseId) => {
    const snap = await db.collection('buildings').doc(bid)
      .collection('expenses').doc(expenseId)
      .collection('attachments').orderBy('uploadedAt', 'desc').get();
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  },

  addExpenseAttachment: async (bid, expenseId, file, meta = {}) => {
    const safe = (file && file.name ? file.name : 'file').replace(/[^\w.\-]+/g, '_');
    const path = `buildings/${bid}/expenses/${expenseId}/attachments/${Date.now()}_${safe}`;

    let url = '';
    try{
      const ref = storage.ref().child(path);
      await ref.put(file);
      url = await ref.getDownloadURL();
    }catch(err){
      console.warn('Storage upload failed', err);
    }

    const doc = clean({
      name: meta.displayName || file.name,
      displayName: meta.displayName || '',
      originalName: file.name,
      size: file.size || 0,
      mime: file.type || '',
      path,
      url,
      uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    await db.collection('buildings').doc(bid)
      .collection('expenses').doc(expenseId)
      .collection('attachments').add(doc);

    // Keep a quick counter on the expense doc
    await db.collection('buildings').doc(bid)
      .collection('expenses').doc(expenseId)
      .set({ attachmentsCount: firebase.firestore.FieldValue.increment(1) }, { merge: true });
  },

  deleteExpenseAttachment: async (bid, expenseId, attId, storagePath) => {
    try{
      if(storagePath) await storage.ref().child(storagePath).delete();
    }catch(err){
      console.warn('Storage delete failed', err);
    }

    await db.collection('buildings').doc(bid)
      .collection('expenses').doc(expenseId)
      .collection('attachments').doc(attId).delete();

    await db.collection('buildings').doc(bid)
      .collection('expenses').doc(expenseId)
      .set({ attachmentsCount: firebase.firestore.FieldValue.increment(-1) }, { merge: true });
  },

// ========== Attachments (per building) ==========
listAttachments: async (bid) => {
  const snap = await db
    .collection('buildings').doc(bid)
    .collection('attachments')
    .orderBy('uploadedAt', 'desc')
    .get();
  return snap.docs.map(d => ({ id: d.id, ...(d.data()||{}) }));
},

addAttachment: async (bid, file, note='') => {
  const safeName = String(file.name||'file').replace(/\s+/g,'_');
  const path     = `buildings/${bid}/attachments/${Date.now()}_${safeName}`;
  const ref      = storage.ref().child(path);
  await (window.__waitAuth||Promise.resolve()); await (window.__waitAppCheck||Promise.resolve()); await ref.put(file, { contentType: file.type || 'application/octet-stream' });
  const url = await ref.getDownloadURL();

  const doc = {
    name: file.name, size: file.size, type: file.type || 'file',
    path, url, note,
    uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  await db.collection('buildings').doc(bid)
          .collection('attachments').add(doc);
},

deleteAttachment: async (bid, docId, path) => {
  try { await storage.ref().child(path).delete(); } catch(e) { /* ignore */ }
  await db.collection('buildings').doc(bid)
          .collection('attachments').doc(docId).delete();
},
// ===============================================

  };

  const FB_DEMO = {
    listBuildings : (...a)=> DemoStore.listBuildings(...a),
    createBuilding: (...a)=> DemoStore.createBuilding(...a),
    updateBuilding: (...a)=> DemoStore.updateBuilding(...a),
    removeBuilding: (...a)=> DemoStore.removeBuilding(...a),

    listTenants: (...a)=> DemoStore.listTenants(...a),
    addTenant  : (...a)=> DemoStore.addTenant(...a),
    updateTenant:(...a)=> DemoStore.updateTenant(...a),
    deleteTenant:(...a)=> DemoStore.deleteTenant(...a),

    listExpenses:(...a)=> DemoStore.listExpenses(...a),
    addExpense  :( ...a)=> DemoStore.addExpense(...a),
    updateExpense:(...a)=> DemoStore.updateExpense(...a),
    deleteExpense:(...a)=> DemoStore.deleteExpense(...a),

    listAttachments:(...a)=> DemoStore.listAttachments(...a),
    addAttachment :( ...a)=> DemoStore.addAttachment(...a),
    deleteAttachment:(...a)=> DemoStore.deleteAttachment(...a)
  };

  const FB = DEMO_MODE ? FB_DEMO : FB_REAL;


  const UI = {
  openModal(title, html){
    $('#modalTitle').textContent = title||'';
    $('#modalBody').innerHTML = html||'';
    $('#modalWrap').classList.add('show');
    $('#modalWrap').setAttribute('aria-hidden','false');
  },
  closeModal(){
    $('#modalWrap').classList.remove('show');
    $('#modalBody').innerHTML='';
    $('#modalWrap').setAttribute('aria-hidden','true');
  },

  toast(msg){ alert(msg); },

  confirm(msg){ return window.confirm(msg); },

  // Helpers
  escape(s){
    return String(s ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  },
  escapeAttr(s){ return UI.escape(s); },

  todayISO(){
    // Local date (not UTC) for <input type="date">
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0,10);
  },

  dateISO(v){
    if(!v) return '';
    try{
      // Firestore Timestamp
      if (typeof v.toDate === 'function') return v.toDate().toISOString().slice(0,10);
      // JS Date
      if (v instanceof Date) return v.toISOString().slice(0,10);
      // ISO string or number
      const d = new Date(v);
      if (isNaN(d.getTime())) return '';
      return d.toISOString().slice(0,10);
    }catch(e){ return ''; }
  },

  money(n){
    const x = Number(n || 0);
    if (!isFinite(x)) return '0.000';
    return x.toFixed(3);
  }
};

  $('#modalWrap').addEventListener('click', (e)=>{ if(e.target.matches('[data-close]')) UI.closeModal(); });

  // Sorting helpers (fixed Arabic digits regex)
  const normalizeDigits = (s) => String(s).replace(/[\u0660-\u0669\u06F0-\u06F9]/g, d => {
    const code = d.charCodeAt(0);
    const base = (code >= 0x06F0) ? 0x06F0 : 0x0660;
    return String(code - base);
  });
  const naturalKey = (val) => {
    const s = normalizeDigits(val || '');
    const parts = s.match(/\d+|\D+/g) || [];
    return parts.map(p => /^\d+$/.test(p) ? parseInt(p, 10) : p.trim().toLowerCase());
  };
  const cmpNatural = (a, b) => {
    const ka = naturalKey(a), kb = naturalKey(b);
    const n = Math.max(ka.length, kb.length);
    for (let i = 0; i < n; i++) {
      const xa = ka[i], xb = kb[i];
      if (xa === undefined) return -1;
      if (xb === undefined) return 1;
      const na = typeof xa === 'number', nb = typeof xb === 'number';
      if (na && nb) { if (xa !== xb) return xa - xb; }
      else { const sa = String(xa), sb = String(xb); if (sa !== sb) return sa.localeCompare(sb, 'ar'); }
    }
    return 0;
  };

  const Render = {
    populateYM(){
      const ys = $('#yearSel'), ms = $('#monthSel');
      ys.innerHTML=''; ms.innerHTML='';
      for(let y=2018; y<=2036; y++){ const o=document.createElement('option'); o.value=y; o.textContent=y; if(y===State.selYear) o.selected=true; ys.appendChild(o); }
      const months = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
      months.forEach((nm,i)=>{ const o=document.createElement('option'); o.value=i+1; o.textContent=nm; if(i+1===State.selMonth) o.selected=true; ms.appendChild(o); });
      ys.onchange = ()=>{ State.selYear = Number(ys.value); Render.dashboard(); if(State.activeBuildingId) Render.building(); };
      ms.onchange = ()=>{ State.selMonth= Number(ms.value); Render.dashboard(); if(State.activeBuildingId) Render.building(); };
    },
applyBizVisibility(){
  const isOwners = (State.bizTab === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
  // KPIs (top): in Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ show only expenses
  const incStat = document.getElementById('kpiIncome')?.closest('.stat');
  const netStat = document.getElementById('kpiNet')?.closest('.stat');
  const expStat = document.getElementById('kpiExpenses')?.closest('.stat');
  if (incStat) incStat.style.display = isOwners ? 'none' : '';
  if (netStat) netStat.style.display = isOwners ? 'none' : '';
  if (expStat) expStat.style.display = '';

  // Dashboard search (remove in Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ)
  const topbar = document.getElementById('bizSearchInput')?.closest('.topbar');
  const inp = document.getElementById('bizSearchInput');
  if (topbar) topbar.style.display = isOwners ? 'none' : '';
  if (inp){
    if (isOwners){
      inp.value = '';
      inp.disabled = true;
      State.bizSearchQuery = '';
    } else {
      inp.disabled = false;
    }
  }

  // Building view: hide revenue/net, unit KPIs, and search/filters in Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ
  const revGrid  = document.getElementById('bkIncome')?.closest('.grid');
  const unitGrid = document.getElementById('stTotal')?.closest('.grid');
  const filters  = document.getElementById('searchBox')?.closest('.filters');
  if (revGrid) revGrid.style.display = isOwners ? 'none' : '';
  if (unitGrid) unitGrid.style.display = isOwners ? 'none' : '';
  if (filters) {
    filters.style.display = isOwners ? 'none' : '';
    if (isOwners){
      const sb = document.getElementById('searchBox');
      if (sb) sb.value = '';
      // reset chips state so no hidden filtering remains
      State.chipsState = { kind:'all', status:null };
      // reset active chips UI
      document.querySelectorAll('.filters .chip').forEach(c=>c.classList.remove('active'));
      const allChip = document.querySelector('.filters .chip[data-ft="all"]');
      if (allChip) allChip.classList.add('active');
    }
  }

  // Building view: hide units list card in Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ
  const unitsCard = document.getElementById('unitsList')?.closest('.card');
  const cardsGrid = document.getElementById('unitsList')?.closest('.grid');
  if (unitsCard) unitsCard.style.display = isOwners ? 'none' : '';
  if (cardsGrid) cardsGrid.style.gridTemplateColumns = isOwners ? '1fr' : '';

},

    syncBizTabsActive(){
      const tabs = document.getElementById("bizTabs");
      if (!tabs) return;
      const biz = State.bizTab || "Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ";
      tabs.querySelectorAll('.chip[data-biz]').forEach(c=>{
        c.classList.toggle("active", (c.getAttribute("data-biz")||"") === biz);
      });
    },



    async dashboard(){
      $('#view-dashboard').classList.remove('hidden');
      $('#view-building').classList.add('hidden');
      Render.applyBizVisibility();
      Render.syncBizTabsActive();
      const grid = $('#buildingsGrid'); grid.innerHTML='';

      const tabs = $('#bizTabs');
      tabs.onclick = (e)=>{
        const chip = e.target.closest('.chip[data-biz]'); if(!chip) return;
        $$('#bizTabs .chip').forEach(c=>c.classList.remove('active'));
        chip.classList.add('active');
        State.bizTab = chip.getAttribute('data-biz') || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ';
        __saveBiz(State.bizTab);
        Render.dashboard();
};
      const inp = $('#bizSearchInput'); let tmo;
      inp.oninput = ()=>{ clearTimeout(tmo); tmo = setTimeout(()=>{ State.bizSearchQuery = inp.value || ''; Render.dashboard(); }, 150); };

      try{
        const buildings = await FB.listBuildings();
        State.cachedBuildings = buildings;
    // âœ… Ù„Ùˆ ÙÙŠ Ø±Ù‚Ù… Ù…Ø¨Ù†Ù‰ Ù…Ø­ÙÙˆØ¸ Ù…Ù† Ù†Ù‚Ø±Ø© Ø³Ø§Ø¨Ù‚Ø©ØŒ Ø§ÙØªØ­Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
    const autoId = localStorage.getItem('autoOpenBuildingId');
    if (autoId) {
      localStorage.removeItem('autoOpenBuildingId'); // Ø­ØªÙ‰ Ù„Ø§ Ù†Ø¯Ø®Ù„ ÙÙŠ Ø­Ù„Ù‚Ø© Ù„Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ©
      const target = buildings.find(b => b.id === autoId);
      if (target) {
        State.activeBuildingId = target.id;
        await Render.building();   // Ø§ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø¨Ù†Ù‰ Ù…Ø¨Ø§Ø´Ø±Ø©
        return;                    // Ù„Ø§ ØªÙƒÙ…Ù„ Ø±Ø³Ù… Ù„ÙˆØ­Ø© "Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ"
      }
    }

        // Update counts on tabs
        const cAdmin = buildings.filter(b => normBiz(b.bizType || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ') === 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ').length;
        const cOwners = buildings.filter(b => (b.bizType || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ') === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ').length;
        const cVal = buildings.filter(b => (b.bizType || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ') === 'ØªØ«Ù…ÙŠÙ†').length;
        const adminChip = document.querySelector('#bizTabs .chip[data-biz="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ"]');
        const ownersChip = document.querySelector('#bizTabs .chip[data-biz="Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ"]');
        const valChip = document.querySelector('#bizTabs .chip[data-biz="ØªØ«Ù…ÙŠÙ†"]');
        if (adminChip) adminChip.textContent = `ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ (${cAdmin})`;
        if (ownersChip) ownersChip.textContent = `ğŸ‘¥ Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ (${cOwners})`;
        if (valChip) valChip.textContent = `ğŸ’ ØªØ«Ù…ÙŠÙ† (${cVal})`;
        Render.syncBizTabsActive();

        let filtered = buildings.filter(b => normBiz(b.bizType || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ') === normBiz(State.bizTab));
        const q = (State.bizSearchQuery||'').trim().toLowerCase();
        if(q){ filtered = filtered.filter(b => ( ((b.name||'')+' '+(b.owner||'')+' '+(b.location||'')+' '+(b.contact||'')).toLowerCase().includes(q) )); }

        // Dynamic labels for current business type
        const isValTab = (State.bizTab === 'ØªØ«Ù…ÙŠÙ†');
        const entitySing = isValTab ? 'Ø¨Ù†Ùƒ' : 'Ù…Ø¨Ù†Ù‰';
        const entityPlural = isValTab ? 'Ø¨Ù†ÙˆÙƒ' : 'Ù…Ø¨Ø§Ù†Ù';
        const dashTitle = document.getElementById('dashTitle');
        if (dashTitle) dashTitle.textContent = isValTab ? 'Ø§Ù„Ø¨Ù†ÙˆÙƒ' : 'Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ';
        const addB = document.getElementById('btnAddBuilding');
        if (addB) addB.textContent = 'â• ' + entitySing;
        const emptyCard = document.querySelector('#emptyBuildings .card-c');
        const titleTxt = isValTab ? 'Ø§Ù„Ø¨Ù†ÙˆÙƒ' : 'Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ';
        if (emptyCard) emptyCard.textContent = `Ù„Ø§ ÙŠÙˆØ¬Ø¯ ${entityPlural} â€” Ø£Ø¶Ù ${entitySing} Ù…Ù† Ø²Ø± (â• ${entitySing}) Ø¨Ø¬Ø§Ù†Ø¨ ÙƒÙ„Ù…Ø© ${titleTxt}.`;
        if (inp) inp.placeholder = isValTab ? 'Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ø²Ø¨ÙˆÙ† / Ø§Ù„Ù…ÙˆÙ‚Ø¹' : 'Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ù…ÙˆÙ‚Ø¹';
        const valActions = document.getElementById('valInlineActions');
        if (valActions) valActions.style.display = isValTab ? 'flex' : 'none';
        const oaActions = document.getElementById('oaInlineActions');
        if (oaActions) oaActions.style.display = (State.bizTab === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ') ? 'flex' : 'none';

        $('#emptyBuildings').style.display = filtered.length ? 'none' : 'block';

        filtered.forEach(b=>{
          const counts = b.counts || {apartments:Number(b.apartments||0),shops:Number(b.shops||0),showrooms:Number(b.showrooms||0),basements:Number(b.basements||0)};
          const card = document.createElement('div');
          card.className = 'icon-card';
          const biz = (b.bizType || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
          const icon = biz === 'ØªØ«Ù…ÙŠÙ†' ? 'ğŸ¦' : (biz === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ' ? 'ğŸ˜ï¸' : 'ğŸ¢');
          const ownerLabel = biz === 'ØªØ«Ù…ÙŠÙ†' ? 'ğŸ‘¤ Ø§Ù„Ø²Ø¨ÙˆÙ†: ' : 'ğŸ‘¤ Ø§Ù„Ù…Ø§Ù„Ùƒ: ';
          const addPersonLabel = biz === 'ØªØ«Ù…ÙŠÙ†' ? 'Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ†' : (biz === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ' ? 'Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ù„Ùƒ' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ£Ø¬Ø±');
          card.innerHTML = `
            <div class="circle">${icon}</div>
            <div style="font-weight:700">${b.name||''}</div>
${ (b.buildingImage || b.imageData || b.imageUrl) ? `<img src="${b.buildingImage || b.imageData || b.imageUrl}" alt="" style="width:100%;max-height:120px;object-fit:cover;border-radius:14px;border:1px solid var(--border);margin-top:8px">` : '' }
            ${(biz==='ØªØ«Ù…ÙŠÙ†' && b.owner) ? `<div class="muted" style="font-size:12px">${ownerLabel + b.owner}</div>` : ''}
            <div class="muted" style="font-size:12px">${b.location? 'ğŸ“ '+b.location : ''}</div>
            ${(biz==='ØªØ«Ù…ÙŠÙ†' && b.contact) ? `<div class="muted" style="font-size:12px">${'â˜ï¸ '+b.contact}</div>` : ''}
            ${b.notes? `<div class="muted" style="font-size:12px">${b.notes}</div>`:''}
            <div class="muted" style="font-size:12px">
              Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${(Number(counts.apartments||0)+Number(counts.shops||0)+Number(counts.showrooms||0)+Number(counts.basements||0)) || 0}
            </div>
            <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
              <button type="button" class="btn" data-act="open">ÙØªØ­</button>
              <button type="button" class="btn" data-act="addTenant">${addPersonLabel}</button>
              <button type="button" class="btn" data-act="edit">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
              <button type="button" class="btn danger admin-only" data-act="delete">Ø­Ø°Ù</button>
            </div>`;
card.addEventListener('click', async (e)=>{
  const btn = e.target.closest('[data-act]'); if(!btn) return;

  if (btn.dataset.act === 'open') {
    // Ø§ÙØªØ­ Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© (ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±)
    State.activeBuildingId = b.id;
    __saveBiz(State.bizTab);
    await Render.building();
  }
  else if (btn.dataset.act === 'addTenant') {
    State.activeBuildingId = b.id;
    Actions.openAddTenant();
  }
  else if (btn.dataset.act === 'edit') {
    Actions.openEditBuilding(b);
  }
  else if (btn.dataset.act === 'delete') {
    if (!checkDeletePin()) return;
    const entity = ((normBiz(b.bizType)||'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ')==='ØªØ«Ù…ÙŠÙ†') ? 'Ø§Ù„Ø¨Ù†Ùƒ' : 'Ø§Ù„Ù…Ø¨Ù†Ù‰';
                if (UI.confirm('Ø­Ø°Ù ' + entity + 'ØŸ')) {
      await FB.removeBuilding(b.id);
      Render.dashboard();
    }
  }
});

          grid.appendChild(card);
        });

        // KPIs (global)
        let income=0, expenses=0;
        const ownersOnly = (State.bizTab === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
        const ms = startOfMonth(State.selYear, State.selMonth);
        const me = endOfMonth(State.selYear, State.selMonth);
        for(const b of buildings){
          if(!ownersOnly){
    const tenants = await FB.listTenants(b.id);
            const activeTenants = tenants.filter(t=> isActiveDuring(t.startDate, t.endDate, ms, me));
            // exclude grace-period months from income
            const incT = activeTenants.filter(t=>{
              const sd = new Date(t.startDate);
              const mSince = monthsSinceStartIncl(sd.getUTCFullYear(), sd.getUTCMonth()+1, State.selYear, State.selMonth);
              return !(t.graceEnabled && Number(t.graceMonths||0) >= mSince);
            }).reduce((s,t)=> s + num(t.rent), 0);
            income += incT;

          }
  const exps = await FB.listExpenses(b.id);
          expenses += exps.filter(e=>{ const d=asDate(e.date,false); return (d instanceof Date && !isNaN(d.getTime()) && d>=ms && d<=me); }).reduce((s,e)=> s + num(e.amount), 0);
        }
        $('#kpiIncome').textContent = income.toFixed(2);
        $('#kpiExpenses').textContent = expenses.toFixed(2);
        $('#kpiNet').textContent = (income-expenses).toFixed(2);
      }catch(err){
        console.error(err);
        $('#emptyBuildings').style.display='block';
        $('#emptyBuildings .card-c').textContent='ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ.';
      }
    },

    async building(){
      $('#view-dashboard').classList.add('hidden');
      $('#view-building').classList.remove('hidden');

      let b = null;
      if (DEMO_MODE) {
        b = (DemoStore.getBuilding(State.activeBuildingId) || { id: State.activeBuildingId });
      } else {
        const ref = await firebase.firestore().collection('buildings').doc(State.activeBuildingId).get();
        b = { id: ref.id, ...(ref.data()||{}) };
      }

      const bizType = normBiz(b.bizType || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
      State.bizTab = bizType;
      __saveBiz(State.bizTab);
      Render.applyBizVisibility();
      const isOA = (bizType === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
      const isVal = (bizType === 'ØªØ«Ù…ÙŠÙ†');
      const tSing = isVal ? 'Ø²Ø¨ÙˆÙ†' : (isOA ? 'Ù…Ø§Ù„Ùƒ' : 'Ù…Ø³ØªØ£Ø¬Ø±');
      const tDef  = isVal ? 'Ø§Ù„Ø²Ø¨ÙˆÙ†' : (isOA ? 'Ø§Ù„Ù…Ø§Ù„Ùƒ' : 'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±');
      const tPlural = isVal ? 'Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†' : (isOA ? 'Ø§Ù„Ù…Ù„Ø§Ùƒ' : 'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙˆÙ†');
      const tImport = isVal ? 'ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø²Ø¨Ø§Ø¦Ù† (CSV)' : (isOA ? 'ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ø§Ùƒ (CSV)' : 'ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† (CSV)');
      const addBtn = document.getElementById('btnAddTenant'); if (addBtn) addBtn.textContent = 'â• Ø¥Ø¶Ø§ÙØ© ' + tSing;
      const impBtn = document.getElementById('btnImportCSV'); if (impBtn) impBtn.textContent = tImport;
      const editB = document.getElementById('btnEditBuilding'); if (editB) editB.textContent = (isVal ? 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ù†Ùƒ' : 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ù†Ù‰');
          const mbtn = document.getElementById('btnMaintReport');
          if (mbtn) mbtn.onclick = () => Actions.openMaintenanceAnnualReport();
      const tenantsHeaderEl = document.querySelector('#view-building .grid.cols-2 .card:nth-child(2) .card-h b');
      if (tenantsHeaderEl) tenantsHeaderEl.textContent = tPlural;

      $('#buildingTitle').textContent = b.name || '';
      const bizNow = normBiz(b.bizType || State.bizTab || State.bizTab);
      $('#buildingMeta').innerHTML = [
        (bizNow==='ØªØ«Ù…ÙŠÙ†' && b.owner)? `ğŸ‘¤ <span>${b.owner}</span>` : '',
        b.location? `ğŸ“ <span>${b.location}</span>` : '',
        (bizNow==='ØªØ«Ù…ÙŠÙ†' && b.contact)? `â˜ï¸ <span>${b.contact}</span>` : '',
        b.notes? `ğŸ“ <span>${b.notes}</span>` : '',
        b.electricAccount? `âš¡ <span>${b.electricAccount}</span>` : '',
        b.internetNumber? `ğŸŒ <span>${b.internetNumber}</span>` : '',
        b.guardPhone? `ğŸ‘® <span>${b.guardPhone}</span>` : '',
        b.sewageTruckPhone? `ğŸš› <span>${b.sewageTruckPhone}</span>` : '',
        (b.buildingImage || b.imageData || b.imageUrl) ? `ğŸ–¼ï¸ <span style="display:block;flex:1 1 100%"><img src="${b.buildingImage || b.imageData || b.imageUrl}" style="width:100%;max-width:520px;max-height:220px;object-fit:cover;border-radius:14px;border:1px solid var(--border)"></span>` : '',
        (b.coordsLink || b.mapLink || b.coordinates) ? `ğŸ—ºï¸ <a href="${b.coordsLink || b.mapLink || b.coordinates}" target="_blank" rel="noopener">Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹ Google Maps</a>` : '',
        b.totalArea? `ğŸ“ <span>Ø§Ù„Ù…Ø³Ø§Ø­Ø©: ${b.totalArea}</span>` : '',
        b.waterAccount? `ğŸ’§ <span>Ø§Ù„Ù…ÙŠØ§Ù‡: ${b.waterAccount}</span>` : '',
        b.bankAccount? `ğŸ¦ <span>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ: ${b.bankAccount}</span>` : '',
        b.guardName? `ğŸ‘® <span>Ø§Ù„Ø­Ø§Ø±Ø³: ${b.guardName}</span>` : '',
      ].filter(Boolean).map(x=>`<div>${x}</div>`).join('');

      const ms = startOfMonth(State.selYear, State.selMonth);
      const me = endOfMonth(State.selYear, State.selMonth);
      const tenantsAll = await FB.listTenants(b.id);
      let tenants = tenantsAll.filter(t=> isActiveDuring(t.startDate, t.endDate, ms, me));
      const expensesAll = await FB.listExpenses(b.id);
      const expenses = expensesAll.filter(e=>{ const d=asDate(e.date,false); return (d instanceof Date && !isNaN(d.getTime()) && d>=ms && d<=me); });

      // ===== Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ: Ø±Ø³Ù… Ø¨Ø§ÙŠ ØªØ´Ø§Ø±Øª (Ø¯ÙØ¹ÙˆØ§ / Ù„Ù… ÙŠØ¯ÙØ¹ÙˆØ§) =====
      (function updateOaPaymentChart(){
        const wrap = document.getElementById('oaPaymentChartWrap');
        if(!wrap) return;
        if(!isOA){ wrap.style.display='none'; return; }
        const ym = ymKey(State.selYear, State.selMonth);
        const paid = (tenants||[]).filter(t => t && t.payments && t.payments[ym] && String(t.payments[ym]).trim()).length;
        const unpaid = Math.max(0, (tenants||[]).length - paid);
        const paidEl = document.getElementById('oaPaidCount');
        const unpdEl = document.getElementById('oaUnpaidCount');
        if(paidEl) paidEl.textContent = String(paid);
        if(unpdEl) unpdEl.textContent = String(unpaid);
        wrap.style.display = '';

        const canvas = document.getElementById('oaPaymentChart');
        if(!canvas || !window.Chart) return;
        try{ if(window.__oaPayChart){ window.__oaPayChart.destroy(); window.__oaPayChart = null; } }catch(e){}
        const css = getComputedStyle(document.documentElement);
        // Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¨Ø§ÙŠ ØªØ´Ø§Ø±Øª Ø­Ø³Ø¨ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±:
        // - Ø¯ÙØ¹ÙˆØ§ = Ù„ÙˆÙ† Ø²Ø± (Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ù„Ùƒ) (teal gradient)
        // - Ù„Ù… ÙŠØ¯ÙØ¹ÙˆØ§ = Ù„ÙˆÙ† Ø²Ø± (Ø­Ø°Ù Ø§Ù„Ù…Ø¨Ù†Ù‰) (redâ†’orange gradient)
        const ctx2d = canvas.getContext('2d');
        const accent = (css.getPropertyValue('--accent') || '#0bb8b2').trim();
        const danger = (css.getPropertyValue('--danger') || '#ef4444').trim();

        // Gradient Ù…Ø´Ø§Ø¨Ù‡ Ù„Ø²Ø± "Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ù„Ùƒ"
        const gradPaid = ctx2d.createLinearGradient(0, 0, canvas.width || 320, canvas.height || 200);
        gradPaid.addColorStop(0, accent);
        gradPaid.addColorStop(1, '#22d3ee');

        // Gradient Ù…Ø´Ø§Ø¨Ù‡ Ù„Ø²Ø± "Ø­Ø°Ù Ø§Ù„Ù…Ø¨Ù†Ù‰"
        const gradUnpd = ctx2d.createLinearGradient(0, 0, canvas.width || 320, canvas.height || 200);
        gradUnpd.addColorStop(0, danger);
        gradUnpd.addColorStop(1, '#f97316');

        window.__oaPayChart = new Chart(canvas, {
          type:'pie',
          data:{
            labels:['Ø¯ÙØ¹ÙˆØ§','Ù„Ù… ÙŠØ¯ÙØ¹ÙˆØ§'],
            datasets:[{ data:[paid, unpaid], backgroundColor:[gradPaid, gradUnpd], borderWidth:0 }]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{ legend:{ position:'bottom' } }
          }
        });
      })();

      // compute total units and stats
      const counts = b.counts || {apartments:Number(b.apartments||0),shops:Number(b.shops||0),showrooms:Number(b.showrooms||0),basements:Number(b.basements||0)};
      const totalUnits = (counts.apartments||0) + (counts.shops||0) + (counts.showrooms||0) + (counts.basements||0);

      // Sorting for tenants
      function normalizeDigits2(s) {
        return String(s||'').replace(/[\u0660-\u0669\u06F0-\u06F9]/g, d => {
          const code = d.charCodeAt(0);
          const base = (code >= 0x06F0) ? 0x06F0 : 0x0660;
          return String(code - base);
        });
      }
      function naturalKey2(val){
        const s = normalizeDigits2(val||'');
        const parts = s.match(/\d+|\D+/g) || [];
        return parts.map(p => /^\d+$/.test(p) ? parseInt(p,10) : p.trim().toLowerCase());
      }
      function cmpNatural2(a,b){
        const ka = naturalKey2(a), kb = naturalKey2(b);
        const n = Math.max(ka.length, kb.length);
        for(let i=0;i<n;i++){
          const xa = ka[i], xb = kb[i];
          if(xa===undefined) return -1;
          if(xb===undefined) return 1;
          const na = typeof xa==='number', nb = typeof xb==='number';
          if(na && nb){ if(xa!==xb) return xa-xb; }
          else { const sa=String(xa), sb=String(xb); if(sa!==sb) return sa.localeCompare(sb,'ar'); }
        }
        return 0;
      }
      function normKind(k){
        const s = String(k||'').toLowerCase();
        if (/Ø´Ù‚Ø©|apartment/.test(s)) return 'apartment';
        if (/Ù…Ø­Ù„|shop/.test(s))     return 'shop';
        if (/Ù…Ø¹Ø±Ø¶|showroom/.test(s))return 'showroom';
        if (/Ù‚Ø¨Ùˆ|Ù‚Ø¨|basement/.test(s)) return 'basement';
        return 'apartment';
      }
      function unitCore(u){
        return String(u||'').replace(/^\s*(Ø´Ù‚Ø©|Ù…Ø­Ù„|Ù…Ø¹Ø±Ø¶|Ù‚Ø¨Ùˆ)\s*/i,'');
      }

      tenants.sort((a,b)=>{
        const order = {apartment:1, shop:2, showroom:3, basement:4};
        const ka = order[normKind(a && a.kind)] || 99;
        const kb = order[normKind(b && b.kind)] || 99;
        if (ka !== kb) return ka - kb;
        const c  = cmpNatural2(unitCore(a && a.unitNumber), unitCore(b && b.unitNumber));
        if (c) return c;
        const ta = (a && a.tenantName || '').toString().trim();
        const tb = (b && b.tenantName || '').toString().trim();
        return ta.localeCompare(tb, 'ar', {sensitivity:'base', numeric:true});
      });
          // === ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ø¨Ù†Ù‰ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ===

// Ø§Ù„Ø¯Ø®Ù„: Ù…Ø¬Ù…ÙˆØ¹ Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† Ø§Ù„Ù†Ø´ÙØ·ÙŠÙ† Ù…Ø¹ Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø£Ø´Ù‡Ø± Ø§Ù„Ø³Ù…Ø§Ø­
const incomeThisMonth = tenants.reduce((sum, t) => {
  const sd = t.startDate ? new Date(t.startDate) : null;
  const mSince = sd ? monthsSinceStartIncl(sd.getUTCFullYear(), sd.getUTCMonth()+1, State.selYear, State.selMonth) : 0;
  const inGrace = t.graceEnabled && Number(t.graceMonths||0) >= mSince;
  return sum + (inGrace ? 0 : num(t.rent));
}, 0);

// Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: Ù…Ø¬Ø§Ù…ÙŠØ¹ Ù…ØµØ±ÙˆÙØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± (Ù…ØµÙÙˆÙØ© expenses Ù„Ø¯ÙŠÙƒ Ù…ÙØ±Ø´Ù‘Ø­Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§)
const expensesThisMonth = expenses.reduce((s, e) => s + num(e.amount), 0);

// ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ÙƒØ±ÙˆØª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„
const entityLbl = isVal ? 'Ø§Ù„Ø¨Ù†Ùƒ' : 'Ø§Ù„Ù…Ø¨Ù†Ù‰';
const statsCards = document.querySelectorAll('#view-building .grid.cols-3 .stat');
if (statsCards && statsCards.length >= 3) {
  statsCards[0].innerHTML = `Ø¥ÙŠØ±Ø§Ø¯ ${entityLbl} (Ø§Ù„Ø´Ù‡Ø±): <b id="bkIncome">0</b> Ø±.Ø¹`;
  statsCards[1].innerHTML = `Ù…ØµØ±ÙˆÙØ§Øª ${entityLbl} (Ø§Ù„Ø´Ù‡Ø±): <b id="bkExpenses">0</b> Ø±.Ø¹`;
  statsCards[2].innerHTML = `Ø§Ù„ØµØ§ÙÙŠ (Ø§Ù„Ø´Ù‡Ø±): <b id="bkNet">0</b> Ø±.Ø¹`;
}

// ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
$('#bkIncome').textContent  = incomeThisMonth.toFixed(2);
$('#bkExpenses').textContent = expensesThisMonth.toFixed(2);
$('#bkNet').textContent     = (incomeThisMonth - expensesThisMonth).toFixed(2);

// Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª
$('#stTotal').textContent = totalUnits;
$('#stApt').textContent   = Number(counts.apartments||0);
$('#stShop').textContent  = Number(counts.shops||0) + Number(counts.showrooms||0);
$('#stOcc').textContent   = tenants.length;
$('#stVac').textContent   = Math.max(0, totalUnits - tenants.length);

// ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ù‹Ø§ (â‰¤ 30 ÙŠÙˆÙ…Ù‹Ø§ Ù…Ù† Ø§Ù„ÙŠÙˆÙ…)
const now = new Date();
const soonLimit = new Date(now.getTime() + 30*24*60*60*1000);
const expSoon = tenants.filter(t => {
  const ed = asDate(t.endDate, true);
  return ed && ed >= now && ed <= soonLimit;
}).length;
$('#stExpSoon').textContent = expSoon;

const searchBoxEl = document.getElementById('searchBox');
if (searchBoxEl) searchBoxEl.oninput = () => renderLists();

function applyFilters(base){
  const q = (searchBoxEl?.value || '').trim().toLowerCase();
        return base.filter(t=>{
          if(State.chipsState.kind!=='all'){
            if(State.chipsState.kind==='shop'){
              if(!(t.kind==='shop' || t.kind==='showroom')) return false;
            } else if(t.kind!==State.chipsState.kind){ return false; }
          }
          const bag = `${t.unitNumber||''} ${t.tenantName||''} ${t.phone||''} ${t.nationalId||''}`.toLowerCase();
          return !q || bag.includes(q);
        });
      }

      function labelKind(kind){ return kind==='apartment'?'Ø´Ù‚Ø©':(kind==='shop'?'Ù…Ø­Ù„':(kind==='showroom'?'Ù…Ø¹Ø±Ø¶':'Ù‚Ø¨Ùˆ')); }

      function renderLists(){
        const filtered = applyFilters(tenants);
        const tenantsBox = $('#tenantsList'); tenantsBox.innerHTML='';
        if(!filtered.length){ tenantsBox.innerHTML='<div class="muted">'+(isVal ? 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø¨Ø§Ø¦Ù† Ø­Ø³Ø¨ Ø§Ù„ØªØµÙÙŠØ©.' : (isOA ? 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø§Ùƒ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙÙŠØ©.' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ£Ø¬Ø±ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„ØªØµÙÙŠØ©.'))+'</div>'; }
        filtered.forEach(t=>{
          const row = document.createElement('div');
          row.style.cssText='border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;background:#ecfdf5';
          const natPart = t.nationalId ? (' â€¢ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: '+t.nationalId) : '';
          const ym = ymKey(State.selYear, State.selMonth);
          const paidMark = (t.payments && t.payments[ym]) ? '<span style="color:#22bb33;font-weight:bold;font-size:16px">âœ”ï¸</span>' : '';
          const payNote = (t.payments && t.payments[ym]) ? `<div class="muted" style="font-size:12px;margin-top:4px;color:#1558d6">ğŸ’¬ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø¯ÙØ¹: ${t.payments[ym]}</div>` : '';

          const ptLabel = t.paymentType==='delayed' ? 'Ù…Ø¤Ø®Ø±Ø§Ù‹' : 'Ù…Ù‚Ø¯Ù…Ø§Ù‹';
          const graceLabel = (t.graceEnabled && Number(t.graceMonths||0)>0) ? ` â€¢ ÙØªØ±Ø© Ø³Ù…Ø§Ø­: ${Number(t.graceMonths)} Ø´Ù‡Ø±` : '';
          const unitHtml = isOA ? `<span class=\"muted\">â€” Ø§Ù„ÙˆØ­Ø¯Ø©: <span data-unit>${t.unitNumber||'â€”'}</span>${(t.unitArea?` â€¢ Ø§Ù„Ù…Ø³Ø§Ø­Ø©: <span data-area>${t.unitArea}</span>`:'')}</span>` : `<span class=\"muted\">(<span data-unit>${t.unitNumber||'â€”'}</span>)</span>`;

          row.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
              <div>
                <div style="font-weight:600"><span data-tenant-name>${t.tenantName}</span> ${paidMark} ${unitHtml} <span class="badge success">Ù…Ø´ØºÙˆÙ„Ø©</span></div>
                <div class="muted" style="font-size:12px">${labelKind(t.kind)} â€¢ ${(isOA?'Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©':(isVal?'Ø§Ù„Ø£Ø¬Ø±Ø©':'Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±'))}: <span data-rent>${t.rent}</span> Ø±.Ø¹${(isOA||isVal)?'':` â€¢ Ø§Ù„Ø¯ÙØ¹: ${ptLabel}${graceLabel}`} â€¢ Ù‡Ø§ØªÙ: <span data-phone>${t.phone||'â€”'}</span>${natPart?`<span data-id>${natPart}</span>`:''}</div>
                ${(isOA||isVal)?'':`<div class="muted" style="font-size:12px">Ù…Ù† <span data-start>${fmtDate(t.startDate)}</span> Ø¥Ù„Ù‰ <span data-end>${fmtDate(t.endDate)}</span></div>`}
              </div>
              <div style="display:flex;gap:6px;justify-content:flex-end;align-items:flex-start">
                <div class="tenant-actions" style="display:flex;flex-direction:row;gap:6px;align-items:center;flex-wrap:nowrap">
                  <button type="button" class="btn primary" data-edit>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                  <button type="button" class="btn" data-pay>ğŸ’³ Ø¯ÙØ¹</button>
                  ${isOA ? `
                  <details class="drop" data-docs-drop
                          data-tenant-name="${t.tenantName||t.name||''}"
                          data-unit="${t.unitNumber||t.unit||''}"
                          data-kind="${t.kind||''}"
                          data-phone="${t.phone||''}"
                          data-id="${t.nationalId||t.id||''}"
                          data-unituse="${t.unitUse||''}">
                    <summary class="btn" data-docs>ğŸ“„ Ø¥ØµØ¯Ø§Ø± Ù…Ø³ØªÙ†Ø¯Ø§Øª</summary>
                    <div class="drop-menu">
                      <button type="button" class="drop-item" data-doc-issue="noobj_rent">ğŸ“„ Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… Ù…Ù…Ø§Ù†Ø¹Ø© ØªØ£Ø¬ÙŠØ±</button>
                      <button type="button" class="drop-item" data-doc-issue="noobj_sell">ğŸ“„ Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… Ù…Ù…Ø§Ù†Ø¹Ø© Ø¨ÙŠØ¹</button>
                      <button type="button" class="drop-item" data-doc-issue="undertake_new_owner">ğŸ“„ Ø±Ø³Ø§Ù„Ø© ØªØ¹Ù‡Ø¯ Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯</button>
                      <button type="button" class="drop-item" data-doc-issue="warning">âš ï¸ Ø±Ø³Ø§Ù„Ø© Ø¥Ù†Ø°Ø§Ø±</button>
                    </div>
                  </details>
                  ` : `
                  <button type="button" class="btn" data-receipt
                          data-tenant-name="${t.tenantName||t.name||''}"
                          data-unit="${t.unitNumber||t.unit||''}"
                          data-rent="${t.rent||t.amount||0}"
                          data-kind="${t.kind||''}"
                          data-phone="${t.phone||''}"
                          data-id="${t.nationalId||t.id||''}"
                          data-paydate="${t.payDate||''}">ğŸ§¾ Ø¥ØµØ¯Ø§Ø± Ø¥ÙŠØµØ§Ù„</button>
                  <button type="button" class="btn" data-contract
        data-tenant-name="${t.tenantName||t.name||''}"
        data-unit="${t.unitNumber||t.unit||''}"
        data-rent="${t.rent||t.amount||0}"
        data-kind="${t.kind||''}"
        data-phone="${t.phone||''}"
        data-id="${t.nationalId||t.id||''}"
        data-paydate="${t.payDate||''}"
        data-idimg="${t.nationalIdImageUrl || ''}"
        data-idimg-path="${t.nationalIdImagePath || ''}">ğŸ“ƒ Ø¥ØµØ¯Ø§Ø± Ø¹Ù‚Ø¯</button>
                  `}

                </div>
                <button type="button" class="btn danger admin-only" data-del>ğŸ—‘ï¸ Ø­Ø°Ù</button>
              </div>
            </div>
            ${payNote}
            ${t.notes? `<div class="muted" style="font-size:12px;margin-top:4px">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${t.notes}</div>`:''}
          `;
          // dataset for report
          row.setAttribute('data-tenant-row','');
          row.dataset.unit       = t.unitNumber || '';
          row.dataset.tenantName = t.tenantName || '';
          row.dataset.id         = t.nationalId || '';
          row.dataset.rent       = t.rent || '';
          row.dataset.phone      = t.phone || '';
          row.dataset.start      = t.startDate || '';
          row.dataset.end        = t.endDate || '';
          row.dataset.notes      = (t.payments && t.payments[ym]) ? t.payments[ym] : (t.notes || '');
          row.dataset.kind       = t.kind || '';

          // delete
row.querySelector('[data-del]').onclick = async (ev)=>{
  ev.stopPropagation();
  if(!(window.AuthState && window.AuthState.isAdmin)){ UI.toast('Ø§Ù„Ø­Ø°Ù Ù…ØªØ§Ø­ Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·'); return; }
  if(!UI.confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ ' + tDef + 'ØŸ')) return;

  const mStart = startOfMonth(State.selYear, State.selMonth);
  const pEnd   = prevMonthEnd(State.selYear, State.selMonth);

  if ((asDate(t.startDate) || new Date(0)) < mStart) {
    // ÙƒØ§Ù† Ù†Ø´ÙØ·Ù‹Ø§ Ù‚Ø¨Ù„ Ø¨Ø¯Ø§ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± â‡’ Ù†Ù‚ÙÙ„Ù‡ Ø¨Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚
    await FB.updateTenant(b.id, t.id, { endDate: pEnd.toISOString().slice(0,10) });
  } else {
    // Ø¨Ø¯Ø£ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ø£Ùˆ Ø¨Ø¹Ø¯Ù‡ â‡’ Ù†Ø­Ø°ÙÙ‡ ØªÙ…Ø§Ù…Ù‹Ø§
    await FB.deleteTenant(b.id, t.id);
  }
  Render.building();
};

// pay
// pay
row.querySelector('[data-pay]').onclick = async (ev)=>{
  ev.stopPropagation();
  const ym = ymKey(State.selYear, State.selMonth);

  // Ù…ÙˆÙ„Ù‘Ø¯ Ø±Ù‚Ù… Ø¥ÙŠØµØ§Ù„ Ø¨Ù†ÙØ³ ØµÙŠØºØ© Ø§Ù„Ø¥ÙŠØµØ§Ù„ (YYMMDD + 4 Ø£Ø±Ù‚Ø§Ù…)
  function makeRcNo(){
    const d = new Date();
    const YY = String(d.getFullYear()).slice(-2);
    const MM = String(d.getMonth()+1).padStart(2,'0');
    const DD = String(d.getDate()).padStart(2,'0');
    const rnd = Math.floor(1000 + Math.random()*9000);
    return YY+MM+DD+String(rnd);
  }

  const due = Number(t.rent||0);
  const dueLabel = isOA ? 'Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©' : (isVal ? 'Ø§Ù„Ø£Ø¬Ø±Ø©' : 'Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±');

  UI.openModal('ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹', `
    <div class="grid cols-2">
      <div>
        <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø±.Ø¹)</label>
        <input id="payAmount" type="number" step="0.001" placeholder="0.000">
      </div>
      <div>
        <label>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„</label>
        <input id="payRcNo" placeholder="Ù…Ø«Ø§Ù„: ${makeRcNo()}">
      </div>

      <div style="grid-column:1/-1" class="muted">
        <span id="payDueLabel">${dueLabel}</span>: <b id="payRent">0.000</b> Ø±.Ø¹ â€”
        Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <b id="payRemain">0.000</b> Ø±.Ø¹
      </div>

      <div id="payOldSummaryWrap" style="grid-column:1/-1;display:none">
        <label style="display:flex;justify-content:space-between;align-items:center">
          <span>Ø³Ø¬Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± (${ym})</span>
          <button type="button" class="btn" id="btnDeletePayMonth" style="background:#fff;border:1px solid #fee2e2;color:#b91c1c">ğŸ—‘ï¸ Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø´Ù‡Ø±</button>
        </label>
        <div class="muted" id="payOldSummary" style="padding:10px 12px;border:1px dashed #e5e7eb;border-radius:12px;background:#fafafa;font-size:12px;line-height:1.6;direction:rtl"></div>
      </div>

      <div style="grid-column:1/-1">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (${ym})</label>
        <textarea id="payNote" rows="3" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
      </div>
    </div>

    <div class="buttons-row">
      <button type="button" class="btn" id="btnIssueReceipt">ğŸ§¾ Ø¥ØµØ¯Ø§Ø± Ø¥ÙŠØµØ§Ù„</button>
      <button type="button" class="btn primary" id="savePay">Ø­ÙØ¸</button>
    </div>
  `);

  // Ù‚ÙŠÙ… Ù…Ø¨Ø¯Ø¦ÙŠØ©
  const dueStr = due.toFixed(3);
  document.getElementById('payRent').textContent = dueStr;
  document.getElementById('payRemain').textContent = dueStr;
  document.getElementById('payRcNo').value = makeRcNo();

  const amtEl  = document.getElementById('payAmount');
  const rcEl   = document.getElementById('payRcNo');
  const noteEl = document.getElementById('payNote');

  // Ù„Ùˆ ÙÙŠÙ‡ Ø³Ø¬Ù„ Ù‚Ø¯ÙŠÙ…ØŒ Ù†Ø¹Ø¨ÙŠÙ‡ (Ø­ØªÙ‰ Ù†Ù‚Ø¯Ø± Ù†Ø¹Ø¯Ù‘Ù„)
  let oldSummary = '';
  try{
    oldSummary = DEMO_MODE
      ? (((t.payments||{})[ym]) || '')
      : await (async()=>{
          const tdoc = await firebase.firestore()
            .collection('buildings').doc(b.id)
            .collection('tenants').doc(t.id).get();
          const tdata = tdoc.exists ? tdoc.data() : {};
          return ((tdata.payments||{})[ym]) || '';
        })();

    if(oldSummary){
      const wrap = document.getElementById('payOldSummaryWrap');
      const box  = document.getElementById('payOldSummary');
      wrap.style.display = '';
      box.textContent = String(oldSummary);

      // Parse summary (ÙŠØ¯Ø¹Ù… Ø§Ù„ØµÙŠØº Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
      const mAmt = String(oldSummary).match(/Ù…Ø¨Ù„Øº\s*:\s*([\d\.]+)/) || String(oldSummary).match(/Ù…Ø³ØªÙ„Ù…\s*:\s*([\d\.]+)/);
      if(mAmt) amtEl.value = mAmt[1];

      const mRc  = String(oldSummary).match(/Ø¥ÙŠØµØ§Ù„\s*:\s*([^\|]+)/) || String(oldSummary).match(/Ø±Ù‚Ù…\s*:\s*([^\|]+)/);
      if(mRc) rcEl.value = (mRc[1]||'').trim();

      const mNote = String(oldSummary).split('Ù…Ù„Ø§Ø­Ø¸Ø©:')[1];
      if(mNote) noteEl.value = String(mNote).trim();
    }
  }catch(e){
    // Ù†ØªØ¬Ø§Ù‡Ù„ØŒ Ù„ÙƒÙ† Ù†ØªØ±Ùƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ³Ø¬Ù„ Ø¯ÙØ¹ Ø¬Ø¯ÙŠØ¯
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ø¨Ø§Ø´Ø±
  function refreshRemain(){
    const paid = Number(amtEl.value||0);
    document.getElementById('payRemain').textContent = (due - paid).toFixed(3);
  }
  amtEl.addEventListener('input', refreshRemain);
  refreshRemain();

  // Ø­Ø°Ù Ø³Ø¬Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± (Ø¥Ù† ÙˆÙØ¬Ø¯)
  const delBtn = document.getElementById('btnDeletePayMonth');
  if(delBtn){
    if(!oldSummary){
      delBtn.style.display = 'none';
    }else{
      delBtn.onclick = async ()=>{
        const REQUIRED_PIN = '998080';
        const pin = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø³Ø¬Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±:');
        if(pin !== REQUIRED_PIN) return alert('Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­.');
        try{
          const patch = {};
          patch['payments.'+ym] = firebase.firestore.FieldValue.delete();
          await FB.updateTenant(b.id, t.id, patch);
          UI.closeModal();
          Render.building();
        }catch(err){
          alert('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø´Ù‡Ø±: ' + (err && err.message ? err.message : err));
        }
      };
    }
  }

  // Ø¥ØµØ¯Ø§Ø± Ø¥ÙŠØµØ§Ù„ Ø¨Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„Ù…Ø¨Ù„Øº
  document.getElementById('btnIssueReceipt').onclick = ()=>{
    const paid = Number(amtEl.value||0);
    const rc   = (rcEl.value||'').trim() || makeRcNo();

    openReceipt({
      tenantName: t.tenantName || '',
      unitNumber: t.unitNumber || '',
      rent:       paid || due,     // Ù†Ù…Ø±Ø± Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹
      kind:       t.kind || '',
      phone:      t.phone || '',
      idNumber:   t.nationalId || ''
    });

    setTimeout(()=>{
      try{
        const rcNoEl = document.getElementById('rcNo');
        const rcAmtEl = document.getElementById('rcAmount');
        if(rcNoEl) rcNoEl.value = rc;
        if(rcAmtEl){ rcAmtEl.value = (paid||due).toFixed(3); rcAmtEl.dispatchEvent(new Event('input')); }
      }catch(e){}
    }, 60);
  };

  // Ø­ÙØ¸/ØªØ¹Ø¯ÙŠÙ„
  document.getElementById('savePay').onclick = async ()=>{
    const btn = document.getElementById('savePay');
    const oldText = btn ? btn.textContent : '';
    if(btn){ btn.disabled = true; btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...'; }

    const paid   = Number(amtEl.value||0);
    const rc     = (rcEl.value||'').trim() || makeRcNo();
    const remain = (due - paid).toFixed(3);
    const extra  = (noteEl.value||'').trim();

    if(!paid || paid <= 0){
      if(btn){ btn.disabled = false; btn.textContent = oldText || 'Ø­ÙØ¸'; }
      UI.toast('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºÙ‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§');
      return;
    }

    const summary =
      `Ø¥ÙŠØµØ§Ù„: ${rc||'â€”'} | Ù…Ø¨Ù„Øº: ${paid.toFixed(3)} | ${dueLabel}: ${due.toFixed(3)} | Ù…ØªØ¨Ù‚ÙŠ: ${remain}` +
      (extra ? ` | Ù…Ù„Ø§Ø­Ø¸Ø©: ${extra}` : '');

    const field = {}; field['payments.'+ym] = summary;

    // Timeout guard (prevents "hang" feeling on slow/offline connections)
    const withTimeout = (p, ms)=> Promise.race([
      p,
      new Promise((_, rej)=> setTimeout(()=> rej(new Error('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø­ÙØ¸. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.')), ms))
    ]);

    try{
      await withTimeout(FB.updateTenant(b.id, t.id, field), 15000);
      UI.toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹');
      UI.closeModal();
      Render.building();
    }catch(err){
      console.error('save payment failed', err);
      alert('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹: ' + (err && err.message ? err.message : err));
      if(btn){ btn.disabled = false; btn.textContent = oldText || 'Ø­ÙØ¸'; }
    }
  };
};



// edit
row.querySelector('[data-edit]').onclick = (ev)=>{
  ev.stopPropagation();

  UI.openModal('ØªØ¹Ø¯ÙŠÙ„ ' + tDef + ' (Ø³Ø§Ø±ÙŠ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±)', `
    <div class="grid cols-2">
      <div>
        <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø©</label>
        <select id="etKind">
          <option value="apartment" ${t.kind==='apartment'?'selected':''}>Ø´Ù‚Ø©</option>
          <option value="shop" ${t.kind==='shop'?'selected':''}>Ù…Ø­Ù„</option>
          <option value="showroom" ${t.kind==='showroom'?'selected':''}>Ù…Ø¹Ø±Ø¶</option>
          <option value="basement" ${t.kind==='basement'?'selected':''}>Ù‚Ø¨Ùˆ</option>
        </select>
      </div>
      <div><label>Ø±Ù‚Ù… Ø§Ù„Ø´Ù‚Ø©/Ø§Ù„Ù…Ø­Ù„</label><input id="etUnit" value="${t.unitNumber||''}"></div>
      ${isOA ? `<div><label>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</label><input id="etUnitUse" value="${t.unitUse||''}" placeholder="Ù…Ø«Ø§Ù„: Ø³ÙƒÙ†ÙŠ / ØªØ¬Ø§Ø±ÙŠ / Ù…ÙƒØ§ØªØ¨"></div>` : ``}
      <div><label>Ø§Ø³Ù… ${tDef}</label><input id="etName" value="${t.tenantName||''}"></div>
      <div><label>${isOA ? 'Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©' : 'Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ'} (Ø±.Ø¹)</label><input id="etRent" type="number" step="0.001" value="${t.rent||0}"></div>
      <div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="etPhone" type="tel" value="${t.phone||''}"></div>
      ${isOA ? `<div><label>Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„Ùƒ</label><input id="etOwnerEmail" type="email" value="${t.ownerEmail||''}" placeholder="name@example.com"></div>` : ``}
      <div><label>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</label><input id="etNatId" value="${t.nationalId||''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©"></div>

      ${isOA ? '' : `
<div>
        <label>ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</label>
        <div style="display:flex;align-items:center;gap:8px">
          <img id="tNatIdPreview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©"
               style="width:56px;height:56px;border-radius:8px;border:1px solid var(--border);object-fit:cover;display:none">
          <input id="tNatIdFile" type="file" accept="image/*" style="display:none">
          <button id="tNatIdAttach" type="button" class="btn"
                  style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#f9fafb;cursor:pointer">ğŸ“ Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
          <a id="tNatIdOpen" href="#" target="_blank" style="text-decoration:underline;display:none">ğŸ‘ï¸ Ø¹Ø±Ø¶</a>
          <button id="tNatIdDelete" type="button" class="btn danger admin-only" style="display:none">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>
        <small class="muted">jpeg/png Ø­ØªÙ‰ 5MB</small>
      </div>
      `}

            ${isOA ? '' : `
      <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input id="etEnd" type="date" value="${t.endDate||''}"></div>
      <div>
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</label>
        <select id="etPaymentType">
          <option value="advance" ${t.paymentType!=='delayed'?'selected':''}>Ù…Ù‚Ø¯Ù…Ø§Ù‹</option>
          <option value="delayed" ${t.paymentType==='delayed'?'selected':''}>Ù…Ø¤Ø®Ø±Ø§Ù‹</option>
        </select>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <label style="margin:0">ÙØªØ±Ø© Ø³Ù…Ø§Ø­ØŸ</label>
        <input id="etGraceEnabled" type="checkbox" ${t.graceEnabled?'checked':''} />
      </div>
      <div><label>Ù…Ø¯Ø© Ø§Ù„Ø³Ù…Ø§Ø­ (Ø£Ø´Ù‡Ø±)</label><input id="etGraceMonths" type="number" min="0" step="1" value="${Number(t.graceMonths||0)}"></div>
      `}<div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="etNotes" rows="3">${t.notes||''}</textarea></div>
      ${isOA ? `
      <div style="grid-column:1/-1">
        <div class="card" style="margin-top:6px">
          <div class="card-h"><b>ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ</b></div>
          <div class="card-c">
            <div class="grid cols-2" style="align-items:end">
              <div style="grid-column:1/-1">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚</label>
                <input id="etOaAttName" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù‚Ø¯ / Ø³Ù†Ø¯ / ØªÙ‚Ø±ÙŠØ±">
              </div>
              <div style="grid-column:1/-1">
                <label>Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</label>
                <input type="file" id="etOaAttFile" multiple>
              </div>
              <div style="grid-column:1/-1;display:flex;gap:8px;flex-wrap:wrap">
                <button type="button" class="btn" id="etOaAttUpload">â¬†ï¸ Ø±ÙØ¹</button>
                <div id="etOaAttMsg" class="muted" style="align-self:center"></div>
              </div>
            </div>

            <div style="margin-top:10px;overflow:auto">
              <table>
                <thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚</th><th style="width:180px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                <tbody id="etOaAttRows">
                  <tr><td colspan="2" style="text-align:center;color:#666">â€”</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      ` : ``}
    </div>
    <div class="buttons-row">
      <button type="button" class="btn primary" id="etSave">Ø­ÙØ¸</button>
    </div>
  `);

  // Ø¹Ù†Ø§ØµØ± ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (ÙŠØ¯Ø¹Ù… et* Ùˆ t*)
  const scope    = document.getElementById('modalBody');
  const etFileEl = scope.querySelector('#etNatIdFile, #tNatIdFile');
  const etPrevEl = scope.querySelector('#etNatIdPreview, #tNatIdPreview');
  const etOpenEl = scope.querySelector('#etNatIdOpen,  #tNatIdOpen');
  const etDelEl  = scope.querySelector('#etNatIdDelete, #tNatIdDelete');
  const etAttach = scope.querySelector('#etNatIdAttach, #tNatIdAttach');

  etAttach?.addEventListener('click', ()=> etFileEl?.click());

  // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª
  (async ()=>{
    try{
      let initUrl = t.nationalIdImageUrl || '';
      if (!initUrl && t.nationalIdImagePath) {
        await (window.__waitAuth||Promise.resolve());
        await (window.__waitAppCheck||Promise.resolve());
        initUrl = await firebase.storage().ref().child(t.nationalIdImagePath).getDownloadURL();
      }
      if (initUrl && etPrevEl){
        etPrevEl.src = initUrl;
        etPrevEl.style.display = 'block';
        if (etOpenEl){ etOpenEl.href = initUrl; etOpenEl.style.display = 'inline'; }
        if (etDelEl) etDelEl.style.display = 'inline-block';
      }
    }catch(e){ console.warn('init image err', e); }
  })();

  // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù
  etFileEl?.addEventListener('change', ()=>{
    const f = etFileEl.files?.[0];
    if (!etPrevEl) return;
    if (!f){
      etPrevEl.style.display='none'; etPrevEl.removeAttribute('src');
      if (etOpenEl){ etOpenEl.style.display='none'; etOpenEl.removeAttribute('href'); }
      if (etDelEl) etDelEl.style.display='none';
      return;
    }
    const url = URL.createObjectURL(f);
    etPrevEl.src = url; etPrevEl.style.display='block';
    if (etOpenEl){ etOpenEl.href = url; etOpenEl.style.display='inline'; }
    if (etDelEl) etDelEl.style.display='inline-block';
  });

  // Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙˆÙ…Ù† Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
  etDelEl?.addEventListener('click', async ()=>{
    try{
      if(!App.UI.confirm('Ø­Ø°Ù ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ')) return;
      await (window.__waitAuth||Promise.resolve());
      await (window.__waitAppCheck||Promise.resolve());

      if (t.nationalIdImagePath) {
        await firebase.storage().ref().child(t.nationalIdImagePath).delete().catch(()=>{});
      } else if (t.nationalIdImageUrl) {
        try{ await firebase.storage().refFromURL(t.nationalIdImageUrl).delete(); }catch(_){}
      }

      await App.FB.updateTenant(b.id, t.id, {
        nationalIdImageUrl : firebase.firestore.FieldValue.delete(),
        nationalIdImagePath: firebase.firestore.FieldValue.delete()
      });

      if (etPrevEl){ etPrevEl.style.display='none'; etPrevEl.removeAttribute('src'); }
      if (etOpenEl){ etOpenEl.style.display='none'; etOpenEl.removeAttribute('href'); }
      if (etDelEl)  etDelEl.style.display='none';
      if (etFileEl) etFileEl.value='';
      App.UI.toast('ØªÙ… Ø­Ø°Ù ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©.');
    }catch(e){
      console.error(e);
      App.UI.toast('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©.');
    }
  });

  // ===================== Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ (Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ) =====================
  const __oaRows = document.getElementById('etOaAttRows');
  if (isOA && __oaRows) {
    const __oaName  = document.getElementById('etOaAttName');
    const __oaFiles = document.getElementById('etOaAttFile');
    const __oaUp    = document.getElementById('etOaAttUpload');
    const __oaMsg   = document.getElementById('etOaAttMsg');

    const __esc = (s)=> String(s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const __readAsDataURL = (file)=> new Promise((res, rej)=>{
      try{
        const r = new FileReader();
        r.onload = ()=>res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
      }catch(e){ rej(e); }
    });

    const draw = ()=>{
      const arr = Array.isArray(t.attachments) ? t.attachments : [];
      if(!arr.length){
        __oaRows.innerHTML = '<tr><td colspan="2" style="text-align:center;color:#666">â€”</td></tr>';
        return;
      }
      __oaRows.innerHTML = arr.map(a=>`
        <tr data-id="${__esc(a.id||'')}">
          <td>${__esc(a.name || a.fileName || 'Ù…Ø±ÙÙ‚')}</td>
          <td style="white-space:nowrap">
            ${a.url ? `<a class="btn" href="${a.url}" target="_blank" rel="noopener">ØªØ­Ù…ÙŠÙ„</a>` : `<span class="muted">â€”</span>`}
            <button type="button" class="btn danger admin-only" data-del="${__esc(a.id||'')}">Ø­Ø°Ù</button>
          </td>
        </tr>
      `).join('');
    };
    draw();

    __oaUp && (__oaUp.onclick = async ()=>{
      try{
        const files = Array.from(__oaFiles?.files || []);
        const baseName = (__oaName?.value||'').trim();
        if(!files.length){ if(__oaMsg) __oaMsg.textContent = 'Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§.'; return; }
        if(!baseName){ if(__oaMsg) __oaMsg.textContent = 'Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚.'; return; }

        if(__oaMsg) __oaMsg.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';
        const isLocal = (location.protocol==='file:' || location.origin==='null');

        const next = Array.isArray(t.attachments) ? [...t.attachments] : [];
        let i = 0;
        for(const f of files){
          i++;
          let url = '';
          let path = '';

          if (!DEMO_MODE && storage && f && !isLocal) {
            const safeName = (f.name||'file').replace(/[^\w.\-]+/g,'_');
            path = `buildings/${b.id}/tenants/${t.id}/attachments/${Date.now()}_${safeName}`;
            const ref = storage.ref().child(path);
            await (window.__waitAuth||Promise.resolve()); await (window.__waitAppCheck||Promise.resolve());
            await ref.put(f, { contentType: f.type || 'application/octet-stream' });
            url = await ref.getDownloadURL();
          } else {
            url = await __readAsDataURL(f);
          }

          if(url){
            const nm = files.length>1 ? `${baseName} (${i})` : baseName;
            next.push({ id: 'att_' + Math.floor(Math.random()*1e9).toString(36), name: nm, url, path, fileName: f.name, createdAt: new Date().toISOString() });
          }
        }

        await FB.updateTenant(b.id, t.id, { attachments: next });
        t.attachments = next;

        if(__oaFiles) __oaFiles.value = '';
        if(__oaName)  __oaName.value = '';
        if(__oaMsg)   __oaMsg.textContent = 'ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª.';
        draw();
      }catch(e){
        console.error(e);
        if(__oaMsg) __oaMsg.textContent = 'ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª.';
      }
    });

    __oaRows.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-del]');
      if(!btn) return;
      const id = btn.getAttribute('data-del')||'';
      if(!id) return;
      if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙÙ‚ØŸ')) return;

      try{
        const arr = Array.isArray(t.attachments) ? t.attachments : [];
        const item = arr.find(x => String(x.id)===String(id));
        const next = arr.filter(x => String(x.id)!==String(id));

        await FB.updateTenant(b.id, t.id, { attachments: next });
        t.attachments = next;

        const isLocal = (location.protocol==='file:' || location.origin==='null');
        if(item?.path && !DEMO_MODE && storage && !isLocal){
          try{
            await (window.__waitAuth||Promise.resolve()); await (window.__waitAppCheck||Promise.resolve());
            await storage.ref().child(item.path).delete();
          }catch(e){ console.warn('delete attachment storage fail', e); }
        }

        draw();
      }catch(err){
        console.error(err);
        App.UI.toast('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚.');
      }
    });
  }

  // Ø­ÙØ¸
  document.getElementById('etSave').onclick = async ()=>{
    let __saved = false;
    try{
      const __rentVal = Number(document.getElementById('etRent').value||0);

      const patch = {
        kind:        document.getElementById('etKind').value,
        unitNumber:  document.getElementById('etUnit').value.trim(),
        unitUse:     isOA ? (document.getElementById('etUnitUse')?.value||'').trim() : (t.unitUse||''),
        tenantName:  document.getElementById('etName').value.trim(),
        ownerEmail:  isOA ? (document.getElementById('etOwnerEmail')?.value||'').trim() : (t.ownerEmail||''),
        rent:        __rentVal, // ÙÙŠ Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ = Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©
        annualContribution: isOA ? __rentVal : (t.annualContribution||0),
        phone:       document.getElementById('etPhone').value.trim(),
        nationalId:  document.getElementById('etNatId').value.trim(),
        notes:       document.getElementById('etNotes').value.trim(),
        ...(isOA ? {} : {
          endDate:     document.getElementById('etEnd').value,
          paymentType: document.getElementById('etPaymentType').value,
          graceEnabled:document.getElementById('etGraceEnabled').checked,
          graceMonths: Number(document.getElementById('etGraceMonths').value||0)
        })
      };

      // Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù† Ø§Ø®ØªÙŠØ±Øª
      const isLocal = (location.protocol==='file:' || location.origin==='null');
      let finalImgUrl=null, finalImgPath=null;
      const f = etFileEl?.files?.[0];
      if (f && !isLocal){
        const ext  = (f.name.split('.').pop()||'jpg').toLowerCase();
        const name = `national_id_${Date.now()}.${ext}`;
        const path = `buildings/${b.id}/tenants/${t.id}/${name}`;
        const ref  = firebase.storage().ref().child(path);
        await (window.__waitAuth||Promise.resolve());
        await (window.__waitAppCheck||Promise.resolve());
        await ref.put(f,{contentType: f.type||'image/jpeg'});
        finalImgUrl  = await ref.getDownloadURL();
        finalImgPath = path;
      }

      // Ù‡Ù„ Ù†Ù‚Ø³Ù… Ø§Ù„Ø³Ø¬Ù„ Ù„Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯ØŸ
      let splitting = false;
      if(!isOA){
        try{
          const d0 = new Date(t.startDate);
          splitting = (d0.toString()!=='Invalid Date') && (d0 < startOfMonth(State.selYear, State.selMonth));
        }catch{}
      }

      if (splitting){
        await FB.updateTenant(b.id, t.id, {
          endDate: prevMonthEnd(State.selYear, State.selMonth).toISOString().slice(0,10)
        });

        const imgCarry = finalImgUrl
          ? { nationalIdImageUrl: finalImgUrl, nationalIdImagePath: finalImgPath }
          : (t.nationalIdImageUrl || t.nationalIdImagePath
              ? { nationalIdImageUrl: t.nationalIdImageUrl||'', nationalIdImagePath: t.nationalIdImagePath||'' }
              : {});

        await FB.addTenant(b.id, {
          ...patch,
          ...imgCarry,
          startDate: startOfMonth(State.selYear, State.selMonth).toISOString().slice(0,10)
        });
      } else {
        const imgFields = finalImgUrl ? { nationalIdImageUrl: finalImgUrl, nationalIdImagePath: finalImgPath } : {};
        await FB.updateTenant(b.id, t.id, { ...patch, ...imgFields });
      }

      __saved = true;
    }catch(err){
      console.error('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:', err);
      try{ UI.toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸: ' + (err?.message || err)); }catch(_){}
    }finally{
      if (__saved){ UI.closeModal(); Render.building(); }
    }
  };
};
// Ø¥ØµØ¯Ø§Ø± Ø¹Ù‚Ø¯ (Ø´Ø¨Ùƒ Ù…Ø¨Ø§Ø´Ø±)
const __ctBtn = row.querySelector('[data-contract]');
if(__ctBtn) __ctBtn.onclick = async (ev)=>{
  ev.stopPropagation();

  const btn = ev.currentTarget;
  let idimg = btn.dataset.idimg || '';
  const imgPath = btn.dataset.idimgPath || '';
  if (!idimg && imgPath && firebase?.storage) {
    try {
      await (window.__waitAuth||Promise.resolve());
      await (window.__waitAppCheck||Promise.resolve());
      idimg = await firebase.storage().ref().child(imgPath).getDownloadURL();
    } catch(e){ /* ØªØ¬Ø§Ù‡Ù„ */ }
  }

  openContract({
    tenantName: t.tenantName || '',
    unitNumber: t.unitNumber || '',
    rent:      parseFloat(t.rent||'0') || 0,
    kind:      t.kind || '',
    phone:     t.phone || '',
    idNumber:  t.nationalId || '',
    payDate:   t.payDate || '',
    idimg
  });
};




          document.getElementById('tenantsList').appendChild(row);
        });

        // Units list (not used in Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ)
        const unitsBox = $('#unitsList'); if (unitsBox) unitsBox.innerHTML='';
        if(!isOA){
          const filteredUnits = applyFilters(tenants);
          filteredUnits.forEach(t=>{
            const li = document.createElement('div');
            li.style.cssText='display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px;margin-bottom:8px';
            li.innerHTML = `<div>Ø§Ù„ÙˆØ­Ø¯Ø© <b>${t.unitNumber||'â€”'}</b> â€” ${labelKind(t.kind)}</div><div><span class="badge success">Ù…Ø´ØºÙˆÙ„Ø©</span></div>`;
            unitsBox && unitsBox.appendChild(li);
          });
          const vacant = Math.max(0, (Number(totalUnits)||0) - tenants.length);
          const liVac = document.createElement('div');
          liVac.style.cssText='display:flex;justify-content:space-between;align-items:center;border:1px dashed var(--border);border-radius:10px;padding:8px;margin-bottom:8px;background:#fff';
          liVac.innerHTML = `<div>ÙˆØ­Ø¯Ø§Øª Ø´Ø§ØºØ±Ø©</div><div><span class="badge gray">${vacant}</span></div>`;
          unitsBox && unitsBox.appendChild(liVac);
        }
      }
      renderLists();

      document.getElementById('btnBack').onclick = ()=>{ State.activeBuildingId = null; Render.dashboard(); };
      document.getElementById('btnEditBuilding').onclick = ()=> Actions.openEditBuilding(b);
      const delBtn = document.getElementById('btnDeleteBuilding');
      if (delBtn){
        const bizNow = (normBiz(b.bizType||State.bizTab)||'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ');
        const isOA = (bizNow === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
        delBtn.style.display = isOA ? 'inline-flex' : 'none';
        delBtn.onclick = async ()=>{
          if (!checkDeletePin()) return;
          if (!UI.confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø¨Ù†Ù‰ØŸ')) return;
          try{
            await FB.removeBuilding(b.id);
            State.activeBuildingId = null;
            Render.dashboard();
          }catch(err){
            console.error(err);
            alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª/Ø§Ù„Ø§ØªØµØ§Ù„.');
          }
        };
      }

      document.getElementById('btnAddTenant').onclick = ()=> Actions.openAddTenant();
      document.getElementById('btnExpenses').onclick = ()=> Actions.openExpenses(b.id);
      document.getElementById('btnFiles').onclick = App.Actions.openAttachments;


      const reportBtn = document.getElementById('btnReport');
      if (reportBtn) {
        
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù…Ù‡Ø§ Ø¹Ù†Ø¯ ÙØªØ­ Ù…Ø¨Ù†Ù‰/Ø§Ù„Ø±Ø¬ÙˆØ¹ØŒ ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… addEventListener Ù‡Ù†Ø§
        // ÙŠØ¤Ø¯ÙŠ Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ø±Ø¨Ø· ÙˆÙØªØ­ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¹Ø¯Ø© Ù…Ø±Ø§Øª. Ù„Ø°Ù„Ùƒ Ù†Ø³ØªØ®Ø¯Ù… onclick (ÙŠØ³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¯Ø§Ø¦Ù…Ø§Ù‹).
        reportBtn.onclick = (ev) => {
          ev.preventDefault();
          ev.stopPropagation?.();
          try {
            openBuildingReport({
              name:     b.name || '',
              location: b.location || '',
              phone:    b.contact || '',
              owner:    b.owner || '',
              workType: b.bizType || '',
              feeType:  b.feeType || 'percentage',              // Ù†Ø³Ø¨Ø© Ø£Ùˆ Ø±Ø§ØªØ¨
              feeValue: (b.feeValue != null ? b.feeValue : ''), // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙØ¯Ø®Ù„Ø© Ù„Ù„Ù…Ø¨Ù†Ù‰
            });
          } catch (e) {
            console.error('openBuildingReport ØºÙŠØ± Ù…Ø¹Ø±Ù‘ÙØ©ØŸ', e);
            alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±. ØªØ£ÙƒØ¯ Ø£Ù† ÙƒØªÙ„Ø© "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨Ù†Ù‰" Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù.');
          }
        };
      }
      document.getElementById('btnImportCSV').onclick = ()=> Actions.openImportCSV();
    },
  };

  function labelKind(kind){ return kind==='apartment'?'Ø´Ù‚Ø©':(kind==='shop'?'Ù…Ø­Ù„':(kind==='showroom'?'Ù…Ø¹Ø±Ø¶':'Ù‚Ø¨Ùˆ')); }

  const Actions = {

openAddUser(){
  if(!window.AuthState || !window.AuthState.isAdmin){
    alert('Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·');
    return;
  }
  UI.openModal('Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…', `
    <div class="form">
      <div class="row">
        <label>Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
        <input id="newUserEmail" type="email" placeholder="name@example.com" style="direction:ltr;text-align:left" />
      </div>
      <div class="row">
        <label>Ø§Ù„Ø§Ø³Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="newUserName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
      </div>
      <div class="row">
        <label><input id="newUserMakeAdmin" type="checkbox" /> Ø§Ø¬Ø¹Ù„Ù‡ Ø£Ø¯Ù…Ù†</label>
      </div>
      <div class="note" style="margin-top:8px;color:#555;font-size:13px">
        Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ Ø«Ù… Ø¥ØµØ¯Ø§Ø± Ø±Ø§Ø¨Ø· ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± (Password Reset) Ù„ØªØ´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
      </div>
      <div class="actions" style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
        <button class="btn primary" id="btnCreateUserNow">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
        <button class="btn" data-close>Ø¥Ù„ØºØ§Ø¡</button>
      </div>
      <div id="createUserResult" style="margin-top:12px"></div>
    </div>
  `);

  setTimeout(()=>{
    const btn = document.getElementById('btnCreateUserNow');
    if(!btn) return;
    btn.onclick = async ()=>{
      const email = (document.getElementById('newUserEmail')?.value||'').trim();
      const name  = (document.getElementById('newUserName')?.value||'').trim();
      const makeAdmin = !!document.getElementById('newUserMakeAdmin')?.checked;
      const out = document.getElementById('createUserResult');
      if(!email){ alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„'); return; }
      btn.disabled = true;
      if(out) out.innerHTML = '... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡';
      try{
        const data = await window.AdminAPI.createUser({ email, displayName:name, makeAdmin });
        const link = data?.resetLink || '';
        const uid  = data?.uid || '';
        if(out){
          out.innerHTML = `
            <div style="padding:10px;border:1px solid #ddd;border-radius:10px">
              <div><b>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</b></div>
              <div style="margin-top:6px"><b>UID:</b> <span style="direction:ltr">${uid}</span></div>
              <div style="margin-top:10px"><b>Ø±Ø§Ø¨Ø· ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</b></div>
              <textarea id="resetLinkBox" style="width:100%;min-height:90px;direction:ltr;text-align:left">${link}</textarea>
              <div style="display:flex;gap:10px;margin-top:8px;flex-wrap:wrap">
                <button class="btn" id="btnCopyResetLink">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
                <a class="btn" href="${link}" target="_blank" rel="noopener">ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</a>
              </div>
              <div style="margin-top:8px;color:#666;font-size:12px">
                Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙˆØ§ØªØ³Ø§Ø¨/Ø¥ÙŠÙ…ÙŠÙ„) Ù„ÙŠØ¶Ø¹ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¨Ù†ÙØ³Ù‡.
              </div>
            </div>
          `;
          const copyBtn = document.getElementById('btnCopyResetLink');
          if(copyBtn){
            copyBtn.onclick = async ()=>{
              try{
                const t = document.getElementById('resetLinkBox');
                await navigator.clipboard.writeText(t?.value||'');
                alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®');
              }catch(e){
                alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ â€” Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§');
              }
            };
          }
        }
      }catch(e){
        console.warn(e);
        let msg = 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
        try{
          const code = e?.message || e?.toString?.() || '';
          if(code.includes('DEMO_MODE')) msg = 'Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (DEMO_MODE). Ø¹Ø·Ù‘Ù„ DEMO_MODE Ù„ØªÙØ¹ÙŠÙ„ ÙØ§ÙŠØ±Ø¨ÙŠØ³.';
        }catch(_){}
        if(out) out.innerHTML = `<div style="color:#b00">${msg}</div>`;
        alert(msg);
      }finally{
        btn.disabled = false;
      }
    };
  }, 50);
},

    openAddBuilding(){ openUpsertBuildingModal('add'); },
    openEditBuilding(existing){ openUpsertBuildingModal('edit', existing); },
async openAddTenant(){
  let bizType2 = 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ';
  let isOA2 = false;
  let isVal2 = false;
  if (DEMO_MODE) {
    const bDemo = DemoStore.getBuilding(State.activeBuildingId) || {};
    bizType2 = (bDemo.bizType || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
  } else {
    const bDoc = await firebase.firestore().collection('buildings').doc(State.activeBuildingId).get();
    bizType2 = ((bDoc.data()||{}).bizType || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
  }
  isOA2 = (bizType2 === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
  isVal2 = (bizType2 === 'ØªØ«Ù…ÙŠÙ†');
  const tSing2 = isVal2 ? 'Ø²Ø¨ÙˆÙ†' : (isOA2 ? 'Ù…Ø§Ù„Ùƒ' : 'Ù…Ø³ØªØ£Ø¬Ø±');
  const tDef2  = isVal2 ? 'Ø§Ù„Ø²Ø¨ÙˆÙ†' : (isOA2 ? 'Ø§Ù„Ù…Ø§Ù„Ùƒ' : 'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±');

  // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„)
  const startIso = startOfMonth(State.selYear, State.selMonth).toISOString().slice(0,10);

  UI.openModal('Ø¥Ø¶Ø§ÙØ© ' + tSing2, `
    <div class="grid cols-2">
      <div>
        <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø©</label>
        <select id="tKind">
          <option value="apartment">Ø´Ù‚Ø©</option>
          <option value="shop">Ù…Ø­Ù„</option>
          <option value="showroom">Ù…Ø¹Ø±Ø¶</option>
          <option value="basement">Ù‚Ø¨Ùˆ</option>
        </select>
      </div>
      <div><label>Ø±Ù‚Ù… Ø§Ù„Ø´Ù‚Ø©/Ø§Ù„Ù…Ø­Ù„</label><input id="tUnit" placeholder="Ù…Ø«Ø§Ù„: 203"></div>
      ${isOA2 ? `<div><label>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</label><input id="tUnitUse" placeholder="Ù…Ø«Ø§Ù„: Ø³ÙƒÙ†ÙŠ / ØªØ¬Ø§Ø±ÙŠ / Ù…ÙƒØ§ØªØ¨"></div>` : ``}
      <div><label>Ø§Ø³Ù… ${tDef2}</label><input id="tName" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø¯ÙŠ"></div>
      <div><label>${isOA2 ? 'Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©' : 'Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ'} (Ø±.Ø¹)</label><input id="tRent" type="number" step="0.001" placeholder="Ù…Ø«Ø§Ù„: ${isOA2 ? '120' : '180'}"></div>
      <div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="tPhone" type="tel" placeholder="9xxxxxxx"></div>
      ${isOA2 ? `<div><label>Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„Ùƒ</label><input id="tOwnerEmail" type="email" placeholder="name@example.com"></div>` : ``}
      <div><label>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</label><input id="tNatId" inputmode="numeric" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©"></div>
      ${isOA2 ? '' : `
      <div>
        <label>ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</label>
        <div style="display:flex;align-items:center;gap:8px">
          <img id="tNatIdPreview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©"
               style="width:56px;height:56px;border-radius:8px;border:1px solid var(--border);object-fit:cover;display:none">
          <input id="tNatIdFile" type="file" accept="image/*" style="display:none">
          <button id="tNatIdAttach" type="button" class="btn"
                  style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#f9fafb;cursor:pointer">ğŸ“ Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
          <a id="tNatIdOpen" href="#" target="_blank" style="text-decoration:underline;display:none">ğŸ‘ï¸ Ø¹Ø±Ø¶</a>
          <button id="tNatIdDelete" type="button" class="btn danger admin-only" style="display:none">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>
        <small class="muted">jpeg/png Ø­ØªÙ‰ 5MB</small>
      </div>
      `}

      ${isOA2 ? '' : `<div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</label><input id="tStart" type="date" value="${startIso}"></div>`}
      ${isOA2 ? '' : `
      <div>
        <label>Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯ (Ø£Ø´Ù‡Ø±)</label>
        <input id="tDuration" type="number" min="1" step="1" value="12">
      </div>
      <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input id="tEnd" type="date" value=""></div>

      <div>
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</label>
        <select id="tPaymentType">
          <option value="advance">Ù…Ù‚Ø¯Ù…Ø§Ù‹</option>
          <option value="delayed">Ù…Ø¤Ø®Ø±Ø§Ù‹</option>
        </select>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <label style="margin:0">ÙØªØ±Ø© Ø³Ù…Ø§Ø­ØŸ</label>
        <input id="tGraceEnabled" type="checkbox" />
      </div>
      <div>
        <label>Ù…Ø¯Ø© Ø§Ù„Ø³Ù…Ø§Ø­ (Ø£Ø´Ù‡Ø±)</label>
        <input id="tGraceMonths" type="number" min="0" step="1" value="0">
      </div>
      `}
      <div style="grid-column:1/-1" data-bank-hide><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="tNotes" rows="3" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©"></textarea></div>
      ${isOA2 ? `
      <div style="grid-column:1/-1">
        <div class="card" style="margin-top:6px">
          <div class="card-h"><b>ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ</b></div>
          <div class="card-c">
            <div class="grid cols-2" style="align-items:end">
              <div style="grid-column:1/-1">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚</label>
                <input id="tOaAttName" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù‚Ø¯ / Ø³Ù†Ø¯ / ØªÙ‚Ø±ÙŠØ±">
              </div>
              <div style="grid-column:1/-1">
                <label>Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</label>
                <input type="file" id="tOaAttFile">
              </div>
              <div style="grid-column:1/-1;display:flex;gap:8px;flex-wrap:wrap">
                <button type="button" class="btn" id="tOaAttAdd">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø±ÙÙ‚Ø§Øª</button>
                <div id="tOaAttMsg" class="muted" style="align-self:center"></div>
              </div>
            </div>

            <div style="margin-top:10px;overflow:auto">
              <table>
                <thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚</th><th style="width:140px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                <tbody id="tOaAttRows">
                  <tr><td colspan="2" style="text-align:center;color:#666">â€”</td></tr>
                </tbody>
              </table>
            </div>
            <small class="muted">ØªÙØ­ÙØ¸ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø­ÙØ¸".</small>
          </div>
        </div>
      </div>
      ` : ``}
    </div>
    <div class="buttons-row">
      <button type="button" class="btn primary" id="tSave">Ø­ÙØ¸</button>
    </div>
  `);

  // --- Ø­Ø³Ø§Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ø¢Ø®Ø± ÙŠÙˆÙ… Ù…Ù† Ø¢Ø®Ø± Ø´Ù‡Ø±) ---
  const startEl = document.getElementById('tStart');
  const durEl   = document.getElementById('tDuration');
  const endEl   = document.getElementById('tEnd');

  if (!isOA2) {
    function recalcEnd(){
      const dur = Math.max(1, parseInt(durEl.value || '12', 10));
      const sd  = new Date(startEl.value || startIso);
      const y   = sd.getUTCFullYear();
      const m   = sd.getUTCMonth() + 1;

      // Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£Ø®ÙŠØ± Ø´Ø§Ù…Ù„ (dur-1 Ø£Ø´Ù‡Ø± Ø¨Ø¹Ø¯ Ø´Ù‡Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)
      const total = (y * 12 + (m - 1)) + (dur - 1);
      const y2 = Math.floor(total / 12);
      const m2 = (total % 12) + 1;

      endEl.value = endOfMonth(y2, m2).toISOString().slice(0,10);
    }
    startEl.addEventListener('change', recalcEnd);
    durEl.addEventListener('input', recalcEnd);
    recalcEnd();
  }
  // ------------------------------------------------------------

  
  const tFileEl = document.getElementById('tNatIdFile');
  const tPrevEl = document.getElementById('tNatIdPreview');
  if (tFileEl && tPrevEl) {
      document.getElementById('tNatIdAttach')?.addEventListener('click', ()=> tFileEl.click());
    tFileEl.onchange = () => {
      const f = tFileEl.files?.[0];
      if (f) { tPrevEl.src = URL.createObjectURL(f); tPrevEl.style.display = 'block'; }
      else { tPrevEl.style.display = 'none'; tPrevEl.removeAttribute('src'); }
    };
  }

  // ===================== Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ (Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ) =====================
  let __oaAtt = [];
  const __escAtt = (s)=> String(s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const __readAsDataURL = (file)=> new Promise((res, rej)=>{
    try{
      const r = new FileReader();
      r.onload = ()=>res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    }catch(e){ rej(e); }
  });

  function __drawOaAtt(){
    const rows = document.getElementById('tOaAttRows');
    if(!rows) return;
    if(!__oaAtt.length){
      rows.innerHTML = '<tr><td colspan="2" style="text-align:center;color:#666">â€”</td></tr>';
      return;
    }
    rows.innerHTML = __oaAtt.map((a,i)=>`
      <tr data-i="${i}">
        <td>${__escAtt(a.displayName)}</td>
        <td style="white-space:nowrap">
          ${a.previewUrl ? `<a class="btn" href="${a.previewUrl}" target="_blank" rel="noopener">ØªØ­Ù…ÙŠÙ„</a>` : `<span class="muted">â€”</span>`}
          <button type="button" class="btn danger admin-only" data-del>Ø­Ø°Ù</button>
        </td>
      </tr>
    `).join('');
  }

  if(isOA2){
    const nameInp = document.getElementById('tOaAttName');
    const fileInp = document.getElementById('tOaAttFile');
    const addBtn  = document.getElementById('tOaAttAdd');
    const msg     = document.getElementById('tOaAttMsg');

    addBtn && (addBtn.onclick = ()=>{
      const nm = (nameInp?.value||'').trim();
      const f  = fileInp?.files?.[0];
      if(!nm){ if(msg) msg.textContent = 'Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚.'; return; }
      if(!f){ if(msg) msg.textContent = 'Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§ Ø£ÙˆÙ„Ø§Ù‹.'; return; }
      if(msg) msg.textContent = '';
      const objUrl = URL.createObjectURL(f);
      __oaAtt.push({ displayName: nm, file: f, previewUrl: objUrl });
      if(nameInp) nameInp.value = '';
      if(fileInp) fileInp.value = '';
      __drawOaAtt();
    });

    document.getElementById('tOaAttRows')?.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-del]');
      if(!btn) return;
      const tr = btn.closest('tr'); if(!tr) return;
      const i = Number(tr.getAttribute('data-i'));
      const it = __oaAtt[i];
      if(it?.previewUrl) try{ URL.revokeObjectURL(it.previewUrl); }catch{}
      __oaAtt.splice(i, 1);
      __drawOaAtt();
    });

    __drawOaAtt();
  }

document.getElementById('tSave').onclick = async ()=>{
    const __rentVal = Number(document.getElementById('tRent').value||0);

    const payload = {
      kind: document.getElementById('tKind').value,
      unitNumber: document.getElementById('tUnit').value.trim(),
      unitUse: isOA2 ? (document.getElementById('tUnitUse')?.value||'').trim() : '',
      tenantName: document.getElementById('tName').value.trim(),
      ownerEmail: isOA2 ? (document.getElementById('tOwnerEmail')?.value||'').trim() : '',
      rent: __rentVal, // ÙÙŠ Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ = Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©
      annualContribution: isOA2 ? __rentVal : 0,
      phone: document.getElementById('tPhone').value.trim(),
      nationalId: document.getElementById('tNatId').value.trim(),
      startDate: (startEl?.value || startIso),
      endDate: isOA2 ? '' : ((endEl?.value||'').trim()), // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¢Ø®Ø± ÙŠÙˆÙ… Ù…Ù† Ø¢Ø®Ø± Ø´Ù‡Ø±
      paymentType: isOA2 ? '' : (document.getElementById('tPaymentType')?.value||'advance'),
      graceEnabled: isOA2 ? false : !!(document.getElementById('tGraceEnabled')?.checked),
      graceMonths: isOA2 ? 0 : Number(document.getElementById('tGraceMonths')?.value||0),
      notes: document.getElementById('tNotes').value.trim(),
      payments: {} // Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø´Ù‡Ø±ÙŠØ©ØŒ ÙˆÙ„Ø§ ØªÙÙ†Ù‚Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    };

    if(!payload.tenantName){ UI.toast(isVal2?'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†':(isOA2?'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ':'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±')); return; }
    if(payload.endDate && new Date(payload.endDate) < new Date(payload.startDate)){
      UI.toast('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù„Ø§ ÙŠØ¬ÙˆØ² Ø£Ù† ÙŠØ³Ø¨Ù‚ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'); return;
    }

    const __newId = await FB.addTenant(State.activeBuildingId, payload);
    const __file = document.getElementById('tNatIdFile')?.files?.[0];
    if (__file) {
      try {
        const __ext = (__file.name.split('.').pop()||'jpg').toLowerCase();
        const __path = `buildings/${State.activeBuildingId}/tenants/${__newId}/national_id_${Date.now()}.${__ext}`;
        const __ref = storage.ref().child(__path);
        await (window.__waitAuth||Promise.resolve()); await (window.__waitAppCheck||Promise.resolve()); await __ref.put(__file, { contentType: __file.type || 'image/jpeg' });
        const __url = await __ref.getDownloadURL();
        await FB.updateTenant(State.activeBuildingId, __newId, { nationalIdImageUrl: __url, nationalIdImagePath: __path });
      } catch(e) { console.warn('ÙØ´Ù„ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ø¥Ø¶Ø§ÙØ©):', e); }
    }

    // Ø±ÙØ¹/Ø­ÙØ¸ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ (Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ)
    if (isOA2 && __oaAtt.length) {
      const isLocal = (location.protocol==='file:' || location.origin==='null');
      const list = [];
      for (const a of __oaAtt) {
        try {
          const f = a.file;
          let url = '';
          let path = '';
          if (!DEMO_MODE && storage && f && !isLocal) {
            const safeName = (f.name||'file').replace(/[^\w.\-]+/g,'_');
            path = `buildings/${State.activeBuildingId}/tenants/${__newId}/attachments/${Date.now()}_${safeName}`;
            const ref = storage.ref().child(path);
            await (window.__waitAuth||Promise.resolve()); await (window.__waitAppCheck||Promise.resolve());
            await ref.put(f, { contentType: f.type || 'application/octet-stream' });
            url = await ref.getDownloadURL();
          } else if (f) {
            url = await __readAsDataURL(f);
          }
          if (url) {
            list.push({ id: 'att_' + Math.floor(Math.random()*1e9).toString(36), name: a.displayName, url, path, createdAt: new Date().toISOString() });
          }
        } catch(e) { console.warn('ÙØ´Ù„ Ø­ÙØ¸ Ù…Ø±ÙÙ‚ Ø§Ù„Ù…Ø§Ù„Ùƒ:', e); }
      }
      if (list.length) {
        await FB.updateTenant(State.activeBuildingId, __newId, { attachments: list });
      }
    }

UI.closeModal();
    App.Render.building();
  };
},

  async openExpenses(bidOverride){
  const bid = bidOverride || State.activeBuildingId;
  if (bidOverride) State.activeBuildingId = bidOverride;

  // Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙÙˆØ±Ù‹Ø§ Ø­ØªÙ‰ Ù„Ùˆ ØµØ§Ø± Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
  UI.openModal('ğŸ’° Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', `
    <div class="card">
      <div class="card-c muted" style="padding:18px;text-align:center">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª...</div>
    </div>
  `);

  if(!bid){
    UI.openModal('ğŸ’° Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', `
      <div class="card">
        <div class="card-c" style="padding:16px;text-align:center;color:#b00">Ø§Ø®ØªØ± Ù…Ø¨Ù†Ù‰ Ø£ÙˆÙ„Ø§Ù‹</div>
      </div>
    `);
    return;
  }

  const draw = async ()=>{
    let exps = [];
    try{
      exps = await FB.listExpenses(bid);
     // Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù„Ù„Ø´Ù‡Ø±/Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙÙ‚Ø·
     const __y = Number(State.selYear);
     const __m = Number(State.selMonth);
     if(__y && __m){
       const __ms = startOfMonth(__y, __m);
       const __me = endOfMonth(__y, __m);
       exps = (exps||[]).filter(e=>{ const d=asDate(e.date,false); return (d instanceof Date && !isNaN(d.getTime()) && d>=__ms && d<=__me); });
     }

    } catch(e){
      console.error('listExpenses failed', e);
      UI.openModal('ğŸ’° Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', `
        <div class="card">
          <div class="card-c" style="padding:16px">
            <div style="font-weight:800;margin-bottom:6px">ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
            <div class="muted" style="font-size:13px;direction:ltr;text-align:left;white-space:pre-wrap">${UI.escape(e?.message || String(e))}</div>
            <div style="margin-top:10px"><button class="btn" data-close>Ø¥ØºÙ„Ø§Ù‚</button></div>
          </div>
        </div>
      `);
      return;
    }

    UI.openModal(`ğŸ’° Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª`, `
      <div class="grid cols-2">
        <div style="grid-column:1/-1">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
          <input id="exService" placeholder="Ù…Ø«Ø§Ù„: ØµÙŠØ§Ù†Ø©ØŒ ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ ØªÙ†Ø¸ÙŠÙØŒ Ø³Ø¨Ø§ÙƒØ©...">
        </div>

        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="exUnit" placeholder="Ù…Ø«Ø§Ù„: 101">
        </div>

        <div>
          <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø¹)</label>
          <input id="exAmount" type="number" step="0.001" placeholder="0.000">
        </div>

        <div>
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input id="exDate" type="date" value="${UI.todayISO()}">
        </div>

        <div style="grid-column:1/-1">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <textarea id="exNotes" rows="2" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></textarea>
        </div>

        <div style="grid-column:1/-1">
          <label>Ù…Ø±ÙÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <input id="exNewAttName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="flex:1;min-width:180px">
            <input type="file" id="exNewAttFile" style="flex:1;min-width:180px">
          </div>
          <small class="muted">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ø§Ù‹ ÙØªØ­ (ğŸ“) Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯.</small>
        </div>
      </div>

      <div class="buttons-row" style="margin-top:10px">
        <button class="btn primary" id="exAdd">Ø¥Ø¶Ø§ÙØ©</button>
      </div>

      <div style="margin-top:12px">
        <table>
          <thead>
            <tr>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</th>
              <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ù…Ø±ÙÙ‚</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="exRows">
            ${exps.length ? exps.map(e=>{
              const expType = (e.serviceType || e.type || '').toString();
              const unit = (e.unitNumber || '').toString().trim();
              const attCount = Number(e.attachmentsCount || 0);
              return `
                <tr data-id="${e.id}">
                  <td>${UI.escape(expType)}</td>
                  <td>${unit ? UI.escape(unit) : 'â€”'}</td>
                  <td>${UI.money(e.amount)}</td>
                  <td>${UI.dateISO(e.date)}</td>
                  <td style="text-align:center">
                    ${attCount>0 ? `<button class="btn" data-view title="Ù…Ø¹Ø§ÙŠÙ†Ø©">ğŸ‘ï¸</button>` : 'â€”'}
                  </td>
                  <td style="white-space:nowrap">
                    <button class="btn" data-edit>ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="btn danger" data-del>Ø­Ø°Ù</button>
                  </td>
                  <td>${UI.escape(e.notes || '')}</td>
                </tr>
              `;
            }).join('') : `<tr><td colspan="7" class="muted" style="text-align:center;padding:14px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª</td></tr>`}
          </tbody>
        </table>
      </div>
    `);

    document.getElementById('exAdd').onclick = async ()=>{
      const serviceType = (document.getElementById('exService').value||'').trim();
      const unitNumber  = (document.getElementById('exUnit').value||'').trim();
      const amount      = Number(document.getElementById('exAmount').value||0);
      const date        = document.getElementById('exDate').value || UI.todayISO();
      const notes       = (document.getElementById('exNotes').value||'').trim();

      if(!serviceType){ UI.toast('Ø§ÙƒØªØ¨ Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ'); return; }
      if(!(amount>0)){ UI.toast('Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }

      // Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³Ù†ÙˆÙŠ: Ø§Ø¹ØªØ¨Ø± ÙˆØ¬ÙˆØ¯ Ø±Ù‚Ù… ÙˆØ­Ø¯Ø© = ØµÙŠØ§Ù†Ø©
      const type = unitNumber ? 'ØµÙŠØ§Ù†Ø©' : 'Ø£Ø®Ø±Ù‰';

      
       const dObj = new Date(date);
       const year = dObj.getFullYear();
       const month = dObj.getMonth() + 1;
       const ym = `${year}-${pad2(month)}`;

       const newId = await FB.addExpense(bid, { type, serviceType, unitNumber, amount, date, notes, year, month, ym, attachmentsCount: 0 });

      // Ù…Ø±ÙÙ‚ Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
      const file = document.getElementById('exNewAttFile')?.files?.[0] || null;
      const displayName = (document.getElementById('exNewAttName')?.value || '').trim();
      if(file){
        try{
          await FB.addExpenseAttachment(bid, newId, file, { displayName });
        }catch(e){
          console.warn(e);
          UI.toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙØŒ Ù„ÙƒÙ† ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚');
        }
      }

      Actions.openExpenses(bid);
};

    const rows = document.getElementById('exRows');
    rows.onclick = async (ev)=>{
      const tr = ev.target.closest('tr[data-id]');
      if(!tr) return;
      const id = tr.getAttribute('data-id');
      const ex = (exps||[]).find(x=>x.id===id);
      if(!ex) return;

      if(ev.target.closest('[data-view]')){
        Actions.openExpenseAttachments(bid, id);
        return;
      }

      if(ev.target.closest('[data-del]')){
        if(!(window.AuthState && window.AuthState.isAdmin)){
          UI.toast('Ø§Ù„Ø­Ø°Ù Ù…ØªØ§Ø­ Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·');
          return;
        }
        if(UI.confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')){
          await FB.deleteExpense(bid, id);
          Actions.openExpenses(bid);
}
        return;
      }

      if(ev.target.closest('[data-edit]')){
        UI.openModal(`âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ`, `
          <div class="grid cols-2">
            <div style="grid-column:1/-1">
              <label>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
              <input id="edService" value="${UI.escapeAttr((ex.serviceType || ex.type || '').toString())}" placeholder="Ù…Ø«Ø§Ù„: ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ ØªÙ†Ø¸ÙŠÙ...">
            </div>

            <div>
              <label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="edUnit" value="${UI.escapeAttr((ex.unitNumber||'').toString())}" placeholder="Ù…Ø«Ø§Ù„: 101">
            </div>

            <div>
              <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø¹)</label>
              <input id="edAmount" type="number" step="0.001" value="${UI.escapeAttr(String(ex.amount||0))}">
            </div>

            <div>
              <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              <input id="edDate" type="date" value="${UI.escapeAttr(UI.dateISO(ex.date)||UI.todayISO())}">
            </div>

            <div style="grid-column:1/-1">
              <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
              <textarea id="edNotes" rows="2">${UI.escape(ex.notes||'')}</textarea>
            </div>
          </div>

          <div class="buttons-row" style="margin-top:10px">
            <button class="btn" id="edBack">Ø±Ø¬ÙˆØ¹</button>
            <button class="btn primary" id="edSave">Ø­ÙØ¸</button>
          </div>

          <div style="margin-top:10px">
            <label>Ø§Ù„Ù…Ø±ÙÙ‚</label>
            <div id="edAttInfo" class="muted" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px">
              ${firstAtt ? `
                <span class="pill">${UI.escape(firstAtt.name || 'Ù…Ø±ÙÙ‚')}</span>
                <button class="btn" id="edViewAtt" title="Ù…Ø¹Ø§ÙŠÙ†Ø©">ğŸ‘ï¸</button>
                <button class="btn danger" id="edRemoveAtt">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙÙ‚</button>
              ` : '<span class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚</span>'}
            </div>

            <div style="margin-top:10px">
              <input type="file" id="edNewAttFile" accept="image/*,application/pdf,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt" />
              <div class="muted small">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ Ø³ÙŠØ³ØªØ¨Ø¯Ù„ Ø§Ù„Ù…Ø±ÙÙ‚ Ø§Ù„Ø³Ø§Ø¨Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
            </div>
          </div>
        `);

        document.getElementById('edBack').onclick = ()=> Actions.openExpenses(bid);
if(firstAtt){
          const v = document.getElementById('edViewAtt');
          if(v) v.onclick = ()=> window.open(firstAtt.url, '_blank');
          const r = document.getElementById('edRemoveAtt');
          if(r) r.onclick = async ()=>{
            if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚ØŸ')) return;
            const list = await FB.listExpenseAttachments(bid, id);
            for(const a of list){ await FB.deleteExpenseAttachment(bid, id, a.id, a.path); }
            firstAtt = null;
            const box = document.getElementById('edAttInfo');
            if(box) box.innerHTML = '<span class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚</span>';
          };
        }

        document.getElementById('edSave').onclick = async ()=>{
          const serviceType = (document.getElementById('edService').value||'').trim();
          const unitNumber  = (document.getElementById('edUnit').value||'').trim();
          const amount      = Number(document.getElementById('edAmount').value||0);
          const date        = document.getElementById('edDate').value || UI.todayISO();
          const notes       = (document.getElementById('edNotes').value||'').trim();

          if(!serviceType){ UI.toast('Ø§ÙƒØªØ¨ Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ'); return; }
          if(!(amount>0)){ UI.toast('Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }

          try{
            const type = unitNumber ? 'ØµÙŠØ§Ù†Ø©' : 'Ø£Ø®Ø±Ù‰';
          const dObj = new Date(date);
            const year = dObj.getFullYear();
            const month = dObj.getMonth() + 1;
            const ym = `${year}-${pad2(month)}`;

            await FB.updateExpense(bid, id, { type, serviceType, unitNumber, amount, date, notes, year, month, ym });

          const newFile = document.getElementById('edNewAttFile')?.files?.[0];
          if(newFile){
            const list = await FB.listExpenseAttachments(bid, id);
            for(const a of list){ await FB.deleteExpenseAttachment(bid, id, a.id, a.path); }
            await FB.addExpenseAttachment(bid, id, newFile, { displayName: newFile.name });
          }

          Actions.openExpenses(bid);
          }catch(e){
            console.warn(e);
            UI.toast('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
          }
};
      }
    };
  };

  await draw();
},

openExpenseAttachments: async (bid, expenseId) => {
  bid = bid || State.activeBuildingId;
  if(!bid || !expenseId){ UI.toast('Ø§Ø®ØªØ± Ù…ØµØ±ÙˆÙÙ‹Ø§'); return; }

  // Ø§Ø­Ø¶Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙ Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
  let ex = null;
  try{
    const exps = await FB.listExpenses(bid);
    ex = (exps||[]).find(x=>x.id===expenseId) || null;
  }catch(_){ ex = null; }

  const exLabel = ex && (ex.serviceType || ex.type) ? ` â€” ${UI.escape(ex.serviceType || ex.type)}` : '';
  const headerTitle = `ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙ${exLabel}`;

  const draw = async ()=>{
    const atts = await FB.listExpenseAttachments(bid, expenseId);

    const rowsHtml = (atts||[]).map(a=>{
      const name = (a.displayName || a.name || a.originalName || 'Ù…Ø±ÙÙ‚');
      const dt   = UI.dateISO(a.uploadedAt) || '';
      const url  = a.url || '';
      const path = a.path || '';
      const id   = a.id || '';
      return `
        <tr data-id="${UI.escapeAttr(id)}" data-path="${UI.escapeAttr(path)}">
          <td>${UI.escape(name)}</td>
          <td style="direction:ltr;text-align:left">${UI.escape(a.originalName || '')}</td>
          <td>${UI.escape(dt)}</td>
          <td style="white-space:nowrap">
            ${url ? `<a class="btn" href="${UI.escapeAttr(url)}" target="_blank" rel="noopener">ØªØ­Ù…ÙŠÙ„</a>`
                  : `<button class="btn" data-dl>ØªØ­Ù…ÙŠÙ„</button>`}
            <button class="btn danger admin-only" data-del>Ø­Ø°Ù</button>
          </td>
        </tr>
      `;
    }).join('') || `<tr><td colspan="4" style="text-align:center;color:#666">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯</td></tr>`;

    UI.openModal(headerTitle, `
      <div class="card">
        <div class="card-h"><b>Ø±ÙØ¹ Ù…Ø±ÙÙ‚</b></div>
        <div class="card-c">
          <div class="grid cols-2" style="align-items:end">
            <div style="grid-column:1/-1">
              <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="exAttName" placeholder="Ù…Ø«Ø§Ù„: ÙØ§ØªÙˆØ±Ø© / Ø¹Ù‚Ø¯ / Ø¥ÙŠØµØ§Ù„">
            </div>
            <div style="grid-column:1/-1">
              <label>Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</label>
              <input type="file" id="exAttFile">
            </div>
            <div style="grid-column:1/-1;display:flex;gap:8px;flex-wrap:wrap">
              <button type="button" class="btn primary" id="exAttAdd">Ø±ÙØ¹</button>
              <button type="button" class="btn" id="exAttBack">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
              <div id="exAttMsg" class="muted" style="align-self:center"></div>
            </div>
          </div>
          <small class="muted">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ù…ØªØ§Ø­ Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·.</small>
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="card-h"><b>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</b></div>
        <div class="card-c" style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚</th>
                <th style="width:220px">Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù</th>
                <th style="width:120px">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th style="width:220px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="exAttRows">${rowsHtml}</tbody>
          </table>
        </div>
      </div>
    `);

    const msg = document.getElementById('exAttMsg');
    const addBtn = document.getElementById('exAttAdd');
    const backBtn = document.getElementById('exAttBack');

    if(backBtn) backBtn.onclick = ()=> Actions.openExpenses();

    if(addBtn){
      addBtn.onclick = async ()=>{
        const f = document.getElementById('exAttFile')?.files?.[0] || null;
        const displayName = (document.getElementById('exAttName')?.value || '').trim();
        if(!f){ UI.toast('Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§'); return; }

        addBtn.disabled = true;
        if(msg) msg.textContent = '... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹';
        try{
          await FB.addExpenseAttachment(bid, expenseId, f, { displayName });
          if(msg) msg.textContent = 'ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚.';
          // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
          Actions.openExpenseAttachments(bid, expenseId);
        }catch(e){
          console.warn(e);
          if(msg) msg.textContent = 'ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚.';
          UI.toast('ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚');
        }finally{
          addBtn.disabled = false;
        }
      };
    }

    const tbody = document.getElementById('exAttRows');
    if(tbody){
      tbody.onclick = async (ev)=>{
        const tr = ev.target.closest('tr[data-id]');
        if(!tr) return;
        const attId = tr.getAttribute('data-id');
        const storagePath = tr.getAttribute('data-path') || '';

        // ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ URL (Ø­Ø§Ù„Ø© Storage ÙØ´Ù„ Ø£Ùˆ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©)
        if(ev.target.matches('[data-dl]')){
          try{
            if(!DEMO_MODE && storage && storagePath){
              const url = await storage.ref().child(storagePath).getDownloadURL();
              window.open(url, '_blank', 'noopener');
            }else{
              UI.toast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù');
            }
          }catch(e){
            console.warn(e);
            UI.toast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù');
          }
          return;
        }

        if(ev.target.closest('[data-del]')){
          if(!(window.AuthState && window.AuthState.isAdmin)){
            UI.toast('Ø§Ù„Ø­Ø°Ù Ù…ØªØ§Ø­ Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·');
            return;
          }
          if(UI.confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙÙ‚ØŸ')){
            try{
              await FB.deleteExpenseAttachment(bid, expenseId, attId, storagePath);
              Actions.openExpenseAttachments(bid, expenseId);
            }catch(e){
              console.warn(e);
              UI.toast('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚');
            }
          }
          return;
        }
      };
    }
  };

  await draw();
},

  openMaintenanceAnnualReport: async ()=>{
  const bid = State.activeBuildingId;
  if (!bid) { UI.toast('Ø§Ø®ØªØ± Ù…Ø¨Ù†Ù‰ Ø£ÙˆÙ„Ù‹Ø§'); return; }

  const year = State.selYear;

  // Ø§Ø¬Ù„Ø¨ Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø¨Ù†Ù‰ ÙˆÙÙ„ØªØ± "ØµÙŠØ§Ù†Ø©" ÙÙ‚Ø· Ù„Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
  const exps = await FB.listExpenses(bid);
  const maint = exps.filter(e=>{
    if (String(e.type||'').trim() !== 'ØµÙŠØ§Ù†Ø©') return false;
    const d = asDate(e.date, false);
    return d && d.getUTCFullYear() === year;
  });

  // Ø±ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ØªØµØ§Ø¹Ø¯ÙŠÙ‹Ø§
  const sorted = [...maint].sort((a,b)=>{
    const da = asDate(a.date,false)?.getTime()||0;
    const db = asDate(b.date,false)?.getTime()||0;
    return da - db;
  });

  // Ù…Ø­ÙˆÙ‘Ù„ Ø¢Ù…Ù† Ù„Ù„ØªØ§Ø±ÙŠØ® (Firestore Timestamp Ø£Ùˆ Ù†Øµ)
  const toISO = (v)=>{
    if (v && typeof v.toDate === 'function') return v.toDate().toISOString().slice(0,10);
    if (!v) return '';
    try { return new Date(v).toISOString().slice(0,10); } catch { return ''; }
  };

  // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù†Ø©
  const grand = sorted.reduce((s,e)=> s + Number(e.amount||0), 0);

  // ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„: Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© â€¢ Ø§Ù„ØªØ§Ø±ÙŠØ® â€¢ Ø§Ù„ÙˆØ­Ø¯Ø© â€¢ Ø§Ù„Ù…Ø¨Ù„Øº â€¢ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
  const rows = sorted.map(e=>{
    const dStr = toISO(e.date);
    return `
      <tr>
        <td>${(e.serviceType||'').trim() || 'â€”'}</td>
        <td>${dStr}</td>
        <td>${e.unitNumber || 'â€”'}</td>
        <td>${Number(e.amount||0).toFixed(3)}</td>
        <td>${e.notes || ''}</td>
      </tr>
    `;
  }).join('');

  UI.openModal('ğŸ› ï¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³Ù†ÙˆÙŠ â€” ' + year, `
    <div class="card">
      <div class="card-h">
        <b>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø© (${sorted.length})</b>
        <span class="muted" style="font-weight:normal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${grand.toFixed(3)} Ø±.Ø¹</span>
      </div>
      <div class="card-c" style="max-height:70vh;overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø¹)</th>
              <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="5" style="text-align:center;color:#666">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª ØµÙŠØ§Ù†Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù….</td></tr>`}
          </tbody>
          ${rows ? `<tfoot><tr><th colspan="3" style="text-align:left">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>${grand.toFixed(3)}</th><th></th></tr></tfoot>` : ''}
        </table>
      </div>
    </div>

    <div class="buttons-row">
      <button class="btn" id="btnCsvMaint">ğŸ“„ ØªÙ†Ø²ÙŠÙ„ CSV</button>
      <button class="btn" id="btnPrintMaint">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
  `);

  // ØªÙ†Ø²ÙŠÙ„ CSV (ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯)
  document.getElementById('btnCsvMaint').onclick = ()=>{
    const clean = s => String(s||'').replace(/[\r\n,]/g,' ').trim();
    const lines = ['ServiceType,Date,Unit,AmountOMR,Notes'];
    sorted.forEach(e=>{
      lines.push([
        clean(e.serviceType||''),
        toISO(e.date),
        String(e.unitNumber||'').replace(/,/g,' '),
        Number(e.amount||0).toFixed(3),
        clean(e.notes||'')
      ].join(','));
    });
    const csv = lines.join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `maintenance_${year}.csv`;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
  };

  // Ø·Ø¨Ø§Ø¹Ø© (Ø¨Ù†ÙØ³ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯)
  document.getElementById('btnPrintMaint').onclick = ()=>{
    const win = window.open('', '_blank');
    const html = `<!DOCTYPE html><html dir="rtl" lang="ar"><head>
      <meta charset="utf-8"><title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø© ${year}</title>
      <style>
        body{font-family:Tajawal,system-ui,sans-serif;color:#111;padding:16px}
        h2{margin:0 0 12px}
        table{width:100%;border-collapse:collapse}
        th,td{border:1px solid #ccc;padding:6px 8px;vertical-align:top}
        thead{background:#f8fafc}
      </style>
    
<style id="mobile-enhancements">
/* === Mobile enhancements (phone-first) === */
@media (max-width: 640px) {
  html, body { font-size: 16px; }
  .container { padding: 12px; }
  header .container { flex-direction: column; align-items: stretch; gap: 8px; }
  .toolbar { width: 100%; overflow-x: auto; padding-bottom: 6px; -webkit-overflow-scrolling: touch; }
  .toolbar .btn { flex: 0 0 auto; }
  .card-h { align-items: stretch; }
  .card-h > div:last-child { width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
  .filters { gap: 6px; }
  input, select, textarea { width: 100%; }
  table { display: block; overflow-x: auto; white-space: nowrap; border-radius: 12px; }
  thead, tbody, tfoot, tr, th, td { border-collapse: separate; }
  /* Tenant rows: allow wrapping and stacking on small screens */
  [data-tenant-row] > div[style*="justify-content:flex-end"]{
    justify-content: stretch !important;
    gap: 6px !important;
    flex-wrap: wrap !important;
  }
  [data-tenant-row] .tenant-actions {
    width: 100% !important;
    flex-wrap: wrap !important;
  }
  [data-tenant-row] .tenant-actions .btn {
    flex: 1 1 calc(50% - 6px) !important;
    min-height: 44px !important;
  }
  [data-tenant-row] [data-del]{
    flex: 1 1 100% !important;
    min-height: 44px !important;
  }
  /* Force grid stacks for safety on phones */
  .grid { gap: 10px; }
  .grid.cols-2, .grid.cols-3 { grid-template-columns: 1fr !important; }
  /* Modal: fullscreen on phones */
  .modal-wrap .modal {
    width: 100vw !important;
    max-height: 100vh !important;
    height: 100vh !important;
    border-radius: 0 !important;
  }
  .modal .body { padding-bottom: 72px; }
  .modal .buttons-row {
    position: sticky;
    bottom: 0;
    background: #fff;
    padding: 10px;
    border-top: 1px solid var(--border);
  }
  /* Chips and tabs: horizontal scroll if overflow */
  .filters, #bizTabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .chip { flex: 0 0 auto; }
  /* KPI cards readability */
  .stat { font-size: 14px; }
  /* Building cards: compact layout */
  #buildingsGrid .icon-card { display: grid; grid-template-columns: 56px 1fr; align-items: center; gap: 10px; }
  #buildingsGrid .icon-card .circle { grid-row: span 2; }
}
@media (max-width: 370px){
  .card-h > div:last-child { grid-template-columns: 1fr; }
  [data-tenant-row] .tenant-actions .btn { flex-basis: 100% !important; }
}
/* Better tap targets */
.btn { touch-action: manipulation; }
</style>

</head><body>
      <h2>ğŸ› ï¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³Ù†ÙˆÙŠ â€” ${year}</h2>
      <table>
        <thead>
          <tr>
            <th>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø¹)</th>
            <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          </tr>
        </thead>
        <tbody>${rows || '<tr><td colspan="5" style="text-align:center;color:#666">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>'}</tbody>
        ${rows ? `<tfoot><tr><th colspan="3" style="text-align:left">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>${grand.toFixed(3)}</th><th></th></tr></tfoot>` : ''}
      </table>
      <script>window.print();<\/script>
    </body></html>`;
    if (win) { win.document.open(); win.document.write(html); win.document.close(); }
    else {
      const iframe = document.createElement('iframe');
      iframe.style.display='none';
      document.body.appendChild(iframe);
      iframe.contentDocument.open(); iframe.contentDocument.write(html); iframe.contentDocument.close();
      setTimeout(()=>{ iframe.contentWindow.print(); document.body.removeChild(iframe); }, 100);
    }
  };
},
openAttachments: async () => {
  const bid = State.activeBuildingId;
  if (!bid) return;

  UI.openModal('ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø¨Ù†Ù‰', `
    <div class="grid cols-2" style="align-items:end">
      <div style="grid-column:1/-1">
        <label>Ø±ÙØ¹ Ù…Ù„ÙØ§Øª</label>
        <input type="file" id="attUpload" multiple>
        <small style="color:#6b7280">Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§ ÙˆØ³ÙŠØªÙ… Ø±ÙØ¹Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© (PDF, ØµÙˆØ±, ...)</small>
      </div>
    </div>
    <div id="attMsg" class="muted" style="margin-top:8px"></div>
    <div class="table-wrap" style="margin-top:10px">
      <table class="table">
        <thead>
          <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ø¬Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
        </thead>
        <tbody id="attRows">
          <tr><td colspan="4" style="text-align:center;color:#666">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>
        </tbody>
      </table>
    </div>
  `);

  const fmtSize = (n)=> {
    if (!n && n !== 0) return '';
    const k = 1024, mb = k*k;
    return n >= mb ? (n/mb).toFixed(2)+' MB' : (n/k).toFixed(0)+' KB';
  };

  const draw = async () => {
    const list = await FB.listAttachments(bid);
    const rows = list.map(it => `
      <tr data-id="${it.id}" data-path="${it.path||''}">
        <td><a href="${it.url}" target="_blank" rel="noopener">${it.name||''}</a></td>
        <td>${fmtSize(it.size)}</td>
        <td>${(it.uploadedAt && (it.uploadedAt.toDate?.() || it.uploadedAt)).toLocaleString?.('ar-OM') || ''}</td>
        <td>
          <a class="btn" href="${it.url}" target="_blank" rel="noopener">Ø¹Ø±Ø¶/ØªÙ†Ø²ÙŠÙ„</a>
          <button class="btn danger admin-only" data-del>Ø­Ø°Ù</button>
        </td>
      </tr>
    `).join('');
    document.getElementById('attRows').innerHTML = rows || `
      <tr><td colspan="4" style="text-align:center;color:#666">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯</td></tr>`;
  };

  // Ø±ÙØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
  document.getElementById('attUpload').addEventListener('change', async (e)=>{
    const msg = document.getElementById('attMsg');
    const files = Array.from(e.target.files||[]);
    if (!files.length) return;
    try {
      msg.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø±ÙØ¹â€¦';
      for (const f of files) { await FB.addAttachment(bid, f); }
      msg.textContent = 'âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­';
      e.target.value = '';
      await draw();
    } catch (err) {
      console.error(err);
      msg.textContent = 'âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ' + (err?.message || err);
      alert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù. ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø£Ùˆ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.');
    }
  });

  // Ø­Ø°Ù
  document.getElementById('attRows').addEventListener('click', async (e)=>{
    const tr = e.target.closest('tr[data-id]');
    if (!tr) return;
    if (e.target.matches('[data-del]')) {
      if (UI.confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚ØŸ')) {
        await FB.deleteAttachment(bid, tr.getAttribute('data-id'), tr.getAttribute('data-path')||'');
        await draw();
      }
    }
  });

  await draw();
},

    renderReport(){ UI.toast('Ù…ÙŠØ²Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø³ÙŠÙ†.'); },
    openImportCSV: async ()=>{
  const bid = App.State.activeBuildingId;
  if (!bid) return;

  // Ù„Ù…Ø¹Ø±ÙØ© Ù‡Ù„ Ù†Ø³Ù…ÙŠÙ‡ "Ù…Ø³ØªØ£Ø¬Ø±" Ø£Ùˆ "Ù…Ø§Ù„Ùƒ" Ø£Ùˆ "Ø²Ø¨ÙˆÙ†"
  let bizT = 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ';
  let isOA = false;
  let isVal = false;
  if (DEMO_MODE) {
    const bDemo = DemoStore.getBuilding(bid) || {};
    bizT = (bDemo.bizType || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
  } else {
    const bDoc = await firebase.firestore().collection('buildings').doc(bid).get();
    bizT = ((bDoc.data()||{}).bizType || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
  }
  isOA = (bizT === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
  isVal = (bizT === 'ØªØ«Ù…ÙŠÙ†');
  const sing = isVal ? 'Ø²Ø¨ÙˆÙ†' : (isOA ? 'Ù…Ø§Ù„Ùƒ' : 'Ù…Ø³ØªØ£Ø¬Ø±');
  const plural = isVal ? 'Ø²Ø¨Ø§Ø¦Ù†' : (isOA ? 'Ù…Ù„Ø§Ùƒ' : 'Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†');

  const csvPlaceholder = isOA
    ? 'OWNER NAME,PH NUMBER,AP NO,TYPE OF AP,AP AREA,TOTAL AMOUNT'
    : 'kind,unitNumber,tenantName,rent,phone,nationalId,startDate,endDate,paymentType,graceEnabled,graceMonths,notes';

  // ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø³ÙŠØ·Ø©: Ø±ÙØ¹ Ù…Ù„Ù Ø£Ùˆ Ù„ØµÙ‚ CSV + Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
  App.UI.openModal('ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ ' + plural + ' (CSV)', `
    <div class="grid cols-2">
      <div style="grid-column:1/-1">
        <label>Ù…Ù„Ù CSV</label>
        <input id="csvFile" type="file" accept=".csv,text/csv">
        <small class="muted">Ø§Ù„ØªØ±Ù…ÙŠØ² UTF-8ØŒ Ø§Ù„ÙØ§ØµÙ„ ÙØ§ØµÙ„Ø© Ø£Ùˆ ÙØ§ØµÙ„Ø© Ù…Ù†Ù‚ÙˆØ·Ø©ØŒ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù‚ÙŠÙ… Ø¨ÙŠÙ† Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù‚ØªØ¨Ø§Ø³.</small>
      </div>
      <div style="grid-column:1/-1">
        <label>Ø£Ùˆ Ø§Ù„ØµÙ‚ CSV Ù…Ø¨Ø§Ø´Ø±Ø©</label>
        <textarea id="csvPaste" rows="7" placeholder="${csvPlaceholder}"></textarea>
      </div>
      <div style="grid-column:1/-1;display:flex;gap:8px;justify-content:flex-end">
        <button type="button" class="btn" id="csvPreview">Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
        <button type="button" class="btn primary" id="csvImport" disabled>Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      </div>
    </div>
    <div id="csvMsg" class="muted" style="margin-top:10px"></div>
    <div id="csvTableWrap" style="margin-top:10px; max-height:320px; overflow:auto"></div>
  `);

  const $ = App.utils.$;
  const $$ = App.utils.$$;
  const msg = $('#csvMsg');
  const wrap = $('#csvTableWrap');

  // ====== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø­Ù„ÙŠØ© ======
  const mapDigit = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
  const normDigits = s => String(s??'').replace(/[Ù -Ù©]/g, d=>mapDigit[d]||d);
  const toNum = v => {
    let s = normDigits(v).trim().replace(/,/g,'.');
    s = s.replace(/[^\d.\-]/g,'');
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  };
  const toBool = v => {
    const s = (String(v||'').trim()).toLowerCase();
    return ['1','true','yes','y','âœ“','âœ”','Ù†Ø¹Ù…','ØµØ­','Ù…ÙØ¹Ù„','on'].includes(s);
  };
  const toKind = k => {
    const s = String(k||'').toLowerCase();
    if (/Ø´Ù‚Ø©|apartment/.test(s)) return 'apartment';
    if (/Ù…Ø­Ù„|shop/.test(s))     return 'shop';
    if (/Ù…Ø¹Ø±Ø¶|showroom/.test(s))return 'showroom';
    if (/Ù‚Ø¨Ùˆ|Ù‚Ø¨|basement/.test(s)) return 'basement';
    return 'apartment';
  };
  const toPaymentType = v=>{
    const s = String(v||'').toLowerCase();
    if (/delayed|Ù…Ø¤Ø®Ø±|Ù…Ø¤Ø®Ø±Ø§Ù‹/.test(s)) return 'delayed';
    return 'advance';
  };
  const ymd = d => d ? d.toISOString().slice(0,10) : '';
  const tryDate = (v)=>{
    if(!v) return '';
    v = String(v).trim();
    // ÙŠØ¯Ø¹Ù… YYYY-MM-DD Ø£Ùˆ DD/MM/YYYY Ø£Ùˆ YYYY/MM/DD
    let m = v.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
    if(m){ return ymd(new Date(Date.UTC(+m[1], +m[2]-1, +m[3]))); }
    m = v.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if(m){ return ymd(new Date(Date.UTC(+m[3], +m[2]-1, +m[1]))); }
    const d2 = new Date(v);
    return isNaN(d2) ? '' : ymd(new Date(Date.UTC(d2.getFullYear(), d2.getMonth(), d2.getDate())));
  };

  // CSV Parser Ø¨Ø³ÙŠØ· ÙŠØ¯Ø¹Ù… Ø§Ù„ÙÙˆØ§ØµÙ„ Ø¯Ø§Ø®Ù„ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù‚ØªØ¨Ø§Ø³ ÙˆÙ…Ø­Ø¯Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ (, Ø£Ùˆ ;)
  function parseCSV(text){
    if(!text) return {headers:[], rows:[]};
    text = text.replace(/^\uFEFF/,''); // BOM
    const firstLine = (text.split(/\r?\n/)[0]||'');
    const delim = (firstLine.split(';').length > firstLine.split(',').length) ? ';' : ',';

    const rows = [];
    let cur = '', inQ = false, row = [];
    for(let i=0;i<text.length;i++){
      const ch = text[i], nx = text[i+1];
      if(ch === '"'){
        if(inQ && nx === '"'){ cur += '"'; i++; continue; }
        inQ = !inQ; continue;
      }
      if(!inQ && (ch === '\n' || ch === '\r')){
        if(ch === '\r' && nx === '\n') i++; // CRLF
        row.push(cur); rows.push(row); row = []; cur = '';
        continue;
      }
      if(!inQ && ch === delim){ row.push(cur); cur=''; continue; }
      cur += ch;
    }
    row.push(cur); rows.push(row);

    const headers = (rows.shift()||[]).map(h=>String(h||'').trim());
    return { headers, rows };
  }

  // Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù CSV Ø¨Ø´ÙƒÙ„ Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª (File.text + FileReader fallback)
  async function readFileText(file){
    if(!file) return '';
    try{
      if (typeof file.text === 'function') return await file.text();
    }catch(e){ /* fallback */ }
    return await new Promise((resolve, reject)=>{
      try{
        const r = new FileReader();
        r.onload = ()=> resolve(String(r.result||''));
        r.onerror = ()=> reject(r.error || new Error('FileReader error'));
        r.readAsText(file, 'utf-8');
      }catch(err){ reject(err); }
    });
  }

  // mapping Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)
  const aliases = {
    kind: ['kind','type of ap','type_of_ap','unit type','unittype','type','Ù†ÙˆØ¹','Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø©','Ø§Ù„ÙˆØ­Ø¯Ø©/Ø§Ù„Ù†ÙˆØ¹'],
    unitNumber: ['unit','unitnumber','unit_no','ap no','ap_no','apno','ap number','Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©','Ø±Ù‚Ù… Ø§Ù„Ø´Ù‚Ø©','Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ù„','Ø§Ù„Ø´Ù‚Ø©','Ø§Ù„Ù…Ø­Ù„','Ø§Ù„ÙˆØ­Ø¯Ø©'],
    unitArea: ['unitarea','ap area','ap_area','aparea','area','sqm','sq m','m2','mÂ²','Ø§Ù„Ù…Ø³Ø§Ø­Ø©','Ù…Ø³Ø§Ø­Ø©'],
    tenantName: ['tenantname','owner name','ownername','owner','name','Ø§Ù„Ø§Ø³Ù…','Ø§Ø³Ù…','Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±','Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ'],
    rent: ['rent','total amount','total_amount','totalamount','total','amount','annual contribution','contribution','Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø©','Ù…Ø³Ø§Ù‡Ù…Ø©','Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©','Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±','Ø§Ù„Ø§Ø¬Ø§Ø±','Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±','Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø¯Ù…Ø©'],
    phone: ['phone','ph number','phonenumber','ph no','mobile','tel','Ø§Ù„Ù‡Ø§ØªÙ','Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ','Ø¬ÙˆØ§Ù„'],
    nationalId: ['nationalid','civilid','id','idnumber','Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©','Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©','Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©'],
    startDate: ['start','startdate','from','Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯','ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©','ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„','ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨'],
    endDate: ['end','enddate','to','Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯','ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡'],
    paymentType: ['paymenttype','Ø§Ù„Ø¯ÙØ¹','Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹'],
    graceEnabled: ['grace','graceenabled','Ø³Ù…Ø§Ø­','Ø³Ù…Ø§Ø­ØŸ','ÙØªØ±Ø© Ø³Ù…Ø§Ø­ØŸ'],
    graceMonths: ['gracemonths','Ù…Ø¯Ø© Ø§Ù„Ø³Ù…Ø§Ø­','Ø£Ø´Ù‡Ø± Ø§Ù„Ø³Ù…Ø§Ø­'],
    notes: ['notes','Ù…Ù„Ø§Ø­Ø¸Ø§Øª','Ù…Ù„Ø§Ø­Ø¸Ø©'],
    // Ø§Ø®ØªÙŠØ§Ø±ÙŠ
    nationalIdImageUrl: ['nationalidimageurl','id_image_url','ØµÙˆØ±Ø©_Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©_url'],
    nationalIdImagePath:['nationalidimagepath','id_image_path','Ù…Ø³Ø§Ø±_ØµÙˆØ±Ø©_Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©']
  };
  const findKey = (hdrs, keys)=>{
    const idx = hdrs.findIndex(h=>{
      const hh = String(h||'').trim().toLowerCase();
      return keys.includes(hh);
    });
    return idx >= 0 ? idx : -1;
  };

  let parsed = null;
  let items  = [];

  async function doPreview(){
    try{
    msg.textContent = '';
    wrap.innerHTML = '';
    $('#csvImport').disabled = true;

    // Ø§Ù‚Ø±Ø£ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø§Ù„Ù„ØµÙ‚
    let text = '';
    const f = $('#csvFile').files?.[0];
    if (f){
      text = await readFileText(f);
    } else {
      text = $('#csvPaste').value || '';
    }
    if(!text.trim()){
      msg.textContent = 'Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§ Ø£Ùˆ Ø§Ù„ØµÙ‚ Ù…Ø­ØªÙˆÙ‰ CSV Ø£ÙˆÙ„Ø§Ù‹.';
      return;
    }

    parsed = parseCSV(text);
    if(!parsed.headers.length){
      msg.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙ Ø±Ø¤ÙˆØ³ (Header).';
      return;
    }

    // Ø¨Ù†ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    const H = parsed.headers.map(h => String(h||'').trim());
    const colIdx = {};
    Object.keys(aliases).forEach(key=>{
      colIdx[key] = findKey(H, aliases[key]);
    });

    // ØªØ­Ù‚Ù‚ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    const coreMissing = [];
    if (colIdx.unitNumber < 0) coreMissing.push(isOA ? 'AP NO (unitNumber)' : 'Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© (unitNumber)');
    if (colIdx.tenantName < 0) coreMissing.push(isVal ? 'Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† (tenantName)' : (isOA ? 'OWNER NAME (tenantName)' : 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± (tenantName)'));

    if (isOA){
      if (colIdx.phone < 0)    coreMissing.push('PH NUMBER (phone)');
      if (colIdx.kind < 0)     coreMissing.push('TYPE OF AP (kind)');
      if (colIdx.unitArea < 0) coreMissing.push('AP AREA (unitArea)');
      if (colIdx.rent < 0)     coreMissing.push('TOTAL AMOUNT (rent)');
    } else {
      if (colIdx.rent < 0)      coreMissing.push(isVal ? 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø¯Ù…Ø© (rent)' : 'Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± (rent)');
      if (colIdx.startDate < 0) coreMissing.push(isVal ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨ (startDate)' : 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (startDate)');
    }
    if (coreMissing.length){
      msg.textContent = 'Ø£Ø¹Ù…Ø¯Ø© Ø£Ø³Ø§Ø³ÙŠØ© Ù†Ø§Ù‚ØµØ©: ' + coreMissing.join('ØŒ ');
      return;
    }

    const selY = App.State.selYear, selM = App.State.selMonth;
    const startDefault = ymd(App.startOfMonth ? App.startOfMonth(selY, selM) : new Date());

    items = parsed.rows
      .filter(r => r.some(c => String(c||'').trim() !== ''))
      .map((r,i)=>{
        const get = idx => (idx>=0 ? r[idx] : '');
        const obj = {
          kind:        toKind(get(colIdx.kind)),
          unitNumber:  String(get(colIdx.unitNumber)||'').trim(),
          unitArea:    String(get(colIdx.unitArea)||'').trim(),
          tenantName:  String(get(colIdx.tenantName)||'').trim(),
          rent:        toNum(get(colIdx.rent)),
          phone:       String(get(colIdx.phone)||'').trim(),
          nationalId:  normDigits(get(colIdx.nationalId)).trim(),
          startDate:   (isOA ? '' : (tryDate(get(colIdx.startDate)) || startDefault)),
          endDate:     (isOA ? '' : (tryDate(get(colIdx.endDate)) || '')),
          paymentType: (isOA ? 'advance' : toPaymentType(get(colIdx.paymentType))),
          graceEnabled: (isOA ? false : toBool(get(colIdx.graceEnabled))),
          graceMonths: (isOA ? 0 : Math.max(0, parseInt(normDigits(get(colIdx.graceMonths)||'0'))||0)),
          notes:       String(get(colIdx.notes)||'').trim()
        };
        if (colIdx.nationalIdImageUrl >= 0)  obj.nationalIdImageUrl  = String(get(colIdx.nationalIdImageUrl)||'').trim();
        if (colIdx.nationalIdImagePath >= 0) obj.nationalIdImagePath = String(get(colIdx.nationalIdImagePath)||'').trim();
        return obj;
      })
      .filter(x => x.tenantName && x.unitNumber); // ØµÙÙˆÙ ØµØ§Ù„Ø­Ø© ÙÙ‚Ø·

    if (!items.length){
      msg.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙˆÙ ØµØ§Ù„Ø­Ø© Ø¨Ø¹Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.';
      return;
    }

    // Ø¬Ø¯ÙˆÙ„ Ù…Ø¹Ø§ÙŠÙ†Ø©
    const tDefLocal = (typeof isVal !== 'undefined' && isVal) ? 'Ø§Ù„Ø²Ø¨ÙˆÙ†' : ((typeof isOA !== 'undefined' && isOA) ? 'Ø§Ù„Ù…Ø§Ù„Ùƒ' : 'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±');

    let head = '';
    let body = '';

    if (isOA){
      head = `
        <thead><tr>
          <th>OWNER NAME</th><th>PH NUMBER</th><th>AP NO</th><th>TYPE OF AP</th><th>AP AREA</th><th>TOTAL AMOUNT</th>
        </tr></thead>`;
      body = items.map(it=>`
        <tr>
          <td>${it.tenantName}</td>
          <td>${it.phone||''}</td>
          <td>${it.unitNumber}</td>
          <td>${(typeof window.labelKind==='function'? labelKind(it.kind): it.kind)}</td>
          <td>${it.unitArea||''}</td>
          <td>${Number(it.rent||0).toFixed(3)}</td>
        </tr>
      `).join('');
    } else {
      const rentLabel = (isVal ? 'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø¯Ù…Ø©' : 'Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±');
      const startLabel = (isVal ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨' : 'Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©');
      head = `
        <thead><tr>
          <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>${tDefLocal}</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>${rentLabel}</th>
          <th>${startLabel}</th><th>Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        </tr></thead>`;
      body = items.map(it=>`
        <tr>
          <td>${it.unitNumber}</td>
          <td>${it.tenantName}</td>
          <td>${(typeof window.labelKind==='function'? labelKind(it.kind): it.kind)}</td>
          <td>${Number(it.rent||0).toFixed(3)}</td>
          <td>${it.startDate||''}</td>
          <td>${it.endDate||''}</td>
          <td>${it.phone||''}</td>
          <td>${it.notes||''}</td>
        </tr>
      `).join('');
    }

    wrap.innerHTML = `
      <div class="card">
        <div class="card-h"><b>Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</b> <span class="muted">(${items.length} ØµÙ)</span></div>
        <div class="card-c" style="overflow:auto">
          <table>${head}<tbody>${body}</tbody></table>
        </div>
      </div>
    `;
    $('#csvImport').disabled = false;
    msg.textContent = 'Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØµØ­ÙŠØ­Ø© Ø§Ø¶ØºØ· "Ø§Ø³ØªÙŠØ±Ø§Ø¯". Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†.';

    } catch(err){
      console.error('CSV preview error', err);
      wrap.innerHTML = '';
      $('#csvImport').disabled = true;
      msg.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©: ' + (err && err.message ? err.message : String(err||''));
    }

  }

  async function doImport(){
    $('#csvImport').disabled = true;
    $('#csvPreview').disabled = true;
    msg.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯â€¦';

    let ok=0, fail=0;
    for (const it of items){
      try{
        // Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ù„Ø§ ØªÙÙ…Ù„Ø£ Ù„ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ± Ù‡Ù†Ø§Ø› ÙÙ‚Ø· Ù†Ù…Ø±Ø± notes Ø§Ù„Ø¹Ø§Ù…Ø©
        const payload = {
          kind: it.kind,
          unitNumber: it.unitNumber,
          tenantName: it.tenantName,
          rent: Number(it.rent||0),
          phone: it.phone||'',
          nationalId: it.nationalId||'',
          notes: it.notes||'',
          payments: {}
        };

        if (isOA){
          // Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ: rent = Ø§Ù„Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©
          payload.annualContribution = Number(it.rent||0);
          if (it.unitArea) payload.unitArea = it.unitArea;
        } else {
          payload.startDate = it.startDate;
          payload.endDate = it.endDate||'';
          payload.paymentType = it.paymentType||'advance';
          payload.graceEnabled = !!it.graceEnabled;
          payload.graceMonths = Number(it.graceMonths||0);
        }
        // Ù„Ùˆ Ø§Ù„Ù…Ù„Ù ÙÙŠÙ‡ URL/Path Ù„Ù„ØµÙˆØ±Ø© Ù†Ø®Ø²Ù†Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ (Ù„Ù† Ù†Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ù…Ù† CSV)
        if (it.nationalIdImageUrl)  payload.nationalIdImageUrl  = it.nationalIdImageUrl;
        if (it.nationalIdImagePath) payload.nationalIdImagePath = it.nationalIdImagePath;

        await App.FB.addTenant(bid, payload);
        ok++;
      }catch(e){
        console.warn('Import row failed', e);
        fail++;
      }
    }

    msg.textContent = `ØªÙ…: ${ok} âœ… â€” ÙØ´Ù„: ${fail} âŒ`;
    // Ø­Ø¯Ù‘Ø« Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
    setTimeout(()=>{ App.UI.closeModal(); App.Render.building(); }, 800);
  }

  const __p = $('#csvPreview');
  const __i = $('#csvImport');
  if(__p) __p.addEventListener('click', (ev)=>{ ev.preventDefault(); doPreview(); });
  if(__i) __i.addEventListener('click', (ev)=>{ ev.preventDefault(); doImport(); });
}

  };

  function openUpsertBuildingModal(mode, existing){
    const isEdit = mode === 'edit';
    const b = existing || {};
    const counts = b.counts || {apartments:Number(b.apartments||0),shops:Number(b.shops||0),showrooms:Number(b.showrooms||0),basements:Number(b.basements||0)};
    const bizType = b.bizType || App.State.bizTab || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ';
    const feeType = b.feeType || 'percentage';
    const feeValue = (b.feeValue!=null ? b.feeValue : '');
    const electricAccount = b.electricAccount || '';
    const internetNumber = b.internetNumber || '';
    const guardPhone = b.guardPhone || '';
    const sewageTruckPhone = b.sewageTruckPhone || '';
    const coordsLink = b.coordsLink || b.mapLink || b.coordinates || '';
    const totalArea = (b.totalArea!=null ? b.totalArea : '');
    const waterAccount = b.waterAccount || '';
    const bankAccount = b.bankAccount || b.buildingBankAccount || '';
    const guardName = b.guardName || '';
    const buildingImage = b.buildingImage || b.imageData || b.imageUrl || '';

    const entityTitle = (bizType==='ØªØ«Ù…ÙŠÙ†') ? 'Ø¨Ù†Ùƒ' : 'Ù…Ø¨Ù†Ù‰';

    UI.openModal(isEdit? ('ØªØ¹Ø¯ÙŠÙ„ ' + entityTitle) : ('Ø¥Ø¶Ø§ÙØ© ' + entityTitle), `<div class="grid cols-2">
  <div data-bank-hide>
    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„</label>
    <select id="mbBizType">
      <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ" ${bizType==='Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ'?'selected':''}>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</option>
      <option value="Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ" ${bizType==='Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ'?'selected':''}>Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ</option>
      <option value="ØªØ«Ù…ÙŠÙ†" ${bizType==='ØªØ«Ù…ÙŠÙ†'?'selected':''}>ØªØ«Ù…ÙŠÙ†</option>
    </select>
  </div>
  <div data-bank-hide>
    <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£Ø¬Ø±Ø© (Ù†Ø³Ø¨Ø©/Ø±Ø§ØªØ¨)</label>
    <select id="mbFeeType">
      <option value="percentage" ${feeType==='percentage'?'selected':''}>Ù†Ø³Ø¨Ø©</option>
      <option value="salary" ${feeType==='salary'?'selected':''}>Ø±Ø§ØªØ¨</option>
    </select>
  </div>

  <div style="grid-column:1/-1" data-bank-hide>
    <label id="mbFeeLabel">${feeType==='salary'?'Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±.Ø¹)':'Ø§Ù„Ù†Ø³Ø¨Ø© (%)'}</label>
    <input id="mbFeeValue" type="number" inputmode="decimal" step="0.01" value="${feeValue}" placeholder="${feeType==='salary'?'Ù…Ø«Ø§Ù„: 150 (Ø±.Ø¹)':'Ù…Ø«Ø§Ù„: 15 (Ùª)'}">
  </div>

  <div style="grid-column:1/-1">
    <label id="mbNameLabel">Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰</label>
    <input id="mbName" value="${b.name||''}" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¨Ù†Ù‰ Ø§Ù„Ø³ÙŠÙØ©">
  </div>

  <!-- Bank-only fields (ØªØ«Ù…ÙŠÙ†) -->
  <div style="grid-column:1/-1" data-bank-only>
    <label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ø¹ Ø§Ù„Ø¨Ù†Ùƒ</label>
    <input id="mbBankContractStart" type="date" value="${b.bankContractStart||''}">
  </div>
  <div data-bank-only><label>Ø§Ø³Ù… Ø´Ø®Øµ Ø§Ù„ØªÙˆØ§ØµÙ„</label><input id="mbBankContactName" value="${(b.bankContact||{}).name||''}" placeholder="Ø§Ù„Ø§Ø³Ù…"></div>
  <div data-bank-only><label>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label><input id="mbBankContactTitle" value="${(b.bankContact||{}).title||''}" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¯ÙŠØ± Ø¹Ù„Ø§Ù‚Ø§Øª"></div>
  <div data-bank-only><label>Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„</label><input id="mbBankContactPhone" inputmode="tel" value="${(b.bankContact||{}).phone||''}" placeholder="9xxxxxxx"></div>
  <div data-bank-only><label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label><input id="mbBankContactEmail" type="email" value="${(b.bankContact||{}).email||''}" placeholder="name@bank.com"></div>

  <div data-bank-hide><label id="mbLocLabel">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¨Ù†Ù‰</label><input id="mbLocation" value="${b.location||''}" placeholder="Ù…Ø«Ø§Ù„: ÙˆÙ„Ø§ÙŠØ© ØµÙˆØ± - Ø§Ù„Ø³ÙŠÙØ©"></div>
  <div data-bank-hide data-hoa-hide><label>Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„</label><input id="mbContact" inputmode="tel" value="${b.contact||''}" placeholder="9xxxxxxx"></div>

  <div style="grid-column:1/-1" data-val-only data-bank-hide>
    <label id="mbCoordsLabel">Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ø±Ø§Ø¨Ø· Google Maps)</label>
    <input id="mbCoords" value="${coordsLink}" placeholder="https://maps.google.com/...">
  </div>

  <div style="grid-column:1/-1" data-bank-hide data-hoa-hide><label id="mbOwnerLabel">Ø§Ù„Ù…Ø§Ù„Ùƒ</label><input id="mbOwner" value="${b.owner||''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ"></div>

  <div style="grid-column:1/-1" data-val-only data-bank-hide>
    <label id="mbImageLabel">ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¨Ù†Ù‰</label>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input id="mbImage" type="file" accept="image/*" style="flex:1">
      <button type="button" class="btn" id="mbImageClear">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©</button>
    </div>
    <div style="margin-top:8px">
      <img id="mbImagePreview" src="${buildingImage||''}" style="max-width:100%;max-height:180px;object-fit:cover;border:1px solid var(--border);border-radius:12px;display:${buildingImage?'block':'none'}">
    </div>
    <div class="muted" style="font-size:12px;margin-top:6px">Ø§Ù„ØµÙˆØ±Ø© ØªÙØ­ÙØ¸ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù†Ø³Ø®Ø© Ù…Ø¹Ø§ÙŠÙ†Ø©).</div>
  </div>

  <div style="grid-column:1/-1" data-bank-hide><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="mbNotes" rows="2" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©">${b.notes||''}</textarea></div>

  <div data-bank-hide><label>Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‚Ù‚</label><input id="mbApt" type="number" min="0" value="${Number(counts.apartments||0)}"></div>
  <div data-bank-hide><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ù„Ø§Øª</label><input id="mbShop" type="number" min="0" value="${Number(counts.shops||0)}"></div>
  <div data-bank-hide><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ø±Ø¶</label><input id="mbShow" type="number" min="0" value="${Number(counts.showrooms||0)}"></div>
  <div data-bank-hide><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø¨Ùˆ</label><input id="mbBase" type="number" min="0" value="${Number(counts.basements||0)}"></div>

  <div style="grid-column:1/-1" data-val-only data-bank-hide>
    <label>Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ø¨Ù†Ø§ÙŠØ© (Ù…Â²)</label>
    <input id="mbTotalArea" type="number" inputmode="decimal" step="0.01" value="${totalArea}" placeholder="Ù…Ø«Ø§Ù„: 1250">
  </div>

  <div data-bank-hide><label>Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</label><input id="mbElectric" value="${electricAccount}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨"></div>

  <div data-val-only data-bank-hide><label>Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙŠØ§Ù‡</label><input id="mbWater" value="${waterAccount}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨"></div>
  <div data-val-only data-bank-hide><label>Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†Ùƒ Ù„Ù„Ø¨Ù†Ø§ÙŠØ©</label><input id="mbBankAcc" value="${bankAccount}" placeholder="OMxx xxxx xxxx xxxx"></div>

  <div data-nonval-only><label>Ø±Ù‚Ù… Ø§Ù†ØªØ±Ù†Øª Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</label><input id="mbInternet" value="${internetNumber}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ/Ø§Ù„Ø­Ø³Ø§Ø¨"></div>
  <div data-nonval-only><label>Ø±Ù‚Ù… Ø³Ø§Ø¦Ù‚ Ù†Ø§Ù‚Ù„Ø© Ø§Ù„Ù…Ø¬Ø§Ø±ÙŠ</label><input id="mbSewage" value="${sewageTruckPhone}" placeholder="Ù‡Ø§ØªÙ Ø§Ù„Ø³Ø§Ø¦Ù‚"></div>

  <div data-bank-hide><label>Ø§Ø³Ù… Ø­Ø§Ø±Ø³ Ø§Ù„Ù…Ø¨Ù†Ù‰</label><input id="mbGuardName" value="${guardName}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ø±Ø³"></div>
  <div data-bank-hide><label>Ø±Ù‚Ù… Ø­Ø§Ø±Ø³ Ø§Ù„Ù…Ø¨Ù†Ù‰</label><input id="mbGuard" value="${guardPhone}" placeholder="Ù‡Ø§ØªÙ Ø§Ù„Ø­Ø§Ø±Ø³"></div>

  <div id="valAttSection" style="grid-column:1/-1" data-val-only>
    <div class="card" style="margin-top:6px">
      <div class="card-h"><b>ğŸ“ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</b> <span class="muted" id="mbAttHint"></span></div>
      <div class="card-c">
        <div class="grid cols-2" style="align-items:end">
          <div style="grid-column:1/-1">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚</label>
            <input id="mbAttName" placeholder="Ù…Ø«Ø§Ù„: ØªÙ‚Ø±ÙŠØ± ØªØ«Ù…ÙŠÙ† / ØµÙˆØ±Ø© Ø¹Ø¯Ø§Ø¯ / Ø¹Ù‚Ø¯">
          </div>
          <div style="grid-column:1/-1">
            <label>Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</label>
            <input type="file" id="mbAttFiles" multiple>
          </div>
          <div style="grid-column:1/-1;display:flex;gap:8px;flex-wrap:wrap">
            <button type="button" class="btn" id="mbAttUploadBtn">â¬†ï¸ Ø±ÙØ¹</button>
            <div id="mbAttMsg" class="muted" style="align-self:center"></div>
          </div>
        </div>

        <div style="margin-top:10px;overflow:auto">
          <table>
            <thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙÙ‚</th><th style="width:140px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
            <tbody id="mbAttRows">
              <tr><td colspan="2" style="text-align:center;color:#666">â€”</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>

<div class="buttons-row">
  <button type="button" class="btn primary" id="saveB">${isEdit?'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„':('Ø­ÙØ¸ ' + entityTitle)}</button>
</div>    `);

    // Bank field for Owners Association
    (function(){
      const sel = document.getElementById('mbBizType');
      if(!sel) return;
      const grid = sel.closest('.grid') || sel.closest('[style*="grid"]') || (document.querySelector('.grid.cols-2'));
      let holder = document.getElementById('oaBankHolder');
      if(!holder){
        holder = document.createElement('div');
        holder.id = 'oaBankHolder';
        holder.style.gridColumn = '1 / -1';
        holder.innerHTML = '<label id="oaBankWrap" style="display:none">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ Ù„Ù„Ø¬Ù…Ø¹ÙŠØ©'
          + '<input id="oaBank" value="'+(b.oaBank||'')+'" placeholder="Ù…Ø«Ø§Ù„: OMxx xxxx xxxx xxxx" style="width:100%"></label>';
        (grid||document.body).appendChild(holder);
      }
      function apply(){
        const isOA = ((sel.value||'') === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
        const label = document.getElementById('oaBankWrap');
        if (label) label.style.display = isOA ? 'block' : 'none';
        if (!isOA) {
          const inp = document.getElementById('oaBank');
          if (inp) inp.value = '';
        }
      }
      sel.addEventListener('change', apply);
      apply();
    })();

    // Update labels for valuation (ØªØ«Ù…ÙŠÙ†)
    const mbBiz = document.getElementById('mbBizType');
    const mbNameLbl = document.getElementById('mbNameLabel');
    const mbOwnerLbl = document.getElementById('mbOwnerLabel');
    const mbLocLbl   = document.getElementById('mbLocLabel');
    const mbCoordsLbl= document.getElementById('mbCoordsLabel');
    const mbImageLbl = document.getElementById('mbImageLabel');
    const mbNameInp  = document.getElementById('mbName');
    const mbOwnerInp = document.getElementById('mbOwner');

    function applyValuationLabels(){
      const bt = (mbBiz && mbBiz.value) || bizType || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ';
      const isValBt = (bt === 'ØªØ«Ù…ÙŠÙ†');
  const isHOA = (bt === 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
  document.querySelectorAll('[data-hoa-hide]').forEach(el=>{ el.style.display = isHOA ? 'none' : ''; });

      if (mbNameLbl) mbNameLbl.textContent = isValBt ? 'Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ' : 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰';
      if (mbOwnerLbl) mbOwnerLbl.textContent = isValBt ? 'Ø§Ù„Ø²Ø¨ÙˆÙ†' : 'Ø§Ù„Ù…Ø§Ù„Ùƒ';
      if (mbLocLbl) mbLocLbl.textContent = isValBt ? 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ù†Ùƒ' : 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¨Ù†Ù‰';
      if (mbCoordsLbl) mbCoordsLbl.textContent = isValBt ? 'Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¨Ù†Ùƒ (Ø±Ø§Ø¨Ø· Google Maps)' : 'Ø§Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ø±Ø§Ø¨Ø· Google Maps)';
      if (mbImageLbl) mbImageLbl.textContent = isValBt ? 'ØµÙˆØ±Ø© Ø§Ù„Ø¨Ù†Ùƒ' : 'ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¨Ù†Ù‰';

      if (mbNameInp)  mbNameInp.placeholder  = isValBt ? 'Ù…Ø«Ø§Ù„: Ø¨Ù†Ùƒ Ù…Ø³Ù‚Ø· - ÙØ±Ø¹ Ø¨Ø±ÙƒØ§Ø¡' : 'Ù…Ø«Ø§Ù„: Ù…Ø¨Ù†Ù‰ Ø§Ù„Ø³ÙŠÙØ©';
      if (mbOwnerInp) mbOwnerInp.placeholder = isValBt ? 'Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†' : 'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ';
    }
    if (mbBiz) mbBiz.addEventListener('change', applyValuationLabels);
    applyValuationLabels();
function applyValuationVisibility(){
  const bt = (mbBiz && mbBiz.value) || bizType || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ';
  const isValBt = (bt === 'ØªØ«Ù…ÙŠÙ†');
  document.querySelectorAll('[data-val-only]').forEach(el=>{ el.style.display = isValBt ? '' : 'none'; });
  document.querySelectorAll('[data-nonval-only]').forEach(el=>{ el.style.display = isValBt ? 'none' : ''; });

  // ØªØ¨Ø³ÙŠØ· Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ù†Ùƒ ÙÙŠ Ù‚Ø³Ù… "ØªØ«Ù…ÙŠÙ†"
  document.querySelectorAll('[data-bank-only]').forEach(el=>{ el.style.display = isValBt ? '' : 'none'; });
  if (isValBt){
    document.querySelectorAll('[data-bank-hide]').forEach(el=>{ el.style.display = 'none'; });
  }
}
if (mbBiz) mbBiz.addEventListener('change', applyValuationVisibility);
applyValuationVisibility();

// ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ø­ÙØ¸ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ù†Ø³Ø®Ø© Ù…Ø¹Ø§ÙŠÙ†Ø©)
let __mbImgData = buildingImage || '';
const __imgInp  = document.getElementById('mbImage');
const __imgPrev = document.getElementById('mbImagePreview');
const __imgClr  = document.getElementById('mbImageClear');
function __setImg(v){
  __mbImgData = v || '';
  if (__imgPrev){
    if (__mbImgData){
      __imgPrev.src = __mbImgData;
      __imgPrev.style.display = 'block';
    } else {
      __imgPrev.src = '';
      __imgPrev.style.display = 'none';
    }
  }
}
if (__imgInp){
  __imgInp.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ()=> __setImg(String(r.result||''));
    r.readAsDataURL(f);
  });
}
if (__imgClr){
  __imgClr.onclick = ()=>{ if(__imgInp) __imgInp.value=''; __setImg(''); };
}
__setImg(__mbImgData);

// Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„ØªØ«Ù…ÙŠÙ† Ø¯Ø§Ø®Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
(function initValuationAttachments(){
  const sec = document.getElementById('valAttSection');
  if(!sec) return;

  const bid = (isEdit ? ((b && b.id) || State.activeBuildingId) : null);
  const hint = document.getElementById('mbAttHint');
  const nameInp = document.getElementById('mbAttName');
  const fileInp = document.getElementById('mbAttFiles');
  const uploadBtn = document.getElementById('mbAttUploadBtn');
  const msg = document.getElementById('mbAttMsg');
  const rows = document.getElementById('mbAttRows');

  async function draw(){
    if(!rows) return;
    if(!bid){
      rows.innerHTML = '<tr><td colspan="2" style="text-align:center;color:#666">Ø§Ø­ÙØ¸ Ø§Ù„Ø¨Ù†Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª.</td></tr>';
      return;
    }
    const list = await FB.listAttachments(bid);
    const html = (list||[]).map(it=>{
      const disp = (it.note || it.name || '');
      const url  = it.url || '#';
      const path = it.path || '';
      return `
        <tr data-id="${it.id}" data-path="${path}">
          <td>${disp ? `<a href="${url}" target="_blank" rel="noopener">${disp}</a>` : ''}</td>
          <td style="white-space:nowrap">
            <a class="btn" href="${url}" target="_blank" rel="noopener">ØªØ­Ù…ÙŠÙ„</a>
            <button type="button" class="btn danger admin-only" data-del>Ø­Ø°Ù</button>
          </td>
        </tr>
      `;
    }).join('');
    rows.innerHTML = html || '<tr><td colspan="2" style="text-align:center;color:#666">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯</td></tr>';
  }

  if(hint) hint.textContent = bid ? '' : ' (Ø§Ø­ÙØ¸ Ø£ÙˆÙ„Ø§Ù‹)';
  if(uploadBtn) uploadBtn.disabled = !bid;
  if(fileInp) fileInp.disabled = !bid;
  if(nameInp) nameInp.disabled = !bid;

  if(uploadBtn){
    uploadBtn.onclick = async ()=>{
      if(!bid) return;
      const files = Array.from(fileInp?.files||[]);
      if(!files.length){
        if(msg) msg.textContent = 'Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§ Ø£ÙˆÙ„Ø§Ù‹.';
        return;
      }
      const baseName = (nameInp?.value||'').trim();
      try{
        if(msg) msg.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø±ÙØ¹â€¦';
        for(let i=0;i<files.length;i++){
          const f = files[i];
          const nm = baseName ? (files.length>1 ? `${baseName} (${i+1})` : baseName) : '';
          if (DEMO_MODE){
            const url = URL.createObjectURL(f);
            await FB.addAttachment(bid, f, { url, note: nm, name: (nm || f.name), size: f.size, type: f.type || 'file' });
          } else {
            await FB.addAttachment(bid, f, nm);
          }
        }
        if(msg) msg.textContent = 'âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹';
        if(fileInp) fileInp.value = '';
        if(nameInp) nameInp.value = '';
        await draw();
      }catch(err){
        console.error(err);
        if(msg) msg.textContent = 'âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ' + (err?.message || err);
      }
    };
  }

  if(rows){
    rows.addEventListener('click', async (e)=>{
      const tr = e.target.closest('tr[data-id]');
      if(!tr) return;
      if(e.target.matches('[data-del]')){
        if(!(window.AuthState && window.AuthState.isAdmin)){ UI.toast('Ø§Ù„Ø­Ø°Ù Ù…ØªØ§Ø­ Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·'); return; }
        if(UI.confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙÙ‚ØŸ')){
          await FB.deleteAttachment(bid, tr.getAttribute('data-id'), tr.getAttribute('data-path')||'');
          await draw();
        }
      }
    });
  }

  draw();
})();

    const feeSel = document.getElementById('mbFeeType');
    if(feeSel){
      feeSel.onchange = function(){
        const isSalary = this.value==='salary';
        document.getElementById('mbFeeLabel').textContent = isSalary ? 'Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±.Ø¹)' : 'Ø§Ù„Ù†Ø³Ø¨Ø© (%)';
        const iv = document.getElementById('mbFeeValue');
        if(iv){ iv.placeholder = isSalary ? 'Ù…Ø«Ø§Ù„: 150 (Ø±.Ø¹)' : 'Ù…Ø«Ø§Ù„: 15 (Ùª)'; }
      };
    }

    document.getElementById('saveB').onclick = async ()=>{
      const payload = {
        bizType: document.getElementById('mbBizType').value,
        feeType: document.getElementById('mbFeeType').value,
        feeValue: Number(document.getElementById('mbFeeValue').value||0),
        name: (document.getElementById('mbName').value||'').trim(),
        bankContractStart: (document.getElementById('mbBankContractStart')?.value||'').trim(),
        bankContact: {
          name: (document.getElementById('mbBankContactName')?.value||'').trim(),
          title: (document.getElementById('mbBankContactTitle')?.value||'').trim(),
          phone: (document.getElementById('mbBankContactPhone')?.value||'').trim(),
          email: (document.getElementById('mbBankContactEmail')?.value||'').trim(),
        },
        location: (document.getElementById('mbLocation').value||'').trim(),
        contact: (document.getElementById('mbContact').value||'').trim(),
        owner: (document.getElementById('mbOwner').value||'').trim(),
        coordsLink: (document.getElementById('mbCoords')?.value||'').trim(),
        totalArea: (document.getElementById('mbTotalArea')?.value||'').trim(),
        waterAccount: (document.getElementById('mbWater')?.value||'').trim(),
        bankAccount: (document.getElementById('mbBankAcc')?.value||'').trim(),
        guardName: (document.getElementById('mbGuardName')?.value||'').trim(),
        buildingImage: (__mbImgData || ''),
        notes: (document.getElementById('mbNotes').value||'').trim(),
        counts: {
          apartments: Number(document.getElementById('mbApt').value||0),
          shops: Number(document.getElementById('mbShop').value||0),
          showrooms: Number(document.getElementById('mbShow').value||0),
          basements: Number(document.getElementById('mbBase').value||0),
        },
        electricAccount: (document.getElementById('mbElectric').value||'').trim(),
        internetNumber: (document.getElementById('mbInternet')?.value||'').trim(),
        guardPhone: (document.getElementById('mbGuard').value||'').trim(),
        sewageTruckPhone: (document.getElementById('mbSewage')?.value||'').trim(),
        oaBank: (document.getElementById('oaBank')?.value||'').trim(),
      };

      if(!payload.name){ const btNow = payload.bizType || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ'; const entityNow = (btNow==='ØªØ«Ù…ÙŠÙ†') ? 'Ø§Ù„Ø¨Ù†Ùƒ' : 'Ø§Ù„Ù…Ø¨Ù†Ù‰'; UI.toast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ' + entityNow); return; }

      if(isEdit){
        const id = (b && b.id) || State.activeBuildingId;
        await FB.updateBuilding(id, payload);
      }else{
        await FB.createBuilding(Object.assign({createdAt: new Date().toISOString()}, payload));
      }
      UI.closeModal();
      Render.dashboard();
      if(State.activeBuildingId) Render.building();
    };
  }

  function bindHeader(){
  document.getElementById('btnAddBuilding').onclick = ()=> Actions.openAddBuilding();

  const btnLogin = document.getElementById('btnLogin');
  const btnLogout = document.getElementById('btnLogout');
  const btnAddUser = document.getElementById('btnAddUser');
  if (btnLogin){
    btnLogin.onclick = async ()=>{
      try{
        const email = prompt('Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:');
        if(!email) return;
        const pass = prompt('Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:');
        if(!pass) return;
        if(!window.AuthAPI){ alert('Firebase Auth ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„'); return; }
        await window.AuthAPI.signIn(email, pass);
        alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
      }catch(e){
        alert('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        console.warn(e);
      }
    };
  }
  if (btnLogout){
    btnLogout.onclick = async ()=>{
      try{
        if(window.AuthAPI) await window.AuthAPI.signOut();
      }catch(e){ console.warn(e); }
    };
  }
}

  return { State, FB, UI, Render, Actions, utils:{ $, $$, todayIso, ymKey } };
})();
window.App = App; // â† Ø­ØªÙ‰ ÙŠÙ‚Ø¯Ø± Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØµÙ„ Ù„Ù€ App Ùˆ FB

function labelKind(kind){ return kind==='apartment'?'Ø´Ù‚Ø©':(kind==='shop'?'Ù…Ø­Ù„':(kind==='showroom'?'Ù…Ø¹Ø±Ø¶':'Ù‚Ø¨Ùˆ')); }


/* ========================= WhatsApp Reminders (UltraMsg) =========================
   - Ø²Ø± Ø®Ø§Ø±Ø¬ÙŠ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ ØªØ°ÙƒÙŠØ± Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† (ÙÙ‚Ø· Ù…Ø¨Ø§Ù†ÙŠ "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ")
   - ÙŠØ³ØªØ«Ù†ÙŠ Ø£ÙŠ Ù…Ø³ØªØ£Ø¬Ø± Ù„Ø¯ÙŠÙ‡ Ø¯ÙØ¹ Ù…Ø³Ø¬Ù„ ÙÙŠ payments[YYYY-MM]
   - UltraMsg API: https://api.ultramsg.com/{instance_id}/messages/chat
================================================================================= */

const ULTRAMSG_TOKEN = 'h5y18d56wizgr7ws';
const ULTRAMSG_INSTANCE_ID = (()=>{
  const raw = 'instance156538';
  return String(raw||'').startsWith('instance') ? String(raw) : ('instance' + String(raw));
})();

const WA_ADMIN_PHONE_KEY = 'WA_ADMIN_PHONE';

const WA_TEMPLATES = {
  // Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ… 1 Ù…Ù† Ø§Ù„Ø´Ù‡Ø± (ØªØ°ÙƒÙŠØ± Ø£ÙˆÙ„) - Ø¹Ø±Ø¨ÙŠ + Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
  d1: `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… {name}ØŒ

Ù†Ø°ÙƒÙ‘Ø±ÙƒÙ… Ø¨Ø£Ù† Ø¥ÙŠØ¬Ø§Ø± Ø´Ù‡Ø± {monthName} Ù„Ù„ÙˆØ­Ø¯Ø© Ø±Ù‚Ù… {unit} ÙÙŠ Ù…Ø¨Ù†Ù‰ {building} Ù…Ø³ØªØ­Ù‚ Ù„Ù„Ø¯ÙØ¹.
Ù†Ø±Ø¬Ùˆ Ø§Ù„ØªÙØ¶Ù„ Ø¨Ø§Ù„Ø³Ø¯Ø§Ø¯ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ†ØŒ Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ù„Ù‰ {adminPhone} ÙÙŠ Ø­Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±.

Ù…Ø¹ Ø§Ù„Ø´ÙƒØ± ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±ØŒ
Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ù†Ù‰

----------------------------

Dear {name},

This is a friendly reminder that the rent for {monthName} for unit {unit} in building {building} is now due.
Please arrange the payment at your earliest convenience, or contact us on {adminPhone} if you have any questions.

Thank you,
Building Management`,

  // Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ… 5 (Ø£Ùˆ ØªØ°ÙƒÙŠØ± Ù…ØªØ£Ø®Ø±) - Ø¹Ø±Ø¨ÙŠ + Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
  d5: `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… {name}ØŒ

Ù†Ù„ÙØª Ø§Ù†ØªØ¨Ø§Ù‡ÙƒÙ… Ø¥Ù„Ù‰ Ø£Ù† Ø¥ÙŠØ¬Ø§Ø± Ø´Ù‡Ø± {monthName} Ù„Ù„ÙˆØ­Ø¯Ø© Ø±Ù‚Ù… {unit} ÙÙŠ Ù…Ø¨Ù†Ù‰ {building} Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù…Ù‡ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.
Ù†Ø±Ø¬Ùˆ Ø§Ù„Ø³Ø¯Ø§Ø¯ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙØ±ØµØ© Ù„ØªÙØ§Ø¯ÙŠ Ø£ÙŠ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©ØŒ Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ù„Ù‰ {adminPhone} Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø£ÙŠ Ø¹Ø°Ø± Ø£Ùˆ Ø§Ø³ØªÙØ³Ø§Ø±.

Ù…Ø¹ Ø§Ù„Ø´ÙƒØ± ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±ØŒ
Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ù†Ù‰

----------------------------

Dear {name},

We would like to kindly inform you that the rent for {monthName} for unit {unit} in building {building} has not been received yet.
Please make the payment as soon as possible to avoid any further action, or contact us on {adminPhone} if there is any issue or clarification needed.

Thank you for your cooperation,
Building Management`
};

function waMonthNameAr(m){
  const months = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
  return months[(Number(m||1)-1)] || '';
}
function waMonthLabel(y,m){ return `${waMonthNameAr(m)} ${y}`; }
function waNextMonth(y,m){
  y = Number(y); m = Number(m);
  if(m>=12) return { y:y+1, m:1 };
  return { y:y, m:m+1 };
}
function waStartOfMonth(y,m){ return new Date(Date.UTC(Number(y), Number(m)-1, 1, 0,0,0,0)); }
function waEndOfMonth(y,m){ return new Date(Date.UTC(Number(y), Number(m), 0, 23,59,59,999)); }


function waAsDate(v, end=false){
  if(!v) return null;
  try{
    let d;
    if (typeof v?.toDate === 'function') {
      d = v.toDate();
    } else if (typeof v?.seconds === 'number') {
      d = new Date(v.seconds*1000);
    } else if (v instanceof Date) {
      d = v;
    } else {
      const s = String(v).trim();
      // ØµÙŠØºØ© ISO: 2025-12-31
      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(m){
        return new Date(Date.UTC(+m[1], +m[2]-1, +m[3], end?23:0, end?59:0, end?59:0, end?999:0));
      }
      // ØµÙŠØºØ© Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ø´Ù‡Ø±/Ø§Ù„Ø³Ù†Ø©: 31/12/2025 Ø£Ùˆ 31-12-2025
      m = s.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})$/);
      if(m){
        return new Date(Date.UTC(+m[3], +m[2]-1, +m[1], end?23:0, end?59:0, end?59:0, end?999:0));
      }
      return null;
    }
    const yy = d.getFullYear(), mm = d.getMonth(), dd = d.getDate();
    return new Date(Date.UTC(yy, mm, dd, end?23:0, end?59:0, end?59:0, end?999:0));
  }catch{
    return null;
  }
}
function waIsActiveDuring(s,e, ms, me){
  const sd = waAsDate(s,false) || new Date(0);
  const ed = waAsDate(e,true)  || new Date(Date.UTC(9999,11,31,23,59,59,999));
  return sd <= me && ed >= ms;


if (btnAddUser){
  btnAddUser.onclick = ()=>{ try{ Actions.openAddUser(); }catch(e){ console.warn(e); alert('ØªØ¹Ø°Ø± ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…'); } };
}
}

function waSanitizePhone(raw){
  let p = String(raw||'').trim();
  if(!p) return '';
  p = p.replace(/\s+/g,'');
  // keep leading + if exists
  p = p.replace(/[^\d+]/g,'');
  if(p.startsWith('00')) p = '+' + p.slice(2);
  if(p.startsWith('+')) return p;
  // Oman: 8 digits -> +968xxxxxxxx
  if(/^\d{8}$/.test(p)) return '+968' + p;
  // 968xxxxxxxx -> +968xxxxxxxx
  if(/^968\d{8}$/.test(p)) return '+' + p;
  // fallback: add +
  if(/^\d+$/.test(p)) return '+' + p;
  return p;
}

function waApplyTemplate(tpl, vars){
  const v = vars || {};
  const monthName = (v.monthName ?? v.month ?? '');
  return String(tpl||'')
    .replaceAll('{name}', v.name ?? '')
    .replaceAll('{unit}', v.unit ?? '')
    .replaceAll('{building}', v.building ?? '')
    .replaceAll('{rent}', v.rent ?? '')
    .replaceAll('{monthName}', monthName)
    .replaceAll('{month}', (v.month ?? monthName))
    .replaceAll('{year}', v.year ?? '')
    .replaceAll('{ym}', v.ym ?? '')
    .replaceAll('{adminPhone}', v.adminPhone ?? '');
}

async function waSendChatMessage(to, body){
  const tok = String(ULTRAMSG_TOKEN||'').trim();
  // Ø¨Ø¹Ø¶ Ù†Ù‚Ø§Ø· UltraMsg ØªÙ‚Ø¨Ù„ token Ø¨Ø§Ù„Ù€ GETØŒ ÙˆØ¨Ø¹Ø¶Ù‡Ø§ Ø¨Ø§Ù„Ù€ bodyØ› Ù†Ø±Ø³Ù„Ù‡Ø§ Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚ØªÙŠÙ† Ù„Ù„Ø§Ø­ØªÙŠØ§Ø·
  const url = `https://api.ultramsg.com/${ULTRAMSG_INSTANCE_ID}/messages/chat?token=${encodeURIComponent(tok)}`;
  const form = new URLSearchParams();
  form.set('token', tok);
  form.set('to', to);
  form.set('body', body);

  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
    body: form
  });

  let out;
  try { out = await res.json(); } catch { out = await res.text(); }
  if(out && typeof out === 'object' && out.error) throw new Error(out.error);
  if(!res.ok) throw new Error(typeof out === 'string' ? out : JSON.stringify(out));
  return out;
}


function waChatIdFromPhone(phone){
  const digits = String(phone||'').replace(/[^\d]/g,'');
  if(!digits) return '';
  return digits + '@c.us';
}

async function waGetInstanceStatus(){
  const tok = String(ULTRAMSG_TOKEN||'').trim();
  const url = `https://api.ultramsg.com/${ULTRAMSG_INSTANCE_ID}/instance/status?token=${encodeURIComponent(tok)}`;
  const res = await fetch(url, { method: 'GET' });
  let out;
  try { out = await res.json(); } catch { out = await res.text(); }
  // UltraMsg Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ ÙŠØ±Ø¬Ù‘Ø¹ 200 ÙˆÙ…Ø¹Ù‡Ø§ {error: ...}
  if(out && typeof out === 'object' && out.error) throw new Error(out.error);
  if(!res.ok) throw new Error(typeof out === 'string' ? out : JSON.stringify(out));
  return out;
}

async function waGetMessagesLog(status='all', limit=20, page=1){
  const tok = String(ULTRAMSG_TOKEN||'').trim();
  const qs = new URLSearchParams({
    token: tok,
    page: String(page),
    limit: String(limit),
    status: String(status),
    sort: 'desc'
  }).toString();
  const url = `https://api.ultramsg.com/${ULTRAMSG_INSTANCE_ID}/messages?` + qs;
  const res = await fetch(url, { method: 'GET' });
  let out;
  try { out = await res.json(); } catch { out = await res.text(); }
  if(out && typeof out === 'object' && out.error) throw new Error(out.error);
  if(!res.ok) throw new Error(typeof out === 'string' ? out : JSON.stringify(out));
  return out;
}


async function waGetInstanceSettings(){
  const tok = String(ULTRAMSG_TOKEN||'').trim();
  const url = `https://api.ultramsg.com/${ULTRAMSG_INSTANCE_ID}/instance/settings?token=${encodeURIComponent(tok)}`;
  const res = await fetch(url, { method: 'GET' });
  let out;
  try { out = await res.json(); } catch { out = await res.text(); }
  if(out && typeof out === 'object' && out.error) throw new Error(out.error);
  if(!res.ok) throw new Error(typeof out === 'string' ? out : JSON.stringify(out));
  return out;
}

async function waClearMessages(status='queue'){
  const tok = String(ULTRAMSG_TOKEN||'').trim();
  const url = `https://api.ultramsg.com/${ULTRAMSG_INSTANCE_ID}/messages/clear?token=${encodeURIComponent(tok)}`;
  const form = new URLSearchParams();
  form.set('token', tok);
  form.set('status', String(status||'queue'));
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
    body: form.toString()
  });
  let out;
  try { out = await res.json(); } catch { out = await res.text(); }
  if(out && typeof out === 'object' && out.error) throw new Error(out.error);
  if(!res.ok) throw new Error(typeof out === 'string' ? out : JSON.stringify(out));
  return out;
}

async function waRestartInstance(){
  const tok = String(ULTRAMSG_TOKEN||'').trim();
  const url = `https://api.ultramsg.com/${ULTRAMSG_INSTANCE_ID}/instance/restart?token=${encodeURIComponent(tok)}`;
  const form = new URLSearchParams();
  form.set('token', tok);
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
    body: form.toString()
  });
  let out;
  try { out = await res.json(); } catch { out = await res.text(); }
  if(out && typeof out === 'object' && out.error) throw new Error(out.error);
  if(!res.ok) throw new Error(typeof out === 'string' ? out : JSON.stringify(out));
  return out;
}

async function waCheckContactHasWhatsApp(phone){
  const tok = String(ULTRAMSG_TOKEN||'').trim();
  const chatId = waChatIdFromPhone(phone);
  if(!chatId) return { status:'invalid' };
  const qs = new URLSearchParams({
    token: tok,
    chatId,
    nocache: 'true'
  }).toString();
  const url = `https://api.ultramsg.com/${ULTRAMSG_INSTANCE_ID}/contacts/check?` + qs;
  const res = await fetch(url, { method: 'GET' });
  let out;
  try { out = await res.json(); } catch { out = await res.text(); }
  if(out && typeof out === 'object' && out.error) throw new Error(out.error);
  if(!res.ok) throw new Error(typeof out === 'string' ? out : JSON.stringify(out));
  return out;
}

function waPrettyJson(x){
  try { return JSON.stringify(x, null, 2); } catch { return String(x); }
}

function waEscapeHtml(str){
  return String(str ?? '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}


async function waCollectUnpaidTenants(targetY, targetM){
  const ym = App.utils.ymKey(targetY, targetM);
  const ms = waStartOfMonth(targetY, targetM);
  const me = waEndOfMonth(targetY, targetM);

  const buildings = await App.FB.listBuildings();
  const adminBuildings = buildings.filter(b => normBiz(b.bizType || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ') === 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ');

  const recipients = [];
  const skipped = { paid: 0, noPhone: 0, inactive: 0 };
  const skippedDetails = { paid: [], noPhone: [], inactive: [] };

  for (const b of adminBuildings){
    const bLabel = (b.buildingName || b.name || b.title || b.building || b.buildingTitle || b.id || '').toString().trim();
    const tenants = await App.FB.listTenants(b.id);

    for (const t of tenants){
      // Ø£ÙˆÙ„Ø§Ù‹: Ù†ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¹Ù‚Ø¯ Ù†Ø´Ø· Ø®Ù„Ø§Ù„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
      if (!waIsActiveDuring(t.startDate, t.endDate, ms, me)){
        skipped.inactive++;
        skippedDetails.inactive.push({
          tenantId: t.id,
          buildingId: b.id,
          name: t.tenantName || '',
          unit: t.unitNumber || '',
          building: bLabel,
          startDate: t.startDate || '',
          endDate: t.endDate || ''
        });
        continue;
      }

      // Ø«Ø§Ù†ÙŠØ§Ù‹: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ù…Ø³Ø¬Ù‘Ù„ "Ù…Ø¯ÙÙˆØ¹" Ù†ØªØ¬Ø§ÙˆØ²Ù‡
      const paid = t.payments && t.payments[ym] && String(t.payments[ym]).trim();
      if (paid){
        skipped.paid++;
        skippedDetails.paid.push({
          tenantId: t.id,
          buildingId: b.id,
          name: t.tenantName || '',
          unit: t.unitNumber || '',
          building: bLabel,
          note: paid
        });
        continue;
      }

      // Ø«Ø§Ù„Ø«Ø§Ù‹: ÙØ­Øµ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
      const phoneRaw = (t.phone || '').toString();
      const phoneSanitized = waSanitizePhone(phoneRaw);
      const digits = phoneSanitized.replace(/[^0-9]/g, '');

      let phoneValid = true;
      if (!digits){
        phoneValid = false;
      } else if (digits.startsWith('968')){
        // Ù…Ø¹ 968 ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø·ÙˆÙ„ 11 Ø±Ù‚Ù… (968 + 8 Ø£Ø±Ù‚Ø§Ù… Ø¯Ø§Ø®Ù„ÙŠØ©)
        if (digits.length !== 11) phoneValid = false;
      } else {
        // Ø¨Ø¯ÙˆÙ† 968 ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø·ÙˆÙ„ 8 Ø£Ø±Ù‚Ø§Ù… (Ø±Ù‚Ù… Ù…Ø­Ù„ÙŠ Ø¯Ø§Ø®Ù„ Ø¹Ù…Ø§Ù†)
        if (digits.length !== 8) phoneValid = false;
      }

      if (!phoneSanitized || !phoneValid){
        skipped.noPhone++;
        skippedDetails.noPhone.push({
          tenantId: t.id,
          buildingId: b.id,
          name: t.tenantName || '',
          unit: t.unitNumber || '',
          building: bLabel,
          phoneRaw,
          phoneSanitized,
          reason: (!phoneSanitized || !digits) ? 'missing' : 'invalid'
        });
        continue;
      }

      // Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ù…Ø³ØªÙ‡Ø¯Ù Ø¨Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ°ÙƒÙŠØ±
      recipients.push({
        buildingId: b.id,
        tenantId: t.id,
        building: bLabel,
        name: t.tenantName || '',
        unit: t.unitNumber || '',
        phone: phoneSanitized,
        rent: t.rentAmount || t.rent || 0,
        ym,
        targetY,
        targetM
      });
    }
  }

  return {
    ym,
    targetY,
    targetM,
    recipients,
    skipped,
    skippedDetails,
    buildingsCount: adminBuildings.length
  };
}
async function openWhatsRemindersModal(){
  const baseY = App.State.selYear;
  const baseM = App.State.selMonth;

  App.UI.openModal('Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ± (ÙˆØ§ØªØ³Ø§Ø¨)', `
    <div class="grid cols-2">
      <div>
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
        <select id="waType">
          <option value="d1">Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø§Ù„ÙŠÙˆÙ… 1 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±)</option>
          <option value="d5">Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (ØªØ§Ø±ÙŠØ® 5 â€” ØªØ°ÙƒÙŠØ± Ù…ØªØ£Ø®Ø±)</option>
        </select>
      </div>
      <div>
        <label>Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (Ø§Ù„Ø¯ÙØ¹)</label>
        <div class="badge gray" id="waTargetYm">â€”</div>
      </div>
      <div style="grid-column:1/-1">
        <label>Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„ (Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)</label>
        <input id="waAdminPhone" class="input" placeholder="+968XXXXXXXX" />
        <div class="muted" style="font-size:12px;margin-top:4px">Ø³ÙŠØ¸Ù‡Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø³Ø·Ø± "Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ù„Ù‰ ..."</div>
      </div>
      <div style="grid-column:1/-1">
        <label>Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</label>
        <textarea id="waBody" rows="5" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§..."></textarea>
        <div class="muted" style="font-size:12px;margin-top:4px">Ù…ØªØºÙŠØ±Ø§Øª Ø¬Ø§Ù‡Ø²Ø©: {name} {unit} {building} {rent} {monthName} {month} {year} {adminPhone}</div>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <div class="card-h">
        <b>Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙˆÙ† (ØºÙŠØ± Ø¯Ø§ÙØ¹ÙŠÙ†)</b>
        <span class="muted" id="waCounts">â€”</span>
      </div>
      <div class="card-c" id="waList" style="max-height:260px;overflow:auto">
        <div class="muted">Ø§Ø¶ØºØ· "Ø­Ø³Ø§Ø¨" Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†.</div>
      </div>
    </div>


    <div class="card" style="margin-top:10px;display:none" id="waSkippedCard">
      <div class="card-h">
        <b>Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ÙŠÙ†</b>
        <span class="muted" id="waSkippedHint">
          Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ÙŠÙ† Ø­Ø³Ø¨ Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯.
        </span>
      </div>
      <div class="card-c">
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <button type="button" class="btn" id="waShowPaid">Ù…Ø¯ÙÙˆØ¹ (0)</button>
          <button type="button" class="btn" id="waShowNoPhone">Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù… (0)</button>
          <button type="button" class="btn" id="waShowInactive">ØºÙŠØ± Ù†Ø´Ø· (0)</button>
        </div>
        <div id="waSkippedList" style="max-height:220px;overflow:auto">
          <div class="muted">â€”</div>
        </div>
      </div>
    </div>

    <div class="buttons-row">
      <button type="button" class="btn" id="waCalc">Ø­Ø³Ø§Ø¨</button>
      <button type="button" class="btn" id="waTest">ØªØ¬Ø±Ø¨Ø©</button>
      <button type="button" class="btn primary" id="waSend">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†</button>
      <button type="button" class="btn" id="waSend40">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ 40 Ø´Ø®Øµ</button>
      <button type="button" class="btn" id="waStop">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
    </div>

    <div style="margin-top:8px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);cursor:pointer">
        <input type="checkbox" id="waAllowQueue" />
        Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø­Ø§Ù„Ø© Ù„ÙŠØ³Øª authenticated (Ø³ØªØ°Ù‡Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ù„Ù‰ QUEUE)
      </label>
    </div>

    <div class="card" style="margin-top:10px;display:none" id="waReportCard">
      <div class="card-h">
        <b>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ©)</b>
      </div>
      <div class="card-c" id="waReportBody">
        <div class="muted">Ù„Ù… ÙŠØªÙ… Ø£ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø¹Ø¯.</div>
      </div>
    </div>

    <div class="buttons-row" style="margin-top:10px">
      <button type="button" class="btn" id="waCheck">ÙØ­Øµ Ø­Ø§Ù„Ø© UltraMsg</button>
      <button type="button" class="btn" id="waSettings">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
      <button type="button" class="btn" id="waLogs">Ø³Ø¬Ù„ UltraMsg</button>
    </div>

    <div class="buttons-row" style="margin-top:10px">
      <button type="button" class="btn" id="waClearQueue">Ù…Ø³Ø­ QUEUE</button>
      <button type="button" class="btn" id="waRestart">Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ù†Ø³ØªØ§Ù†Ø³</button>
    </div>

    <div class="muted" style="font-size:12px;margin-top:8px" id="waStatus"></div>
    <div id="waDebug" style="margin-top:10px;max-height:220px;overflow:auto"></div>
  `);

  const typeEl   = document.getElementById('waType');
  const bodyEl   = document.getElementById('waBody');
  const targetEl = document.getElementById('waTargetYm');
  const listEl   = document.getElementById('waList');
  const countsEl = document.getElementById('waCounts');
  const adminPhoneEl = document.getElementById('waAdminPhone');
  const reportCard = document.getElementById('waReportCard');
  const reportBody = document.getElementById('waReportBody');

  const skippedCard = document.getElementById('waSkippedCard');
  const skipPaidBtn    = document.getElementById('waShowPaid');
  const skipNoPhoneBtn = document.getElementById('waShowNoPhone');
  const skipInactiveBtn = document.getElementById('waShowInactive');
  const skippedListEl = document.getElementById('waSkippedList');

  const statusEl = document.getElementById('waStatus');
  const debugEl  = document.getElementById('waDebug');
  const sendBtn  = document.getElementById('waSend');
  const testBtn  = document.getElementById('waTest');
  const stopBtn  = document.getElementById('waStop');
  const send40Btn = document.getElementById('waSend40');
  const checkBtn = document.getElementById('waCheck');
  const settingsBtn = document.getElementById('waSettings');
  const logsBtn  = document.getElementById('waLogs');
  const clearQueueBtn = document.getElementById('waClearQueue');
  const restartBtn = document.getElementById('waRestart');
  const allowQueueEl = document.getElementById('waAllowQueue');

  let cache = null;
  let stopSending = false;

  const setStatus = (t)=>{ statusEl.textContent = t || ''; };
  const setDebug  = (html)=>{ if(debugEl) debugEl.innerHTML = html || ''; };

  function getTarget(){
    const type = typeEl.value;
    const t = { y: baseY, m: baseM };
    return { type, ...t };
  }

  function resetView(){
    cache = null;
    countsEl.textContent = 'â€”';
    listEl.innerHTML = '<div class="muted">Ø§Ø¶ØºØ· "Ø­Ø³Ø§Ø¨" Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†.</div>';
    setDebug('');

    if(reportCard){
      reportCard.style.display = 'none';
    }
    if(reportBody){
      reportBody.innerHTML = '<div class="muted">Ù„Ù… ÙŠØªÙ… Ø£ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø¹Ø¯.</div>';
    }

    if(skippedCard){
      skippedCard.style.display = 'none';
      if(skipPaidBtn)     skipPaidBtn.textContent     = 'Ù…Ø¯ÙÙˆØ¹ (0)';
      if(skipNoPhoneBtn)  skipNoPhoneBtn.textContent  = 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù… (0)';
      if(skipInactiveBtn) skipInactiveBtn.textContent = 'ØºÙŠØ± Ù†Ø´Ø· (0)';
      if(skippedListEl)   skippedListEl.innerHTML = '<div class="muted">â€”</div>';
    }

    stopSending = false;
    if(stopBtn){
      stopBtn.disabled = true;
      stopBtn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
    }
  }
  
  if(stopBtn){
    stopBtn.disabled = true;
    stopBtn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
    stopBtn.onclick = ()=>{
      stopSending = true;
      setStatus('ØªÙ… Ø·Ù„Ø¨ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„Ø› Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆÙ‚Ù Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø§Ø±ÙŠØ©.');
    };
  }
function renderReport(rows){
    if(!reportCard || !reportBody) return;
    if(!rows || !rows.length){
      reportCard.style.display = 'none';
      reportBody.innerHTML = '<div class="muted">Ù„Ù… ÙŠØªÙ… Ø£ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø¹Ø¯.</div>';
      return;
    }
    reportCard.style.display = 'block';
    reportBody.innerHTML = rows.map((r,i)=>`
      <div style="border:1px solid var(--border);border-radius:12px;padding:8px;margin-bottom:6px;background:#fff">
        <div style="font-weight:600">${r.name || 'â€”'} <span class="muted">(${r.unit || 'â€”'})</span></div>
        <div class="muted" style="font-size:12px">
          ${r.building || 'â€”'} â€¢ ${r.phone || 'â€”'}
        </div>
        <div style="margin-top:4px;font-size:12px">
          Ø§Ù„Ø­Ø§Ù„Ø©:
          <span class="badge ${r.success ? 'success' : 'gray'}">${r.success ? 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„' : 'ÙØ´Ù„'}</span>
          ${r.error ? `<span class="muted" style="margin-right:6px">Ø³Ø¨Ø¨ Ø§Ù„ÙØ´Ù„: ${waEscapeHtml(String(r.error))}</span>` : ''}
        </div>
      </div>
    `).join('');
  }


  function refreshDefaults(){
    const t = getTarget();
    targetEl.textContent = `${waMonthLabel(t.y,t.m)} ( ${App.utils.ymKey(t.y,t.m)} )`;
    bodyEl.value = (t.type === 'd1') ? WA_TEMPLATES.d1 : WA_TEMPLATES.d5;
    resetView();
    setStatus('');
  }

  typeEl.onchange = refreshDefaults;

  
function renderSkipped(kind){
    if(!cache || !cache.skippedDetails || !skippedCard) return;

    const label =
      (kind === 'noPhone') ? 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…' :
      (kind === 'inactive') ? 'ØºÙŠØ± Ù†Ø´Ø·' :
      'Ù…Ø¯ÙÙˆØ¹';

    const arr = cache.skippedDetails[kind] || [];

    skippedCard.style.display = 'block';

    if(skipPaidBtn)     skipPaidBtn.classList.toggle('primary', kind === 'paid');
    if(skipNoPhoneBtn)  skipNoPhoneBtn.classList.toggle('primary', kind === 'noPhone');
    if(skipInactiveBtn) skipInactiveBtn.classList.toggle('primary', kind === 'inactive');

    if(!arr.length){
      skippedListEl.innerHTML = `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ØªØ­Øª "${label}".</div>`;
      return;
    }

    skippedListEl.innerHTML = arr.map((x,i)=>{
      let reasonText = '';
      if(kind === 'noPhone'){
        if(x.reason === 'missing'){
          reasonText = 'Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…Ø³Ø¬Ù„ / Reason: no phone number on file';
        }else{
          reasonText = 'Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯: Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­ (Ø§Ù„Ø·ÙˆÙ„ ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨) / Reason: invalid phone number length';
        }
      }else if(kind === 'inactive'){
        reasonText = 'Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯: Ø§Ù„Ø¹Ù‚Ø¯ ØºÙŠØ± Ù†Ø´Ø· ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± / Reason: contract not active for this month';
      }else{
        reasonText = 'Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ¨Ø¹Ø§Ø¯: Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ù…Ø³Ø¬Ù‘Ù„ Ù…Ø¯ÙÙˆØ¹ / Reason: rent for this month already marked as paid';
      }

      let extra = '';
      if(kind === 'noPhone'){
        extra = `
          <div class="muted" style="font-size:11px">
            Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${waEscapeHtml(String(x.phoneRaw || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'))}<br>
            Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚: ${waEscapeHtml(String(x.phoneSanitized || 'â€”'))}
          </div>
          <div style="margin-top:6px">
            <button type="button" class="btn" data-action="edit-phone" data-kind="${kind}" data-index="${i}" style="padding:4px 8px;font-size:12px">
              ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ù‚Ù…
            </button>
          </div>
        `;
      }else if(kind === 'inactive'){
        extra = `
          <div class="muted" style="font-size:11px">
            Ù…Ù†: ${waEscapeHtml(String(x.startDate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'))} â€¢ Ø¥Ù„Ù‰: ${waEscapeHtml(String(x.endDate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'))}
          </div>
          <div style="margin-top:6px">
            <button type="button" class="btn" data-action="edit-dates" data-kind="${kind}" data-index="${i}" style="padding:4px 8px;font-size:12px">
              ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯
            </button>
          </div>
        `;
      }

      return `
        <div style="border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:8px;background:#fff">
          <div style="font-weight:600">${x.name || 'â€”'} <span class="muted">(${x.unit || 'â€”'})</span></div>
          <div class="muted" style="font-size:12px">
            ${x.building || 'â€”'}<br>
            ${reasonText}
          </div>
          ${extra}
        </div>
      `;
    }).join('');
  }

  if(skipPaidBtn)     skipPaidBtn.onclick     = ()=> renderSkipped('paid');
  if(skipNoPhoneBtn)  skipNoPhoneBtn.onclick  = ()=> renderSkipped('noPhone');
  if(skipInactiveBtn) skipInactiveBtn.onclick = ()=> renderSkipped('inactive');

  countsEl.onclick = (e)=>{
    const el = e.target;
    if(!el) return;
    const kind = el.getAttribute && el.getAttribute('data-skip');
    if(kind){
      renderSkipped(kind);
    }
  };

  if(skippedListEl){
    skippedListEl.onclick = async (ev)=>{
      const btn = ev.target.closest && ev.target.closest('button[data-action]');
      if(!btn) return;
      const action = btn.getAttribute('data-action');
      const kind = btn.getAttribute('data-kind');
      const idx = parseInt(btn.getAttribute('data-index') || '-1', 10);
      if(!cache || !cache.skippedDetails || !cache.skippedDetails[kind]) return;
      const item = cache.skippedDetails[kind][idx];
      if(!item) return;

      if(action === 'edit-phone'){
        const current = (item.phoneRaw || '').toString();
        const updated = window.prompt('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª):', current);
        if(updated === null) return;
        const trimmed = updated.trim();
        if(!trimmed){
          setStatus('Ù„Ù… ÙŠØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù….');
          return;
        }
        try{
          setStatus('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„...');
          await App.FB.updateTenant(item.buildingId, item.tenantId, { phone: trimmed });
          setStatus('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„. Ø§Ø¶ØºØ· "Ø­Ø³Ø§Ø¨" Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.');
        }catch(err){
          console.error(err);
          setStatus('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„: ' + (err?.message || err));
        }
      }else if(action === 'edit-dates'){
        const curStart = (item.startDate || '').toString();
        const curEnd   = (item.endDate || '').toString();
        const newStart = window.prompt('ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ (Ù…Ø«Ø§Ù„: 2025-01-01):', curStart);
        if(newStart === null) return;
        const newEnd = window.prompt('ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ (Ù…Ø«Ø§Ù„: 2025-12-31):', curEnd);
        if(newEnd === null) return;
        const patch = {};
        if(newStart.trim()) patch.startDate = newStart.trim();
        if(newEnd.trim())   patch.endDate   = newEnd.trim();
        if(!Object.keys(patch).length){
          setStatus('Ù„Ù… ÙŠØªÙ… ØªØºÙŠÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯.');
          return;
        }
        try{
          setStatus('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯...');
          await App.FB.updateTenant(item.buildingId, item.tenantId, patch);
          setStatus('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯. Ø§Ø¶ØºØ· "Ø­Ø³Ø§Ø¨" Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.');
        }catch(err){
          console.error(err);
          setStatus('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯: ' + (err?.message || err));
        }
      }
    };
  }

  refreshDefaults();


  async function checkInstance(){
    try{
      setStatus('Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø­Ø§Ù„Ø© UltraMsg...');
      const st = await waGetInstanceStatus();

      let statusValue = null;
      if(st){
        if(typeof st.status === 'string'){
          statusValue = st.status;
        }else if(st.status && st.status.accountStatus && typeof st.status.accountStatus.status === 'string'){
          statusValue = st.status.accountStatus.status;
        }else if(st.response && st.response.status && st.response.status.accountStatus && typeof st.response.status.accountStatus.status === 'string'){
          statusValue = st.response.status.accountStatus.status;
        }else if(typeof st.state === 'string'){
          statusValue = st.state;
        }else if(typeof st.auth_status === 'string'){
          statusValue = st.auth_status;
        }else if(typeof st.authStatus === 'string'){
          statusValue = st.authStatus;
        }else if(typeof st.message === 'string'){
          statusValue = st.message;
        }
      }
      const status = statusValue ? String(statusValue) : waPrettyJson(st);

      setStatus('Ø­Ø§Ù„Ø© UltraMsg: ' + status);

      const dbg = {
        instance_id: String(ULTRAMSG_INSTANCE_ID||'').trim(),
        token_length: String(ULTRAMSG_TOKEN||'').trim().length,
        response: st
      };

      setDebug(`<pre style="direction:ltr;text-align:left;background:#0b1220;color:#e5e7eb;padding:10px;border-radius:12px;white-space:pre-wrap">${waEscapeHtml(waPrettyJson(dbg))}</pre>`);
      return status;
    }catch(e){
      const tokLen = String(ULTRAMSG_TOKEN||'').trim().length;
      setStatus('Ø®Ø·Ø£ ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø©: ' + (e?.message||e) + ` (instance: ${String(ULTRAMSG_INSTANCE_ID||'').trim()}, token_len: ${tokLen})`);
      setDebug('');
      return null;
    }
  }

  async function showLogs(){
    try{
      setStatus('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø³Ø¬Ù„ UltraMsg...');
      const statuses = ['queue','invalid','unsent','sent'];
      const blocks = [];
      for(const st of statuses){
        const out = await waGetMessagesLog(st, 10, 1);
        const arr = Array.isArray(out?.messages) ? out.messages : (Array.isArray(out) ? out : []);
        blocks.push({ st, arr });
      }
      const htmlBlocks = blocks.map(b=>{
        const rows = (b.arr||[]).slice(0,10).map(x=>{
          const to = (x.to || x.chatId || x.contact || x.phone || 'â€”');
          const body = (x.body || x.text || x.message || '').toString().slice(0,160);
          const id = (x.id || x.msgId || x.messageId || 'â€”');
          return `<div style="border:1px solid var(--border);border-radius:12px;padding:8px;margin:8px 0;background:#fff">
            <div style="font-weight:600">${b.st.toUpperCase()} â€¢ <span class="muted">${waEscapeHtml(String(to))}</span></div>
            <div class="muted" style="font-size:12px">ID: ${waEscapeHtml(String(id))}</div>
            <div style="font-size:13px;margin-top:6px;white-space:pre-wrap">${waEscapeHtml(String(body))}</div>
          </div>`;
        }).join('') || `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±.</div>`;
        return `<div style="margin-bottom:12px">
          <div style="font-weight:700;margin:6px 0">${b.st.toUpperCase()}</div>
          ${rows}
        </div>`;
      }).join('');
      setStatus('ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„.');
      setDebug(htmlBlocks);
    }catch(e){
      setStatus('Ø®Ø·Ø£ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„: ' + (e?.message||e));
      setDebug('');
    }
  }

  async function showSettings(){
    try{
      setStatus('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª UltraMsg...');
      const st = await waGetInstanceSettings();
      setStatus('ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.');
      setDebug(`<pre style="direction:ltr;text-align:left;background:#0b1220;color:#e6eefc;padding:12px;border-radius:12px;white-space:pre-wrap">${waEscapeHtml(waPrettyJson(st))}</pre>`);
    }catch(e){
      setStatus('Ø®Ø·Ø£ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: ' + (e?.message||e));
      setDebug('');
    }
  }

  async function clearQueue(){
    try{
      if(!confirm('Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ QUEUE Ø¯Ø§Ø®Ù„ UltraMsgØŸ')) return;
      setStatus('Ø¬Ø§Ø±ÙŠ Ù…Ø³Ø­ QUEUE...');
      const out = await waClearMessages('queue');
      setStatus('ØªÙ… Ù…Ø³Ø­ QUEUE.');
      setDebug(`<pre style="direction:ltr;text-align:left;background:#0b1220;color:#e6eefc;padding:12px;border-radius:12px;white-space:pre-wrap">${waEscapeHtml(waPrettyJson(out))}</pre>`);
    }catch(e){
      setStatus('Ø®Ø·Ø£ Ù…Ø³Ø­ QUEUE: ' + (e?.message||e));
      setDebug('');
    }
  }

  async function restartInstance(){
    try{
      if(!confirm('Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ù†Ø³ØªØ§Ù†Ø³ ÙÙŠ UltraMsgØŸ Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø«ÙˆØ§Ù†Ù.')) return;
      setStatus('Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ù†Ø³ØªØ§Ù†Ø³...');
      const out = await waRestartInstance();
      setStatus('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„. Ø§ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¢Ù†.');
      setDebug(`<pre style="direction:ltr;text-align:left;background:#0b1220;color:#e6eefc;padding:12px;border-radius:12px;white-space:pre-wrap">${waEscapeHtml(waPrettyJson(out))}</pre>`);
    }catch(e){
      setStatus('Ø®Ø·Ø£ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„: ' + (e?.message||e));
      setDebug('');
    }
  }

  if(checkBtn) checkBtn.onclick = ()=> checkInstance();
  if(settingsBtn) settingsBtn.onclick = ()=> showSettings();
  if(logsBtn) logsBtn.onclick = ()=> showLogs();
  if(clearQueueBtn) clearQueueBtn.onclick = ()=> clearQueue();
  if(restartBtn) restartBtn.onclick = ()=> restartInstance();


  async function calc(){
    const t = getTarget();
    setStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...');
    const res = await waCollectUnpaidTenants(t.y, t.m);
    cache = res;

    const total = res.recipients.length;


    if(skippedCard){
      const hasSkipped = (res.skipped.paid || res.skipped.noPhone || res.skipped.inactive);
      skippedCard.style.display = hasSkipped ? 'block' : 'none';
      if(skipPaidBtn)     skipPaidBtn.textContent     = `Ù…Ø¯ÙÙˆØ¹ (${res.skipped.paid})`;
      if(skipNoPhoneBtn)  skipNoPhoneBtn.textContent  = `Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù… (${res.skipped.noPhone})`;
      if(skipInactiveBtn) skipInactiveBtn.textContent = `ØºÙŠØ± Ù†Ø´Ø· (${res.skipped.inactive})`;
      if(skippedListEl)   skippedListEl.innerHTML = '<div class="muted">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£Ø­Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.</div>';
    }

    countsEl.innerHTML = `Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ: ${res.buildingsCount} â€¢ Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙˆÙ†: ${total} â€¢ ØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯: 
        <span data-skip="paid" style="color:var(--primary);text-decoration:underline;cursor:pointer">Ù…Ø¯ÙÙˆØ¹: ${res.skipped.paid}</span> â€¢ 
        <span data-skip="noPhone" style="color:var(--primary);text-decoration:underline;cursor:pointer">Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…: ${res.skipped.noPhone}</span> â€¢ 
        <span data-skip="inactive" style="color:var(--primary);text-decoration:underline;cursor:pointer">ØºÙŠØ± Ù†Ø´Ø·: ${res.skipped.inactive}</span>`;

    if(!total){
      listEl.innerHTML = '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ£Ø¬Ø±ÙˆÙ† Ù…Ø³ØªØ­Ù‚ÙˆÙ† Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯.</div>';
      setStatus('Ø¬Ø§Ù‡Ø².');
      return;
    }

    listEl.innerHTML = res.recipients.map((r,i)=>`
      <div id="waRow_${i}" style="border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:8px;background:#fff">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start">
          <label style="display:flex;align-items:flex-start;gap:8px;cursor:pointer">
            <input type="checkbox" class="waSelect" data-index="${i}" style="margin-top:4px">
            <div>
              <div style="font-weight:600">${r.name || 'â€”'} <span class="muted">(${r.unit || 'â€”'})</span></div>
              <div class="muted" style="font-size:12px">${r.building} â€¢ ${r.phone} â€¢ ${Number(r.rent||0).toFixed(3)} Ø±.Ø¹</div>
            </div>
          </label>
          <div class="badge gray" id="waSt_${i}">Ø¬Ø§Ù‡Ø²</div>
        </div>
      </div>
    `).join('');
    setStatus('Ø¬Ø§Ù‡Ø².');
  }
document.getElementById('waCalc').onclick = ()=> calc().catch(e=> setStatus('Ø®Ø·Ø£: ' + (e?.message||e)));

  // Ø²Ø± ØªØ¬Ø±Ø¨Ø©: ÙŠØ±Ø³Ù„ Ø±Ø³Ø§Ù„ØªÙŠÙ† ÙÙ‚Ø· (Ù„Ø´Ø®ØµÙŠÙ† Ù…Ø­Ø¯Ø¯ÙŠÙ†)
  
  // Ø²Ø± ØªØ¬Ø±Ø¨Ø©: ÙŠØ±Ø³Ù„ Ø±Ø³Ø§Ù„ØªÙŠÙ† ÙÙ‚Ø· (Ù„Ø´Ø®ØµÙŠÙ† Ù…Ø­Ø¯Ø¯ÙŠÙ†)
  testBtn.onclick = async ()=>{
    const origText = testBtn.textContent;
    try{
      setDebug('');
      const st = await checkInstance();
      const stLower = String(st || '').toLowerCase();
      if((!st || (st && !stLower.includes('authenticated'))) && !(allowQueueEl && allowQueueEl.checked)){
        setStatus('Ø­Ø§Ù„Ø© UltraMsg Ù„ÙŠØ³Øª authenticated. Ø§ÙØªØ­ Ù„ÙˆØ­Ø© UltraMsg ÙˆØ§Ø¶ØºØ· initialize Ø«Ù… Ø§Ø±Ø¨Ø· Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (QR). Ø¨Ø¹Ø¯ Ø£Ù† ØªØµØ¨Ø­ authenticated Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.');
        return;
      }

      if(!cache){
        await calc();
      }
      if(!cache || !cache.recipients || !cache.recipients.length){
        setStatus('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ£Ø¬Ø±ÙˆÙ† Ù„Ù„ØªØ¬Ø±Ø¨Ø©.');
        return;
      }

      const tpl = (bodyEl.value || '').trim();
      if(!tpl){
        setStatus('Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±Øº.');
        bodyEl.focus();
        return;
      }

      const TEST_PHONES = ['+96899808079', '+96891234567'];
      const targets = cache.recipients.filter(r => TEST_PHONES.includes(r.phone));
      if(!targets.length){
        setStatus('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ£Ø¬Ø±ÙˆÙ† Ù…Ø·Ø§Ø¨Ù‚ÙˆÙ† Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.');
        return;
      }

      testBtn.disabled = true;
      testBtn.textContent = '... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ø±Ø¨Ø©';

      const t = getTarget();
      const monthTxt = waMonthLabel(cache.targetY, cache.targetM);
      let ok = 0, fail = 0;
      const report = [];

      stopSending = false;
      if(stopBtn){
        stopBtn.disabled = false;
        stopBtn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
      }

      for(let i = 0; i < targets.length; i++){
        if(stopSending){
          setStatus(`ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ. ØªÙ…: ${ok} âœ… â€” ÙØ´Ù„: ${fail} âŒ â€” (${i}/${targets.length})`);
          break;
        }
        const r = targets[i];
        const rowIndex = cache.recipients.indexOf(r);
        const stEl = document.getElementById(`waSt_${rowIndex}`);
        const msg = waApplyTemplate(tpl, {
          name: r.name,
          unit: r.unit,
          building: r.building,
          rent: Number(r.rent || 0).toFixed(3),
          monthName: monthTxt,
          month: monthTxt,
          year: String(cache.targetY),
          ym: r.ym,
          adminPhone: (adminPhoneEl ? (adminPhoneEl.value || '').trim() : (localStorage.getItem(WA_ADMIN_PHONE_KEY) || '').trim())
        });

        try{
          if(stEl){
            stEl.textContent = '... Ø¥Ø±Ø³Ø§Ù„';
            stEl.className = 'badge primary';
          }
          await waSendChatMessage(r.phone, msg);
          ok++;
          if(stEl){
            stEl.textContent = 'ØªÙ… âœ…';
            stEl.className = 'badge success';
          }
          report.push({ ...r, success: true, error: '' });
        }catch(err){
          fail++;
          if(stEl){
            stEl.textContent = 'ÙØ´Ù„ âŒ';
            stEl.className = 'badge gray';
          }
          console.warn('WA send error', r.phone, err);
          report.push({ ...r, success: false, error: (err && err.message) || String(err) });
        }

        setStatus(`ØªÙ…: ${ok} âœ… â€” ÙØ´Ù„: ${fail} âŒ â€” (${i+1}/${targets.length})`);
        await new Promise(res => setTimeout(res, 2500));
      }

      renderReport(report);
      setStatus(`Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©. ØªÙ…: ${ok} âœ… â€” ÙØ´Ù„: ${fail} âŒ`);
    }catch(err){
      console.error(err);
      setStatus('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¬Ø±Ø¨Ø©: ' + (err?.message || err));
    }finally{
      testBtn.disabled = false;
      testBtn.textContent = origText;
      if(stopBtn){
        stopBtn.disabled = true;
        stopBtn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
      }
    }
  }


  // Ø²Ø± "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†": ÙŠØ±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ† Ø£Ùˆ Ù„Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙ‚Ø·
  sendBtn.onclick = async ()=>{
    const origText = sendBtn.textContent;
    try{
      setDebug('');
      const st = await checkInstance();
      const stLower = String(st || '').toLowerCase();
      if((!st || (st && !stLower.includes('authenticated'))) && !(allowQueueEl && allowQueueEl.checked)){
        setStatus('Ø­Ø§Ù„Ø© UltraMsg Ù„ÙŠØ³Øª authenticated. Ø§ÙØªØ­ Ù„ÙˆØ­Ø© UltraMsg ÙˆØ§Ø¶ØºØ· initialize Ø«Ù… Ø§Ø±Ø¨Ø· Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (QR). Ø¨Ø¹Ø¯ Ø£Ù† ØªØµØ¨Ø­ authenticated Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.');
        return;
      }

      if(!cache){
        await calc();
      }
      if(!cache || !cache.recipients || !cache.recipients.length){
        setStatus('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ£Ø¬Ø±ÙˆÙ† Ù„Ù„Ø¥Ø±Ø³Ø§Ù„.');
        return;
      }

      const tpl = (bodyEl.value || '').trim();
      if(!tpl){
        setStatus('Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±Øº.');
        bodyEl.focus();
        return;
      }

      const allRecipients = cache.recipients;
      const selectedIdx = Array.from(document.querySelectorAll('#waList input.waSelect:checked'))
        .map(el => parseInt(el.getAttribute('data-index') || '-1', 10))
        .filter(i => !Number.isNaN(i) && allRecipients[i]);

      let targets;

      if(selectedIdx.length){
        // Ø¥Ø±Ø³Ø§Ù„ ÙÙ‚Ø· Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ† ÙŠØ¯ÙˆÙŠÙ‹Ø§
        targets = selectedIdx.map(i => allRecipients[i]);

        // Ø·Ø¨Ù‚Ø© Ø£Ù…Ø§Ù† Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
        if(targets.length > 20){
          const okConfirm = window.confirm(`Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ ${targets.length} Ù…Ø³ØªØ£Ø¬Ø± Ù…Ø­Ø¯Ø¯. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`);
          if(!okConfirm){
            setStatus('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….');
            return;
          }
        }
      }else{
        // Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ø³ØªØ£Ø¬Ø± â†’ Ø§Ø¹ØªØ¨Ø± Ø£Ù† Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø³ÙŠÙƒÙˆÙ† Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        const total = allRecipients.length;
        const okConfirm = window.confirm(
          `Ù„Ù… ØªÙ‚Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ø³ØªØ£Ø¬Ø±.
` +
          `Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (${total}).
` +
          `Ù‚Ø¯ ÙŠØ¤Ø¯ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¯Ø¯ ÙƒØ¨ÙŠØ± Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© Ø¥Ù„Ù‰ ØªÙ‚ÙŠÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ù† Ø´Ø±ÙƒØ© Ù…ÙŠØªØ§.

` +
          'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ'
        );
        if(!okConfirm){
          setStatus('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….');
          return;
        }
        targets = allRecipients.slice();
      }

      sendBtn.disabled = true;
      sendBtn.textContent = '... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';

      const t = getTarget();
      const monthTxt = waMonthLabel(cache.targetY, cache.targetM);
      let ok = 0, fail = 0;
      const report = [];

      stopSending = false;
      if(stopBtn){
        stopBtn.disabled = false;
        stopBtn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
      }

      for(let i = 0; i < targets.length; i++){
        if(stopSending){
          setStatus(`ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ. ØªÙ…: ${ok} âœ… â€” ÙØ´Ù„: ${fail} âŒ â€” (${i}/${targets.length})`);
          break;
        }
        const r = targets[i];
        const rowIndex = cache.recipients.indexOf(r);
        const stEl = document.getElementById(`waSt_${rowIndex}`);
        const msg = waApplyTemplate(tpl, {
          name: r.name,
          unit: r.unit,
          building: r.building,
          rent: Number(r.rent || 0).toFixed(3),
          monthName: monthTxt,
          month: monthTxt,
          year: String(cache.targetY),
          ym: r.ym,
          adminPhone: (adminPhoneEl ? (adminPhoneEl.value || '').trim() : (localStorage.getItem(WA_ADMIN_PHONE_KEY) || '').trim())
        });

        try{
          if(stEl){
            stEl.textContent = '... Ø¥Ø±Ø³Ø§Ù„';
            stEl.className = 'badge primary';
          }
          await waSendChatMessage(r.phone, msg);
          ok++;
          if(stEl){
            stEl.textContent = 'ØªÙ… âœ…';
            stEl.className = 'badge success';
          }
          report.push({ ...r, success: true, error: '' });
        }catch(err){
          fail++;
          if(stEl){
            stEl.textContent = 'ÙØ´Ù„ âŒ';
            stEl.className = 'badge gray';
          }
          console.warn('WA send error', r.phone, err);
          report.push({ ...r, success: false, error: (err && err.message) || String(err) });
        }

        setStatus(`ØªÙ…: ${ok} âœ… â€” ÙØ´Ù„: ${fail} âŒ â€” (${i+1}/${targets.length})`);
        await new Promise(res => setTimeout(res, 2500));
      }

      renderReport(report);
      setStatus(`Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. ØªÙ…: ${ok} âœ… â€” ÙØ´Ù„: ${fail} âŒ`);
    }catch(err){
      console.error(err);
      setStatus('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + (err?.message || err));
    }finally{
      sendBtn.disabled = false;
      sendBtn.textContent = origText;
      if(stopBtn){
        stopBtn.disabled = true;
        stopBtn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
      }
    }
  };
  if(send40Btn){
    send40Btn.onclick = async ()=>{
      const origText = send40Btn.textContent;
      try{
        setDebug('');
        const st = await checkInstance();
        const stLower = String(st || '').toLowerCase();
        if((!st || (st && !stLower.includes('authenticated'))) && !(allowQueueEl && allowQueueEl.checked)){
          setStatus('Ø­Ø§Ù„Ø© UltraMsg Ù„ÙŠØ³Øª authenticated. Ø§ÙØªØ­ Ù„ÙˆØ­Ø© UltraMsg ÙˆØ§Ø¶ØºØ· initialize Ø«Ù… Ø§Ø±Ø¨Ø· Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (QR). Ø¨Ø¹Ø¯ Ø£Ù† ØªØµØ¨Ø­ authenticated Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.');
          return;
        }

        if(!cache){
          await calc();
        }
        if(!cache || !cache.recipients || !cache.recipients.length){
          setStatus('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ£Ø¬Ø±ÙˆÙ† Ù„Ù„Ø¥Ø±Ø³Ø§Ù„.');
          return;
        }

        const tpl = (bodyEl.value || '').trim();
        if(!tpl){
          setStatus('Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±Øº.');
          bodyEl.focus();
          return;
        }

        const allRecipients = cache.recipients;
        const pending = [];
        for(let i = 0; i < allRecipients.length; i++){
          const r = allRecipients[i];
          const stEl = document.getElementById(`waSt_${i}`);
          const stTxt = (stEl && stEl.textContent || '').trim();
          // Ù†Ø¹ØªØ¨Ø±Ù‡ "Ù„Ù… ÙŠÙØ±Ø³Ù„ Ø¨Ø¹Ø¯" Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¬Ø§Ù‡Ø² Ø£Ùˆ ÙØ§Ø±Øº Ø£Ùˆ Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
          if(!stTxt || stTxt === 'Ø¬Ø§Ù‡Ø²' || stTxt === 'Ready' || stTxt === 'â€”'){
            pending.push({ r, index: i });
          }
        }

        if(!pending.length){
          setStatus('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ£Ø¬Ø±ÙˆÙ† Ù…ØªØ¨Ù‚ÙˆÙ† Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ (ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù‡Ù… Ø£Ùˆ ØªÙ…Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©).');
          return;
        }

        const MAX_BATCH = 40;
        const targets = pending.slice(0, MAX_BATCH);
        const remaining = pending.length - targets.length;

        const okConfirm = window.confirm(
          `Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ ${targets.length} Ù…Ø³ØªØ£Ø¬Ø± ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø© Ù…Ù† Ø£ØµÙ„ ${pending.length} Ù…Ø³ØªØ£Ø¬Ø± Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù‡Ù… Ø¨Ø¹Ø¯.\n` +
          `ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¯ÙØ¹Ø§Øª Ø£Ø®Ø±Ù‰ (ÙƒÙ„ Ø¯ÙØ¹Ø© Ø­ØªÙ‰ 40 Ù…Ø³ØªØ£Ø¬Ø±).\n\n` +
          'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ'
        );
        if(!okConfirm){
          setStatus('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….');
          return;
        }

        send40Btn.disabled = true;
        send40Btn.textContent = '... Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¯ÙØ¹Ø© 40';

        const t = getTarget();
        const monthTxt = waMonthLabel(cache.targetY, cache.targetM);
        let ok = 0, fail = 0;
        const report = [];

        stopSending = false;
        if(stopBtn){
          stopBtn.disabled = false;
          stopBtn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
        }

        for(let i = 0; i < targets.length; i++){
          if(stopSending){
            setStatus(`ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ. ØªÙ…: ${ok} âœ… â€” ÙØ´Ù„: ${fail} âŒ â€” (${i}/${targets.length})`);
            break;
          }

          const { r, index } = targets[i];
          const stEl = document.getElementById(`waSt_${index}`);
          const msg = waApplyTemplate(tpl, {
            name: r.name,
            unit: r.unit,
            building: r.building,
            rent: Number(r.rent || 0).toFixed(3),
            monthName: monthTxt,
            month: monthTxt,
            year: String(cache.targetY),
            ym: r.ym,
            adminPhone: (adminPhoneEl ? (adminPhoneEl.value || '').trim() : (localStorage.getItem(WA_ADMIN_PHONE_KEY) || '').trim())
          });

          try{
            if(stEl){
              stEl.textContent = '... Ø¥Ø±Ø³Ø§Ù„';
              stEl.className = 'badge primary';
            }
            await waSendChatMessage(r.phone, msg);
            ok++;
            if(stEl){
              stEl.textContent = 'ØªÙ… âœ…';
              stEl.className = 'badge success';
            }
            report.push({ ...r, success: true, error: '' });
          }catch(err){
            fail++;
            if(stEl){
              stEl.textContent = 'ÙØ´Ù„ âŒ';
              stEl.className = 'badge gray';
            }
            console.warn('WA send error', r.phone, err);
            report.push({ ...r, success: false, error: (err && err.message) || String(err) });
          }

          setStatus(`ØªÙ…: ${ok} âœ… â€” ÙØ´Ù„: ${fail} âŒ â€” (${i+1}/${targets.length})`);
          await new Promise(res => setTimeout(res, 2500));
        }

        renderReport(report);

        if(remaining > 0){
          setStatus(`Ø§ÙƒØªÙ…Ù„ Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©. ØªÙ…: ${ok} âœ… â€” ÙØ´Ù„: ${fail} âŒ. ØªØ¨Ù‚Ù‘Ù‰ ${remaining} Ù…Ø³ØªØ£Ø¬Ø± ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù‡Ù… ÙÙŠ Ø¯ÙØ¹Ø§Øª Ù„Ø§Ø­Ù‚Ø©.`);
        }else{
          setStatus(`Ø§ÙƒØªÙ…Ù„ Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©. ØªÙ…: ${ok} âœ… â€” ÙØ´Ù„: ${fail} âŒ. Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ£Ø¬Ø±ÙˆÙ† Ù…ØªØ¨Ù‚ÙˆÙ† Ø¨Ø¯ÙˆÙ† Ø¥Ø±Ø³Ø§Ù„.`);
        }
      }catch(err){
        console.error(err);
        setStatus('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + (err?.message || err));
      }finally{
        send40Btn.disabled = false;
        send40Btn.textContent = origText;
        if(stopBtn){
          stopBtn.disabled = true;
          stopBtn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
        }
      }
    };
  }


}
/* ======================= Valuation (ØªØ«Ù…ÙŠÙ†) â€” Inline Actions ======================= */
(function(){
  const KEY_BROKERS = 'demo_val_brokers_v1';

  const ValData = {
    getBrokers(){
      try{ return JSON.parse(localStorage.getItem(KEY_BROKERS) || '[]') || []; }catch(e){ return []; }
    },
    setBrokers(list){
      localStorage.setItem(KEY_BROKERS, JSON.stringify(list||[]));
    },
    addBroker(b){
      const list = ValData.getBrokers();
      list.push(b);
      ValData.setBrokers(list);
      return b;
    },
    removeBroker(id){
      const list = ValData.getBrokers().filter(x => x.id !== id);
      ValData.setBrokers(list);
    }
  };

  const esc = (s)=> String(s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  async function getValBanks(){
    // Prefer cached list
    const cached = (window.App?.State?.cachedBuildings) || [];
    const list = cached.length ? cached : await window.App.FB.listBuildings();
    return (list || []).filter(b => (b.bizType||'') === 'ØªØ«Ù…ÙŠÙ†');
  }

  function openPrintWindow(title, bodyHtml){
    const w = window.open('', '_blank');
    if(!w){ alert('ØªØ¹Ø°Ø± ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø­Ø¸Ø± Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù…ÙØ¹Ù‘Ù„).'); return; }
    const html = `
      <!doctype html><html lang="ar" dir="rtl">
      <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <title>${esc(title||'')}</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
        <style>
          body{ font-family:"Tajawal",system-ui; margin:24px; color:#0f172a; }
          h1{ font-size:18px; margin:0 0 10px 0; }
          .muted{ color:#6b7280; font-size:12px; }
          .card{ border:1px solid #e5e7eb; border-radius:14px; padding:14px; margin-top:12px; }
          table{ width:100%; border-collapse:collapse; margin-top:8px; }
          th,td{ border:1px solid #e5e7eb; padding:8px; font-size:13px; text-align:right; vertical-align:top; }
          th{ background:#f8fafc; }
          .row{ display:flex; gap:10px; flex-wrap:wrap; }
          .pill{ border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-size:12px; background:#fff; }
          @media print{ body{ margin:0; } .no-print{ display:none !important; } }
        </style>
      </head>
      <body>
        <div class="no-print" style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px">
          <div class="muted">${new Date().toLocaleString('ar-OM')}</div>
          <button onclick="window.print()" style="border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>
        <h1>${esc(title||'')}</h1>
        ${bodyHtml||''}
      </body></html>`;
    w.document.open(); w.document.write(html); w.document.close();
  }

  function openBrokersModal(){
    const list = ValData.getBrokers();
    window.App.UI.openModal('Ø³Ù…Ø§Ø³Ø±Ø© Ø§Ù„ØªØ«Ù…ÙŠÙ†', `
      <div class="grid cols-2">
        <div><label>Ø§Ø³Ù… Ø§Ù„Ø³Ù…Ø³Ø§Ø±</label><input id="brName" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø§Ù„Ù… Ø§Ù„Ù…Ø¹Ù…Ø±ÙŠ"></div>
        <div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="brPhone" placeholder="9xxxxxxx"></div>
        <div><label>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©/Ø§Ù„Ø³Ø¬Ù„</label><input id="brId" placeholder="ØºÙŠØ± Ø­Ù‚ÙŠÙ‚ÙŠ"></div>
        <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="brNote" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-start;margin-top:10px;flex-wrap:wrap">
        <button class="btn primary" id="brSave">ğŸ’¾ Ø­ÙØ¸ Ø³Ù…Ø³Ø§Ø±</button>
        <button class="btn" id="brSeed">ğŸ² Ø¥Ø¶Ø§ÙØ© Ø³Ù…Ø³Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ</button>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h"><b>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ù…Ø§Ø³Ø±Ø©</b></div>
        <div class="card-c" id="brList"></div>
      </div>
    `);

    const render = ()=>{
      const rows = ValData.getBrokers();
      const box = document.getElementById('brList');
      if(!box) return;
      if(!rows.length){
        box.innerHTML = '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ù…Ø§Ø³Ø±Ø© Ø¨Ø¹Ø¯.</div>';
        return;
      }
      box.innerHTML = `
        <table>
          <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th style="width:1%">Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
          <tbody>
            ${rows.map(b=>`
              <tr>
                <td>${esc(b.name)}</td>
                <td>${esc(b.phone)}</td>
                <td>${esc(b.idNo)}</td>
                <td>${esc(b.note||'')}</td>
                <td><button class="btn mini" data-br-del="${esc(b.id)}">ğŸ—‘ï¸</button></td>
              </tr>`).join('')}
          </tbody>
        </table>
      `;
      box.querySelectorAll('[data-br-del]').forEach(btn=>{
        btn.onclick = ()=>{
          ValData.removeBroker(btn.getAttribute('data-br-del'));
          render();
        };
      });
    };

    const seedNames = ['Ø³Ø§Ù„Ù…','Ø®Ø§Ù„Ø¯','Ø£Ø­Ù…Ø¯','Ù†Ø§ØµØ±','Ø±Ø§Ø´Ø¯','Ù…Ø­Ù…Ø¯','Ø­Ù…ÙˆØ¯','Ø³ÙŠÙ','Ø¹Ù„ÙŠ','Ù…Ø§Ø²Ù†'];
    const seedLast  = ['Ø§Ù„Ø­Ù…Ø§Ø¯ÙŠ','Ø§Ù„Ù…Ø¹Ù…Ø±ÙŠ','Ø§Ù„Ø±Ø§Ø´Ø¯ÙŠ','Ø§Ù„Ù‡Ù†Ø§Ø¦ÙŠ','Ø§Ù„Ø²ÙƒÙˆØ§Ù†ÙŠ','Ø§Ù„Ø¹Ø¨Ø±ÙŠ','Ø§Ù„ØºØ§ÙØ±ÙŠ','Ø§Ù„ÙƒÙ†Ø¯ÙŠ','Ø§Ù„Ø¨Ù„ÙˆØ´ÙŠ'];
    const fakePhone = ()=> '9' + String(Math.floor(1000000 + Math.random()*8999999));

    document.getElementById('brSave').onclick = ()=>{
      const name = (document.getElementById('brName').value||'').trim();
      if(!name){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø³Ù…Ø³Ø§Ø±'); return; }
      const b = {
        id: 'br_' + Date.now().toString(36) + Math.floor(Math.random()*999).toString(36),
        name,
        phone: (document.getElementById('brPhone').value||'').trim(),
        idNo: (document.getElementById('brId').value||'').trim(),
        note: (document.getElementById('brNote').value||'').trim(),
        createdAt: new Date().toISOString()
      };
      ValData.addBroker(b);
      // clear inputs
      ['brName','brPhone','brId','brNote'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      render();
    };

    document.getElementById('brSeed').onclick = ()=>{
      const b = {
        id: 'br_' + Date.now().toString(36) + Math.floor(Math.random()*999).toString(36),
        name: seedNames[Math.floor(Math.random()*seedNames.length)] + ' ' + seedLast[Math.floor(Math.random()*seedLast.length)],
        phone: fakePhone(),
        idNo: 'ID' + Math.floor(100000 + Math.random()*899999),
        note: 'Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©',
        createdAt: new Date().toISOString()
      };
      ValData.addBroker(b);
      render();
    };

    render();
  }

  async function openValFilesModal(){
    const banks = await getValBanks();
    if(!banks.length){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ù†ÙˆÙƒ ÙÙŠ Ù‚Ø³Ù… Ø§Ù„ØªØ«Ù…ÙŠÙ†.'); return; }

    const options = banks.map(b=> `<option value="${esc(b.id)}">${esc(b.name||'Ø¨Ù†Ùƒ')}</option>`).join('');
    window.App.UI.openModal('Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„ØªØ«Ù…ÙŠÙ†', `
      <div class="grid cols-2">
        <div>
          <label>Ø§Ø®ØªØ± Ø¨Ù†Ùƒ</label>
          <select id="vfBank">${options}</select>
        </div>
        <div>
          <label>Ø±ÙØ¹ Ù…Ù„Ù</label>
          <input id="vfFile" type="file" />
        </div>
      </div>

      <div style="display:flex;gap:8px;justify-content:flex-start;margin-top:10px;flex-wrap:wrap">
        <button class="btn primary" id="vfUpload">â¬†ï¸ Ø±ÙØ¹</button>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="card-h"><b>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</b></div>
        <div class="card-c" id="vfList"><span class="muted">â€”</span></div>
      </div>

      <div class="muted" style="margin-top:10px">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ù†Ø³Ø®Ø© Ù…Ø¹Ø§ÙŠÙ†Ø©Ø› Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù‡Ù†Ø§ Ù…Ø­Ù„ÙŠØ© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.
      </div>
    `);

    const sel = document.getElementById('vfBank');
    const fileInp = document.getElementById('vfFile');

    const render = async ()=>{
      const bid = sel.value;
      const list = await window.App.FB.listAttachments(bid);
      const box = document.getElementById('vfList');
      if(!box) return;
      if(!list || !list.length){
        box.innerHTML = '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯.</div>';
        return;
      }
      box.innerHTML = `
        <table>
          <thead><tr><th>Ø§Ù„Ù…Ù„Ù</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th style="width:1%">ÙØªØ­</th><th style="width:1%">Ø­Ø°Ù</th></tr></thead>
          <tbody>
            ${list.map(a=>{
              const dt = a.createdAt ? new Date(a.createdAt).toLocaleString('ar-OM') : 'â€”';
              const openBtn = a.url ? `<a class="btn mini" href="${esc(a.url)}" target="_blank" rel="noopener">ğŸ‘ï¸</a>` : `<span class="muted">â€”</span>`;
              return `
                <tr>
                  <td>${esc(a.name||'file')}</td>
                  <td>${esc(dt)}</td>
                  <td>${openBtn}</td>
                  <td><button class="btn mini" data-att-del="${esc(a.id)}">ğŸ—‘ï¸</button></td>
                </tr>`;
            }).join('')}
          </tbody>
        </table>
      `;
      box.querySelectorAll('[data-att-del]').forEach(btn=>{
        btn.onclick = async ()=>{
          const bid2 = sel.value;
          await window.App.FB.deleteAttachment(bid2, btn.getAttribute('data-att-del'));
          render();
        };
      });
    };

    document.getElementById('vfUpload').onclick = async ()=>{
      const bid = sel.value;
      const f = fileInp.files?.[0];
      if(!f){ alert('Ø§Ø®ØªØ± Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹'); return; }
      const url = URL.createObjectURL(f);
      await window.App.FB.addAttachment(bid, f, { url });
      fileInp.value = '';
      render();
    };

    sel.onchange = ()=> render();
    render();
  }

  async function openValuationReport(){
    const banks = await getValBanks();
    const brokers = ValData.getBrokers();
    const counts = {
      banks: banks.length,
      brokers: brokers.length
    };

    const body = `
      <div class="row">
        <div class="pill">Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù†ÙˆÙƒ: <b>${counts.banks}</b></div>
        <div class="pill">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù…Ø§Ø³Ø±Ø©: <b>${counts.brokers}</b></div>
      </div>

      <div class="card">
        <div><b>Ø§Ù„Ø¨Ù†ÙˆÙƒ</b></div>
        <table>
          <thead><tr><th>Ø§Ù„Ø¨Ù†Ùƒ</th><th>Ø§Ù„Ø²Ø¨ÙˆÙ†</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th></tr></thead>
          <tbody>
            ${banks.map(b=>`
              <tr>
                <td>${esc(b.name||'')}</td>
                <td>${esc(b.owner||'')}</td>
                <td>${esc(b.contact||'')}</td>
                <td>${esc(b.location||'')}</td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
    `;

    window.App.UI.openModal('ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ«Ù…ÙŠÙ†', `
      <div class="muted" style="margin-bottom:8px">Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹ Ù„Ù‚Ø³Ù… Ø§Ù„ØªØ«Ù…ÙŠÙ†.</div>
      ${body}
      <div style="display:flex;gap:8px;justify-content:flex-start;margin-top:10px;flex-wrap:wrap">
        <button class="btn primary" id="vrPrint">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      </div>
    `);

    const btn = document.getElementById('vrPrint');
    if(btn) btn.onclick = ()=> openPrintWindow('ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ«Ù…ÙŠÙ†', body);
  }

  async function issueReport(type){
    if(type === 'brokers'){
      const brokers = ValData.getBrokers();
      const body = brokers.length ? `
        <div class="card">
          <table>
            <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>
            <tbody>
              ${brokers.map(b=>`
                <tr>
                  <td>${esc(b.name)}</td>
                  <td>${esc(b.phone)}</td>
                  <td>${esc(b.idNo)}</td>
                  <td>${esc(b.note||'')}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>
      ` : '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ù…Ø§Ø³Ø±Ø©.</div>';
      openPrintWindow('ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù…Ø§Ø³Ø±Ø© â€” Ø§Ù„ØªØ«Ù…ÙŠÙ†', body);
      return;
    }

    if(type === 'receipt'){
      const banks = await getValBanks();
      if(!banks.length){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ù†ÙˆÙƒ.'); return; }
      const opts = banks.map(b=> `<option value="${esc(b.id)}">${esc(b.name||'')}</option>`).join('');
      window.App.UI.openModal('Ø¥ØµØ¯Ø§Ø± Ø¥ÙŠØµØ§Ù„ Ù„Ù„Ø²Ø¨ÙˆÙ†', `
        <div class="grid cols-2">
          <div>
            <label>Ø§Ø®ØªØ± Ø¨Ù†Ùƒ</label>
            <select id="rcBank">${opts}</select>
          </div>
          <div>
            <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø¹)</label>
            <input id="rcAmount" type="number" step="0.001" placeholder="0.000">
          </div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-start;margin-top:10px;flex-wrap:wrap">
          <button class="btn primary" id="rcGo">ğŸ§¾ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥ÙŠØµØ§Ù„</button>
        </div>
      `);
      document.getElementById('rcGo').onclick = async ()=>{
        const bid = document.getElementById('rcBank').value;
        const amt = parseFloat(document.getElementById('rcAmount').value || '0') || 0;
        const bank = (await getValBanks()).find(b=>b.id===bid);
        if(!bank){ alert('Ø§Ø®ØªØ± Ø¨Ù†Ùƒ ØµØ­ÙŠØ­'); return; }
        if(!amt){ alert('Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }
        window.App.UI.closeModal();
        // reuse receipt generator
        if(typeof window.openReceipt === 'function'){
          window.openReceipt({
            tenantName: bank.owner || 'Ø²Ø¨ÙˆÙ†',
            unitNumber: bank.name || 'Ø¨Ù†Ùƒ',
            rent: amt,
            kind: 'bank',
            phone: bank.contact || '',
            idNumber: ''
          });
        }else{
          alert('Ù…ÙŠØ²Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.');
        }
      };
      return;
    }

    if(type === 'bankMonthly'){
      const banks = await getValBanks();
      if(!banks.length){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ù†ÙˆÙƒ.'); return; }
      const opts = banks.map(b=> `<option value="${esc(b.id)}">${esc(b.name||'')}</option>`).join('');
      window.App.UI.openModal('Ø¥ØµØ¯Ø§Ø± ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ Ù„Ù„Ø¨Ù†Ùƒ', `
        <div class="grid cols-2">
          <div>
            <label>Ø§Ø®ØªØ± Ø¨Ù†Ùƒ</label>
            <select id="mrBank">${opts}</select>
          </div>
          <div>
            <label>Ø§Ù„Ø´Ù‡Ø±/Ø§Ù„Ø³Ù†Ø©</label>
            <div style="display:flex;gap:8px">
              <select id="mrMonth" style="flex:1">
                ${Array.from({length:12}).map((_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}
              </select>
              <select id="mrYear" style="flex:1">
                ${Array.from({length:5}).map((_,i)=>{ const y=new Date().getFullYear()-1+i; return `<option value="${y}">${y}</option>`; }).join('')}
              </select>
            </div>
          </div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-start;margin-top:10px;flex-wrap:wrap">
          <button class="btn primary" id="mrGo">ğŸ“… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
      `);

      document.getElementById('mrGo').onclick = async ()=>{
        const bid = document.getElementById('mrBank').value;
        const m = Number(document.getElementById('mrMonth').value);
        const y = Number(document.getElementById('mrYear').value);
        const bank = (await getValBanks()).find(b=>b.id===bid);
        if(!bank){ alert('Ø§Ø®ØªØ± Ø¨Ù†Ùƒ ØµØ­ÙŠØ­'); return; }

        const atts = await window.App.FB.listAttachments(bid);
        const ym = `${y}-${String(m).padStart(2,'0')}`;
        const inMonth = (atts||[]).filter(a => (a.createdAt||'').startsWith(ym));
        const valuationsCount = inMonth.length;

        const body = `
          <div class="row">
            <div class="pill">Ø§Ù„Ø¨Ù†Ùƒ: <b>${esc(bank.name||'')}</b></div>
            <div class="pill">Ø§Ù„Ø²Ø¨ÙˆÙ†: <b>${esc(bank.owner||'')}</b></div>
            <div class="pill">Ø§Ù„ÙØªØ±Ø©: <b>${esc(ym)}</b></div>
          </div>
          <div class="card">
            <div><b>Ù…Ù„Ø®Øµ</b></div>
            <table>
              <tbody>
                <tr><th>Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª (Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª)</th><td><b>${valuationsCount}</b></td></tr>
                <tr><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><td>ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø· Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù„Ø§Ø­Ù‚Ø§Ù‹ (Ø±Ø³ÙˆÙ…ØŒ Ø¥ÙŠØ±Ø§Ø¯Ø§ØªØŒ Ù…ØµØ±ÙˆÙØ§Øª) Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</td></tr>
              </tbody>
            </table>
          </div>
          <div class="card">
            <div><b>Ù…Ø±ÙÙ‚Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</b></div>
            ${valuationsCount ? `
              <table>
                <thead><tr><th>Ø§Ù„Ù…Ù„Ù</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
                <tbody>
                  ${inMonth.map(a=>`<tr><td>${esc(a.name||'file')}</td><td>${esc(a.createdAt?new Date(a.createdAt).toLocaleString('ar-OM'):'â€”')}</td></tr>`).join('')}
                </tbody>
              </table>
            ` : `<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</div>`}
          </div>
        `;
        window.App.UI.closeModal();
        openPrintWindow('ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ Ù„Ù„Ø¨Ù†Ùƒ â€” Ø§Ù„ØªØ«Ù…ÙŠÙ†', body);
      };
      return;
    }

    if(type === 'brokerContract'){
      const brokers = ValData.getBrokers();
      if(!brokers.length){ alert('Ø£Ø¶Ù Ø³Ù…Ø§Ø³Ø±Ø© Ø£ÙˆÙ„Ø§Ù‹.'); return; }
      const banks = await getValBanks();
      const broOpts = brokers.map(b=> `<option value="${esc(b.id)}">${esc(b.name)}</option>`).join('');
      const bankOpts = banks.map(b=> `<option value="${esc(b.id)}">${esc(b.name||'')}</option>`).join('');

      window.App.UI.openModal('Ø¥ØµØ¯Ø§Ø± Ø¹Ù‚Ø¯ Ø³Ù…Ø³Ø§Ø±', `
        <div class="grid cols-2">
          <div>
            <label>Ø§Ø®ØªØ± Ø³Ù…Ø³Ø§Ø±</label>
            <select id="bcBroker">${broOpts}</select>
          </div>
          <div>
            <label>Ø§Ø®ØªØ± Ø¨Ù†Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <select id="bcBank"><option value="">â€”</option>${bankOpts}</select>
          </div>
          <div>
            <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (%)</label>
            <input id="bcComm" type="number" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 2.5">
          </div>
          <div>
            <label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù‚Ø¯</label>
            <input id="bcStart" type="date">
          </div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-start;margin-top:10px;flex-wrap:wrap">
          <button class="btn primary" id="bcGo">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯</button>
        </div>
      `);

      document.getElementById('bcGo').onclick = async ()=>{
        const brId = document.getElementById('bcBroker').value;
        const bankId = document.getElementById('bcBank').value;
        const comm = parseFloat(document.getElementById('bcComm').value || '0') || 0;
        const start = document.getElementById('bcStart').value || new Date().toISOString().slice(0,10);

        const broker = ValData.getBrokers().find(b=>b.id===brId);
        const bank = bankId ? (await getValBanks()).find(b=>b.id===bankId) : null;

        const body = `
          <div class="row">
            <div class="pill">Ø±Ù‚Ù… Ù…Ø±Ø¬Ø¹ÙŠ: <b>${esc('CN-' + Date.now().toString(36).toUpperCase())}</b></div>
            <div class="pill">Ø§Ù„ØªØ§Ø±ÙŠØ®: <b>${esc(start)}</b></div>
          </div>

          <div class="card">
            <div><b>Ø£Ø·Ø±Ø§Ù Ø§Ù„Ø¹Ù‚Ø¯</b></div>
            <table>
              <tbody>
                <tr><th>Ø§Ù„Ø³Ù…Ø³Ø§Ø±</th><td>${esc(broker?.name||'')}</td></tr>
                <tr><th>Ø§Ù„Ù‡Ø§ØªÙ</th><td>${esc(broker?.phone||'')}</td></tr>
                <tr><th>Ø§Ù„Ø±Ù‚Ù…</th><td>${esc(broker?.idNo||'')}</td></tr>
                <tr><th>Ø§Ù„Ø¨Ù†Ùƒ</th><td>${esc(bank?.name||'â€”')}</td></tr>
                <tr><th>Ø§Ù„Ø²Ø¨ÙˆÙ†</th><td>${esc(bank?.owner||'â€”')}</td></tr>
                <tr><th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th><td>${comm ? esc(comm) + '%' : 'â€”'}</td></tr>
              </tbody>
            </table>
          </div>

          <div class="card">
            <div><b>Ø¨Ù†ÙˆØ¯ Ù…Ø®ØªØµØ±Ø©</b></div>
            <ol>
              <li>ÙŠÙ„ØªØ²Ù… Ø§Ù„Ø³Ù…Ø³Ø§Ø± Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø³Ø¨ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø¨Ù†Ùƒ ÙˆØ§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø§Ù„ÙƒØ©.</li>
              <li>ØªÙØ­ØªØ³Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ÙˆÙÙ‚ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§ Ø£Ø¹Ù„Ø§Ù‡ØŒ Ø¨Ø¹Ø¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.</li>
              <li>Ù‡Ø°Ø§ Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆÙŠÙ…ÙƒÙ† ØªØ®ØµÙŠØµÙ‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©.</li>
            </ol>
          </div>

          <div style="display:flex;justify-content:space-between;gap:10px;margin-top:20px">
            <div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø³Ù…Ø³Ø§Ø±: __________________</div>
            <div>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±: __________________</div>
          </div>
        `;
        window.App.UI.closeModal();
        openPrintWindow('Ø¹Ù‚Ø¯ Ø³Ù…Ø³Ø§Ø± â€” Ø§Ù„ØªØ«Ù…ÙŠÙ†', body);
      };
      return;
    }
  }

  // Bind UI buttons (safe if missing)
  function bindValInlineActions(){
    const add = document.getElementById('btnValAddBank');
    const rep = document.getElementById('btnValuationReport');
    const br  = document.getElementById('btnValAddBroker');
    const fl  = document.getElementById('btnValFiles');
    const drop= document.getElementById('valIssueDrop');

    if(add) add.onclick = ()=> window.App.Actions.openAddBuilding();
    if(rep) rep.onclick = ()=> openValuationReport();
    if(br)  br.onclick  = ()=> openBrokersModal();
    if(fl)  fl.onclick  = ()=> openValFilesModal();

    // Dropdown items
    if(drop){
      drop.querySelectorAll('[data-val-issue]').forEach(btn=>{
        btn.onclick = ()=>{
          const t = btn.getAttribute('data-val-issue');
          drop.open = false;
          issueReport(t);
        };
      });
    }

    // close dropdown on outside click
    document.addEventListener('click', (e)=>{
      const d = document.getElementById('valIssueDrop');
      if(!d || !d.open) return;
      if(d.contains(e.target)) return;
      d.open = false;
    });
  }



  function bindOaInlineActions(){
    // Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø£ØµØ¨Ø­ ÙŠØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (btnAddBuilding)
    // ÙˆÙŠØªÙ… Ø±Ø¨Ø·Ù‡ ÙÙŠ init() Ù…Ø¨Ø§Ø´Ø±Ø©.
    return;
  }

  // Expose binder for init
  window.__bindValInlineActions = bindValInlineActions;
  window.__bindOaInlineActions  = bindOaInlineActions;
})();


/* ======================= /WhatsApp Reminders (UltraMsg) ======================= */
(async function init(){
  // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© (â• Ù…Ø¨Ù†Ù‰ / â• Ø¨Ù†Ùƒ) Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
  const addBtn = document.getElementById('btnAddBuilding');
  if (addBtn) addBtn.onclick = ()=> App.Actions.openAddBuilding();

  // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„Ø®Ø±ÙˆØ¬ (ÙƒØ§Ù†Øª ØºÙŠØ± Ù…Ø±Ø¨ÙˆØ·Ø© ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù†Ø³Ø®)
  const btnLogin  = document.getElementById('btnLogin');
  const btnLogout = document.getElementById('btnLogout');

  if (btnLogin){
    btnLogin.onclick = async ()=>{
      try{
        const email = prompt('Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:');
        if(!email) return;
        const pass = prompt('Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:');
        if(!pass) return;
        if(!window.AuthAPI){ alert('Firebase Auth ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„'); return; }
        await window.AuthAPI.signIn(email, pass);
        setTimeout(()=>{ try{ App.Render.dashboard(); }catch(_){ } }, 250);
      }catch(e){
        alert('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + (e?.message || e));
        console.warn(e);
      }
    };
  }

  if (btnLogout){
    btnLogout.onclick = async ()=>{
      try{
        if(window.AuthAPI) await window.AuthAPI.signOut();
      }catch(e){ console.warn(e); }
      setTimeout(()=>{ try{ App.Render.dashboard(); }catch(_){ } }, 250);
    };
  }

  // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ«Ù…ÙŠÙ†/Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ Ø¥Ù† ÙˆØ¬Ø¯Øª
  if (window.__bindValInlineActions) window.__bindValInlineActions();
  if (window.__bindOaInlineActions) window.__bindOaInlineActions();

  const __waBtn = document.getElementById('btnWhatsRemind');
  if (__waBtn) __waBtn.onclick = ()=> openWhatsRemindersModal();

  if (DEMO_MODE) document.body.classList.add('demo');

  // Ù…Ù‡Ù…: Ø§Ù†ØªØ¸Ø± ØªÙ‡ÙŠØ¦Ø© Auth (Ù„Ø£Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firestore Ø¹Ù†Ø¯Ùƒ ØªÙ…Ù†Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„)
  try{ if (window.__waitAppCheck) await window.__waitAppCheck; }catch(_){}
  try{ if (window.__waitAuth) await window.__waitAuth; }catch(_){}

  App.Render.populateYM();
  App.Render.dashboard();
})();</script>

<!-- ========================= Ø¥ØµØ¯Ø§Ø± Ø¹Ù‚Ø¯ (ØªÙ„Ù‚Ø§Ø¦ÙŠ + Ø·Ø¨Ø§Ø¹Ø©) ========================= -->
<script>
(function(){
  const LOGO_URL = "";
  const STAMP_URL = "";

  // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯
  window.openContract = function openContract(t){
    // Ø­Ø§ÙˆÙ„ Ù†Ù‚Ø±Ø£ Ù…Ù† Ø§Ù„Ø²Ø±/Ø§Ù„Ø³Ø·Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù…Ø§ ÙˆØµÙ„ØªÙ†Ø§ Ù‚ÙŠÙ…
    function autoFromDOM(){
      try{
        const btn = document.activeElement?.closest?.('[data-contract]');
        const row = btn?.closest?.('[data-tenant-row], .tenant-row');
        const read = sel => ((row?.querySelector(sel)?.textContent) || '').trim();
        return {
          tenantName : btn?.dataset.tenantName || read('[data-tenant-name]') || '',
          unitNumber : btn?.dataset.unit       || read('[data-unit]')        || '',
          rent       : parseFloat(btn?.dataset.rent || (read('[data-rent]')||'').replace(/[^\d.]/g,'')) || 0,
          kind       : btn?.dataset.kind       || row?.getAttribute('data-kind') || '',
          phone      : btn?.dataset.phone      || read('[data-phone]') || '',
          idNumber   : btn?.dataset.id         || read('[data-id]')    || '',
          payDate    : btn?.dataset.paydate    || ''
        };
      }catch{ return {}; }
    }
    t = Object.assign(autoFromDOM(), t||{});

    const buildingName = (document.getElementById('buildingTitle')?.textContent || '').trim();
    const today  = new Date().toISOString().slice(0,10);
    const startD = today;
    const endD   = new Date(new Date().setFullYear(new Date().getFullYear()+1)).toISOString().slice(0,10);
    const payD   = t.payDate || today;
    const rentOMR= Number(t.rent||0).toFixed(3);

    // Ø§ØºÙ„ÙÙ‚ Ø£ÙŠ Ù†Ø§ÙØ°Ø© Ù‚Ø¯ÙŠÙ…Ø©
    document.getElementById('ctOverlay')?.remove();

    // Ø§Ù„ØºØ·Ø§Ø¡ + Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
    const overlay = document.createElement('div');
    overlay.id = 'ctOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:#0006;display:flex;align-items:center;justify-content:center;z-index:9999';
    document.body.appendChild(overlay);

    const box = document.createElement('div');
    box.style.cssText = 'direction:rtl;background:#fff;width:min(980px,96%);border-radius:16px;overflow:hidden;font-family:Tajawal,system-ui,sans-serif;color:#111';
    box.innerHTML = `
      <div style="padding:20px;border-bottom:1px solid #e5e7eb;background:#f8fafc">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <div>
            <div style="font-weight:800;font-size:22px">Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ù†Ù…ÙˆØ°Ø¬) Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù…ØªÙ„ÙƒØ§Øª</div>
            <div style="color:#6b7280">Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</div>
          </div>
</div>
      </div>

      <div style="padding:22px 20px">
        <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <label>ØªØ§Ø±ÙŠØ® ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø¯<input id="ctDate" type="date" value="${today}" style="width:100%"></label>
          <label>Ø§Ù„ÙˆØ­Ø¯Ø©<input id="ctUnit" value="${(t.unitNumber||'')}" style="width:100%"></label>

          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±<input id="ctTenant" value="${(t.tenantName||'')}" style="width:100%"></label>
          <label>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©<input id="ctId" value="${(t.idNumber||'')}" style="width:100%"></label>

          <label>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±.Ø¹)<input id="ctRent" type="number" step="0.001" value="${rentOMR}" style="width:100%"></label>
          <label>ØªØ§Ø±ÙŠØ® Ø¯ÙØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±<input id="ctPayDate" type="date" value="${payD}" style="width:100%"></label>

          <label>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯<input id="ctStart" type="date" value="${startD}" style="width:100%"></label>
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡<input id="ctEnd" type="date" value="${endD}" style="width:100%"></label>

          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ<input id="ctPhone" value="${(t.phone||'')}" style="width:100%"></label>
          <label>Ù…Ù‚Ø± Ø§Ù„Ø¹Ù…Ù„<input id="ctWork" value="Ù…Ø³Ù‚Ø·" style="width:100%"></label>
        </div>

        <div style="margin-top:14px;display:flex;gap:8px;justify-content:flex-end">
          <button id="ctPrint" class="btn" style="background:#2563eb;color:#fff;border:none;border-radius:12px;padding:10px 16px;cursor:pointer">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¹Ù‚Ø¯</button>
          <button id="ctClose" class="btn" style="background:#f3f4f6;border:none;border-radius:12px;padding:10px 16px;cursor:pointer">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    `;
    overlay.appendChild(box);

    box.querySelector('#ctClose').onclick = ()=> overlay.remove();

    box.querySelector('#ctPrint').onclick = function(){
      const data = {
        logo: LOGO_URL,
        stamp: STAMP_URL,
        building: buildingName,
        date:   box.querySelector('#ctDate').value || today,
        unit:   box.querySelector('#ctUnit').value || t.unitNumber || '',
        tenant: box.querySelector('#ctTenant').value || t.tenantName || '',
        id:     box.querySelector('#ctId').value || '',
        rent:   Number(box.querySelector('#ctRent').value || t.rent || 0).toFixed(3),
        payday: box.querySelector('#ctPayDate').value || payD,
        start:  box.querySelector('#ctStart').value || startD,
        end:    box.querySelector('#ctEnd').value || endD,
        phone:  box.querySelector('#ctPhone').value || '',
        work:   box.querySelector('#ctWork').value || 'Ù…Ø³Ù‚Ø·',
      
        idimg: t.idimg || ''};

      const html = `<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8">
  <title>Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± - Lease Agreement</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Tajawal:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    @page { size: A4; margin: 10mm; }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: #fff; color: #111; }
    .contract {
      width: 100%;
      max-width: 170mm;
      margin: 0 auto;
      border: 1.5px solid #222;
      border-radius: 12px;
      padding: 10mm;
      font-family: "Tajawal","Segoe UI",Tahoma,Arial,sans-serif;
      line-height: 1.9;
    }
    .header { display: grid; grid-template-columns: 1fr 120px 1fr; align-items: start; gap: 10px; margin-bottom: 8mm; }
    .header .right { text-align: right; line-height: 1.6; font-size: 13.5px; direction: rtl; white-space: pre-line; font-weight: 700; }
    .header .left  { text-align: left;  line-height: 1.6; font-size: 13.5px; direction: ltr; white-space: pre-line; font-family: "Poppins","Segoe UI",Tahoma,Arial,sans-serif; font-weight: 600; }
    .header .logo  { display: flex; align-items: center; justify-content: center; height: 100%; }
    .header .logo img { max-width: 110px; max-height: 110px; object-fit: contain; }
    .title-wrap { text-align: center; margin-bottom: 8mm; }
    .title-frame {
      display: inline-block;
      border: 2px solid #111;
      border-radius: 12px;
      padding: 4mm 6mm;
      text-align: center;
    }
    .title-frame .ar { font-size: 22px; font-weight: 800; margin: 0; letter-spacing: .2px; }
    .title-frame .en { font-size: 14px; font-weight: 700; margin: 0; letter-spacing: .2px; }
    .title-frame hr { border: none; border-top: 1px solid #111; margin: 2.5mm 0; }
    .meta { font-size: 13px; color: #444; margin-bottom: 6mm; display: grid; grid-template-columns: 1fr 1fr; gap: 6mm; }
    .meta b { color: #111; }
    .sec  { margin-top: 6mm; font-size: 14px; color: #111; }
    .clause{ margin: 8px 0; }
    .signs{ display:flex; gap:28px; margin-top: 16mm; }
    .sign { flex:1; border:1px dashed #cbd5e1; border-radius:12px; padding:12px; }
    .stamp{ height:70px; object-fit:contain; }
    @media print { body { padding: 0; } }
  </style>

<style id="oasis-minimal-pack">
/* === Oasis Minimal Pack â€” v1 === */
:root{
  --bg:#faf8f4;
  --fg:#0b1728;
  --muted:#667085;
  --card:#ffffff;
  --border:#e8edf3;
  --accent:#0bb8b2;
  --accent-2:#0891a0;
  --success:#16a34a;
  --danger:#ef4444;
  --kpi:#f2fbfb;
}
html,body{
  background: radial-gradient(1200px 600px at 80% -10%, #e6fbff 0%, transparent 70%),
              radial-gradient(1000px 500px at -10% 100%, #fff3e0 0%, transparent 70%),
              linear-gradient(180deg,#fbfcfd 0%,#f3f6f8 100%);
  color:var(--fg);
}
header{ background: rgba(255,255,255,.78); backdrop-filter: blur(10px) saturate(1.1); border-bottom: 1px solid var(--border); }
.card{ border:1px solid var(--border); border-radius:18px; box-shadow: 0 10px 28px rgba(17,24,39,.06); }
.stat{ background:rgba(255,255,255,.85); border:1px solid var(--border); border-radius:14px; box-shadow: 0 6px 20px rgba(2,132,199,.06); }
.icon-card{ border-radius:18px; background:linear-gradient(180deg,#ffffff 0%, #fbfdff 100%); box-shadow: 0 12px 36px rgba(15,23,42,.08); }
.icon-card .circle{ width:56px;height:56px; background: linear-gradient(135deg, #ccfbf1 0%, #e0f2fe 100%); border:1px solid #cce7f3; }
.btn{ border-radius:12px; border:1px solid var(--border); background:#fff; transition: transform .12s ease, box-shadow .18s ease, background .18s ease; }
.btn:hover{ transform: translateY(-1px); box-shadow:0 10px 26px rgba(0,0,0,.06); }
.btn:focus{ outline:none; box-shadow:0 0 0 3px rgba(11,184,178,.22); }
.btn.primary{ color:#fff; border-color: transparent; background: linear-gradient(135deg, var(--accent) 0%, #22d3ee 100%); box-shadow: 0 6px 20px rgba(34,211,238,.35); }
.btn.primary:hover{ transform: translateY(-1px); box-shadow: 0 10px 28px rgba(34,211,238,.45); }
.btn.danger{ color:#fff; border-color:transparent; background: linear-gradient(135deg, #ef4444 0%, #f97316 100%); box-shadow: 0 6px 18px rgba(249,115,22,.35); }
.chip{ background:#fff; border-radius:999px; }
.chip.active{ background:#e6fffb; border-color:#99f6e4; box-shadow: inset 0 0 0 1px rgba(11,184,178,.25); }
input,select,textarea{ border-radius:12px; border:1px solid var(--border); background:#fff; transition:border-color .15s, box-shadow .15s; }
input:focus,select:focus,textarea:focus{ border-color:#67e8f9; box-shadow: 0 0 0 3px rgba(34,211,238,.3); }
.modal-wrap .modal{ border-radius:20px; box-shadow: 0 24px 70px rgba(15,23,42,.18); }
.modal .head{ background:linear-gradient(180deg,#f8ffff 0%, #ffffff 100%); }
table{ background:#fff; border-radius:14px; overflow:hidden; }
thead{ background:linear-gradient(180deg,#f1fafc 0%, #eaf6fb 100%); }
th,td{ border-color:#e8edf3; }
.badge.success{ background:#e8fff4; border-color:#bfead0; }
.badge.gray{ background:#f5f7fb; border-color:#e8edf3; }
@media print{ body{ background:#fff; } }
</style>


<style id="mobile-enhancements">
/* === Mobile enhancements (phone-first) === */
@media (max-width: 640px) {
  html, body { font-size: 16px; }
  .container { padding: 12px; }
  header .container { flex-direction: column; align-items: stretch; gap: 8px; }
  .toolbar { width: 100%; overflow-x: auto; padding-bottom: 6px; -webkit-overflow-scrolling: touch; }
  .toolbar .btn { flex: 0 0 auto; }
  .card-h { align-items: stretch; }
  .card-h > div:last-child { width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
  .filters { gap: 6px; }
  input, select, textarea { width: 100%; }
  table { display: block; overflow-x: auto; white-space: nowrap; border-radius: 12px; }
  thead, tbody, tfoot, tr, th, td { border-collapse: separate; }
  /* Tenant rows: allow wrapping and stacking on small screens */
  [data-tenant-row] > div[style*="justify-content:flex-end"]{
    justify-content: stretch !important;
    gap: 6px !important;
    flex-wrap: wrap !important;
  }
  [data-tenant-row] .tenant-actions {
    width: 100% !important;
    flex-wrap: wrap !important;
  }
  [data-tenant-row] .tenant-actions .btn {
    flex: 1 1 calc(50% - 6px) !important;
    min-height: 44px !important;
  }
  [data-tenant-row] [data-del]{
    flex: 1 1 100% !important;
    min-height: 44px !important;
  }
  /* Force grid stacks for safety on phones */
  .grid { gap: 10px; }
  .grid.cols-2, .grid.cols-3 { grid-template-columns: 1fr !important; }
  /* Modal: fullscreen on phones */
  .modal-wrap .modal {
    width: 100vw !important;
    max-height: 100vh !important;
    height: 100vh !important;
    border-radius: 0 !important;
  }
  .modal .body { padding-bottom: 72px; }
  .modal .buttons-row {
    position: sticky;
    bottom: 0;
    background: #fff;
    padding: 10px;
    border-top: 1px solid var(--border);
  }
  /* Chips and tabs: horizontal scroll if overflow */
  .filters, #bizTabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .chip { flex: 0 0 auto; }
  /* KPI cards readability */
  .stat { font-size: 14px; }
  /* Building cards: compact layout */
  #buildingsGrid .icon-card { display: grid; grid-template-columns: 56px 1fr; align-items: center; gap: 10px; }
  #buildingsGrid .icon-card .circle { grid-row: span 2; }
}
@media (max-width: 370px){
  .card-h > div:last-child { grid-template-columns: 1fr; }
  [data-tenant-row] .tenant-actions .btn { flex-basis: 100% !important; }
}
/* Better tap targets */
.btn { touch-action: manipulation; }
</style>

</head>
<body>
  <div class="contract">
    <div class="header">
      <div class="right">
Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ù†Ù…ÙˆØ°Ø¬)

Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù†

      </div>
      <div class="logo">
        
      </div>
      <div class="left">
Demo Entity

Sultanate of Oman

      </div>
    </div>

    <div class="title-wrap">
      <div class="title-frame">
        <p class="ar">Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</p>
        <hr>
        <p class="en">Lease Agreement</p>
      </div>
    </div>

    <div class="meta">
      <div>Ø§Ù„Ù…Ø¨Ù†Ù‰: <b>${data.building || 'â€”'}</b></div>
      <div>Ø§Ù„ÙˆØ­Ø¯Ø©: <b>${data.unit || 'â€”'}</b></div>
      <div>ØªØ§Ø±ÙŠØ® ØªØ­Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø¯: <b>${data.date}</b></div>
      <div>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: <b>${data.end}</b></div>
    </div>

    <div class="sec">
      <div>Ø£Ø¨Ø±Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨ØªØ§Ø±ÙŠØ®: <b>${data.date}</b></div>
      <div class="clause">Ø¨ÙŠÙ† ÙƒÙ„Ø§ Ù…Ù†:</div>
      <div>Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„: <b>Ø§Ù„Ù…Ø§Ù„Ùƒ/Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ù†Ù…ÙˆØ°Ø¬)</b></div>
      <div>Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±): Ø§Ù„ÙØ§Ø¶Ù„ / <b>${data.tenant || '__________'}</b></div>
      <div>Ø¨Ø·Ø§Ù‚Ø© Ø´Ø®ØµÙŠØ© Ø±Ù‚Ù… / <b>${data.id || 'â€”'}</b></div>
      <div>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ / <b>${data.rent}</b> Ø±.Ø¹ &nbsp;&nbsp; ØªØ§Ø±ÙŠØ® Ø¯ÙØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±: <b>${data.payday}</b></div>
      <div>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø¨ØªØ§Ø±ÙŠØ®: <b>${data.start}</b> &nbsp;&nbsp; ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†ØªÙ‡Ø§Ø¡: <b>${data.end}</b></div>
      <div>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: <b>${data.phone || 'â€”'}</b> &nbsp;&nbsp; Ù…Ù‚Ø± Ø§Ù„Ø¹Ù…Ù„: <b>${data.work}</b></div>

      <div class="clause" style="margin-top:12px"><b>ØªÙ…Ù‡ÙŠØ¯</b></div>
      <div>
        Ø­ÙŠØ« Ø£Ù† Ø§Ù„ÙØ§Ø¶Ù„ (Ø§Ù„Ù…Ø§Ù„Ùƒ) Ù„Ù…Ø¨Ù†Ù‰ Ù‚Ø§Ù… Ø¨Ø§Ù„ØªØ¹Ø§Ù‚Ø¯ Ù…Ø¹ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ù†Ù…ÙˆØ°Ø¬) Ù„ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† Ù†ÙŠØ§Ø¨Ø© Ø¹Ù†Ù‡ ÙÙŠ Ø§Ù„Ù…Ø¨Ù†Ù‰. 
        ÙˆØ­ÙŠØ« Ø£Ù† Ø§Ù„Ø¹Ù‚Ø¯ Ø¨ÙŠÙ† Ø§Ù„ÙØ§Ø¶Ù„ Ø§Ù„Ù…Ø§Ù„Ùƒ ÙˆØ§Ù„Ù…Ø¤Ø³Ø³Ø© (Ù†Ù…ÙˆØ°Ø¬) ÙŠØªØ¶Ù…Ù† Ø¨Ù†Ø¯Ø§Ù‹ ÙŠÙ„Ø²Ù… Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ù†Ù…ÙˆØ°Ø¬) Ø¨ØªÙˆÙ‚ÙŠØ¹ Ø¹Ù‚ÙˆØ¯ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ø¨Ù†Ù‰ØŒ
        ÙˆØ¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„ÙŠÙ‡ Ù‚Ø¯ Ø£Ø¨Ø±Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨ÙŠÙ† Ø§Ù„Ø·Ø±ÙÙŠÙ† ÙˆØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚ Ø¹Ù„Ù‰ Ù…Ø§ ÙŠÙ„ÙŠ:
      </div>

      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø£ÙˆÙ„:</b> ÙŠÙ„ØªØ²Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¯ÙØ¹ Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„ØªØ²Ø§Ù…Ø§Ù‹ Ø±Ø¦ÙŠØ³ÙŠØ§Ù‹ Ù„Ø§ ØªØ£Ø®ÙŠØ± Ø£Ùˆ ØªØ£Ø¬ÙŠÙ„ ÙÙŠÙ‡ØŒ ÙÙŠ Ù…Ø­Ù„ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†.</div>
      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ:</b> ÙŠÙ„ØªØ²Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¨Ø¯ÙØ¹ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¨Ø¯Ø§ÙŠØ© ÙƒÙ„ Ø´Ù‡Ø± Ø¨Ù†Ø¸Ø§Ù… Ø´ÙŠÙƒØ§Øª ØªÙˆØ¯Ø¹ ÙÙŠ Ø§Ù„Ø¨Ù†Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø«Ø§Ù„Ø«:</b> ÙŠÙ„ØªØ²Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¨Ø¯ÙØ¹ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø®Ù„Ø§Ù„ ÙØªØ±Ø© Ø£Ù‚ØµØ§Ù‡Ø§ 10 Ø£ÙŠØ§Ù… Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„.</div>
      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø±Ø§Ø¨Ø¹:</b> ÙÙŠ Ø­Ø§Ù„Ø© Ø¥Ø®Ù„Ø§Ù„ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ ÙÙŠ Ø³Ø¯Ø§Ø¯ Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠØŒ ÙŠØ­Ù‚ Ù„Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ù†Ù…ÙˆØ°Ø¬) Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØ¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø¹Ù„Ù‰ Ø¥Ø®Ù„Ø§Ø¡ Ø§Ù„Ø´Ù‚Ø© ØªÙ…Ø§Ù…Ø§Ù‹ ÙÙŠ ÙØªØ±Ø© Ø£Ù‚ØµØ§Ù‡Ø§ 10 Ø£ÙŠØ§Ù….</div>
      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø®Ø§Ù…Ø³:</b> ÙŠÙ„ØªØ²Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¨Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø±ØºØ¨Ø© ÙÙŠ ÙØ³Ø® Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± ÙÙŠ ÙØªØ±Ø© Ù„Ø§ ØªÙ‚Ù„ Ø¹Ù† 30 ÙŠÙˆÙ…Ø§Ù‹ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ³Ø®.</div>
      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø³Ø§Ø¯Ø³:</b> ÙŠÙ„ØªØ²Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¨Ø¥ØµØ¯Ø§Ø± Ø´ÙŠÙƒ Ø¶Ù…Ø§Ù† Ù…Ù‚Ø¯Ù…Ø§Ù‹ Ø¹Ù†Ø¯ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø¯ ÙˆÙ‚Ø¯Ø±Ù‡ (<b>${data.rent}</b>) Ø±ÙŠØ§Ù„Ø§Ù‹ Ø¹Ù…Ø§Ù†ÙŠØ§Ù‹ Ù„Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ù‚Ø© Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯ Ø£Ùˆ ÙØ³Ø®Ù‡ Ù…Ù† (Ø·Ù„Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø±Ø§Ù†ØŒ ØµÙŠØ§Ù†Ø© Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ©ØŒ ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨ Ø§Ù„Ø®Ø´Ø¨ÙŠØ© ÙˆØ§Ù„Ø£Ù„Ù…Ù†ÙŠÙˆÙ… Ø£Ùˆ Ø£ÙŠ ØªÙ„Ù Ø¬Ø³ÙŠÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ù‚Ø©). ÙˆÙÙŠ Ø­Ø§Ù„Ø© Ø£Ù† Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ù‡Ùˆ Ø§Ù„Ø°ÙŠ ÙŠØªØ­Ù…Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø´ÙŠÙƒ Ø§Ù„Ø¶Ù…Ø§Ù† Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø±.</div>
      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø³Ø§Ø¨Ø¹:</b> ÙŠØ­Ù‚ Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª ÙÙŠ Ø­Ø§Ù„Ø© ØªØ¹Ø¯ÙŠ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ø¨Ù†Ù‰ Ø£Ùˆ Ø¥Ø³Ø§Ø¡Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§.</div>
      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø«Ø§Ù…Ù†:</b> ÙŠØ¨Ù‚Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ Ø³Ø§Ø±ÙŠ Ø§Ù„Ù…ÙØ¹ÙˆÙ„ Ø·Ø§Ù„Ù…Ø§ Ø¨Ù‚ÙŠ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨ÙŠÙ† Ø§Ù„ÙØ§Ø¶Ù„ (Ø§Ù„Ù…Ø§Ù„Ùƒ) ÙˆØ§Ù„Ù…Ø¤Ø³Ø³Ø© (Ù†Ù…ÙˆØ°Ø¬) Ø³Ø§Ø±ÙŠ Ø§Ù„Ù…ÙØ¹ÙˆÙ„ØŒ ÙˆÙÙŠ Ø­Ø§Ù„Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø°Ù„Ùƒ ÙŠÙ„ØªØ²Ù… Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¨Ø°Ù„Ùƒ ÙˆØ¨ØªØ§Ø±ÙŠØ® ØªÙˆÙ‚ÙÙ‡ Ø¹Ù† ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ù‚Ø¨Ù„ 30 ÙŠÙˆÙ…Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.</div>
      <div class="clause"><b>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„ØªØ§Ø³Ø¹:</b> ÙÙŠ Ø­Ø§Ù„Ø© Ù†Ø´ÙˆØ¡ Ø£ÙŠ Ø®Ù„Ø§Ù Ø¨ÙŠÙ† Ø§Ù„Ø·Ø±ÙÙŠÙ† Ù†Ø§ØªØ¬ Ø£Ùˆ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯ ÙˆÙ„Ù… ÙŠØªÙ… Ø­Ù„Ù‡ ÙˆØ¯ÙŠØ§Ù‹ ÙÙŠÙ…ÙƒÙ† Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ù„Ø§Ù Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§ÙƒÙ… Ø§Ù„Ù…Ø®ØªØµØ© ÙÙŠ Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù† Ù„Ù„ÙØµÙ„ ÙÙŠÙ‡.</div>

      <div class="signs">
        <div class="sign">
          <div><b>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„:</b></div>
          <div>Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„: __________________</div>
          <div>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: __________________</div>
          <div style="margin-top:8px">Ø§Ù„Ø®ØªÙ…:</div>
          
        </div>
        <div class="sign">
          <div><b>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ:</b></div>
          <div>Ø§Ù„ÙØ§Ø¶Ù„: ${data.tenant || '__________'}</div>
          <div>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: __________________</div>
            ${data.idimg ? `<div style="margin-top:8px;text-align:center">
              <img src="${data.idimg}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©" style="width:220px;max-width:100%;border:1px solid #cbd5e1;border-radius:8px" onerror="this.style.display='none'">
            </div>` : ''}
        </div>
      </div>
    </div>
  </div>

  <div class="noprint" style="text-align:center;margin:16px 0">
    <button onclick="window.print()" style="background:#2563eb;color:#fff;border:none;border-radius:12px;padding:10px 16px;cursor:pointer">Ø·Ø¨Ø§Ø¹Ø©</button>
  </div>
</body>
</html>`;

const printInto = (targetWin) => {
  try {
    targetWin.document.open();
    targetWin.document.write(html);
    targetWin.document.close();
  } catch(e){}
  setTimeout(()=>{ try{ targetWin.focus(); targetWin.print(); }catch(e){} }, 150);
};

let w = window.open('', '_blank');
if (w && !w.closed) {
  // Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù†ÙØªØ­Øª Ø¨Ø´ÙƒÙ„ Ø§Ø¹ØªÙŠØ§Ø¯ÙŠ
  printInto(w);
} else {
  // Ø¨Ø¯ÙŠÙ„: iframe Ù…Ø®ÙÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨ÙˆØ¨-Ø£Ø¨ Ù…Ø­Ø¬ÙˆØ¨
  const iframe = document.createElement('iframe');
  iframe.style.position='fixed';
  iframe.style.right='-9999px';
  iframe.style.bottom='-9999px';
  iframe.width=1; iframe.height=1;
  document.body.appendChild(iframe);
  printInto(iframe.contentWindow);
  setTimeout(()=>{ try{ document.body.removeChild(iframe); }catch(e){} }, 1200);
}

overlay.remove();

    };
  };

  // ØªÙÙˆÙŠØ¶ Ø¹Ø§Ù… Ù„Ø²Ø± [data-contract] â€” ÙŠØ¬Ù„Ø¨ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¥Ù† Ù„Ø²Ù…
  document.addEventListener('click', async function(ev){
    const b = ev.target.closest?.('[data-contract]');
    if(!b) return;
    ev.stopPropagation();
    ev.stopImmediatePropagation?.();

    // Ø¬Ø±Ù‘Ø¨ Ø£ÙˆÙ„Ù‹Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø§Ù‡Ø²ØŒ ÙˆØ¥Ù† Ù…Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø³ØªØµØ¯Ø§Ø± URL
    let idimg = b.dataset.idimg || '';
    const imgPath = b.dataset.idimgPath || '';
    if (!idimg && imgPath && firebase?.storage) {
      try {
        await (window.__waitAuth||Promise.resolve());
        await (window.__waitAppCheck||Promise.resolve());
        idimg = await firebase.storage().ref().child(imgPath).getDownloadURL();
      } catch(e){ console.warn('Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ø¬Ù„Ø¨ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±', e); }
    }

    openContract({
      tenantName: b.dataset.tenantName || '',
      unitNumber: b.dataset.unit || '',
      rent: parseFloat(b.dataset.rent||'0') || 0,
      kind: b.dataset.kind || '',
      phone: b.dataset.phone || '',
      idNumber: b.dataset.id || '',
      payDate: b.dataset.paydate || '',
      idimg
    });
  }, {capture:true});   // â† â† â† Ø£ÙØºÙ„ÙÙ‚ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·

})();                  // â† â† â† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ IIFE
</script>

<!-- ========================= Ø¥ØµØ¯Ø§Ø± Ø¥ÙŠØµØ§Ù„ (Ø³Ù†Ø¯ Ù‚Ø¨Ø¶) â€” Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© ========================= -->


<script>
(function(){
  const LOGO_URL = "";
  const STAMP_URL = "";

  // ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø­Ø±ÙˆÙ (Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ) â€” Ù„Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµØ­ÙŠØ­Ø©
  function amountWordsAR(n){
    n = Math.floor(Math.abs(Number(n)||0));
    if(n===0) return 'ØµÙØ±';
    const ones = ['','ÙˆØ§Ø­Ø¯','Ø§Ø«Ù†Ø§Ù†','Ø«Ù„Ø§Ø«Ø©','Ø£Ø±Ø¨Ø¹Ø©','Ø®Ù…Ø³Ø©','Ø³ØªØ©','Ø³Ø¨Ø¹Ø©','Ø«Ù…Ø§Ù†ÙŠØ©','ØªØ³Ø¹Ø©'];
    const teens = ['Ø¹Ø´Ø±Ø©','Ø£Ø­Ø¯ Ø¹Ø´Ø±','Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±','Ø«Ù„Ø§Ø«Ø© Ø¹Ø´Ø±','Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø±','Ø®Ù…Ø³Ø© Ø¹Ø´Ø±','Ø³ØªØ© Ø¹Ø´Ø±','Ø³Ø¨Ø¹Ø© Ø¹Ø´Ø±','Ø«Ù…Ø§Ù†ÙŠØ© Ø¹Ø´Ø±','ØªØ³Ø¹Ø© Ø¹Ø´Ø±'];
    const tens = ['','Ø¹Ø´Ø±Ø©','Ø¹Ø´Ø±ÙˆÙ†','Ø«Ù„Ø§Ø«ÙˆÙ†','Ø£Ø±Ø¨Ø¹ÙˆÙ†','Ø®Ù…Ø³ÙˆÙ†','Ø³ØªÙˆÙ†','Ø³Ø¨Ø¹ÙˆÙ†','Ø«Ù…Ø§Ù†ÙˆÙ†','ØªØ³Ø¹ÙˆÙ†'];
    const hundreds = ['','Ù…Ø§Ø¦Ø©','Ù…Ø§Ø¦ØªØ§Ù†','Ø«Ù„Ø§Ø«Ù…Ø§Ø¦Ø©','Ø£Ø±Ø¨Ø¹Ù…Ø§Ø¦Ø©','Ø®Ù…Ø³Ù…Ø§Ø¦Ø©','Ø³ØªÙ…Ø§Ø¦Ø©','Ø³Ø¨Ø¹Ù…Ø§Ø¦Ø©','Ø«Ù…Ø§Ù†Ù…Ø§Ø¦Ø©','ØªØ³Ø¹Ù…Ø§Ø¦Ø©'];
    function underThousand(x){
      let s = '', h = Math.floor(x/100), t = Math.floor((x%100)/10), o = x%10;
      if(h) s += hundreds[h];
      if(t>1){
        if(s) s+=' Ùˆ ';
        s += (o ? (ones[o] + ' Ùˆ ' + tens[t]) : tens[t]);
      } else if(t===1){
        if(s) s+=' Ùˆ ';
        s += teens[o];
      } else if(o){
        if(s) s+=' Ùˆ ';
        s += (o===1?'ÙˆØ§Ø­Ø¯':o===2?'Ø§Ø«Ù†Ø§Ù†':ones[o]);
      }
      return s;
    }
    const thousands = Math.floor(n/1000), rest = n%1000;
    let res = '';
    if(thousands){
      if(thousands===1) res = 'Ø£Ù„Ù';
      else if(thousands===2) res = 'Ø£Ù„ÙØ§Ù†';
      else if(thousands>=3 && thousands<=10) res = underThousand(thousands) + ' Ø¢Ù„Ø§Ù';
      else res = underThousand(thousands) + ' Ø£Ù„Ù';
    }
    if(rest){
      if(res) res += ' Ùˆ ';
      res += underThousand(rest);
    }
    return res;
  }

  function genRcNo(){
    const d = new Date();
    const YY = String(d.getFullYear()).slice(-2);
    const MM = String(d.getMonth()+1).padStart(2,'0');
    const DD = String(d.getDate()).padStart(2,'0');
    const rnd = Math.floor(1000 + Math.random()*9000);
    return YY+MM+DD+String(rnd);
  }

  // ÙŠÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø«Ù… ÙŠØ·Ø¨Ø¹ Ø§Ù„Ø¥ÙŠØµØ§Ù„
  window.openReceipt = function openReceipt(t){
    t = t || {};
    // Ù‚Ø±Ø§Ø¡Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ù† Ø§Ù„ØµÙ/Ø§Ù„Ø²Ø± Ù„Ùˆ Ø§Ø³ØªØ¯Ø¹ÙŠÙ†Ø§ Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø§Ù…Ù„Ø§Øª
    function autoFromDOM(){
      try{
        const btn = document.activeElement?.closest?.('[data-receipt]');
        const row = btn?.closest?.('[data-tenant-row], .tenant-row');
        const read = sel => ((row?.querySelector(sel)?.textContent) || '').trim();
        return {
          tenantName : btn?.dataset.tenantName || read?.('[data-tenant-name]') || '',
          unitNumber : btn?.dataset.unit       || read?.('[data-unit]')        || '',
          rent       : parseFloat(btn?.dataset.rent || (read?.('[data-rent]')||'').replace(/[^\d.]/g,'')) || 0,
          kind       : btn?.dataset.kind       || row?.getAttribute('data-kind') || '',
          phone      : btn?.dataset.phone      || read?.('[data-phone]') || '',
          idNumber   : btn?.dataset.id         || read?.('[data-id]')    || '',
          payDate    : btn?.dataset.paydate    || ''
        };
      }catch{ return {}; }
    }
    t = Object.assign(autoFromDOM(), t || {});

    const buildingName = (document.getElementById('buildingTitle')?.textContent || '').trim();
    const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD
    const payer = (t.tenantName || '').trim();
    const unit  = (t.tenantUnit || t.unitNumber || '').toString();
    const kind  = (typeof window.labelKind==='function' ? labelKind(t.kind) : (t.kind||''));
    const amountNum = Number(t.rent || t.amount || 0);
    const amount = amountNum.toFixed(3);
    const noteDefault = (kind ? (kind + ' ') : '') + (unit ? ('Ø±Ù‚Ù… ' + unit) : '');

    // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù†Ø§ÙØ°Ø© Ù‚Ø¯ÙŠÙ…Ø©
    document.getElementById('rcOverlay')?.remove();

    // Ø§Ù„Ù€ Overlay + ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    const overlay = document.createElement('div');
    overlay.id = 'rcOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:#0006;display:flex;align-items:center;justify-content:center;z-index:9999';
    document.body.appendChild(overlay);

    const box = document.createElement('div');
    box.style.cssText = 'direction:rtl;background:#fff;width:min(920px,96%);border-radius:16px;overflow:hidden;font-family:Tajawal,system-ui,sans-serif;color:#111';
    box.innerHTML = `
      <div style="padding:20px;border-bottom:1px solid #e5e7eb;background:#f8fafc">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <div>
            <div style="font-weight:800;font-size:22px">Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ù†Ù…ÙˆØ°Ø¬) Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù…ØªÙ„ÙƒØ§Øª</div>
            <div style="color:#6b7280">(Receipt Voucher) Ø³Ù†Ø¯ Ù‚Ø¨Ø¶</div>
          </div>
</div>
        <div style="display:flex;gap:24px;margin-top:14px;font-weight:600">
          <div>Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯: <input id="rcNo" style="border:0;border-bottom:1px solid #cbd5e1;outline:0;padding:0 4px;width:140px" value="${genRcNo()}"></div>
          <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: <input id="rcDate" type="date" style="border:0;border-bottom:1px solid #cbd5e1;outline:0;padding:0 4px" value="${today}"></div>
        </div>
      </div>

      <div style="padding:22px 20px">
        <div style="display:grid;grid-template-columns:220px 1fr;row-gap:16px;column-gap:14px;align-items:center">
          <div style="color:#6b7280">Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ù…Ù† Ø§Ù„ÙØ§Ø¶Ù„:</div>
          <div><input id="rcPayer" value="${payer}" style="width:100%;border:0;border-bottom:1px dashed #cbd5e1;outline:0;padding:6px 4px"></div>

          <div style="color:#6b7280">Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡:</div>
          <div><input id="rcAmountWords" value="${amountWordsAR(amountNum)} Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ" style="width:100%;border:0;border-bottom:1px dashed #cbd5e1;outline:0;padding:6px 4px"></div>

          <div style="color:#6b7280">(Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…)</div>
          <div>Ø±Ø¹ <input id="rcAmount" type="number" step="0.001" value="${amount}" style="width:200px;border:0;border-bottom:1px dashed #cbd5e1;outline:0;padding:6px 4px"></div>

          <div style="color:#6b7280">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</div>
          <div style="border:1px solid #cbd5e1;border-radius:12px;padding:8px 10px;display:flex;align-items:center;gap:14px">
            <label><input type="radio" name="rcPayMethod" value="cash" checked> Ù†Ù‚Ø¯Ù‹Ø§</label>
            <label><input type="radio" name="rcPayMethod" value="cheque"> Ø´ÙŠÙƒ Ø±Ù‚Ù…</label>
            <label><input type="radio" name="rcPayMethod" value="transfer"> ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ Ø±Ù‚Ù…</label>
            <span id="rcPayNumWrap" style="display:none;margin-inline-start:10px;display:inline-flex;align-items:center;gap:8px">
              <input id="rcPayNum" placeholder="â€”" style="width:220px;border:1px solid #cbd5e1;border-radius:10px;padding:6px 10px">
            </span>
          </div>

          <div style="color:#6b7280">Ø¨ØªØ§Ø±ÙŠØ®:</div>
          <div><input id="rcPaidOn" type="date" value="${today}" style="border:0;border-bottom:1px dashed #cbd5e1;outline:0;padding:6px 4px"></div>

          <div style="color:#6b7280">ÙˆØ°Ù„Ùƒ Ø¹Ù†:</div>
          <div><input id="rcFor" value="${(kind||'Ø¥ÙŠØ¬Ø§Ø±')} ${noteDefault}" style="width:100%;border:0;border-bottom:1px dashed #cbd5e1;outline:0;padding:6px 4px"></div>
        </div>

        <div style="display:flex;justify-content:flex-end;margin-top:26px">
          <div style="border-top:1px solid #e5e7eb;width:52%"></div>
        </div>
        <div style="text-align:left;font-weight:700;margin-top:10px">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
      </div>

      <div style="padding:16px 20px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-start">
        <button id="rcPrint" class="btn" style="background:#2563eb;color:#fff;border:none;border-radius:12px;padding:10px 16px;cursor:pointer">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        <button id="rcClose" class="btn" style="margin-inline-start:10px;background:#f3f4f6;color:#111;border:none;border-radius:12px;padding:10px 16px;cursor:pointer">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    `;
    overlay.appendChild(box);

    function updatePayUI(){
      const method = box.querySelector('input[name=rcPayMethod]:checked')?.value;
      const wrap = box.querySelector('#rcPayNumWrap');
      const inp  = box.querySelector('#rcPayNum');
      if(method==='cash'){ wrap.style.display='none'; if(inp) inp.value=''; }
      else {
        wrap.style.display='inline-flex';
        if(inp) inp.placeholder = (method==='cheque'?'Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ':'Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ');
      }
    }
    box.querySelectorAll('input[name=rcPayMethod]').forEach(el => el.addEventListener('change', updatePayUI));
    updatePayUI();

    box.querySelector('#rcClose').onclick = () => overlay.remove();
    box.querySelector('#rcAmount').addEventListener('input', e=>{
      box.querySelector('#rcAmountWords').value = amountWordsAR(e.target.value) + ' Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ';
    });

    // Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    box.querySelector('#rcPrint').onclick = function(){
      const data = {
        building  : buildingName,
        rcNo      : box.querySelector('#rcNo').value || genRcNo(),
        dateHeader: box.querySelector('#rcDate').value || today,
        payer     : box.querySelector('#rcPayer').value || '',
        amount    : Number(box.querySelector('#rcAmount').value || 0).toFixed(3),
        amountWords: (box.querySelector('#rcAmountWords').value || '').trim(),
        payMethod : box.querySelector('input[name=rcPayMethod]:checked')?.value || 'cash',
        payNum    : box.querySelector('#rcPayNum')?.value || '',
        paidOn    : box.querySelector('#rcPaidOn').value || today,
        theFor    : box.querySelector('#rcFor').value || '',
        unit      : unit,
        kindLabel : kind
      };

      const payRow = (data.payMethod==='cash') ? '' : `
        <tr><th>${data.payMethod==='cheque'?'Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ':'Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ'}</th><td>${data.payNum || 'â€”'}</td></tr>
      `;

      const html = `<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8">
<title>Ø³Ù†Ø¯ Ù‚Ø¨Ø¶ - Receipt Voucher</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Tajawal:wght@500;700;800&display=swap" rel="stylesheet">

<style>
  @page { size: A4; margin: 10mm; }
  * { box-sizing: border-box; }
  body { margin: 0; padding: 0; background: #fff; color: #111; }
  .receipt {
    width: 100%;
    max-width: 170mm;
    margin: 0 auto;
    border: 1.5px solid #222;
    border-radius: 12px;
    padding: 10mm;
    font-family: "Tajawal","Segoe UI",Tahoma,Arial,sans-serif;
    line-height: 1.8;
  }
  .header { display: grid; grid-template-columns: 1fr 120px 1fr; align-items: start; gap: 10px; margin-bottom: 8mm; }
  .header .right{ text-align:right; line-height:1.6; font-size:13.5px; direction:rtl; white-space:pre-line; font-weight:700 }
  .header .left { text-align:left;  line-height:1.6; font-size:13.5px; direction:ltr; white-space:pre-line; font-family:"Poppins","Segoe UI",Tahoma,Arial,sans-serif; font-weight:600 }
  .header .logo{ display:flex;align-items:center;justify-content:center; height:100% }
  .header .logo img{ max-width:110px; max-height:110px; object-fit:contain }
  .title-wrap { text-align:center; margin-bottom: 8mm; }
  .title-frame {
    display:inline-block; border:2px solid #111; border-radius:12px;
    padding:4mm 6mm; text-align:center;
  }
  .title-frame .ar { font-size:22px; font-weight:800; margin:0; letter-spacing:.2px }
  .title-frame .en { font-size:14px; font-weight:700; margin:0; letter-spacing:.2px }
  .title-frame hr { border:none; border-top:1px solid #111; margin:2.5mm 0 }
  .meta { font-size:13px; color:#444; margin-bottom:6mm; display:grid; grid-template-columns:1fr 1fr; gap:6mm }
  .meta div b { color:#111 }
  table{ width:100%; border-collapse:collapse }
  th,td{ border:1px solid #000; padding:8px; font-size:13.5px; text-align:right }
  th{ white-space:nowrap }
  .sign{ margin-top:14mm; display:flex; flex-direction:column; align-items:center; gap:14mm }
  .sig-block{ display:flex; flex-direction:column; align-items:center }
  .sig-block .label{ font-weight:800; margin-bottom:6px }
  .sig-block img{ height:70px; width:auto; object-fit:contain }
  .sig-block .line{ border-top:1px solid #111; width:60%; height:0; margin-top:8mm }
  @media print{ body{ padding:0 } }
</style>

<style id="oasis-minimal-pack">
/* === Oasis Minimal Pack â€” v1 === */
:root{
  --bg:#faf8f4;
  --fg:#0b1728;
  --muted:#667085;
  --card:#ffffff;
  --border:#e8edf3;
  --accent:#0bb8b2;
  --accent-2:#0891a0;
  --success:#16a34a;
  --danger:#ef4444;
  --kpi:#f2fbfb;
}
html,body{
  background: radial-gradient(1200px 600px at 80% -10%, #e6fbff 0%, transparent 70%),
              radial-gradient(1000px 500px at -10% 100%, #fff3e0 0%, transparent 70%),
              linear-gradient(180deg,#fbfcfd 0%,#f3f6f8 100%);
  color:var(--fg);
}
header{ background: rgba(255,255,255,.78); backdrop-filter: blur(10px) saturate(1.1); border-bottom: 1px solid var(--border); }
.card{ border:1px solid var(--border); border-radius:18px; box-shadow: 0 10px 28px rgba(17,24,39,.06); }
.stat{ background:rgba(255,255,255,.85); border:1px solid var(--border); border-radius:14px; box-shadow: 0 6px 20px rgba(2,132,199,.06); }
.icon-card{ border-radius:18px; background:linear-gradient(180deg,#ffffff 0%, #fbfdff 100%); box-shadow: 0 12px 36px rgba(15,23,42,.08); }
.icon-card .circle{ width:56px;height:56px; background: linear-gradient(135deg, #ccfbf1 0%, #e0f2fe 100%); border:1px solid #cce7f3; }
.btn{ border-radius:12px; border:1px solid var(--border); background:#fff; transition: transform .12s ease, box-shadow .18s ease, background .18s ease; }
.btn:hover{ transform: translateY(-1px); box-shadow:0 10px 26px rgba(0,0,0,.06); }
.btn:focus{ outline:none; box-shadow:0 0 0 3px rgba(11,184,178,.22); }
.btn.primary{ color:#fff; border-color: transparent; background: linear-gradient(135deg, var(--accent) 0%, #22d3ee 100%); box-shadow: 0 6px 20px rgba(34,211,238,.35); }
.btn.primary:hover{ transform: translateY(-1px); box-shadow: 0 10px 28px rgba(34,211,238,.45); }
.btn.danger{ color:#fff; border-color:transparent; background: linear-gradient(135deg, #ef4444 0%, #f97316 100%); box-shadow: 0 6px 18px rgba(249,115,22,.35); }
.chip{ background:#fff; border-radius:999px; }
.chip.active{ background:#e6fffb; border-color:#99f6e4; box-shadow: inset 0 0 0 1px rgba(11,184,178,.25); }
input,select,textarea{ border-radius:12px; border:1px solid var(--border); background:#fff; transition:border-color .15s, box-shadow .15s; }
input:focus,select:focus,textarea:focus{ border-color:#67e8f9; box-shadow: 0 0 0 3px rgba(34,211,238,.3); }
.modal-wrap .modal{ border-radius:20px; box-shadow: 0 24px 70px rgba(15,23,42,.18); }
.modal .head{ background:linear-gradient(180deg,#f8ffff 0%, #ffffff 100%); }
table{ background:#fff; border-radius:14px; overflow:hidden; }
thead{ background:linear-gradient(180deg,#f1fafc 0%, #eaf6fb 100%); }
th,td{ border-color:#e8edf3; }
.badge.success{ background:#e8fff4; border-color:#bfead0; }
.badge.gray{ background:#f5f7fb; border-color:#e8edf3; }
@media print{ body{ background:#fff; } }
</style>


<style id="mobile-enhancements">
/* === Mobile enhancements (phone-first) === */
@media (max-width: 640px) {
  html, body { font-size: 16px; }
  .container { padding: 12px; }
  header .container { flex-direction: column; align-items: stretch; gap: 8px; }
  .toolbar { width: 100%; overflow-x: auto; padding-bottom: 6px; -webkit-overflow-scrolling: touch; }
  .toolbar .btn { flex: 0 0 auto; }
  .card-h { align-items: stretch; }
  .card-h > div:last-child { width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
  .filters { gap: 6px; }
  input, select, textarea { width: 100%; }
  table { display: block; overflow-x: auto; white-space: nowrap; border-radius: 12px; }
  thead, tbody, tfoot, tr, th, td { border-collapse: separate; }
  /* Tenant rows: allow wrapping and stacking on small screens */
  [data-tenant-row] > div[style*="justify-content:flex-end"]{
    justify-content: stretch !important;
    gap: 6px !important;
    flex-wrap: wrap !important;
  }
  [data-tenant-row] .tenant-actions {
    width: 100% !important;
    flex-wrap: wrap !important;
  }
  [data-tenant-row] .tenant-actions .btn {
    flex: 1 1 calc(50% - 6px) !important;
    min-height: 44px !important;
  }
  [data-tenant-row] [data-del]{
    flex: 1 1 100% !important;
    min-height: 44px !important;
  }
  /* Force grid stacks for safety on phones */
  .grid { gap: 10px; }
  .grid.cols-2, .grid.cols-3 { grid-template-columns: 1fr !important; }
  /* Modal: fullscreen on phones */
  .modal-wrap .modal {
    width: 100vw !important;
    max-height: 100vh !important;
    height: 100vh !important;
    border-radius: 0 !important;
  }
  .modal .body { padding-bottom: 72px; }
  .modal .buttons-row {
    position: sticky;
    bottom: 0;
    background: #fff;
    padding: 10px;
    border-top: 1px solid var(--border);
  }
  /* Chips and tabs: horizontal scroll if overflow */
  .filters, #bizTabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .chip { flex: 0 0 auto; }
  /* KPI cards readability */
  .stat { font-size: 14px; }
  /* Building cards: compact layout */
  #buildingsGrid .icon-card { display: grid; grid-template-columns: 56px 1fr; align-items: center; gap: 10px; }
  #buildingsGrid .icon-card .circle { grid-row: span 2; }
}
@media (max-width: 370px){
  .card-h > div:last-child { grid-template-columns: 1fr; }
  [data-tenant-row] .tenant-actions .btn { flex-basis: 100% !important; }
}
/* Better tap targets */
.btn { touch-action: manipulation; }
</style>

</head>
<body>
  <div class="receipt">
    <div class="header">
      <div class="right">
Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ù†Ù…ÙˆØ°Ø¬)

Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù†

      </div>
      <div class="logo">
</div>
      <div class="left">
Demo Entity

Sultanate of Oman

      </div>
    </div>

    <div class="title-wrap">
      <div class="title-frame">
        <p class="ar">Ø³Ù†Ø¯ Ù‚Ø¨Ø¶</p>
        <hr>
        <p class="en">Receipt Voucher</p>
      </div>
    </div>

    <div class="meta">
      <div>Ø§Ù„Ù…Ø¨Ù†Ù‰: <b>${data.building || 'â€”'}</b></div>
      <div>Ø§Ù„ÙˆØ­Ø¯Ø©: <b>${data.unit || 'â€”'}</b> (${data.kindLabel || 'â€”'})</div>
      <div>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„: <b>${data.rcNo}</b></div>
      <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: <b>${data.dateHeader}</b></div>
    </div>

    <table>
      <tr><th>Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ù…Ù† Ø§Ù„ÙØ§Ø¶Ù„</th><td>${data.payer || 'â€”'}</td></tr>
      <tr><th>Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡</th><td>${data.amountWords || (amountWordsAR(data.amount) + ' Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ')}</td></tr>
      <tr><th>(Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…)</th><td>Ø±Ø¹ ${data.amount}</td></tr>
      <tr><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th><td>${data.payMethod==='cheque'?'Ø´ÙŠÙƒ':(data.payMethod==='transfer'?'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ':'Ù†Ù‚Ø¯Ù‹Ø§')}</td></tr>
      ${payRow}
      <tr><th>Ø¨ØªØ§Ø±ÙŠØ®</th><td>${data.paidOn}</td></tr>
      <tr><th>ÙˆØ°Ù„Ùƒ Ø¹Ù†</th><td>${data.theFor}</td></tr>
    </table>

    <div class="sign">
      <div class="sig-block">
        <div class="label">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
        
        <div class="line"></div>
      </div>
    </div>
  </div>
</body>
</html>`;

      const w = window.open('', '_blank');
      w.document.write(html);
      w.document.close();
      setTimeout(()=>{ try{ w.print(); }catch(e){} }, 120);
      overlay.remove();
    };
  };

  // ØªÙÙˆÙŠØ¶ Ø¹Ø§Ù… Ù„Ø²Ø± [data-receipt]
  document.addEventListener('click', function(ev){
    const b = ev.target.closest?.('[data-receipt]');
    if(!b) return;
    ev.stopPropagation();
    ev.stopImmediatePropagation?.();
    openReceipt({
      tenantName: b.dataset.tenantName || '',
      unitNumber: b.dataset.unit || '',
      rent: parseFloat(b.dataset.rent||'0') || 0,
      kind: b.dataset.kind || '',
      phone: b.dataset.phone || '',
      idNumber: b.dataset.id || '',
      payDate: b.dataset.paydate || '',
      idimg: b.dataset.idimg || ''
    });
  }, {capture:true});
})();
</script>
<!-- ========================= ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ + Ø¨Ø¯ÙˆÙ† Ø¯ÙØ¹Ø© Ø§Ù„ØµØ§Ù„ÙˆÙ†) ========================= -->
<script>
(function () {
  const ADMIN_PERCENT = 15; // Ù†Ø³Ø¨Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
  const LOGO_URL = "";

  // Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø©
  const T = s => (s||"").toString().trim();
  const H = s => String(s||"")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");

  // Ø£Ø¯ÙˆØ§Øª ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ù‘Ø¯ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const pad2 = n => String(n).padStart(2,'0');
  const startOfMonth = (y,m)=> new Date(Date.UTC(y, m-1, 1));
  const endOfMonth   = (y,m)=> new Date(Date.UTC(y, m, 0, 23,59,59));
  const monthsSinceStartIncl = (sy, sm, y, m)=> (y*12+m) - (sy*12+sm) + 1;

  // ØªØµÙ†ÙŠÙ Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø©
  const kindKey = s => {
    s = String(s||'').toLowerCase();
    if (/shop/.test(s) || /Ù…Ø­Ù„/.test(s)) return 'shop';
    if (/showroom/.test(s) || /Ù…Ø¹Ø±Ø¶/.test(s)) return 'showroom';
    if (/basement/.test(s) || /Ù‚Ø¨Ùˆ/.test(s)) return 'basement';
    return 'apartment';
  };

  // ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù…Ù„Ø©
  const formatOMR = n => {
    const x = Number(n||0);
    return isFinite(x) ? x.toFixed(3) : "0.000";
  };
// --- ÙØ±Ø² Ø·Ø¨ÙŠØ¹ÙŠ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© + Ø¥Ø²Ø§Ù„Ø© Ø¨Ø§Ø¯Ø¦Ø© Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø© ---

// ÙŠØ­ÙˆÙ‘Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
function _normalizeDigits(s){
  return String(s||'').replace(/[\u0660-\u0669\u06F0-\u06F9]/g, d=>{
    const code = d.charCodeAt(0);
    const base = (code >= 0x06F0) ? 0x06F0 : 0x0660;
    return String(code - base);
  });
}

// ÙŠØ¬Ø²Ù‘Ø¦ Ø§Ù„Ù†Øµ Ù„Ù‚Ø·Ø¹ Ø£Ø±Ù‚Ø§Ù…/Ø­Ø±ÙˆÙ Ù„Ø¹Ù…Ù„ Ù…Ù‚Ø§Ø±Ù†Ø© Ø·Ø¨ÙŠØ¹ÙŠØ©
function _naturalKey(val){
  const s = _normalizeDigits(val||'');
  const parts = s.match(/\d+|\D+/g) || [];
  return parts.map(p => (/^\d+$/.test(p) ? parseInt(p,10) : p.trim().toLowerCase()));
}

// Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© Ø¨ÙŠÙ† Ù‚ÙŠÙ…ØªÙŠÙ†
function _cmpNatural(a,b){
  const ka=_naturalKey(a), kb=_naturalKey(b);
  const n=Math.max(ka.length,kb.length);
  for(let i=0;i<n;i++){
    const xa=ka[i], xb=kb[i];
    if(xa===undefined) return -1;
    if(xb===undefined) return 1;
    const na=typeof xa==='number', nb=typeof xb==='number';
    if(na && nb){ if(xa!==xb) return xa - xb; }
    else{
      const sa=String(xa), sb=String(xb);
      if(sa!==sb) return sa.localeCompare(sb,'ar',{numeric:true,sensitivity:'base'});
    }
  }
  return 0;
}

// ÙŠØ²ÙŠÙ„ "Ø§Ù„Ø´Ù‚Ø©/Ø´Ù‚Ø©/Ø§Ù„Ù…Ø­Ù„/..." Ù…Ù† Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù†Øµ Ù„Ù†Ø¨Ù‚Ù‰ Ù…Ø¹ Ø±Ù‚Ù…/Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø© ÙÙ‚Ø·
function _unitCore(u){
  return String(u||'').replace(/^\s*(?:Ø§Ù„Ø´Ù‚Ø©|Ø´Ù‚Ø©|Ø§Ù„Ù…Ø­Ù„|Ù…Ø­Ù„|Ø§Ù„Ù…Ø¹Ø±Ø¶|Ù…Ø¹Ø±Ø¶|Ø§Ù„Ù‚Ø¨Ùˆ|Ù‚Ø¨Ùˆ)\s*/i,'').trim();
}

  // ØªØ­ÙˆÙŠÙ„ Ù†Øµ Ø¥Ù„Ù‰ Ø±Ù‚Ù… (ÙŠØ¯Ø¹Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆÙŠØ²ÙŠÙ„ % ÙˆØ§Ù„ÙÙˆØ§ØµÙ„)
  function toNum(v){
    let s = (v ?? '').toString().trim();
    const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
    s = s.replace(/[Ù -Ù©]/g, d => map[d] || d);
    s = s.replace(/[ï¼…Ùª%]/g, '');
    s = s.replace(/,/g, '.');
    s = s.replace(/[^0-9.\-]/g, '');
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : NaN;
  }
// ÙŠØ¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¯Ø§Ø®Ù„ Ù†Øµ (ÙŠØ¯Ø¹Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„ÙƒØ³ÙˆØ±)
// Ù…Ø«Ø§Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©: "80 Ù…Ù‚Ø¯Ù…Ø§Ù‹" Ø£Ùˆ "200 Ù…Ø¤Ø®Ø±" â‡’ 80 / 200
function sumNumbersInText(txt){
  if(!txt) return 0;
  let s = String(txt);

  // Ø·ÙØ¨Ù‘Ø¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŒ ÙˆØ§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„ÙØ§ØµÙ„Ø© Ø¨Ø¹Ù„Ø§Ù…Ø© Ø¹Ø´Ø±ÙŠØ© Ù†Ù‚Ø·Ø©
  const map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
  s = s.replace(/[Ù -Ù©]/g, d => map[d] || d).replace(/,/g, '.');

  // Ø¥Ù† ÙˆÙØ¬Ø¯Øª ÙƒÙ„Ù…Ø© "Ø³Ù…Ø§Ø­ X Ø´Ù‡Ø±" Ù„Ø§ Ù†Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø£Ø´Ù‡Ø± Ø¶Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹
  s = s.replace(/Ø³Ù…Ø§Ø­[^0-9\-+]*[-+]?\d+(?:\.\d+)?\s*Ø´Ù‡Ø±/gi, '');

  const nums = s.match(/[-+]?\d+(?:\.\d+)?/g) || [];
  return nums.reduce((acc, v)=> acc + (parseFloat(v)||0), 0);
}

  // Ù…Ø­ÙˆÙ‘Ù„ ØªØ§Ø±ÙŠØ® Ù…Ø±Ù† + Ø¥Ø®Ø±Ø§Ø¬ Ù†Øµ ISO
  function toDateAny(v){
    try{
      if(!v) return null;
      if(v instanceof Date) return v;
      if(typeof v.toDate === 'function') return v.toDate();        // Firestore Timestamp
      if(typeof v.seconds === 'number') return new Date(v.seconds*1000);
      if(typeof v === 'number') return new Date(v);
      if(typeof v === 'string'){
        const s = v.replace(/\//g,'-').slice(0,10);                // "YYYY/MM/DD" â†’ "YYYY-MM-DD"
        const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if(m) return new Date(Date.UTC(+m[1], +m[2]-1, +m[3]));
        const d2 = new Date(v);
        if(!isNaN(d2)) return d2;
      }
    }catch(e){}
    return null;
  }
  const dateToStr = v => {
    const d = toDateAny(v);
    return d ? d.toISOString().slice(0,10) : '';
  };

  // Ø§ÙƒØ³Ø± Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ø³Ø·Ø±ÙŠÙ†
  function splitTwoLines(str){
    const s = String(str||"").replace(/\s+/g,"");
    if (!s) return "";
    if (s.length <= 4) return H(s);
    const mid = Math.ceil(s.length/2);
    return H(s.slice(0, mid)) + "<br>" + H(s.slice(mid));
  }

  // 1) Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
  async function loadExpensesForCurrentMonth(){
    try{
      const bid = window.App?.State?.activeBuildingId;
      const y   = Number(window.App?.State?.selYear);
      const m   = Number(window.App?.State?.selMonth);
      if(!bid || !y || !m || !window.App?.FB?.listExpenses) return {list:[], total:0};

      const listAll = await window.App.FB.listExpenses(bid);
      const ms = startOfMonth(y,m), me = endOfMonth(y,m);

      const inMonth = listAll.filter(e=>{
        if (e.year != null && e.month != null) return Number(e.year)===y && Number(e.month)===m;
        if (e.ym) return String(e.ym).slice(0,7) === `${y}-${pad2(m)}`;
        const d = toDateAny(e.date);
        return d && d >= ms && d <= me;
      });

      const total = inMonth.reduce((s,e)=> s + (Number(e.amount)||0), 0);
      return {list: inMonth, total};
    }catch{ return {list:[], total:0}; }
  }

  // 2) ØµÙÙˆÙ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†
  async function buildRows(){
    const y = Number(window.App?.State?.selYear);
    const m = Number(window.App?.State?.selMonth);
    const ym = `${y}-${pad2(m)}`;
    const ms = startOfMonth(y,m), me = endOfMonth(y,m);
    const bid = window.App?.State?.activeBuildingId;

    if(!window.App?.FB?.listTenants || !bid){
      const container = document.getElementById("tenantsList") || document;
      const rows = [];
      container.querySelectorAll("#tenantsList [data-tenant-row], .tenant-row, tr[data-unit], tr.unit-row, .row-tenant").forEach(row=>{
        const ds = row.dataset || {};
        rows.push({
          unit  : ds.unit || ds.unitNumber || "",
          tenant: ds.tenantName || ds.tenant || "",
          id    : ds.id || "",
          rent  : Number(String(ds.rent||"").replace(/[^\d.]/g,""))||0,
          phone : ds.phone || "",
          start : ds.start || "",
          end   : ds.end || "",
          notes : ds.notes || "",
          kind  : kindKey(ds.kind || row.getAttribute('data-kind') || ""),
          inGrace:false
        });
      });
      return rows;
    }

    const tenants = await window.App.FB.listTenants(bid);
    return tenants.filter(t=>{
      const sd = t.startDate ? new Date(t.startDate) : new Date(0);
      const ed = t.endDate   ? new Date(t.endDate)   : new Date('9999-12-31');
      return sd <= me && ed >= ms;
    }).map(t=>{
      const sd = t.startDate ? new Date(t.startDate) : new Date();
      const mSince = monthsSinceStartIncl(sd.getUTCFullYear(), sd.getUTCMonth()+1, y, m);
      const graceEnabled = !!t.graceEnabled;
      const graceMonths  = Number(t.graceMonths||0);
      const inGrace = graceEnabled && graceMonths >= mSince;
      const payNote = (t.payments && t.payments[ym]) ? t.payments[ym] : '';
      const graceNote = graceEnabled ? `Ø³Ù…Ø§Ø­ ${graceMonths} Ø´Ù‡Ø±${inGrace ? ' (ØºÙŠØ± Ù…Ø­Ø³ÙˆØ¨)' : ''}` : '';
      const combinedNote = [payNote, graceNote, (t.notes||'')].filter(Boolean).join(' â€¢ ');
      return {
        unit  : t.unitNumber || '',
        tenant: t.tenantName || '',
        id    : t.nationalId || '',
        rent  : Number(t.rent||0)||0,
        phone : t.phone || '',
        start : (t.startDate||'').slice(0,10),
        end   : (t.endDate||'').slice(0,10),
        notes : combinedNote,
        kind  : kindKey(t.kind),
        inGrace
      };
    });
  }

  // 3) Ø¬Ø¯Ø§ÙˆÙ„ HTML
function tableHTML(title, unitHeader, list, partyHeader='Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±'){
  if (!list.length) return "";

  // ÙØ±Ø² ØªØµØ§Ø¹Ø¯ÙŠ Ø­Ø³Ø¨ Ø±Ù‚Ù…/Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø©ØŒ Ø«Ù… Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
  const sorted = [...list].sort((a,b)=>{
    const c = _cmpNatural(_unitCore(a.unit), _unitCore(b.unit));
    if (c) return c;
    return String(a.tenant||'').localeCompare(String(b.tenant||''), 'ar', {numeric:true, sensitivity:'base'});
  });

  return `
    <h2 class="sec-title">${H(title)}</h2>
    <div class="table-wrap">
      <table>
        <colgroup>
          <col style="width:8%">
          <col style="width:18%">
          <col style="width:16%">
          <col style="width:8%">
          <col style="width:12%">
          <col style="width:11%">
          <col style="width:11%">
          <col style="width:16%">
        </colgroup>
        <thead>
          <tr>
            <th>${H(unitHeader)}</th>
            <th>${H(partyHeader)}</th>
            <th>Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</th>
            <th>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
            <th>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</th>
            <th>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</th>
            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¯ÙØ¹</th>
          </tr>
        </thead>
        <tbody>
          ${sorted.map(r=>`
            <tr>
              <td class="split2">${splitTwoLines(r.unit)}</td>
              <td class="wrap">${H(r.tenant)}</td>
              <td class="big-id nowrap">${H(r.id)}</td>
              <td>${formatOMR(r.rent)}</td>
              <td class="wrap">${H(r.phone)}</td>
              <td>${H(r.start)}</td>
              <td>${H(r.end)}</td>
              <td class="wrap small-notes">${H(r.notes)}</td>
            </tr>`).join("")}
        </tbody>
      </table>
    </div>`;
}


  function expensesTableHTML(exps){
    if(!exps.length) return "";
    return `
      <h2 class="sec-title">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2>
      <div class="table-wrap">
        <table>
          <colgroup>
            <col style="width:28%"><col style="width:14%"><col style="width:16%"><col style="width:42%">
          </colgroup>
          <thead>
            <tr>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø¹)</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            </tr>
          </thead>
          <tbody>
            ${exps.map(e=>`
              <tr>
                <td class="wrap">${H(e.type||'')}</td>
                <td>${formatOMR(e.amount)}</td>
                <td>${H(dateToStr(e.date) || e.ym || (e.year && e.month ? (e.year+'-'+pad2(e.month)) : ''))}</td>
                <td class="wrap small-notes">${H(e.notes||'')}</td>
              </tr>`).join("")}
          </tbody>
        </table>
      </div>`;
  }

  // 4) Ø¨Ù†Ø§Ø¡ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
  async function printReport(ctx){
    const allRows = await buildRows();

    const groups = {
      apartment: allRows.filter(r => r.kind==='apartment'),
      shop     : allRows.filter(r => r.kind==='shop'),
      showroom : allRows.filter(r => r.kind==='showroom'),
      basement : allRows.filter(r => r.kind==='basement'),
    };

    const sum = list => list.reduce((s,r)=> s + (r.inGrace ? 0 : (Number(r.rent||0)||0)), 0);
    const tA = sum(groups.apartment);
    const tS = sum(groups.shop);
    const tR = sum(groups.showroom);
    const tB = sum(groups.basement);

    const exp = await loadExpensesForCurrentMonth();
    const invoicesTotal = exp.total;

    const coreTotal = tA + tS;
let paidTotal = 0;
try {
  const y  = Number(window.App?.State?.selYear);
  const m  = Number(window.App?.State?.selMonth);
  const ym = `${y}-${String(m).padStart(2,'0')}`;

  const bid = window.App?.State?.activeBuildingId;
  if (bid && window.App?.FB?.listTenants) {
    const tenantsRaw = await window.App.FB.listTenants(bid);
    for (const t of tenantsRaw) {
      const note = t?.payments?.[ym];
      if (note) paidTotal += sumNumbersInText(note);
    }
  } else {
    // Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Ù…Ù† DOM): Ù‚Ø¯ ØªØ­ØªÙˆÙŠ "Ø³Ù…Ø§Ø­ 2 Ø´Ù‡Ø±" Ù„Ø°Ù„Ùƒ Ø£Ø²Ù„Ù†Ø§Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¯Ø§Ù„Ø©
    document.querySelectorAll('#tenantsList [data-tenant-row]').forEach(row=>{
      const note = row.dataset?.notes || '';
      if (note) paidTotal += sumNumbersInText(note);
    });
  }
} catch(e){ /* ØªØ¬Ø§Ù‡Ù„ */ }
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    let feeType  = ctx.feeType  || 'percentage';
    let feeValue = (ctx.feeValue != null ? ctx.feeValue : '');
    let fv = toNum(feeValue);

    if (!(fv > 0)) {
      try {
        const bid = window.App?.State?.activeBuildingId;
        if (bid) {
          const b = DEMO_MODE
            ? (DemoStore.getBuilding(bid) || {})
            : await (async()=>{
                const ref = await firebase.firestore().collection('buildings').doc(bid).get();
                return ref.exists ? (ref.data() || {}) : {};
              })();

          feeType  = b.feeType  || feeType;
          feeValue = (b.feeValue != null ? b.feeValue : feeValue);
          fv = toNum(feeValue);
        }
      } catch(e){}
    }

    let adminFee = 0, adminLabel = '';
    if (feeType === 'salary' && (fv > 0)) {
      adminFee = fv;
      adminLabel = 'Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø±Ø§ØªØ¨ Ø«Ø§Ø¨Øª)';
    } else if (fv > 0) {
      adminFee = coreTotal * (fv / 100);
      adminLabel = `Ù†Ø³Ø¨Ø© Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ${fv}%`;
    } else {
      adminFee = coreTotal * (ADMIN_PERCENT/100);
      adminLabel = `Ù†Ø³Ø¨Ø© Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ${ADMIN_PERCENT}%`;
    }

    const netTotal = coreTotal - adminFee - invoicesTotal;
 // Ø¹Ù†ÙˆØ§Ù† ÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©)
    const selYear  = Number(window.App?.State?.selYear)  || new Date().getFullYear();
    const selMonth = Number(window.App?.State?.selMonth) || (new Date().getMonth() + 1);
    const monthsAr = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ',
                      'ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
    const monthName = monthsAr[selMonth - 1] || '';
    const periodTitle = monthName ? `ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø± ${monthName} ${selYear}` : '';

    const workType = (ctx.workType || 'Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ');
    const entityLabel = (workType==='ØªØ«Ù…ÙŠÙ†') ? 'Ø§Ù„Ø¨Ù†Ùƒ' : 'Ø§Ù„Ù…Ø¨Ù†Ù‰';
    const partyHeader = (workType==='ØªØ«Ù…ÙŠÙ†') ? 'Ø§Ù„Ø²Ø¨ÙˆÙ†' : (workType==='Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ' ? 'Ø§Ù„Ù…Ø§Ù„Ùƒ' : 'Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±');
    const ownerLabel = (workType==='ØªØ«Ù…ÙŠÙ†') ? 'Ø§Ù„Ø²Ø¨ÙˆÙ†' : 'Ø§Ù„Ù…Ø§Ù„Ùƒ';

    const html = `<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8">
<title>ØªÙ‚Ø±ÙŠØ± ${entityLabel}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Tajawal:wght@500;700;800&display=swap" rel="stylesheet">
<style>
  @page { size: A4; margin: 10mm; }
  *{box-sizing:border-box}
  body{margin:0;background:#fff;color:#111}
  .page-frame{ position:relative; width:100%; max-width:190mm; margin:0 auto; padding:8mm 6mm 6mm; }
  .page-frame::before{ content:""; position:absolute; inset:0; border:2px solid #000; border-radius:12px; pointer-events:none; }
  .report{ width:100%; max-width:190mm; margin:0 auto; padding:0; font-family:"Tajawal","Segoe UI",Tahoma,Arial,sans-serif; line-height:1.8; }
  .header{display:grid;grid-template-columns:1fr 120px 1fr;align-items:start;gap:10px;margin:0 0 8mm}
  .header .right{ text-align:right; line-height:1.6; font-size:13.5px; direction:rtl; white-space:pre-line; font-weight:700 }
  .header .left{  text-align:left;  line-height:1.6; font-size:13.5px; direction:ltr; white-space:pre-line; font-family:"Poppins","Segoe UI",Tahoma,Arial,sans-serif; font-weight:600 }
  .header .logo{ display:flex;align-items:center;justify-content:center }
  .header .logo img{ max-width:110px; max-height:110px; object-fit:contain }
  .meta{ font-size:12.5px; color:#444; margin:0 0 6mm; display:grid; grid-template-columns:1fr 1fr; gap:6mm }
  .meta b{ color:#111 }
  .sec-title{ font-weight:800; margin:7mm 0 5mm; text-align:center; font-size:16px }
  .table-wrap{ border:1px solid #000; border-radius:10px; overflow:hidden; }
  table{ width:100%; border-collapse:collapse; table-layout:fixed; }
  th,td{ border:1px solid #000; padding:6px 7px; font-size:12.5px; line-height:1.35; vertical-align:top; text-align:right; }
  th{ background:#f8fafc; white-space:nowrap; }
  td.wrap{ white-space:pre-wrap; word-break:break-word; overflow-wrap:anywhere; }
  td.split2{ white-space:normal; line-height:1.3; font-family:monospace; text-align:center; }
  td.big-id{ font-size:15px; }
  td.nowrap{ white-space:nowrap; word-break:keep-all; overflow-wrap:normal; }
  td.small-notes{ font-size:11px; }
  .totals{ margin-top:8mm; border:1px solid #111; border-radius:10px; padding:10px 12px; font-size:13.5px; }
  .totals .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .accounts{ margin-top:6mm; border:1px solid #111; border-radius:10px; padding:10px 12px; font-size:14px; }
  .accounts .item{ display:flex; align-items:center; justify-content:space-between; padding:4px 0; }
  .accounts .item .lbl{ font-weight:700 }
  .footer{ margin-top:6mm; margin-bottom: 10mm; font-size:11.5px; color:#555; text-align:center; white-space:pre-line }
  @media print{ body{padding:0} }
</style>

<style id="oasis-minimal-pack">
/* === Oasis Minimal Pack â€” v1 === */
:root{
  --bg:#faf8f4;
  --fg:#0b1728;
  --muted:#667085;
  --card:#ffffff;
  --border:#e8edf3;
  --accent:#0bb8b2;
  --accent-2:#0891a0;
  --success:#16a34a;
  --danger:#ef4444;
  --kpi:#f2fbfb;
}
html,body{
  background: radial-gradient(1200px 600px at 80% -10%, #e6fbff 0%, transparent 70%),
              radial-gradient(1000px 500px at -10% 100%, #fff3e0 0%, transparent 70%),
              linear-gradient(180deg,#fbfcfd 0%,#f3f6f8 100%);
  color:var(--fg);
}
header{ background: rgba(255,255,255,.78); backdrop-filter: blur(10px) saturate(1.1); border-bottom: 1px solid var(--border); }
.card{ border:1px solid var(--border); border-radius:18px; box-shadow: 0 10px 28px rgba(17,24,39,.06); }
.stat{ background:rgba(255,255,255,.85); border:1px solid var(--border); border-radius:14px; box-shadow: 0 6px 20px rgba(2,132,199,.06); }
.icon-card{ border-radius:18px; background:linear-gradient(180deg,#ffffff 0%, #fbfdff 100%); box-shadow: 0 12px 36px rgba(15,23,42,.08); }
.icon-card .circle{ width:56px;height:56px; background: linear-gradient(135deg, #ccfbf1 0%, #e0f2fe 100%); border:1px solid #cce7f3; }
.btn{ border-radius:12px; border:1px solid var(--border); background:#fff; transition: transform .12s ease, box-shadow .18s ease, background .18s ease; }
.btn:hover{ transform: translateY(-1px); box-shadow:0 10px 26px rgba(0,0,0,.06); }
.btn:focus{ outline:none; box-shadow:0 0 0 3px rgba(11,184,178,.22); }
.btn.primary{ color:#fff; border-color: transparent; background: linear-gradient(135deg, var(--accent) 0%, #22d3ee 100%); box-shadow: 0 6px 20px rgba(34,211,238,.35); }
.btn.primary:hover{ transform: translateY(-1px); box-shadow: 0 10px 28px rgba(34,211,238,.45); }
.btn.danger{ color:#fff; border-color:transparent; background: linear-gradient(135deg, #ef4444 0%, #f97316 100%); box-shadow: 0 6px 18px rgba(249,115,22,.35); }
.chip{ background:#fff; border-radius:999px; }
.chip.active{ background:#e6fffb; border-color:#99f6e4; box-shadow: inset 0 0 0 1px rgba(11,184,178,.25); }
input,select,textarea{ border-radius:12px; border:1px solid var(--border); background:#fff; transition:border-color .15s, box-shadow .15s; }
input:focus,select:focus,textarea:focus{ border-color:#67e8f9; box-shadow: 0 0 0 3px rgba(34,211,238,.3); }
.modal-wrap .modal{ border-radius:20px; box-shadow: 0 24px 70px rgba(15,23,42,.18); }
.modal .head{ background:linear-gradient(180deg,#f8ffff 0%, #ffffff 100%); }
table{ background:#fff; border-radius:14px; overflow:hidden; }
thead{ background:linear-gradient(180deg,#f1fafc 0%, #eaf6fb 100%); }
th,td{ border-color:#e8edf3; }
.badge.success{ background:#e8fff4; border-color:#bfead0; }
.badge.gray{ background:#f5f7fb; border-color:#e8edf3; }
@media print{ body{ background:#fff; } }
</style>


<style id="mobile-enhancements">
/* === Mobile enhancements (phone-first) === */
@media (max-width: 640px) {
  html, body { font-size: 16px; }
  .container { padding: 12px; }
  header .container { flex-direction: column; align-items: stretch; gap: 8px; }
  .toolbar { width: 100%; overflow-x: auto; padding-bottom: 6px; -webkit-overflow-scrolling: touch; }
  .toolbar .btn { flex: 0 0 auto; }
  .card-h { align-items: stretch; }
  .card-h > div:last-child { width: 100%; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
  .filters { gap: 6px; }
  input, select, textarea { width: 100%; }
  table { display: block; overflow-x: auto; white-space: nowrap; border-radius: 12px; }
  thead, tbody, tfoot, tr, th, td { border-collapse: separate; }
  /* Tenant rows: allow wrapping and stacking on small screens */
  [data-tenant-row] > div[style*="justify-content:flex-end"]{
    justify-content: stretch !important;
    gap: 6px !important;
    flex-wrap: wrap !important;
  }
  [data-tenant-row] .tenant-actions {
    width: 100% !important;
    flex-wrap: wrap !important;
  }
  [data-tenant-row] .tenant-actions .btn {
    flex: 1 1 calc(50% - 6px) !important;
    min-height: 44px !important;
  }
  [data-tenant-row] [data-del]{
    flex: 1 1 100% !important;
    min-height: 44px !important;
  }
  /* Force grid stacks for safety on phones */
  .grid { gap: 10px; }
  .grid.cols-2, .grid.cols-3 { grid-template-columns: 1fr !important; }
  /* Modal: fullscreen on phones */
  .modal-wrap .modal {
    width: 100vw !important;
    max-height: 100vh !important;
    height: 100vh !important;
    border-radius: 0 !important;
  }
  .modal .body { padding-bottom: 72px; }
  .modal .buttons-row {
    position: sticky;
    bottom: 0;
    background: #fff;
    padding: 10px;
    border-top: 1px solid var(--border);
  }
  /* Chips and tabs: horizontal scroll if overflow */
  .filters, #bizTabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .chip { flex: 0 0 auto; }
  /* KPI cards readability */
  .stat { font-size: 14px; }
  /* Building cards: compact layout */
  #buildingsGrid .icon-card { display: grid; grid-template-columns: 56px 1fr; align-items: center; gap: 10px; }
  #buildingsGrid .icon-card .circle { grid-row: span 2; }
}
@media (max-width: 370px){
  .card-h > div:last-child { grid-template-columns: 1fr; }
  [data-tenant-row] .tenant-actions .btn { flex-basis: 100% !important; }
}
/* Better tap targets */
.btn { touch-action: manipulation; }
</style>

</head>
<body>
  <div class="page-frame">
    <div class="report">
      <div class="header">
        <div class="right">
Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ù†Ù…ÙˆØ°Ø¬)

Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù†

        </div>
        <div class="logo">
</div>
        <div class="left">
Demo Entity

Sultanate of Oman

        </div>
      </div>

      <div class="meta">
        ${periodTitle
          ? `<div style="grid-column:1/-1;text-align:center;font-size:17px;font-weight:800;margin-bottom:2mm;">
               ${H(periodTitle)}
             </div>`
          : ''
        }
        <div>Ø§Ø³Ù… ${H(entityLabel)}: <b>${H(ctx.building||'')}</b></div>
        <div>Ø§Ù„Ù…ÙˆÙ‚Ø¹: <b>${H(ctx.location||'')}</b></div>
        <div>Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„: <b>${H(ctx.phone||'')}</b></div>
        <div>${H(ownerLabel)}: <b>${H(ctx.owner||'')}</b></div>
        <div style="grid-column:1/-1">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„: <b>${H(ctx.workType||'')}</b></div>
      </div>


      ${tableHTML('Ø§Ù„Ø´Ù‚Ù‚', ' Ø§Ù„Ø´Ù‚Ø©', groups.apartment, partyHeader)}
      ${tableHTML('Ø§Ù„Ù…Ø­Ù„Ø§Øª', ' Ø§Ù„Ù…Ø­Ù„', groups.shop, partyHeader)}
      ${tableHTML('Ø§Ù„Ù…Ø¹Ø§Ø±Ø¶', ' Ø§Ù„Ù…Ø¹Ø±Ø¶', groups.showroom, partyHeader)}
      ${tableHTML('Ø§Ù„Ù‚Ø¨Ùˆ', ' Ø§Ù„Ù‚Ø¨Ùˆ', groups.basement, partyHeader)}
      ${expensesTableHTML(exp.list)}

<div class="accounts">
        <div class="item"><span class="lbl">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</span><span></span></div>
        <div class="item"><span>Ù…Ø¬Ù…ÙˆØ¹ Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø´Ù‚Ù‚</span><b>${formatOMR(tA)} Ø±.Ø¹</b></div>
        <div class="item"><span>Ù…Ø¬Ù…ÙˆØ¹ Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…Ø­Ù„Ø§Øª</span><b>${formatOMR(tS)} Ø±.Ø¹</b></div>
        <div class="item"><span>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„ÙƒÙ„ÙŠ (Ø´Ù‚Ù‚ + Ù…Ø­Ù„Ø§Øª)</span><b>${formatOMR(coreTotal)} Ø±.Ø¹</b></div>
        <div class="item"><span>${adminLabel}</span><b>${formatOMR(adminFee)} Ø±.Ø¹</b></div>
             <div class="item"><span>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span><b>${formatOMR(paidTotal)} Ø±.Ø¹</b></div>
        <div class="item"><span>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span><b>${formatOMR(invoicesTotal)} Ø±.Ø¹</b></div>
        <div class="item" style="border-top:1px dashed #aaa; margin-top:6px; padding-top:8px">
          <span class="lbl">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø¨Ø¹Ø¯ Ø®ØµÙ… Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ±Ø³ÙˆÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
          <b>${formatOMR(netTotal)} Ø±.Ø¹</b>
        </div>
      </div>

      

      <div class="footer">
Øµ.Ø¨:138ØŒ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ: 323ØŒ Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù† â€” 

      </div>
    </div>
  </div>
</body>
</html>`;

    const w = window.open("", "_blank");
    w.document.write(html); w.document.close();
    setTimeout(()=>w.print(), 120);
  }

  // 5) Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
  window.openBuildingReport = async function(t){
    t = t || {};
    const ctx  = {
      building: t.name     || T(document.getElementById("buildingTitle")?.textContent),
      location: t.location || '',
      phone   : t.phone    || '',
      owner   : t.owner    || '',
      workType: t.workType || '',
      feeType : t.feeType  || undefined,
      feeValue: t.feeValue || undefined
    };
    await printReport(ctx);
  };
})();
</script>


<!-- ========================= Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ: Ø¥ØµØ¯Ø§Ø± Ù…Ø³ØªÙ†Ø¯Ø§Øª (Ø¹Ø¯Ù… Ù…Ù…Ø§Ù†Ø¹Ø© / ØªØ¹Ù‡Ø¯ / Ø¥Ù†Ø°Ø§Ø±) ========================= -->
<script>
(function(){
  // ØºÙ„Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
  document.addEventListener('click', function(ev){
    document.querySelectorAll('details[data-docs-drop][open]').forEach(d=>{
      if(!d.contains(ev.target)) d.open = false;
    });
  });

  
  // ØªØ­Ø³ÙŠÙ† ØªÙ…ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: ÙØªØ­ Ù„Ù„Ø£Ø¹Ù„Ù‰ Ø¹Ù†Ø¯ Ø¶ÙŠÙ‚ Ø§Ù„Ù…Ø³Ø§Ø­Ø© + Ù…Ù†Ø¹ Ø®Ø±ÙˆØ¬Ù‡Ø§ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø§Ø´Ø©
  function adjustDocsDrop(d){
    if(!d) return;
    d.classList.remove('open-up','align-left');
    if(!d.open) return;

    const menu = d.querySelector('.drop-menu');
    if(!menu) return;

    // Ù‚ÙŠØ§Ø³ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø¨Ø¯ÙˆÙ† ØªØ£Ø«ÙŠØ± Ù‚ØµÙ‘ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª)
    const prevVis = menu.style.visibility;
    const prevDisp = menu.style.display;
    menu.style.visibility = 'hidden';
    menu.style.display = 'block';
    const mr = menu.getBoundingClientRect();
    menu.style.display = prevDisp;
    menu.style.visibility = prevVis;

    const r = d.getBoundingClientRect();
    const spaceBelow = window.innerHeight - r.bottom;
    const spaceAbove = r.top;

    // Ø§ÙØªØ­ Ù„Ù„Ø£Ø¹Ù„Ù‰ Ø¥Ø°Ø§ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ© Ù„Ù„Ø£Ø³ÙÙ„
    if(spaceBelow < (mr.height + 12) && spaceAbove > spaceBelow){
      d.classList.add('open-up');
    }

    // Ù…Ø­Ø§Ø°Ø§Ø© Ø£ÙÙ‚ÙŠØ©: Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø³ØªØ®Ø±Ø¬ ÙŠØ³Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© ÙŠÙ…ÙŠÙ†Ù‹Ø§
    const mw = mr.width || 260;
    const leftIfRightAligned = r.right - mw;
    const wouldOverflowLeft = leftIfRightAligned < 8;
    const wouldOverflowRight = (r.left + mw) > (window.innerWidth - 8);
    if(wouldOverflowLeft && !wouldOverflowRight){
      d.classList.add('align-left');
    }
  }

  document.addEventListener('toggle', function(ev){
    const d = ev.target;
    if(d && d.matches && d.matches('details[data-docs-drop]')){
      adjustDocsDrop(d);
    }
  }, true);

  window.addEventListener('resize', function(){
    document.querySelectorAll('details[data-docs-drop][open]').forEach(adjustDocsDrop);
  }, {passive:true});

  window.addEventListener('scroll', function(){
    document.querySelectorAll('details[data-docs-drop][open]').forEach(adjustDocsDrop);
  }, true);

function esc(s){
    return (s==null?'':String(s))
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  function todayISO(){
    try{ return new Date().toISOString().slice(0,10); }catch(e){ return ''; }
  }

  function getBuildingTitle(){
    const t = (document.getElementById('buildingTitle')?.textContent || '').trim();
    return t || 'â€”';
  }

  
function getLogoSrc(){
  return (document.querySelector('img.brand-logo') || document.querySelector('header img'))?.src || '';
}

// Ø·Ø¨Ø§Ø¹Ø© "Ø±Ø³Ø§Ø¦Ù„" Ù…Ø¹ ØªØ±ÙˆÙŠØ³Ø© + Ø´Ø¹Ø§Ø± IBSC
window.openLetterPrintWindow = function(title, bodyHtml){
  const w = window.open('', '_blank');
  if(!w){
    alert('ØªØ¹Ø°Ø± ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø­Ø¸Ø± Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù…ÙØ¹Ù‘Ù„).');
    return;
  }

  const logo = getLogoSrc();
  const nowStr = new Date().toLocaleString('ar-OM');

  const html = `
    <!doctype html><html lang="ar" dir="rtl">
    <head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1"/>
      <title>${esc(title||'')}</title>
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">
      <style>
        @page{ size:A4; margin:18mm 16mm; }
        *{ box-sizing:border-box; }
        body{ font-family:"Tajawal","Noto Naskh Arabic",system-ui; margin:0; color:#0f172a; }
        .no-print{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin:10px 0 14px; }
        .btnP{ border:1px solid #e5e7eb; background:#fff; border-radius:12px; padding:8px 12px; cursor:pointer; }
        .wrap{ padding:0; }
        .letterhead{
          display:flex; justify-content:space-between; align-items:center; gap:14px;
          border-bottom:2px solid #0bb8b2; padding-bottom:10px; margin-bottom:14px;
        }
        .lh-right{ display:flex; align-items:center; gap:12px; }
        .logo{ width:70px; height:70px; border-radius:14px; border:1px solid #e5e7eb; object-fit:contain; background:#fff; }
        .co{ line-height:1.35; }
        .co .name{ font-weight:800; font-size:18px; letter-spacing:.2px; }
        .co .sub{ color:#475569; font-size:13px; font-weight:600; }
        .co .tiny{ color:#64748b; font-size:12px; margin-top:2px; }
        .meta-line{ display:flex; flex-wrap:wrap; gap:10px; color:#334155; font-size:12.5px; }
        .meta-pill{ border:1px solid #e5e7eb; padding:6px 10px; border-radius:999px; background:#fff; }
        .title{ text-align:center; font-size:18px; font-weight:900; margin:16px 0 10px; }
        .to{ margin:6px 0 10px; font-size:14px; }
        .subject{ margin:8px 0 14px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px; background:#f8fafc; font-weight:700; }
        .body{ font-size:14.5px; line-height:2; }
        .box{ margin-top:14px; border:1px solid #e5e7eb; border-radius:14px; overflow:hidden; }
        .box-h{ background:#f8fafc; border-bottom:1px solid #e5e7eb; padding:10px 12px; font-weight:800; }
        .box-c{ padding:10px 12px; }
        table{ width:100%; border-collapse:collapse; }
        td,th{ border:1px solid #e5e7eb; padding:8px 10px; font-size:13px; vertical-align:top; }
        th{ background:#f8fafc; }
        .sign{ margin-top:18px; display:flex; justify-content:space-between; gap:16px; flex-wrap:wrap; }
        .sig{ min-width:240px; }
        .sig .lbl{ color:#64748b; font-size:12px; margin-bottom:6px; }
        .sig .line{ border-bottom:1px solid #cbd5e1; height:26px; }
        .sig .nm{ margin-top:6px; font-weight:700; font-size:13px; }
        .footer{ margin-top:14px; padding-top:10px; border-top:1px dashed #cbd5e1; color:#64748b; font-size:12px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
        @media print{ .no-print{ display:none !important; } }
      </style>
    </head>
    <body>
      <div class="wrap">
        <div class="no-print">
          <div style="color:#64748b;font-size:12px">${nowStr}</div>
          <button class="btnP" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>

        <div class="letterhead">
          <div class="lh-right">
            ${logo ? `<img class="logo" src="${esc(logo)}" alt="IBSC"/>` : `<div style="width:70px;height:70px;border:1px solid #e5e7eb;border-radius:14px;display:grid;place-items:center;font-weight:800">IBSC</div>`}
            <div class="co">
              <div class="name">IBSC</div>
              <div class="sub">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù…ØªÙ„ÙƒØ§Øª</div>
              <div class="tiny">ÙˆØ«Ø§Ø¦Ù‚ Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ â€” Ø¥ØµØ¯Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ</div>
            </div>
          </div>
          <div style="text-align:left; color:#64748b; font-size:12px">
            <div>Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù†</div>
            <div>Ù‡Ø§ØªÙ: â€”</div>
          </div>
        </div>

        ${bodyHtml || ''}

        <div class="footer">
          <div>Øµ.Ø¨: 138ØŒ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ: 323ØŒ Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù†</div>
          <div>IBSC Property Management</div>
        </div>
      </div>
    </body></html>
  `;

  w.document.open(); w.document.write(html); w.document.close();
};

function openDocWizard(type, base){
    const UI = window.App && window.App.UI ? window.App.UI : null;
    if(!UI || typeof UI.openModal !== 'function'){
      alert('ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†ÙˆØ§ÙØ° (UI.openModal) ØºÙŠØ± Ù…ØªØ§Ø­Ø©.');
      return;
    }
    if(typeof window.openLetterPrintWindow !== 'function'){
      alert('Ø¯Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© openLetterPrintWindow ØºÙŠØ± Ù…ØªØ§Ø­Ø©.');
      return;
    }

    const titles = {
      noobj_rent: 'Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… Ù…Ù…Ø§Ù†Ø¹Ø© ØªØ£Ø¬ÙŠØ±',
      noobj_sell: 'Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… Ù…Ù…Ø§Ù†Ø¹Ø© Ø¨ÙŠØ¹',
      undertake_new_owner: 'Ø±Ø³Ø§Ù„Ø© ØªØ¹Ù‡Ø¯ Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯',
      warning: 'Ø±Ø³Ø§Ù„Ø© Ø¥Ù†Ø°Ø§Ø±'
    };
    const docTitle = titles[type] || 'Ù…Ø³ØªÙ†Ø¯';

    const bName = getBuildingTitle();
    const date0 = todayISO();
    const to0   = 'Ø¥Ù„Ù‰ Ù…Ù† ÙŠÙ‡Ù…Ù‡ Ø§Ù„Ø£Ù…Ø±';

    const extraCommon = `
      <div class="grid cols-2" style="margin-top:10px">
        <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="oaDocDate" type="date" value="${esc(date0)}"></div>
        <div><label>Ø§Ù„Ø¬Ù‡Ø© / Ø¥Ù„Ù‰</label><input id="oaDocTo" value="${esc(to0)}"></div>
        <div><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ</label><input id="oaOwner" value="${esc(base.ownerName||'')}" readonly></div>
        <div><label>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</label><input id="oaUnit" value="${esc(base.unit||'')}" readonly></div>
        <div><label>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label><input id="oaId" value="${esc(base.id||'')}" readonly></div>
        <div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="oaPhone" value="${esc(base.phone||'')}" readonly></div>
      </div>
    `;

    let extraSpecific = '';
    if(type === 'noobj_rent'){
      extraSpecific = `
        <div class="grid cols-2" style="margin-top:10px">
          <div><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="oaRenter" placeholder="Ù…Ø«Ø§Ù„: ÙÙ„Ø§Ù† Ø¨Ù† ÙÙ„Ø§Ù†"></div>
          <div><label>Ù…Ø¯Ø© Ø§Ù„ØªØ£Ø¬ÙŠØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="oaPeriod" placeholder="Ù…Ø«Ø§Ù„: Ø³Ù†Ø© / 6 Ø£Ø´Ù‡Ø±"></div>
        </div>`;
    }else if(type === 'noobj_sell'){
      extraSpecific = `
        <div class="grid cols-2" style="margin-top:10px">
          <div><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="oaBuyer" placeholder="Ù…Ø«Ø§Ù„: ÙÙ„Ø§Ù† Ø¨Ù† ÙÙ„Ø§Ù†"></div>
          <div><label>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ù…Ø´ØªØ±ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="oaBuyerId" placeholder="â€”"></div>
        </div>`;
    }else if(type === 'undertake_new_owner'){
      extraSpecific = `
        <div class="grid cols-2" style="margin-top:10px">
          <div><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯</label><input id="oaNewOwner" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"></div>
          <div><label>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="oaNewOwnerId" placeholder="â€”"></div>
          <div><label>Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="oaNewOwnerPhone" placeholder="â€”"></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="oaTransferDate" type="date"></div>
        </div>`;
    }else if(type === 'warning'){
      extraSpecific = `
        <div class="grid cols-2" style="margin-top:10px">
          <div style="grid-column:1/-1">
            <label>Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±</label>
            <textarea id="oaWarnReason" rows="3" placeholder="Ù…Ø«Ø§Ù„: Ù…ØªØ£Ø®Ø±Ø§Øª Ø±Ø³ÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© / Ù…Ø®Ø§Ù„ÙØ© Ù„ÙˆØ§Ø¦Ø­ Ø§Ù„Ù…Ø¨Ù†Ù‰"></textarea>
          </div>
          <div><label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="oaWarnAmount" type="number" step="0.001" placeholder="0.000"></div>
          <div><label>Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="oaWarnDeadline" type="date"></div>
        </div>`;
    }

    const body = `
      <div class="muted">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ø¹ØªÙ…Ø§Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ/Ø§Ù„ÙˆØ­Ø¯Ø©.</div>
      <div class="card" style="margin-top:10px">
        <div class="card-c">
          <div class="muted" style="margin-bottom:6px">Ø§Ù„Ù…Ø¨Ù†Ù‰: <b>${esc(bName)}</b></div>
          ${extraCommon}
          ${extraSpecific}
          <div style="margin-top:10px">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <textarea id="oaExtra" rows="2" placeholder="Ø£ÙŠ Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ"></textarea>
          </div>
          <div class="buttons-row" style="justify-content:flex-start;flex-wrap:wrap">
            <button class="btn" id="oaDocGenerate">ğŸ“ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
            <button class="btn primary" id="oaDocPrint" disabled>ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          </div>
          <div class="card" style="margin-top:12px">
            <div class="card-h"><b>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©</b><span class="muted">Ø§Ø¶ØºØ· "ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø©" Ø£ÙˆÙ„Ø§Ù‹</span></div>
            <div class="card-c" id="oaPreview"><div class="muted">â€”</div></div>
          </div>
        </div>
      </div>
    `;

    UI.openModal(docTitle, body);

const genBtn = document.getElementById('oaDocGenerate');
const printBtn = document.getElementById('oaDocPrint');
const previewBox = document.getElementById('oaPreview');

let lastHtml = '';
let lastV = null;

function collectV(){
  return {
    type,
    title: docTitle,
    building: bName,
    date: document.getElementById('oaDocDate')?.value || date0,
    to: (document.getElementById('oaDocTo')?.value || to0).trim(),
    owner: base.ownerName || '',
    unit: base.unit || '',
    kind: base.kind || '',
    unitUse: base.unitUse || '',
    id: base.id || '',
    phone: base.phone || '',
    extra: (document.getElementById('oaExtra')?.value || '').trim(),
    renter: (document.getElementById('oaRenter')?.value || '').trim(),
    period: (document.getElementById('oaPeriod')?.value || '').trim(),
    buyer: (document.getElementById('oaBuyer')?.value || '').trim(),
    buyerId: (document.getElementById('oaBuyerId')?.value || '').trim(),
    newOwner: (document.getElementById('oaNewOwner')?.value || '').trim(),
    newOwnerId: (document.getElementById('oaNewOwnerId')?.value || '').trim(),
    newOwnerPhone: (document.getElementById('oaNewOwnerPhone')?.value || '').trim(),
    transferDate: (document.getElementById('oaTransferDate')?.value || '').trim(),
    warnReason: (document.getElementById('oaWarnReason')?.value || '').trim(),
    warnAmount: (document.getElementById('oaWarnAmount')?.value || '').trim(),
    warnDeadline: (document.getElementById('oaWarnDeadline')?.value || '').trim()
  };
}

function validateV(v){
  if(v.type === 'undertake_new_owner' && !v.newOwner){
    alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯.');
    return false;
  }
  if(v.type === 'warning' && !v.warnReason){
    alert('Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±.');
    return false;
  }
  return true;
}

function generate(){
  const v = collectV();
  if(!validateV(v)) return;

  lastV = v;
  lastHtml = buildDocBody(v);

  if(previewBox) previewBox.innerHTML = lastHtml || '<div class="muted">â€”</div>';
  if(printBtn) printBtn.disabled = !lastHtml;
}

if(genBtn) genBtn.onclick = generate;

if(printBtn){
  printBtn.onclick = ()=>{
    if(!lastHtml) generate();
    if(!lastHtml || !lastV) return;

    UI.closeModal();
    window.openLetterPrintWindow(lastV.title, lastHtml);
  };
}
  }

function buildDocBody(v){
  const typeLabel = (k)=>{
    if(k==='apartment') return 'Ø´Ù‚Ø©';
    if(k==='shop') return 'Ù…Ø­Ù„';
    if(k==='showroom') return 'Ù…Ø¹Ø±Ø¶';
    if(k==='basement') return 'Ù‚Ø¨Ùˆ';
    return 'ÙˆØ­Ø¯Ø©';
  };
  const unitType = typeLabel(v.kind||'');
  const unitLine = v.unit ? `${unitType} Ø±Ù‚Ù… ${v.unit}` : unitType;

  const ref = (()=>{
    const d = (v.date||'').replaceAll('-','');
    const u = (v.unit||'').replace(/\s+/g,'') || 'X';
    const t = (v.type||'DOC').toUpperCase().replace(/[^A-Z0-9]+/g,'_');
    return `IBSC-${t}-${u}-${d||'00000000'}`;
  })();

  const metaLine = `
    <div class="meta-line">
      <div class="meta-pill">Ø§Ù„ØªØ§Ø±ÙŠØ®: <b>${esc(v.date||'')}</b></div>
      <div class="meta-pill">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹: <b>${esc(ref)}</b></div>
      <div class="meta-pill">Ø§Ù„Ù…Ø¨Ù†Ù‰: <b>${esc(v.building||'')}</b></div>
      <div class="meta-pill">${esc(unitLine)}</div>
    </div>
  `;

  const toLine = `<div class="to"><b>Ø¥Ù„Ù‰:</b> ${esc(v.to||'')}</div>`;
  const subject = `<div class="subject">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: ${esc(v.title||'')}</div>`;

  const p = (txt)=> `<p style="margin:0 0 10px 0">${txt}</p>`;

  let body = '';
  if(v.type === 'noobj_rent'){
    body = [
      p(`Ù†ÙÙŠØ¯ Ù†Ø­Ù† <b>IBSC</b> (Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù…ØªÙ„ÙƒØ§Øª/Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ) Ù„Ù…Ø¨Ù†Ù‰ <b>${esc(v.building||'â€”')}</b> Ø¨Ø£Ù†Ù‡ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙ†Ø§ Ù…Ø§Ù†Ø¹ Ù…Ù† <b>ØªØ£Ø¬ÙŠØ±</b> ${esc(unitLine)} Ø§Ù„Ù…Ù…Ù„ÙˆÙƒØ© Ù„Ù€ <b>${esc(v.owner||'â€”')}</b>.`),
      (v.renter ? p(`Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± (Ø¥Ù† ÙˆØ¬Ø¯): <b>${esc(v.renter)}</b>.`) : ''),
      (v.period ? p(`Ù…Ø¯Ø© Ø§Ù„ØªØ£Ø¬ÙŠØ± (Ø¥Ù† ÙˆØ¬Ø¯Øª): <b>${esc(v.period)}</b>.`) : ''),
      p('ÙˆØ°Ù„Ùƒ Ø´Ø±ÙŠØ·Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù„ÙˆØ§Ø¦Ø­ ÙˆØ£Ù†Ø¸Ù…Ø© Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§ÙƒØŒ ÙˆØ¨Ù…Ø§ Ù„Ø§ ÙŠØ®Ù„ Ø¨Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø¹Ù…ÙˆÙ„ Ø¨Ù‡Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¨Ù†Ù‰ØŒ ÙˆØªØ³ÙˆÙŠØ© Ø£ÙŠ Ù…Ø³ØªØ­Ù‚Ø§Øª Ù‚Ø§Ø¦Ù…Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª.')
    ].join('');
  }else if(v.type === 'noobj_sell'){
    body = [
      p(`Ù†ÙÙŠØ¯ Ù†Ø­Ù† <b>IBSC</b> (Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù…ØªÙ„ÙƒØ§Øª/Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ) Ù„Ù…Ø¨Ù†Ù‰ <b>${esc(v.building||'â€”')}</b> Ø¨Ø£Ù†Ù‡ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙ†Ø§ Ù…Ø§Ù†Ø¹ Ù…Ù† <b>Ø¨ÙŠØ¹/Ù†Ù‚Ù„ Ù…Ù„ÙƒÙŠØ©</b> ${esc(unitLine)} Ø§Ù„Ù…Ù…Ù„ÙˆÙƒØ© Ù„Ù€ <b>${esc(v.owner||'â€”')}</b>.`),
      (v.buyer ? p(`Ø§Ù„Ø·Ø±Ù Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ (Ø¥Ù† ÙˆØ¬Ø¯): <b>${esc(v.buyer)}</b>${v.buyerId?` (Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: <b>${esc(v.buyerId)}</b>)`:''}.`) : ''),
      p('Ø¹Ù„Ù‰ Ø£Ù† ÙŠØªÙ… Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ© ÙˆØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ Ù„Ø¯Ù‰ Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ Ø¨Ø¹Ø¯ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ©ØŒ ÙˆØªØ³ÙˆÙŠØ© Ø£ÙŠ Ø±Ø³ÙˆÙ…/Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©.')
    ].join('');
  }else if(v.type === 'undertake_new_owner'){
    const tDate = v.transferDate || v.date || '';
    body = [
      p(`Ø£Ù†Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ø¯Ù†Ø§Ù‡ <b>${esc(v.owner||'â€”')}</b> Ø£ÙÙ‚Ø± ÙˆØ£ØªØ¹Ù‡Ø¯ Ø¨Ø£Ù† ${esc(unitLine)} ÙÙŠ Ù…Ø¨Ù†Ù‰ <b>${esc(v.building||'â€”')}</b> Ù‚Ø¯ ØªÙ…/Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ù…Ù„ÙƒÙŠØªÙ‡Ø§ Ø¥Ù„Ù‰:`),
      p(`<b>Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</b> ${esc(v.newOwner||'â€”')}${v.newOwnerId?` â€” Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: <b>${esc(v.newOwnerId)}</b>`:''}${v.newOwnerPhone?` â€” Ø§Ù„Ù‡Ø§ØªÙ: <b>${esc(v.newOwnerPhone)}</b>`:''}.`),
      p(`ÙˆØ°Ù„Ùƒ Ø§Ø¹ØªØ¨Ø§Ø±Ù‹Ø§ Ù…Ù† ØªØ§Ø±ÙŠØ® <b>${esc(tDate)}</b>.`),
      p('ÙˆØ£ØªØ¹Ù‡Ø¯ Ø¨ØªØ²ÙˆÙŠØ¯ Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ Ø¨Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¬Ù…Ø¹ÙŠØ©ØŒ ÙˆØªØ³ÙˆÙŠØ© Ø£ÙŠ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø© Ø­Ø³Ø¨ Ø§Ù„Ù„ÙˆØ§Ø¦Ø­.')
    ].join('');
  }else if(v.type === 'warning'){
    const amt = (()=>{
      const x = Number(v.warnAmount||'');
      return Number.isFinite(x) ? x.toFixed(3) : '';
    })();
    body = [
      p(`Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ§Ø¦Ø­ Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ Ù„Ù…Ø¨Ù†Ù‰ <b>${esc(v.building||'â€”')}</b>ØŒ Ù†Ø­ÙŠØ·ÙƒÙ… Ø¹Ù„Ù…Ù‹Ø§ Ø¨Ø¥ØµØ¯Ø§Ø± <b>Ø¥Ù†Ø°Ø§Ø±</b> Ø¨Ø®ØµÙˆØµ ${esc(unitLine)}.`),
      p(`<b>Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±:</b> ${esc(v.warnReason||'â€”')}.`),
      (amt ? p(`<b>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª/Ø§Ù„Ù…Ø¨Ù„Øº (Ø¥Ù† ÙˆØ¬Ø¯):</b> ${esc(amt)} Ø±.Ø¹.`) : ''),
      (v.warnDeadline ? p(`<b>Ø¢Ø®Ø± Ù…ÙˆØ¹Ø¯ Ù„Ù„ØªØµØ­ÙŠØ­/Ø§Ù„Ø³Ø¯Ø§Ø¯ (Ø¥Ù† ÙˆØ¬Ø¯):</b> ${esc(v.warnDeadline)}.`) : ''),
      p('ÙŠØ±Ø¬Ù‰ Ø§ØªØ®Ø§Ø° Ø§Ù„Ù„Ø§Ø²Ù… Ø®Ù„Ø§Ù„ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©ØŒ ÙˆÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ù‚Ø¯ ÙŠØªÙ… Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø­Ø³Ø¨ Ù„ÙˆØ§Ø¦Ø­ Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ùƒ.')
    ].join('');
  }else{
    body = p('â€”');
  }

  const extra = v.extra ? `<div style="margin-top:10px"><b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</b> ${esc(v.extra)}</div>` : '';

  const unitTable = `
    <div class="box">
      <div class="box-h">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ ÙˆØ§Ù„ÙˆØ­Ø¯Ø©</div>
      <div class="box-c">
        <table>
          <tbody>
            <tr>
              <th style="width:22%">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ</th>
              <td>${esc(v.owner||'â€”')}</td>
              <th style="width:22%">Ø§Ù„Ù‡ÙˆÙŠØ©</th>
              <td>${esc(v.id||'â€”')}</td>
            </tr>
            <tr>
              <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
              <td>${esc(v.phone||'â€”')}</td>
              <th>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <td>${esc(v.unitUse||'â€”')}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  `;

  const sign = `
    <div class="sign">
      <div class="sig">
        <div class="lbl">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</div>
        <div class="line"></div>
        <div class="nm">${esc(v.owner||'')}</div>
      </div>
      <div class="sig">
        <div class="lbl">Ø§Ù„Ø®ØªÙ…</div>
        <div class="line"></div>
      </div>
    </div>
  `;

  return `
    ${metaLine}
    <div class="title">${esc(v.title||'')}</div>
    ${toLine}
    ${subject}
    <div class="body">${body}</div>
    ${extra}
    ${unitTable}
    ${sign}
  `;
}

  // ØªÙÙˆÙŠØ¶ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  document.addEventListener('click', function(ev){
    const item = ev.target.closest && ev.target.closest('button[data-doc-issue]');
    if(!item) return;
    ev.preventDefault();
    ev.stopPropagation();

    const drop = item.closest('details[data-docs-drop]');
    if(drop) drop.open = false;

    const base = {
      ownerName: drop?.dataset.tenantName || '',
      unit: drop?.dataset.unit || '',
      kind: drop?.dataset.kind || '',
      phone: drop?.dataset.phone || '',
      id: drop?.dataset.id || '',
      unitUse: drop?.dataset.unituse || ''
    };
    openDocWizard(item.getAttribute('data-doc-issue') || '', base);
  }, true);
})();
</script>

</body>
</html>
